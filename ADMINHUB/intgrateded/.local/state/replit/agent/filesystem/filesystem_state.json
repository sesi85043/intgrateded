{"file_contents":{"client/src/pages/register.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { \n  LayoutDashboard, \n  Eye, \n  EyeOff, \n  AlertCircle, \n  Loader2, \n  CheckCircle2,\n  User,\n  MapPin,\n  Users,\n  Shield,\n  ArrowRight,\n  ArrowLeft\n} from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nconst registrationSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n  password: z.string().min(8, \"Password must be at least 8 characters\"),\n  confirmPassword: z.string(),\n  firstName: z.string().min(1, \"First name is required\"),\n  lastName: z.string().min(1, \"Last name is required\"),\n  phone: z.string().min(10, \"Valid phone number required\"),\n  departmentId: z.string().min(1, \"Department is required\"),\n  \n  addressLine1: z.string().min(1, \"Street address is required\"),\n  addressLine2: z.string().optional(),\n  city: z.string().min(1, \"City is required\"),\n  state: z.string().min(1, \"State is required\"),\n  postalCode: z.string().min(1, \"Postal code is required\"),\n  country: z.string().min(1, \"Country is required\"),\n  \n  nextOfKin1Name: z.string().min(1, \"Next of kin name is required\"),\n  nextOfKin1Relationship: z.string().min(1, \"Relationship is required\"),\n  nextOfKin1Phone: z.string().min(10, \"Valid phone number required\"),\n  nextOfKin1Email: z.string().email().optional().or(z.literal(\"\")),\n  nextOfKin1Address: z.string().optional(),\n  \n  nextOfKin2Name: z.string().min(1, \"Second next of kin name is required\"),\n  nextOfKin2Relationship: z.string().min(1, \"Relationship is required\"),\n  nextOfKin2Phone: z.string().min(10, \"Valid phone number required\"),\n  nextOfKin2Email: z.string().email().optional().or(z.literal(\"\")),\n  nextOfKin2Address: z.string().optional(),\n  \n  captchaVerified: z.boolean().refine(val => val === true, \"Please verify you are human\"),\n}).refine(data => data.password === data.confirmPassword, {\n  message: \"Passwords don't match\",\n  path: [\"confirmPassword\"],\n});\n\ntype RegistrationForm = z.infer<typeof registrationSchema>;\n\nconst NIGERIAN_STATES = [\n  \"Abia\", \"Adamawa\", \"Akwa Ibom\", \"Anambra\", \"Bauchi\", \"Bayelsa\", \"Benue\", \"Borno\",\n  \"Cross River\", \"Delta\", \"Ebonyi\", \"Edo\", \"Ekiti\", \"Enugu\", \"FCT\", \"Gombe\",\n  \"Imo\", \"Jigawa\", \"Kaduna\", \"Kano\", \"Katsina\", \"Kebbi\", \"Kogi\", \"Kwara\",\n  \"Lagos\", \"Nasarawa\", \"Niger\", \"Ogun\", \"Ondo\", \"Osun\", \"Oyo\", \"Plateau\",\n  \"Rivers\", \"Sokoto\", \"Taraba\", \"Yobe\", \"Zamfara\"\n];\n\nconst COUNTRIES = [\n  { code: \"AF\", name: \"Afghanistan\", states: [] },\n  { code: \"AL\", name: \"Albania\", states: [] },\n  { code: \"DZ\", name: \"Algeria\", states: [] },\n  { code: \"AR\", name: \"Argentina\", states: [\"Buenos Aires\", \"Córdoba\", \"Santa Fe\", \"Mendoza\", \"Tucumán\"] },\n  { code: \"AU\", name: \"Australia\", states: [\"New South Wales\", \"Queensland\", \"South Australia\", \"Tasmania\", \"Victoria\", \"Western Australia\", \"Northern Territory\", \"Australian Capital Territory\"] },\n  { code: \"AT\", name: \"Austria\", states: [] },\n  { code: \"BD\", name: \"Bangladesh\", states: [\"Dhaka\", \"Chittagong\", \"Khulna\", \"Rajshahi\", \"Sylhet\"] },\n  { code: \"BE\", name: \"Belgium\", states: [] },\n  { code: \"BR\", name: \"Brazil\", states: [\"São Paulo\", \"Rio de Janeiro\", \"Minas Gerais\", \"Bahia\", \"Paraná\", \"Rio Grande do Sul\"] },\n  { code: \"CA\", name: \"Canada\", states: [\"Alberta\", \"British Columbia\", \"Manitoba\", \"New Brunswick\", \"Newfoundland and Labrador\", \"Nova Scotia\", \"Ontario\", \"Prince Edward Island\", \"Quebec\", \"Saskatchewan\", \"Northwest Territories\", \"Nunavut\", \"Yukon\"] },\n  { code: \"CL\", name: \"Chile\", states: [] },\n  { code: \"CN\", name: \"China\", states: [\"Beijing\", \"Shanghai\", \"Guangdong\", \"Jiangsu\", \"Zhejiang\", \"Shandong\", \"Sichuan\"] },\n  { code: \"CO\", name: \"Colombia\", states: [] },\n  { code: \"CZ\", name: \"Czech Republic\", states: [] },\n  { code: \"DK\", name: \"Denmark\", states: [] },\n  { code: \"EG\", name: \"Egypt\", states: [\"Cairo\", \"Alexandria\", \"Giza\", \"Luxor\", \"Aswan\"] },\n  { code: \"ET\", name: \"Ethiopia\", states: [\"Addis Ababa\", \"Oromia\", \"Amhara\", \"Tigray\"] },\n  { code: \"FI\", name: \"Finland\", states: [] },\n  { code: \"FR\", name: \"France\", states: [\"Île-de-France\", \"Provence-Alpes-Côte d'Azur\", \"Auvergne-Rhône-Alpes\", \"Nouvelle-Aquitaine\"] },\n  { code: \"DE\", name: \"Germany\", states: [\"Bavaria\", \"Berlin\", \"Hamburg\", \"Hesse\", \"North Rhine-Westphalia\", \"Baden-Württemberg\"] },\n  { code: \"GH\", name: \"Ghana\", states: [\"Greater Accra\", \"Ashanti\", \"Western\", \"Eastern\", \"Central\", \"Northern\"] },\n  { code: \"GR\", name: \"Greece\", states: [] },\n  { code: \"HK\", name: \"Hong Kong\", states: [] },\n  { code: \"HU\", name: \"Hungary\", states: [] },\n  { code: \"IN\", name: \"India\", states: [\"Maharashtra\", \"Karnataka\", \"Tamil Nadu\", \"Uttar Pradesh\", \"Gujarat\", \"West Bengal\", \"Rajasthan\", \"Delhi\", \"Kerala\", \"Telangana\"] },\n  { code: \"ID\", name: \"Indonesia\", states: [\"Jakarta\", \"West Java\", \"East Java\", \"Central Java\", \"Bali\"] },\n  { code: \"IE\", name: \"Ireland\", states: [\"Dublin\", \"Cork\", \"Galway\", \"Limerick\"] },\n  { code: \"IL\", name: \"Israel\", states: [] },\n  { code: \"IT\", name: \"Italy\", states: [\"Lombardy\", \"Lazio\", \"Campania\", \"Sicily\", \"Veneto\", \"Tuscany\"] },\n  { code: \"JP\", name: \"Japan\", states: [\"Tokyo\", \"Osaka\", \"Kanagawa\", \"Aichi\", \"Saitama\", \"Hokkaido\"] },\n  { code: \"KE\", name: \"Kenya\", states: [\"Nairobi\", \"Mombasa\", \"Kisumu\", \"Nakuru\", \"Eldoret\"] },\n  { code: \"KR\", name: \"South Korea\", states: [\"Seoul\", \"Busan\", \"Incheon\", \"Daegu\", \"Daejeon\"] },\n  { code: \"MY\", name: \"Malaysia\", states: [\"Kuala Lumpur\", \"Selangor\", \"Penang\", \"Johor\", \"Sabah\", \"Sarawak\"] },\n  { code: \"MX\", name: \"Mexico\", states: [\"Mexico City\", \"Jalisco\", \"Nuevo León\", \"Puebla\", \"Guanajuato\"] },\n  { code: \"MA\", name: \"Morocco\", states: [] },\n  { code: \"NL\", name: \"Netherlands\", states: [\"North Holland\", \"South Holland\", \"Utrecht\", \"North Brabant\"] },\n  { code: \"NZ\", name: \"New Zealand\", states: [\"Auckland\", \"Wellington\", \"Canterbury\", \"Waikato\"] },\n  { code: \"NG\", name: \"Nigeria\", states: NIGERIAN_STATES },\n  { code: \"NO\", name: \"Norway\", states: [] },\n  { code: \"PK\", name: \"Pakistan\", states: [\"Punjab\", \"Sindh\", \"Khyber Pakhtunkhwa\", \"Balochistan\", \"Islamabad\"] },\n  { code: \"PE\", name: \"Peru\", states: [] },\n  { code: \"PH\", name: \"Philippines\", states: [\"Metro Manila\", \"Cebu\", \"Davao\", \"Calabarzon\", \"Central Luzon\"] },\n  { code: \"PL\", name: \"Poland\", states: [] },\n  { code: \"PT\", name: \"Portugal\", states: [] },\n  { code: \"QA\", name: \"Qatar\", states: [] },\n  { code: \"RO\", name: \"Romania\", states: [] },\n  { code: \"RU\", name: \"Russia\", states: [\"Moscow\", \"Saint Petersburg\", \"Novosibirsk\", \"Yekaterinburg\"] },\n  { code: \"SA\", name: \"Saudi Arabia\", states: [\"Riyadh\", \"Makkah\", \"Eastern Province\", \"Madinah\"] },\n  { code: \"SG\", name: \"Singapore\", states: [] },\n  { code: \"ZA\", name: \"South Africa\", states: [\"Gauteng\", \"Western Cape\", \"KwaZulu-Natal\", \"Eastern Cape\", \"Free State\"] },\n  { code: \"ES\", name: \"Spain\", states: [\"Madrid\", \"Catalonia\", \"Andalusia\", \"Valencia\", \"Galicia\"] },\n  { code: \"SE\", name: \"Sweden\", states: [] },\n  { code: \"CH\", name: \"Switzerland\", states: [] },\n  { code: \"TW\", name: \"Taiwan\", states: [] },\n  { code: \"TZ\", name: \"Tanzania\", states: [\"Dar es Salaam\", \"Dodoma\", \"Mwanza\", \"Arusha\"] },\n  { code: \"TH\", name: \"Thailand\", states: [\"Bangkok\", \"Chiang Mai\", \"Phuket\", \"Pattaya\"] },\n  { code: \"TR\", name: \"Turkey\", states: [\"Istanbul\", \"Ankara\", \"Izmir\", \"Antalya\"] },\n  { code: \"UA\", name: \"Ukraine\", states: [\"Kyiv\", \"Kharkiv\", \"Odesa\", \"Lviv\"] },\n  { code: \"AE\", name: \"United Arab Emirates\", states: [\"Dubai\", \"Abu Dhabi\", \"Sharjah\", \"Ajman\"] },\n  { code: \"UK\", name: \"United Kingdom\", states: [\"England\", \"Scotland\", \"Wales\", \"Northern Ireland\"] },\n  { code: \"US\", name: \"United States\", states: [\"Alabama\", \"Alaska\", \"Arizona\", \"Arkansas\", \"California\", \"Colorado\", \"Connecticut\", \"Delaware\", \"Florida\", \"Georgia\", \"Hawaii\", \"Idaho\", \"Illinois\", \"Indiana\", \"Iowa\", \"Kansas\", \"Kentucky\", \"Louisiana\", \"Maine\", \"Maryland\", \"Massachusetts\", \"Michigan\", \"Minnesota\", \"Mississippi\", \"Missouri\", \"Montana\", \"Nebraska\", \"Nevada\", \"New Hampshire\", \"New Jersey\", \"New Mexico\", \"New York\", \"North Carolina\", \"North Dakota\", \"Ohio\", \"Oklahoma\", \"Oregon\", \"Pennsylvania\", \"Rhode Island\", \"South Carolina\", \"South Dakota\", \"Tennessee\", \"Texas\", \"Utah\", \"Vermont\", \"Virginia\", \"Washington\", \"West Virginia\", \"Wisconsin\", \"Wyoming\", \"District of Columbia\"] },\n  { code: \"VN\", name: \"Vietnam\", states: [\"Ho Chi Minh City\", \"Hanoi\", \"Da Nang\", \"Hai Phong\"] },\n  { code: \"ZM\", name: \"Zambia\", states: [\"Lusaka\", \"Copperbelt\", \"Southern\", \"Eastern\"] },\n  { code: \"ZW\", name: \"Zimbabwe\", states: [\"Harare\", \"Bulawayo\", \"Manicaland\", \"Mashonaland\"] },\n];\n\nconst RELATIONSHIPS = [\n  \"Spouse\", \"Parent\", \"Child\", \"Sibling\", \"Uncle\", \"Aunt\", \"Cousin\", \"Friend\", \"Other\"\n];\n\ninterface Department {\n  id: string;\n  name: string;\n  code: string;\n}\n\nexport default function Register() {\n  const [, setLocation] = useLocation();\n  const [step, setStep] = useState(1);\n  const [showPassword, setShowPassword] = useState(false);\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [success, setSuccess] = useState(false);\n  const [captchaChallenge, setCaptchaChallenge] = useState({ num1: 0, num2: 0 });\n  const [captchaAnswer, setCaptchaAnswer] = useState(\"\");\n\n  const { data: departments = [] } = useQuery<Department[]>({\n    queryKey: [\"/api/public/departments\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/public/departments\");\n      if (!response.ok) throw new Error(\"Failed to fetch departments\");\n      return response.json();\n    },\n  });\n\n  const form = useForm<RegistrationForm>({\n    resolver: zodResolver(registrationSchema),\n    defaultValues: {\n      email: \"\",\n      password: \"\",\n      confirmPassword: \"\",\n      firstName: \"\",\n      lastName: \"\",\n      phone: \"\",\n      departmentId: \"\",\n      addressLine1: \"\",\n      addressLine2: \"\",\n      city: \"\",\n      state: \"\",\n      postalCode: \"\",\n      country: \"\",\n      nextOfKin1Name: \"\",\n      nextOfKin1Relationship: \"\",\n      nextOfKin1Phone: \"\",\n      nextOfKin1Email: \"\",\n      nextOfKin1Address: \"\",\n      nextOfKin2Name: \"\",\n      nextOfKin2Relationship: \"\",\n      nextOfKin2Phone: \"\",\n      nextOfKin2Email: \"\",\n      nextOfKin2Address: \"\",\n      captchaVerified: false,\n    },\n  });\n\n  useEffect(() => {\n    generateCaptcha();\n  }, []);\n\n  const generateCaptcha = () => {\n    const num1 = Math.floor(Math.random() * 10) + 1;\n    const num2 = Math.floor(Math.random() * 10) + 1;\n    setCaptchaChallenge({ num1, num2 });\n    setCaptchaAnswer(\"\");\n    form.setValue(\"captchaVerified\", false);\n  };\n\n  const verifyCaptcha = () => {\n    const expectedAnswer = captchaChallenge.num1 + captchaChallenge.num2;\n    const isCorrect = parseInt(captchaAnswer) === expectedAnswer;\n    form.setValue(\"captchaVerified\", isCorrect);\n    if (!isCorrect) {\n      generateCaptcha();\n    }\n    return isCorrect;\n  };\n\n  const registerMutation = useMutation({\n    mutationFn: async (data: RegistrationForm) => {\n      const payload = {\n        ...data,\n        captchaToken: data.captchaVerified ? \"verified\" : \"\",\n        nextOfKin1Email: data.nextOfKin1Email || undefined,\n        nextOfKin2Email: data.nextOfKin2Email || undefined,\n      };\n      return await apiRequest(\"/api/auth/register\", \"POST\", payload);\n    },\n    onSuccess: () => {\n      setSuccess(true);\n    },\n    onError: (err: any) => {\n      const message = err?.message || \"Registration failed. Please try again.\";\n      setError(message);\n    },\n  });\n\n  const validateStep = async (currentStep: number): Promise<boolean> => {\n    let fieldsToValidate: (keyof RegistrationForm)[] = [];\n    \n    switch (currentStep) {\n      case 1:\n        fieldsToValidate = [\"firstName\", \"lastName\", \"email\", \"phone\", \"password\", \"confirmPassword\", \"departmentId\"];\n        break;\n      case 2:\n        fieldsToValidate = [\"addressLine1\", \"city\", \"state\", \"postalCode\"];\n        break;\n      case 3:\n        fieldsToValidate = [\"nextOfKin1Name\", \"nextOfKin1Relationship\", \"nextOfKin1Phone\"];\n        break;\n      case 4:\n        fieldsToValidate = [\"nextOfKin2Name\", \"nextOfKin2Relationship\", \"nextOfKin2Phone\", \"captchaVerified\"];\n        break;\n    }\n\n    const result = await form.trigger(fieldsToValidate);\n    return result;\n  };\n\n  const nextStep = async () => {\n    setError(null);\n    const isValid = await validateStep(step);\n    if (isValid) {\n      setStep(prev => Math.min(prev + 1, 4));\n    }\n  };\n\n  const prevStep = () => {\n    setError(null);\n    setStep(prev => Math.max(prev - 1, 1));\n  };\n\n  const onSubmit = async (data: RegistrationForm) => {\n    setError(null);\n    registerMutation.mutate(data);\n  };\n\n  if (success) {\n    return (\n      <div className=\"min-h-screen bg-background flex flex-col\">\n        <header className=\"border-b border-border\">\n          <div className=\"container mx-auto px-6 py-4\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-primary text-primary-foreground\">\n                <LayoutDashboard className=\"h-6 w-6\" />\n              </div>\n              <span className=\"text-xl font-semibold\">Admin Hub</span>\n            </div>\n          </div>\n        </header>\n\n        <main className=\"flex-1 flex items-center justify-center px-6 py-12\">\n          <Card className=\"w-full max-w-md\">\n            <CardContent className=\"pt-6\">\n              <div className=\"text-center space-y-4\">\n                <div className=\"mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center\">\n                  <CheckCircle2 className=\"h-10 w-10 text-green-600\" />\n                </div>\n                <h2 className=\"text-2xl font-bold text-green-600\">Registration Submitted!</h2>\n                <p className=\"text-muted-foreground\">\n                  Your application has been submitted successfully and is now pending approval by management.\n                </p>\n                <p className=\"text-sm text-muted-foreground\">\n                  You will be notified once your account has been reviewed and activated.\n                </p>\n                <Button onClick={() => setLocation(\"/login\")} className=\"mt-4\">\n                  Return to Login\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </main>\n      </div>\n    );\n  }\n\n  const stepTitles = [\n    { icon: User, title: \"Personal Information\", description: \"Your basic details\" },\n    { icon: MapPin, title: \"Residential Address\", description: \"Where you live\" },\n    { icon: Users, title: \"Next of Kin (1)\", description: \"Primary emergency contact\" },\n    { icon: Shield, title: \"Next of Kin (2) & Verify\", description: \"Secondary contact & verification\" },\n  ];\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col\">\n      <header className=\"border-b border-border\">\n        <div className=\"container mx-auto px-6 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-primary text-primary-foreground\">\n                <LayoutDashboard className=\"h-6 w-6\" />\n              </div>\n              <span className=\"text-xl font-semibold\">Admin Hub</span>\n            </div>\n            <Button variant=\"ghost\" onClick={() => setLocation(\"/login\")}>\n              Already have an account? Sign In\n            </Button>\n          </div>\n        </div>\n      </header>\n\n      <main className=\"flex-1 container mx-auto px-6 py-8\">\n        <div className=\"max-w-2xl mx-auto\">\n          <div className=\"text-center mb-8\">\n            <h1 className=\"text-3xl font-bold mb-2\">Staff Registration</h1>\n            <p className=\"text-muted-foreground\">Complete the form below to apply for staff access</p>\n          </div>\n\n          <div className=\"flex justify-between mb-8\">\n            {stepTitles.map((s, index) => {\n              const StepIcon = s.icon;\n              const isActive = step === index + 1;\n              const isCompleted = step > index + 1;\n              return (\n                <div \n                  key={index} \n                  className={`flex flex-col items-center flex-1 ${index < stepTitles.length - 1 ? 'relative' : ''}`}\n                >\n                  <div \n                    className={`w-10 h-10 rounded-full flex items-center justify-center border-2 transition-colors ${\n                      isCompleted ? 'bg-primary border-primary text-primary-foreground' :\n                      isActive ? 'border-primary text-primary bg-primary/10' :\n                      'border-muted-foreground/30 text-muted-foreground'\n                    }`}\n                  >\n                    {isCompleted ? <CheckCircle2 className=\"h-5 w-5\" /> : <StepIcon className=\"h-5 w-5\" />}\n                  </div>\n                  <span className={`text-xs mt-2 text-center ${isActive ? 'text-primary font-medium' : 'text-muted-foreground'}`}>\n                    {s.title}\n                  </span>\n                  {index < stepTitles.length - 1 && (\n                    <div className={`absolute top-5 left-[60%] w-[80%] h-0.5 ${isCompleted ? 'bg-primary' : 'bg-muted-foreground/30'}`} />\n                  )}\n                </div>\n              );\n            })}\n          </div>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                {(() => {\n                  const StepIcon = stepTitles[step - 1].icon;\n                  return <StepIcon className=\"h-5 w-5\" />;\n                })()}\n                {stepTitles[step - 1].title}\n              </CardTitle>\n              <CardDescription>{stepTitles[step - 1].description}</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                {error && (\n                  <Alert variant=\"destructive\">\n                    <AlertCircle className=\"h-4 w-4\" />\n                    <AlertDescription>{error}</AlertDescription>\n                  </Alert>\n                )}\n\n                {step === 1 && (\n                  <div className=\"space-y-4\">\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"firstName\">First Name *</Label>\n                        <Input\n                          id=\"firstName\"\n                          {...form.register(\"firstName\")}\n                          placeholder=\"John\"\n                        />\n                        {form.formState.errors.firstName && (\n                          <p className=\"text-sm text-destructive\">{form.formState.errors.firstName.message}</p>\n                        )}\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"lastName\">Last Name *</Label>\n                        <Input\n                          id=\"lastName\"\n                          {...form.register(\"lastName\")}\n                          placeholder=\"Doe\"\n                        />\n                        {form.formState.errors.lastName && (\n                          <p className=\"text-sm text-destructive\">{form.formState.errors.lastName.message}</p>\n                        )}\n                      </div>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"email\">Email Address *</Label>\n                      <Input\n                        id=\"email\"\n                        type=\"email\"\n                        {...form.register(\"email\")}\n                        placeholder=\"john.doe@company.com\"\n                      />\n                      {form.formState.errors.email && (\n                        <p className=\"text-sm text-destructive\">{form.formState.errors.email.message}</p>\n                      )}\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"phone\">Phone Number *</Label>\n                      <Input\n                        id=\"phone\"\n                        {...form.register(\"phone\")}\n                        placeholder=\"+234 801 234 5678\"\n                      />\n                      {form.formState.errors.phone && (\n                        <p className=\"text-sm text-destructive\">{form.formState.errors.phone.message}</p>\n                      )}\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"departmentId\">Department *</Label>\n                      <Select\n                        value={form.watch(\"departmentId\")}\n                        onValueChange={(value) => form.setValue(\"departmentId\", value)}\n                      >\n                        <SelectTrigger>\n                          <SelectValue placeholder=\"Select your department\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {departments.map((dept) => (\n                            <SelectItem key={dept.id} value={dept.id}>\n                              {dept.name} ({dept.code})\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      {form.formState.errors.departmentId && (\n                        <p className=\"text-sm text-destructive\">{form.formState.errors.departmentId.message}</p>\n                      )}\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"password\">Password *</Label>\n                      <div className=\"relative\">\n                        <Input\n                          id=\"password\"\n                          type={showPassword ? \"text\" : \"password\"}\n                          {...form.register(\"password\")}\n                          placeholder=\"At least 8 characters\"\n                          className=\"pr-10\"\n                        />\n                        <Button\n                          type=\"button\"\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"absolute right-0 top-0 h-full px-3 hover:bg-transparent\"\n                          onClick={() => setShowPassword(!showPassword)}\n                        >\n                          {showPassword ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                        </Button>\n                      </div>\n                      {form.formState.errors.password && (\n                        <p className=\"text-sm text-destructive\">{form.formState.errors.password.message}</p>\n                      )}\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"confirmPassword\">Confirm Password *</Label>\n                      <div className=\"relative\">\n                        <Input\n                          id=\"confirmPassword\"\n                          type={showConfirmPassword ? \"text\" : \"password\"}\n                          {...form.register(\"confirmPassword\")}\n                          placeholder=\"Repeat your password\"\n                          className=\"pr-10\"\n                        />\n                        <Button\n                          type=\"button\"\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"absolute right-0 top-0 h-full px-3 hover:bg-transparent\"\n                          onClick={() => setShowConfirmPassword(!showConfirmPassword)}\n                        >\n                          {showConfirmPassword ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                        </Button>\n                      </div>\n                      {form.formState.errors.confirmPassword && (\n                        <p className=\"text-sm text-destructive\">{form.formState.errors.confirmPassword.message}</p>\n                      )}\n                    </div>\n                  </div>\n                )}\n\n                {step === 2 && (\n                  <div className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"addressLine1\">Street Address *</Label>\n                      <Input\n                        id=\"addressLine1\"\n                        {...form.register(\"addressLine1\")}\n                        placeholder=\"123 Main Street\"\n                      />\n                      {form.formState.errors.addressLine1 && (\n                        <p className=\"text-sm text-destructive\">{form.formState.errors.addressLine1.message}</p>\n                      )}\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"addressLine2\">Address Line 2 (Optional)</Label>\n                      <Input\n                        id=\"addressLine2\"\n                        {...form.register(\"addressLine2\")}\n                        placeholder=\"Apartment, suite, etc.\"\n                      />\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"city\">City *</Label>\n                        <Input\n                          id=\"city\"\n                          {...form.register(\"city\")}\n                          placeholder=\"Lagos\"\n                        />\n                        {form.formState.errors.city && (\n                          <p className=\"text-sm text-destructive\">{form.formState.errors.city.message}</p>\n                        )}\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"state\">State/Region *</Label>\n                        <Select\n                          value={form.watch(\"state\")}\n                          onValueChange={(value) => form.setValue(\"state\", value)}\n                        >\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Select state/region\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {(() => {\n                              const selectedCountry = COUNTRIES.find(c => c.code === form.watch(\"country\"));\n                              return selectedCountry ? selectedCountry.states.map((state) => (\n                                <SelectItem key={state} value={state}>\n                                  {state}\n                                </SelectItem>\n                              )) : null;\n                            })()}\n                          </SelectContent>\n                        </Select>\n                        {form.formState.errors.state && (\n                          <p className=\"text-sm text-destructive\">{form.formState.errors.state.message}</p>\n                        )}\n                      </div>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"postalCode\">Postal Code *</Label>\n                        <Input\n                          id=\"postalCode\"\n                          {...form.register(\"postalCode\")}\n                          placeholder=\"100001\"\n                        />\n                        {form.formState.errors.postalCode && (\n                          <p className=\"text-sm text-destructive\">{form.formState.errors.postalCode.message}</p>\n                        )}\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"country\">Country *</Label>\n                        <Select\n                          value={form.watch(\"country\")}\n                          onValueChange={(value) => {\n                            form.setValue(\"country\", value);\n                            form.setValue(\"state\", \"\");\n                          }}\n                        >\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Select country\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {COUNTRIES.map((country) => (\n                              <SelectItem key={country.code} value={country.code}>\n                                {country.name}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        {form.formState.errors.country && (\n                          <p className=\"text-sm text-destructive\">{form.formState.errors.country.message}</p>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                {step === 3 && (\n                  <div className=\"space-y-4\">\n                    <div className=\"p-3 bg-muted rounded-lg mb-4\">\n                      <p className=\"text-sm text-muted-foreground\">\n                        Please provide details of your primary emergency contact person.\n                      </p>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"nextOfKin1Name\">Full Name *</Label>\n                      <Input\n                        id=\"nextOfKin1Name\"\n                        {...form.register(\"nextOfKin1Name\")}\n                        placeholder=\"Jane Doe\"\n                      />\n                      {form.formState.errors.nextOfKin1Name && (\n                        <p className=\"text-sm text-destructive\">{form.formState.errors.nextOfKin1Name.message}</p>\n                      )}\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"nextOfKin1Relationship\">Relationship *</Label>\n                        <Select\n                          value={form.watch(\"nextOfKin1Relationship\")}\n                          onValueChange={(value) => form.setValue(\"nextOfKin1Relationship\", value)}\n                        >\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Select relationship\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {RELATIONSHIPS.map((rel) => (\n                              <SelectItem key={rel} value={rel}>\n                                {rel}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        {form.formState.errors.nextOfKin1Relationship && (\n                          <p className=\"text-sm text-destructive\">{form.formState.errors.nextOfKin1Relationship.message}</p>\n                        )}\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"nextOfKin1Phone\">Phone Number *</Label>\n                        <Input\n                          id=\"nextOfKin1Phone\"\n                          {...form.register(\"nextOfKin1Phone\")}\n                          placeholder=\"+234 801 234 5678\"\n                        />\n                        {form.formState.errors.nextOfKin1Phone && (\n                          <p className=\"text-sm text-destructive\">{form.formState.errors.nextOfKin1Phone.message}</p>\n                        )}\n                      </div>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"nextOfKin1Email\">Email (Optional)</Label>\n                      <Input\n                        id=\"nextOfKin1Email\"\n                        type=\"email\"\n                        {...form.register(\"nextOfKin1Email\")}\n                        placeholder=\"jane.doe@email.com\"\n                      />\n                      {form.formState.errors.nextOfKin1Email && (\n                        <p className=\"text-sm text-destructive\">{form.formState.errors.nextOfKin1Email.message}</p>\n                      )}\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"nextOfKin1Address\">Address (Optional)</Label>\n                      <Input\n                        id=\"nextOfKin1Address\"\n                        {...form.register(\"nextOfKin1Address\")}\n                        placeholder=\"Contact's address\"\n                      />\n                    </div>\n                  </div>\n                )}\n\n                {step === 4 && (\n                  <div className=\"space-y-4\">\n                    <div className=\"p-3 bg-muted rounded-lg mb-4\">\n                      <p className=\"text-sm text-muted-foreground\">\n                        Please provide details of your secondary emergency contact person.\n                      </p>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"nextOfKin2Name\">Full Name *</Label>\n                      <Input\n                        id=\"nextOfKin2Name\"\n                        {...form.register(\"nextOfKin2Name\")}\n                        placeholder=\"John Smith\"\n                      />\n                      {form.formState.errors.nextOfKin2Name && (\n                        <p className=\"text-sm text-destructive\">{form.formState.errors.nextOfKin2Name.message}</p>\n                      )}\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"nextOfKin2Relationship\">Relationship *</Label>\n                        <Select\n                          value={form.watch(\"nextOfKin2Relationship\")}\n                          onValueChange={(value) => form.setValue(\"nextOfKin2Relationship\", value)}\n                        >\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Select relationship\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {RELATIONSHIPS.map((rel) => (\n                              <SelectItem key={rel} value={rel}>\n                                {rel}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        {form.formState.errors.nextOfKin2Relationship && (\n                          <p className=\"text-sm text-destructive\">{form.formState.errors.nextOfKin2Relationship.message}</p>\n                        )}\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"nextOfKin2Phone\">Phone Number *</Label>\n                        <Input\n                          id=\"nextOfKin2Phone\"\n                          {...form.register(\"nextOfKin2Phone\")}\n                          placeholder=\"+234 801 234 5678\"\n                        />\n                        {form.formState.errors.nextOfKin2Phone && (\n                          <p className=\"text-sm text-destructive\">{form.formState.errors.nextOfKin2Phone.message}</p>\n                        )}\n                      </div>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"nextOfKin2Email\">Email (Optional)</Label>\n                      <Input\n                        id=\"nextOfKin2Email\"\n                        type=\"email\"\n                        {...form.register(\"nextOfKin2Email\")}\n                        placeholder=\"john.smith@email.com\"\n                      />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"nextOfKin2Address\">Address (Optional)</Label>\n                      <Input\n                        id=\"nextOfKin2Address\"\n                        {...form.register(\"nextOfKin2Address\")}\n                        placeholder=\"Contact's address\"\n                      />\n                    </div>\n\n                    <div className=\"border-t pt-4 mt-6\">\n                      <div className=\"space-y-4\">\n                        <div className=\"p-4 bg-muted rounded-lg\">\n                          <Label className=\"text-base font-medium\">Human Verification *</Label>\n                          <p className=\"text-sm text-muted-foreground mt-1 mb-3\">\n                            Please solve this simple math problem to verify you are human:\n                          </p>\n                          <div className=\"flex items-center gap-3\">\n                            <div className=\"bg-background px-4 py-2 rounded border font-mono text-lg\">\n                              {captchaChallenge.num1} + {captchaChallenge.num2} = ?\n                            </div>\n                            <Input\n                              type=\"number\"\n                              value={captchaAnswer}\n                              onChange={(e) => setCaptchaAnswer(e.target.value)}\n                              placeholder=\"Answer\"\n                              className=\"w-24\"\n                            />\n                            <Button \n                              type=\"button\" \n                              variant=\"outline\" \n                              onClick={verifyCaptcha}\n                              disabled={!captchaAnswer}\n                            >\n                              Verify\n                            </Button>\n                            {form.watch(\"captchaVerified\") && (\n                              <CheckCircle2 className=\"h-5 w-5 text-green-600\" />\n                            )}\n                          </div>\n                          {form.formState.errors.captchaVerified && (\n                            <p className=\"text-sm text-destructive mt-2\">{form.formState.errors.captchaVerified.message}</p>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                <div className=\"flex justify-between pt-4 border-t\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={prevStep}\n                    disabled={step === 1}\n                  >\n                    <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                    Previous\n                  </Button>\n                  \n                  {step < 4 ? (\n                    <Button type=\"button\" onClick={nextStep}>\n                      Next\n                      <ArrowRight className=\"h-4 w-4 ml-2\" />\n                    </Button>\n                  ) : (\n                    <Button \n                      type=\"submit\" \n                      disabled={registerMutation.isPending || !form.watch(\"captchaVerified\")}\n                    >\n                      {registerMutation.isPending ? (\n                        <>\n                          <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                          Submitting...\n                        </>\n                      ) : (\n                        <>\n                          <CheckCircle2 className=\"mr-2 h-4 w-4\" />\n                          Submit Application\n                        </>\n                      )}\n                    </Button>\n                  )}\n                </div>\n              </form>\n            </CardContent>\n          </Card>\n        </div>\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":40443,"size_tokens":null},"ADMINHUB/server/provisioning.ts":{"content":"import crypto from 'crypto';\nimport { db } from './db';\nimport { mailcowConfig } from '../shared/schema';\nimport { eq } from 'drizzle-orm';\n\n/**\n * Generate a cryptographically secure password.\n * Uses Node's WebCrypto implementation for secure randomness.\n */\nexport function generateSecurePassword(length = 16): string {\n  const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=';\n  const randomValues = new Uint32Array(length);\n  // Use Node's WebCrypto for secure randomness\n  if (crypto.webcrypto && typeof crypto.webcrypto.getRandomValues === 'function') {\n    crypto.webcrypto.getRandomValues(randomValues as unknown as Uint8Array);\n  } else {\n    // Fallback to randomFillSync if WebCrypto not available\n    const buf = Buffer.allocUnsafe(length * 4);\n    crypto.randomFillSync(buf);\n    for (let i = 0; i < length; i++) randomValues[i] = buf.readUInt32LE(i * 4);\n  }\n\n  let password = '';\n  for (let i = 0; i < length; i++) {\n    password += charset[randomValues[i] % charset.length];\n  }\n  return password;\n}\n\n/**\n * Create a Mailcow mailbox using the configured Mailcow instance in the DB.\n * Format for local part: surname.firstname_department\n */\nexport async function createMailcowMailbox(firstName: string, lastName: string, department: string) {\n  const config = await db.query.mailcowConfig.findFirst({\n    where: eq(mailcowConfig.enabled, true),\n  });\n\n  if (!config || !config.instanceUrl || !config.apiKey || !config.domain) {\n    throw new Error('Mailcow is not configured or enabled.');\n  }\n\n  const cleanLast = lastName.toLowerCase().trim().replace(/[^a-z0-9]/g, '');\n  const cleanFirst = firstName.toLowerCase().trim().replace(/[^a-z0-9]/g, '');\n  const cleanDept = (department || 'staff').toLowerCase().trim().replace(/[^a-z0-9]/g, '');\n\n  const localPart = `${cleanLast}.${cleanFirst}_${cleanDept}`;\n  const email = `${localPart}@${config.domain}`;\n  const password = generateSecurePassword(16);\n\n  const res = await fetch(`${config.instanceUrl.replace(/\\/$/, '')}/api/v1/add/mailbox`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'X-API-Key': config.apiKey,\n    },\n    body: JSON.stringify({\n      local_part: localPart,\n      domain: config.domain,\n      password,\n      name: `${firstName} ${lastName}`,\n      active: '1',\n      quota: 3072,\n    }),\n  });\n\n  const result = await res.json();\n  if (Array.isArray(result) && result[0] && result[0].type === 'error') {\n    throw new Error(`Mailcow Error: ${result[0].msg}`);\n  }\n\n  return { email, password };\n}\n","path":null,"size_bytes":2566,"size_tokens":null},"docs/replit-legacy/README.md":{"content":"Replit local state archive\n==========================\n\nThese Replit-specific local state files were moved/removed from the working tree to keep the repository clean.\n\nIf you need to restore them, retrieve the files from Git history or from your local backup.\n\nFiles removed:\n- `.local/state/replit/agent/*`\n\nWhy removed:\n- These files are Replit agent/local state files created by the Replit import/agent tooling and are not required for development or production deployments.\n\nIf you later want to re-enable Replit-specific docs or state, restore from Git history or copy files into `.local/state/replit/`.\n","path":null,"size_bytes":608,"size_tokens":null},"client/src/pages/inbox.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { \n  MessageSquare, \n  ExternalLink, \n  Settings,\n  AlertCircle,\n  Inbox as InboxIcon,\n  RefreshCw,\n  Clock,\n  CheckCircle2,\n  MessageCircle,\n  Zap,\n  Copy,\n  Plus,\n  Trash2\n} from \"lucide-react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface ChatwootEmbedInfo {\n  embedUrl: string;\n  instanceUrl: string;\n  accountId: number;\n  agentId: number | null;\n  ssoEnabled: boolean;\n}\n\ninterface DepartmentInbox {\n  inbox: {\n    id: string;\n    chatwootInboxId: number;\n    chatwootInboxName: string;\n    inboxType: string;\n  } | null;\n  embedUrl: string;\n  message?: string;\n}\n\ninterface IntegrationStatus {\n  chatwoot: { configured: boolean; enabled: boolean };\n}\n\ninterface ConversationStats {\n  open: number;\n  pending: number;\n  resolved: number;\n  unassigned: number;\n  available: boolean;\n  lastUpdated?: string;\n}\n\ninterface QuickReply {\n  id: string;\n  title: string;\n  content: string;\n}\n\nconst DEFAULT_QUICK_REPLIES: QuickReply[] = [\n  {\n    id: \"1\",\n    title: \"Greeting\",\n    content: \"Hello! Thank you for contacting us. How can I assist you today?\",\n  },\n  {\n    id: \"2\",\n    title: \"Checking Status\",\n    content: \"I'm looking into this for you now. Please give me a moment to check the details.\",\n  },\n  {\n    id: \"3\",\n    title: \"Request Info\",\n    content: \"To help you better, could you please provide your order number or account email?\",\n  },\n  {\n    id: \"4\",\n    title: \"Escalation\",\n    content: \"I'll escalate this to our specialist team. They will get back to you within 24 hours.\",\n  },\n  {\n    id: \"5\",\n    title: \"Closing\",\n    content: \"Is there anything else I can help you with today? If not, I'll close this conversation.\",\n  },\n];\n\nfunction StatCard({ title, value, icon: Icon, color }: { \n  title: string; \n  value: number; \n  icon: React.ComponentType<{ className?: string }>;\n  color: string;\n}) {\n  return (\n    <div className={`p-4 rounded-lg border ${color}`}>\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <p className=\"text-sm font-medium text-muted-foreground\">{title}</p>\n          <p className=\"text-2xl font-bold\">{value}</p>\n        </div>\n        <Icon className=\"h-8 w-8 opacity-50\" />\n      </div>\n    </div>\n  );\n}\n\nfunction QuickReplies({ onCopy }: { onCopy: (text: string) => void }) {\n  const [replies, setReplies] = useState<QuickReply[]>(() => {\n    const saved = localStorage.getItem('quickReplies');\n    return saved ? JSON.parse(saved) : DEFAULT_QUICK_REPLIES;\n  });\n  const [newTitle, setNewTitle] = useState(\"\");\n  const [newContent, setNewContent] = useState(\"\");\n  const [showAdd, setShowAdd] = useState(false);\n  const { toast } = useToast();\n\n  const saveReplies = (updated: QuickReply[]) => {\n    setReplies(updated);\n    localStorage.setItem('quickReplies', JSON.stringify(updated));\n  };\n\n  const handleAdd = () => {\n    if (!newTitle.trim() || !newContent.trim()) {\n      toast({ title: \"Error\", description: \"Please fill in both title and content\", variant: \"destructive\" });\n      return;\n    }\n    const newReply: QuickReply = {\n      id: Date.now().toString(),\n      title: newTitle,\n      content: newContent,\n    };\n    saveReplies([...replies, newReply]);\n    setNewTitle(\"\");\n    setNewContent(\"\");\n    setShowAdd(false);\n    toast({ title: \"Quick reply added\" });\n  };\n\n  const handleDelete = (id: string) => {\n    saveReplies(replies.filter(r => r.id !== id));\n    toast({ title: \"Quick reply deleted\" });\n  };\n\n  const handleCopy = (content: string) => {\n    navigator.clipboard.writeText(content);\n    onCopy(content);\n    toast({ title: \"Copied to clipboard\", description: \"Paste this in your Chatwoot conversation\" });\n  };\n\n  return (\n    <div className=\"space-y-3\">\n      <div className=\"flex items-center justify-between\">\n        <h4 className=\"font-medium text-sm\">Quick Replies</h4>\n        <Button size=\"sm\" variant=\"outline\" onClick={() => setShowAdd(!showAdd)}>\n          <Plus className=\"h-4 w-4 mr-1\" />\n          Add\n        </Button>\n      </div>\n\n      {showAdd && (\n        <div className=\"p-3 rounded-md bg-muted space-y-2\">\n          <input\n            type=\"text\"\n            placeholder=\"Title (e.g., 'Greeting')\"\n            value={newTitle}\n            onChange={(e) => setNewTitle(e.target.value)}\n            className=\"w-full px-3 py-2 text-sm rounded-md border bg-background\"\n          />\n          <Textarea\n            placeholder=\"Reply content...\"\n            value={newContent}\n            onChange={(e) => setNewContent(e.target.value)}\n            rows={3}\n          />\n          <div className=\"flex gap-2\">\n            <Button size=\"sm\" onClick={handleAdd}>Save</Button>\n            <Button size=\"sm\" variant=\"ghost\" onClick={() => setShowAdd(false)}>Cancel</Button>\n          </div>\n        </div>\n      )}\n\n      <div className=\"grid gap-2 max-h-[300px] overflow-y-auto\">\n        {replies.map((reply) => (\n          <div \n            key={reply.id} \n            className=\"p-3 rounded-md border bg-card hover:bg-accent/50 transition-colors group\"\n          >\n            <div className=\"flex items-start justify-between gap-2\">\n              <div className=\"flex-1 min-w-0\">\n                <p className=\"font-medium text-sm\">{reply.title}</p>\n                <p className=\"text-xs text-muted-foreground line-clamp-2 mt-1\">{reply.content}</p>\n              </div>\n              <div className=\"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button \n                      size=\"icon\" \n                      variant=\"ghost\" \n                      className=\"h-7 w-7\"\n                      onClick={() => handleCopy(reply.content)}\n                    >\n                      <Copy className=\"h-3 w-3\" />\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent>Copy to clipboard</TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button \n                      size=\"icon\" \n                      variant=\"ghost\" \n                      className=\"h-7 w-7 text-destructive\"\n                      onClick={() => handleDelete(reply.id)}\n                    >\n                      <Trash2 className=\"h-3 w-3\" />\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent>Delete</TooltipContent>\n                </Tooltip>\n              </div>\n            </div>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction ChatwootEmbed({ embedUrl, title }: { embedUrl: string; title: string }) {\n  return (\n    <div className=\"w-full h-full min-h-[600px] border rounded-md overflow-hidden bg-background\">\n      <iframe\n        src={embedUrl}\n        title={title}\n        className=\"w-full h-full min-h-[600px]\"\n        allow=\"microphone; camera\"\n        data-testid=\"iframe-chatwoot\"\n      />\n    </div>\n  );\n}\n\nfunction NotConfiguredState() {\n  return (\n    <Card>\n      <CardContent className=\"pt-6\">\n        <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n          <div className=\"h-16 w-16 rounded-full bg-muted flex items-center justify-center mb-4\">\n            <Settings className=\"h-8 w-8 text-muted-foreground\" />\n          </div>\n          <h3 className=\"text-lg font-semibold mb-2\">Chatwoot Not Configured</h3>\n          <p className=\"text-muted-foreground mb-4 max-w-md\">\n            To view conversations, an administrator needs to configure the Chatwoot integration first.\n          </p>\n          <Button variant=\"outline\" onClick={() => window.location.href = \"/integrations\"}>\n            <Settings className=\"h-4 w-4 mr-2\" />\n            Go to Integration Settings\n          </Button>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction NoInboxState({ departmentName }: { departmentName?: string }) {\n  return (\n    <Card>\n      <CardContent className=\"pt-6\">\n        <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n          <div className=\"h-16 w-16 rounded-full bg-muted flex items-center justify-center mb-4\">\n            <InboxIcon className=\"h-8 w-8 text-muted-foreground\" />\n          </div>\n          <h3 className=\"text-lg font-semibold mb-2\">No Inbox Assigned</h3>\n          <p className=\"text-muted-foreground mb-4 max-w-md\">\n            {departmentName \n              ? `No Chatwoot inbox has been mapped to the ${departmentName} department yet.`\n              : \"No Chatwoot inbox has been assigned to your department.\"}\n          </p>\n          <Button variant=\"outline\" onClick={() => window.location.href = \"/department-channels\"}>\n            <Settings className=\"h-4 w-4 mr-2\" />\n            Configure Department Channels\n          </Button>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nexport default function Inbox() {\n  const { teamMember, isManagement } = useAuth();\n  const { toast } = useToast();\n  const [refreshing, setRefreshing] = useState(false);\n  const [iframeKey, setIframeKey] = useState(0);\n\n  const { data: status, isLoading: statusLoading } = useQuery<IntegrationStatus>({\n    queryKey: [\"/api/integrations/status\"],\n  });\n\n  const { data: embedInfo, isLoading: embedLoading } = useQuery<ChatwootEmbedInfo>({\n    queryKey: [\"/api/integrations/chatwoot/sso-url\"],\n    enabled: status?.chatwoot?.configured && status?.chatwoot?.enabled,\n  });\n\n  const { data: deptInbox, isLoading: inboxLoading } = useQuery<DepartmentInbox>({\n    queryKey: [\"/api/integrations/chatwoot/department-inbox\"],\n    enabled: status?.chatwoot?.configured && status?.chatwoot?.enabled,\n  });\n\n  const { data: stats, isLoading: statsLoading, isError: statsError, refetch: refetchStats } = useQuery<ConversationStats>({\n    queryKey: [\"/api/integrations/chatwoot/stats\"],\n    enabled: status?.chatwoot?.configured && status?.chatwoot?.enabled,\n    refetchInterval: 60000, // Refresh every minute\n    retry: 1, // Only retry once\n  });\n\n  const isLoading = statusLoading || embedLoading || inboxLoading;\n  const chatwootConfigured = status?.chatwoot?.configured && status?.chatwoot?.enabled;\n\n  const handleRefresh = async () => {\n    setRefreshing(true);\n    try {\n      await Promise.all([\n        queryClient.invalidateQueries({ queryKey: [\"/api/integrations/chatwoot/stats\"] }),\n        queryClient.invalidateQueries({ queryKey: [\"/api/integrations/chatwoot/sso-url\"] }),\n      ]);\n      setIframeKey(prev => prev + 1); // Force iframe reload\n      toast({ title: \"Refreshed\", description: \"Inbox and statistics updated\" });\n    } catch (error) {\n      toast({ title: \"Error\", description: \"Failed to refresh\", variant: \"destructive\" });\n    } finally {\n      setRefreshing(false);\n    }\n  };\n\n  const handleQuickReplyCopy = (text: string) => {\n    // Could trigger additional actions when a quick reply is copied\n  };\n\n  return (\n    <div className=\"space-y-6 h-full\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-3xl font-semibold text-foreground\">Inbox</h1>\n          <p className=\"text-muted-foreground mt-1\">\n            {isManagement \n              ? \"View and manage all customer conversations\" \n              : `View conversations for ${teamMember?.departmentName || \"your department\"}`}\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2 flex-wrap\">\n          {deptInbox?.inbox && (\n            <Badge variant=\"outline\" className=\"gap-1\">\n              <MessageSquare className=\"h-3 w-3\" />\n              {deptInbox.inbox.chatwootInboxName}\n            </Badge>\n          )}\n          {chatwootConfigured && (\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={handleRefresh}\n              disabled={refreshing}\n              data-testid=\"button-refresh-inbox\"\n            >\n              <RefreshCw className={`h-4 w-4 mr-2 ${refreshing ? 'animate-spin' : ''}`} />\n              Refresh\n            </Button>\n          )}\n          {embedInfo?.instanceUrl && (\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => window.open(embedInfo.instanceUrl, '_blank')}\n              data-testid=\"button-open-chatwoot\"\n            >\n              <ExternalLink className=\"h-4 w-4 mr-2\" />\n              Open in Chatwoot\n            </Button>\n          )}\n        </div>\n      </div>\n\n      {isLoading ? (\n        <div className=\"space-y-4\">\n          <Skeleton className=\"h-12 w-full\" />\n          <Skeleton className=\"h-[500px] w-full\" />\n        </div>\n      ) : !chatwootConfigured ? (\n        <NotConfiguredState />\n      ) : !deptInbox?.inbox && !isManagement ? (\n        <NoInboxState departmentName={teamMember?.departmentName} />\n      ) : (\n        <div className=\"space-y-4\">\n          {/* Statistics Cards */}\n          {statsLoading ? (\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n              {[1, 2, 3, 4].map((i) => (\n                <Skeleton key={i} className=\"h-20 w-full rounded-lg\" />\n              ))}\n            </div>\n          ) : statsError ? (\n            <div className=\"p-4 rounded-lg border bg-muted/50 text-center\">\n              <p className=\"text-sm text-muted-foreground\">\n                Unable to load conversation statistics. <Button variant=\"ghost\" className=\"p-0 h-auto underline\" onClick={() => refetchStats()}>Retry</Button>\n              </p>\n            </div>\n          ) : stats?.available ? (\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n              <StatCard \n                title=\"Open\" \n                value={stats.open} \n                icon={MessageCircle}\n                color=\"bg-blue-50 dark:bg-blue-950 border-blue-200 dark:border-blue-800\"\n              />\n              <StatCard \n                title=\"Pending\" \n                value={stats.pending} \n                icon={Clock}\n                color=\"bg-yellow-50 dark:bg-yellow-950 border-yellow-200 dark:border-yellow-800\"\n              />\n              <StatCard \n                title=\"Resolved\" \n                value={stats.resolved} \n                icon={CheckCircle2}\n                color=\"bg-green-50 dark:bg-green-950 border-green-200 dark:border-green-800\"\n              />\n              <StatCard \n                title=\"Total Active\" \n                value={stats.open + stats.pending} \n                icon={MessageSquare}\n                color=\"bg-purple-50 dark:bg-purple-950 border-purple-200 dark:border-purple-800\"\n              />\n            </div>\n          ) : (\n            <div className=\"p-4 rounded-lg border bg-muted/50 text-center\">\n              <p className=\"text-sm text-muted-foreground\">\n                Statistics not available - connect to Chatwoot to see conversation counts\n              </p>\n            </div>\n          )}\n\n          {isManagement && (\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-center justify-between gap-2 flex-wrap\">\n                  <div className=\"flex items-center gap-2\">\n                    <MessageSquare className=\"h-5 w-5 text-primary\" />\n                    <CardTitle className=\"text-lg\">All Conversations</CardTitle>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Badge variant=\"secondary\">Management View</Badge>\n                  </div>\n                </div>\n                <CardDescription>\n                  As a manager, you have access to all department conversations\n                </CardDescription>\n              </CardHeader>\n            </Card>\n          )}\n\n          <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-4\">\n            {/* Main Inbox Area */}\n            <div className=\"lg:col-span-3\">\n              {embedInfo?.embedUrl ? (\n                <ChatwootEmbed \n                  key={iframeKey}\n                  embedUrl={isManagement ? embedInfo.embedUrl : (deptInbox?.embedUrl || embedInfo.embedUrl)} \n                  title=\"Chatwoot Inbox\"\n                />\n              ) : (\n                <Card>\n                  <CardContent className=\"pt-6\">\n                    <div className=\"flex items-center gap-3 p-4 rounded-md bg-yellow-50 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-200\">\n                      <AlertCircle className=\"h-5 w-5 flex-shrink-0\" />\n                      <div>\n                        <p className=\"font-medium\">Unable to load Chatwoot</p>\n                        <p className=\"text-sm opacity-80\">\n                          There was an issue loading the Chatwoot inbox. Please try refreshing the page or contact an administrator.\n                        </p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n            </div>\n\n            {/* Quick Replies Sidebar */}\n            <div className=\"lg:col-span-1\">\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-base flex items-center gap-2\">\n                    <Zap className=\"h-4 w-4\" />\n                    Quick Tools\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <QuickReplies onCopy={handleQuickReplyCopy} />\n                </CardContent>\n              </Card>\n            </div>\n          </div>\n\n          <Card>\n            <CardContent className=\"pt-4\">\n              <div className=\"flex items-center justify-between gap-4 flex-wrap text-sm text-muted-foreground\">\n                <div className=\"flex items-center gap-4\">\n                  <span>Chatwoot Account: {embedInfo?.accountId}</span>\n                  {embedInfo?.agentId && <span>Agent ID: {embedInfo.agentId}</span>}\n                  {stats?.lastUpdated && (\n                    <span>Stats updated: {new Date(stats.lastUpdated).toLocaleTimeString()}</span>\n                  )}\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  {embedInfo?.ssoEnabled ? (\n                    <Badge variant=\"default\" className=\"bg-green-600\">SSO Enabled</Badge>\n                  ) : (\n                    <Badge variant=\"secondary\">Manual Login Required</Badge>\n                  )}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":19208,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/components/theme-toggle.tsx":{"content":"import { Moon, Sun } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useEffect, useState } from \"react\";\n\nexport function ThemeToggle() {\n  const [theme, setTheme] = useState<\"light\" | \"dark\">(\"light\");\n\n  useEffect(() => {\n    const savedTheme = localStorage.getItem(\"theme\") as \"light\" | \"dark\" | null;\n    const initialTheme = savedTheme || \"light\";\n    setTheme(initialTheme);\n    document.documentElement.classList.toggle(\"dark\", initialTheme === \"dark\");\n  }, []);\n\n  const toggleTheme = () => {\n    const newTheme = theme === \"light\" ? \"dark\" : \"light\";\n    setTheme(newTheme);\n    localStorage.setItem(\"theme\", newTheme);\n    document.documentElement.classList.toggle(\"dark\", newTheme === \"dark\");\n  };\n\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"icon\"\n      onClick={toggleTheme}\n      data-testid=\"button-theme-toggle\"\n      aria-label=\"Toggle theme\"\n    >\n      {theme === \"light\" ? (\n        <Moon className=\"h-5 w-5\" />\n      ) : (\n        <Sun className=\"h-5 w-5\" />\n      )}\n    </Button>\n  );\n}\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"server/seed.ts":{"content":"import { db } from \"./db\";\nimport { \n  roles, \n  permissions, \n  rolePermissions, \n  departments, \n  teamMembers,\n  teams,\n  teamMemberTeams,\n  ROLE_TYPES,\n  PERMISSION_TYPES,\n  TEAM_TYPES\n} from \"@shared/schema\";\nimport bcrypt from \"bcryptjs\";\nimport { eq } from \"drizzle-orm\";\n\nasync function seed() {\n  console.log(\"Starting database seed...\");\n\n  try {\n    // Check if already seeded\n    const existingRoles = await db.select().from(roles);\n    if (existingRoles.length > 0) {\n      console.log(\"Database already seeded. Skipping...\");\n      return;\n    }\n\n    // 1. Create Roles\n    console.log(\"Creating roles...\");\n    const rolesData = [\n      { \n        name: \"Technician\", \n        code: ROLE_TYPES.TECHNICIAN, \n        description: \"Field technician with basic task access\", \n        level: 1 \n      },\n      { \n        name: \"Department Admin\", \n        code: ROLE_TYPES.DEPARTMENT_ADMIN, \n        description: \"Department administrator with user management within their department\", \n        level: 2 \n      },\n      { \n        name: \"Management\", \n        code: ROLE_TYPES.MANAGEMENT, \n        description: \"Full access to all departments and global user management\", \n        level: 3 \n      },\n    ];\n\n    const insertedRoles = await db.insert(roles).values(rolesData).returning();\n    console.log(`Created ${insertedRoles.length} roles`);\n\n    const roleMap = {\n      [ROLE_TYPES.TECHNICIAN]: insertedRoles.find(r => r.code === ROLE_TYPES.TECHNICIAN)!,\n      [ROLE_TYPES.DEPARTMENT_ADMIN]: insertedRoles.find(r => r.code === ROLE_TYPES.DEPARTMENT_ADMIN)!,\n      [ROLE_TYPES.MANAGEMENT]: insertedRoles.find(r => r.code === ROLE_TYPES.MANAGEMENT)!,\n    };\n\n    // 2. Create Permissions\n    console.log(\"Creating permissions...\");\n    const permissionsData = [\n      { name: \"View Tasks\", code: PERMISSION_TYPES.VIEW_TASKS, description: \"View assigned tasks\", category: \"tasks\" },\n      { name: \"Create Task\", code: PERMISSION_TYPES.CREATE_TASK, description: \"Create new tasks\", category: \"tasks\" },\n      { name: \"Update Task\", code: PERMISSION_TYPES.UPDATE_TASK, description: \"Update task details and status\", category: \"tasks\" },\n      { name: \"Delete Task\", code: PERMISSION_TYPES.DELETE_TASK, description: \"Delete tasks\", category: \"tasks\" },\n      { name: \"Assign Task\", code: PERMISSION_TYPES.ASSIGN_TASK, description: \"Assign tasks to technicians\", category: \"tasks\" },\n      { name: \"View Own Department\", code: PERMISSION_TYPES.VIEW_OWN_DEPARTMENT, description: \"View own department data\", category: \"dashboard\" },\n      { name: \"View All Departments\", code: PERMISSION_TYPES.VIEW_ALL_DEPARTMENTS, description: \"View all departments data\", category: \"dashboard\" },\n      { name: \"View Department Dashboard\", code: PERMISSION_TYPES.VIEW_DEPARTMENT_DASHBOARD, description: \"View department dashboard\", category: \"dashboard\" },\n      { name: \"View Global Dashboard\", code: PERMISSION_TYPES.VIEW_GLOBAL_DASHBOARD, description: \"View global dashboard with all stats\", category: \"dashboard\" },\n      { name: \"Manage Department Users\", code: PERMISSION_TYPES.MANAGE_DEPARTMENT_USERS, description: \"Add/edit/deactivate users in own department\", category: \"users\" },\n      { name: \"Manage Global Users\", code: PERMISSION_TYPES.MANAGE_GLOBAL_USERS, description: \"Full user management across all departments\", category: \"users\" },\n      { name: \"View Department Logs\", code: PERMISSION_TYPES.VIEW_DEPARTMENT_LOGS, description: \"View activity logs for own department\", category: \"logs\" },\n      { name: \"View All Logs\", code: PERMISSION_TYPES.VIEW_ALL_LOGS, description: \"View all activity logs\", category: \"logs\" },\n      { name: \"Manage Service Config\", code: PERMISSION_TYPES.MANAGE_SERVICE_CONFIG, description: \"Configure external service integrations\", category: \"settings\" },\n      { name: \"View Analytics\", code: PERMISSION_TYPES.VIEW_ANALYTICS, description: \"View analytics and metrics\", category: \"analytics\" },\n      { name: \"Submit Worklog\", code: PERMISSION_TYPES.SUBMIT_WORKLOG, description: \"Submit work time and notes\", category: \"tasks\" },\n    ];\n\n    const insertedPermissions = await db.insert(permissions).values(permissionsData).returning();\n    console.log(`Created ${insertedPermissions.length} permissions`);\n\n    const permMap: Record<string, typeof insertedPermissions[0]> = {};\n    insertedPermissions.forEach(p => {\n      permMap[p.code] = p;\n    });\n\n    // 3. Create Role-Permission mappings\n    console.log(\"Mapping permissions to roles...\");\n    \n    // Technician permissions\n    const technicianPerms = [\n      PERMISSION_TYPES.VIEW_TASKS,\n      PERMISSION_TYPES.UPDATE_TASK,\n      PERMISSION_TYPES.VIEW_OWN_DEPARTMENT,\n      PERMISSION_TYPES.SUBMIT_WORKLOG,\n    ];\n\n    // Department Admin permissions (includes technician perms)\n    const deptAdminPerms = [\n      ...technicianPerms,\n      PERMISSION_TYPES.CREATE_TASK,\n      PERMISSION_TYPES.DELETE_TASK,\n      PERMISSION_TYPES.ASSIGN_TASK,\n      PERMISSION_TYPES.VIEW_DEPARTMENT_DASHBOARD,\n      PERMISSION_TYPES.MANAGE_DEPARTMENT_USERS,\n      PERMISSION_TYPES.VIEW_DEPARTMENT_LOGS,\n      PERMISSION_TYPES.VIEW_ANALYTICS,\n    ];\n\n    // Management permissions (all permissions)\n    const managementPerms = Object.values(PERMISSION_TYPES);\n\n    const rolePermissionsData = [\n      ...technicianPerms.map(perm => ({\n        roleId: roleMap[ROLE_TYPES.TECHNICIAN].id,\n        permissionId: permMap[perm].id,\n      })),\n      ...deptAdminPerms.map(perm => ({\n        roleId: roleMap[ROLE_TYPES.DEPARTMENT_ADMIN].id,\n        permissionId: permMap[perm].id,\n      })),\n      ...managementPerms.map(perm => ({\n        roleId: roleMap[ROLE_TYPES.MANAGEMENT].id,\n        permissionId: permMap[perm].id,\n      })),\n    ];\n\n    await db.insert(rolePermissions).values(rolePermissionsData);\n    console.log(`Created ${rolePermissionsData.length} role-permission mappings`);\n\n    // 4. Create Departments\n    console.log(\"Creating departments...\");\n    const departmentsData = [\n      { name: \"Home Appliances\", code: \"HA\", description: \"Home Appliances Division - Repairs and maintenance\", status: \"active\" as const },\n      { name: \"Home Entertainment Products\", code: \"HHP\", description: \"Home Entertainment Products - TVs, audio systems\", status: \"active\" as const },\n      { name: \"Digital Television\", code: \"DTV\", description: \"Digital Television Services - Installation and support\", status: \"active\" as const },\n    ];\n\n    const insertedDepts = await db.insert(departments).values(departmentsData).returning();\n    console.log(`Created ${insertedDepts.length} departments`);\n\n    const deptMap: Record<string, typeof insertedDepts[0]> = {};\n    insertedDepts.forEach(d => {\n      deptMap[d.code] = d;\n    });\n\n    // 5. Create Super Admin User (Management Role)\n    console.log(\"Creating super admin user...\");\n    const passwordHash = await bcrypt.hash(\"admin123\", 10);\n    \n    const adminUser = await db.insert(teamMembers).values({\n      departmentId: deptMap[\"HA\"].id,\n      roleId: roleMap[ROLE_TYPES.MANAGEMENT].id,\n      employeeId: \"ADMIN001\",\n      email: \"admin@company.com\",\n      firstName: \"System\",\n      lastName: \"Administrator\",\n      role: \"admin\",\n      passwordHash: passwordHash,\n      phone: \"\",\n      status: \"active\",\n      isVerified: true, // Super admin is always verified\n    }).returning();\n\n    console.log(\"Created super admin user: admin@company.com / admin123\");\n\n    // 6. Create Teams for Tiered Support Architecture\n    console.log(\"Creating teams for tiered support...\");\n    \n    // Create \"All Staff\" team - everyone auto-joins this\n    const allStaffTeam = await db.insert(teams).values({\n      name: \"All Staff\",\n      code: \"all_staff\",\n      description: \"Parent team - All staff members receive messages sent to main support email\",\n      teamType: TEAM_TYPES.ALL_STAFF,\n      emailAddress: \"support@allelectronics.co.za\",\n      isDefault: true, // New staff auto-join\n      status: \"active\",\n    }).returning();\n    console.log(\"Created 'All Staff' team\");\n\n    // Create department-specific teams\n    const departmentTeams = [];\n    for (const dept of insertedDepts) {\n      const teamCode = dept.code.toLowerCase() + \"_team\";\n      const deptTeam = await db.insert(teams).values({\n        name: `${dept.name} Team`,\n        code: teamCode,\n        description: `Team for ${dept.name} department - Only ${dept.name} staff see these messages`,\n        teamType: TEAM_TYPES.DEPARTMENT,\n        departmentId: dept.id,\n        emailAddress: `${dept.code.toLowerCase()}@allelectronics.co.za`,\n        isDefault: false,\n        status: \"active\",\n      }).returning();\n      departmentTeams.push(deptTeam[0]);\n      console.log(`Created '${dept.name} Team'`);\n    }\n\n    // 7. Add admin to all teams\n    console.log(\"Adding admin to all teams...\");\n    \n    // Add to All Staff team\n    await db.insert(teamMemberTeams).values({\n      teamMemberId: adminUser[0].id,\n      teamId: allStaffTeam[0].id,\n      isActive: true,\n    });\n\n    // Add admin to all department teams (management sees everything)\n    for (const deptTeam of departmentTeams) {\n      await db.insert(teamMemberTeams).values({\n        teamMemberId: adminUser[0].id,\n        teamId: deptTeam.id,\n        isActive: true,\n      });\n    }\n    console.log(\"Admin added to all teams\");\n\n    console.log(\"\\n=== Seed Complete ===\");\n    console.log(\"\\nSuper Admin Account (password: admin123):\");\n    console.log(\"Email: admin@company.com\");\n    console.log(\"\\nTeams Created:\");\n    console.log(\"- All Staff (everyone auto-joins - for support@ emails)\");\n    console.log(\"- Home Appliances Team (HA department)\");\n    console.log(\"- Home Entertainment Products Team (HHP department)\");\n    console.log(\"- Digital Television Team (DTV department)\");\n    console.log(\"\\nNo demo accounts created - users must sign up and await approval\");\n\n  } catch (error) {\n    console.error(\"Seed error:\", error);\n    throw error;\n  }\n}\n\nseed()\n  .then(() => {\n    console.log(\"Seed completed successfully\");\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error(\"Seed failed:\", error);\n    process.exit(1);\n  });\n","path":null,"size_bytes":10106,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"add_docker_group.sh":{"content":"#!/bin/bash\nusermod -aG docker adminhub\necho \"SUCCESS: adminhub added to docker group\"\n","path":null,"size_bytes":87,"size_tokens":null},"server/auth.ts":{"content":"// Environment-based auth router: picks the right auth implementation\n// Exports: setupAuth(app), isAuthenticated, isTeamMemberAuthenticated, getSession\n// Use dynamic import with top-level await so this module works under ESM\nasync function loadAuthModule() {\n  try {\n    if (process.env.STANDALONE_ID || process.env.ISSUER_URL) {\n      const mod = await import(\"./standaloneAuth\");\n      return (mod as any).default || mod;\n    }\n\n    if (process.env.REPL_ID || process.env.REPLIT_DEV_DOMAIN) {\n      const mod = await import(\"./replitAuth\");\n      return (mod as any).default || mod;\n    }\n\n    if (process.env.NODE_ENV === \"development\") {\n      const mod = await import(\"./devAuth\");\n      return (mod as any).default || mod;\n    }\n\n    // Fallback order\n    try {\n      const mod = await import(\"./replitAuth\");\n      return (mod as any).default || mod;\n    } catch (e) {\n      try {\n        const mod = await import(\"./standaloneAuth\");\n        return (mod as any).default || mod;\n      } catch (e2) {\n        const mod = await import(\"./devAuth\");\n        return (mod as any).default || mod;\n      }\n    }\n  } catch (err) {\n    const mod = await import(\"./devAuth\");\n    return (mod as any).default || mod;\n  }\n}\n\nconst auth = await loadAuthModule();\n\nexport const setupAuth = (auth && (auth.setupAuth || auth.default?.setupAuth || auth.setupAuth)) || ((app: any) => {});\nexport const isAuthenticated = (auth && (auth.isAuthenticated || auth.default?.isAuthenticated)) || ((req: any, res: any, next: any) => next());\nexport const isTeamMemberAuthenticated = (auth && (auth.isTeamMemberAuthenticated || auth.default?.isTeamMemberAuthenticated || auth.isAuthenticated)) || ((req: any, res: any, next: any) => next());\nexport const getSession = (auth && (auth.getSession || auth.default?.getSession)) || (() => { throw new Error('getSession not available in selected auth module'); });\n\nexport default auth;\n","path":null,"size_bytes":1913,"size_tokens":null},"server/storage.ts":{"content":"/**\n * @fileoverview Storage layer - Database operations using Drizzle ORM\n * Copyright (c) 2025 DevPulse.Inc\n * Designed for MM ALL ELECTRONICS\n *\n * Description: Database access helpers and queries used across the server.\n */\n// Storage layer - Database operations using Drizzle ORM\nimport {\n  users,\n  departments,\n  teamMembers,\n  teams,\n  teamMemberTeams,\n  serviceConfigs,\n  managedUsers,\n  activityLogs,\n  analyticsMetrics,\n  roles,\n  permissions,\n  rolePermissions,\n  tasks,\n  taskAssignments,\n  taskHistory,\n  worklogs,\n  pendingRegistrations,\n  approvalOtps,\n  adminNotifications,\n  type User,\n  type UpsertUser,\n  type Department,\n  type InsertDepartment,\n  type TeamMember,\n  type InsertTeamMember,\n  type Team,\n  type InsertTeam,\n  type TeamMemberTeam,\n  type ServiceConfig,\n  type InsertServiceConfig,\n  type ManagedUser,\n  type InsertManagedUser,\n  type ActivityLog,\n  type AnalyticsMetric,\n  type Role,\n  type InsertRole,\n  type Permission,\n  type Task,\n  type InsertTask,\n  type TaskAssignment,\n  type TaskHistory,\n  type Worklog,\n  type InsertWorklog,\n  type PendingRegistration,\n  type InsertPendingRegistration,\n  type ApprovalOtp,\n  type AdminNotification,\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, desc, sql, and, gte, or, inArray, lte } from \"drizzle-orm\";\n\nexport interface IStorage {\n  // User operations (required for Replit Auth)\n  getUser(id: string): Promise<User | undefined>;\n  upsertUser(user: UpsertUser): Promise<User>;\n\n  // Role operations\n  getAllRoles(): Promise<Role[]>;\n  getRole(id: string): Promise<Role | undefined>;\n  getRoleByCode(code: string): Promise<Role | undefined>;\n\n  // Permission operations\n  getAllPermissions(): Promise<Permission[]>;\n  getPermissionsByRole(roleId: string): Promise<Permission[]>;\n\n  // Department operations\n  getAllDepartments(): Promise<Department[]>;\n  getDepartment(id: string): Promise<Department | undefined>;\n  getDepartmentByCode(code: string): Promise<Department | undefined>;\n  createDepartment(department: InsertDepartment): Promise<Department>;\n  updateDepartment(id: string, department: Partial<InsertDepartment>): Promise<Department>;\n  deleteDepartment(id: string): Promise<void>;\n\n  // Team Member operations\n  getAllTeamMembers(): Promise<TeamMember[]>;\n  getTeamMembersByDepartment(departmentId: string): Promise<TeamMember[]>;\n  getTeamMember(id: string): Promise<TeamMember | undefined>;\n  getTeamMemberByEmail(email: string): Promise<TeamMember | undefined>;\n  createTeamMember(member: InsertTeamMember): Promise<TeamMember>;\n  updateTeamMember(id: string, member: Partial<InsertTeamMember>): Promise<TeamMember>;\n  deleteTeamMember(id: string): Promise<void>;\n\n  // Task operations\n  getAllTasks(): Promise<Task[]>;\n  getTasksByDepartment(departmentId: string): Promise<Task[]>;\n  getTasksByAssignee(teamMemberId: string): Promise<Task[]>;\n  getTask(id: string): Promise<Task | undefined>;\n  createTask(task: InsertTask): Promise<Task>;\n  updateTask(id: string, task: Partial<InsertTask>): Promise<Task>;\n  deleteTask(id: string): Promise<void>;\n\n  // Task assignment operations\n  getTaskAssignments(taskId: string): Promise<TaskAssignment[]>;\n  assignTask(taskId: string, teamMemberId: string, assignedById: string): Promise<TaskAssignment>;\n  unassignTask(assignmentId: string): Promise<void>;\n\n  // Task history operations\n  createTaskHistory(taskId: string, changedById: string, action: string, previousValue?: any, newValue?: any, notes?: string): Promise<TaskHistory>;\n  getTaskHistory(taskId: string): Promise<TaskHistory[]>;\n\n  // Worklog operations\n  createWorklog(worklog: InsertWorklog): Promise<Worklog>;\n  getWorklogsByTask(taskId: string): Promise<Worklog[]>;\n  getWorklogsByTeamMember(teamMemberId: string): Promise<Worklog[]>;\n\n  // Service configuration operations\n  getAllServices(): Promise<ServiceConfig[]>;\n  getServiceByName(serviceName: string): Promise<ServiceConfig | undefined>;\n  createService(service: InsertServiceConfig): Promise<ServiceConfig>;\n  updateService(id: string, service: Partial<InsertServiceConfig>): Promise<ServiceConfig>;\n  deleteService(id: string): Promise<void>;\n\n  // Managed user operations\n  getAllManagedUsers(): Promise<ManagedUser[]>;\n  getManagedUser(id: string): Promise<ManagedUser | undefined>;\n  createManagedUser(user: InsertManagedUser): Promise<ManagedUser>;\n  updateManagedUser(id: string, user: Partial<InsertManagedUser>): Promise<ManagedUser>;\n  deleteManagedUser(id: string): Promise<void>;\n\n  // Activity log operations\n  createActivityLog(\n    adminId: string,\n    action: string,\n    targetType?: string,\n    targetId?: string,\n    platform?: string,\n    details?: any\n  ): Promise<ActivityLog>;\n  getActivityLogs(limit?: number): Promise<ActivityLog[]>;\n  getRecentActivityLogs(): Promise<ActivityLog[]>;\n\n  // Analytics operations\n  getAnalyticsMetrics(): Promise<any>;\n  getStats(): Promise<{\n    totalUsers: number;\n    activeUsers: number;\n    totalActivities: number;\n    servicesEnabled: number;\n  }>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // User operations (required for Replit Auth)\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    const [user] = await db\n      .insert(users)\n      .values(userData)\n      .onConflictDoUpdate({\n        target: users.id,\n        set: {\n          ...userData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return user;\n  }\n\n  // Role operations\n  async getAllRoles(): Promise<Role[]> {\n    return await db.select().from(roles).orderBy(roles.level);\n  }\n\n  async getRole(id: string): Promise<Role | undefined> {\n    const [role] = await db.select().from(roles).where(eq(roles.id, id));\n    return role;\n  }\n\n  async getRoleByCode(code: string): Promise<Role | undefined> {\n    const [role] = await db.select().from(roles).where(eq(roles.code, code));\n    return role;\n  }\n\n  // Permission operations\n  async getAllPermissions(): Promise<Permission[]> {\n    return await db.select().from(permissions).orderBy(permissions.category, permissions.name);\n  }\n\n  async getPermissionsByRole(roleId: string): Promise<Permission[]> {\n    return await db\n      .select({\n        id: permissions.id,\n        name: permissions.name,\n        code: permissions.code,\n        description: permissions.description,\n        category: permissions.category,\n        createdAt: permissions.createdAt,\n      })\n      .from(rolePermissions)\n      .innerJoin(permissions, eq(rolePermissions.permissionId, permissions.id))\n      .where(eq(rolePermissions.roleId, roleId));\n  }\n\n  // Department operations\n  async getAllDepartments(): Promise<Department[]> {\n    return await db.select().from(departments).orderBy(departments.name);\n  }\n\n  async getDepartment(id: string): Promise<Department | undefined> {\n    const [dept] = await db.select().from(departments).where(eq(departments.id, id));\n    return dept;\n  }\n\n  async getDepartmentByCode(code: string): Promise<Department | undefined> {\n    const [dept] = await db.select().from(departments).where(eq(departments.code, code));\n    return dept;\n  }\n\n  async createDepartment(department: InsertDepartment): Promise<Department> {\n    const [created] = await db.insert(departments).values(department).returning();\n    return created;\n  }\n\n  async updateDepartment(id: string, department: Partial<InsertDepartment>): Promise<Department> {\n    const [updated] = await db\n      .update(departments)\n      .set({ ...department, updatedAt: new Date() })\n      .where(eq(departments.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteDepartment(id: string): Promise<void> {\n    await db.delete(departments).where(eq(departments.id, id));\n  }\n\n  // Team Member operations\n  async getAllTeamMembers(): Promise<TeamMember[]> {\n    return await db.select().from(teamMembers).orderBy(desc(teamMembers.createdAt));\n  }\n\n  async getTeamMembersByDepartment(departmentId: string): Promise<TeamMember[]> {\n    return await db\n      .select()\n      .from(teamMembers)\n      .where(eq(teamMembers.departmentId, departmentId))\n      .orderBy(teamMembers.lastName);\n  }\n\n  async getTeamMember(id: string): Promise<TeamMember | undefined> {\n    const [member] = await db.select().from(teamMembers).where(eq(teamMembers.id, id));\n    return member;\n  }\n\n  async getTeamMemberByEmail(email: string): Promise<TeamMember | undefined> {\n    const [member] = await db.select().from(teamMembers).where(eq(teamMembers.email, email));\n    return member;\n  }\n\n  async createTeamMember(member: InsertTeamMember): Promise<TeamMember> {\n    const [created] = await db.insert(teamMembers).values(member).returning();\n    return created;\n  }\n\n  async updateTeamMember(id: string, member: Partial<InsertTeamMember>): Promise<TeamMember> {\n    const [updated] = await db\n      .update(teamMembers)\n      .set({ ...member, updatedAt: new Date() })\n      .where(eq(teamMembers.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteTeamMember(id: string): Promise<void> {\n    await db.delete(teamMembers).where(eq(teamMembers.id, id));\n  }\n\n  // Service configuration operations\n  async getAllServices(): Promise<ServiceConfig[]> {\n    return await db.select().from(serviceConfigs).orderBy(serviceConfigs.serviceName);\n  }\n\n  async getServiceByName(serviceName: string): Promise<ServiceConfig | undefined> {\n    const [service] = await db\n      .select()\n      .from(serviceConfigs)\n      .where(eq(serviceConfigs.serviceName, serviceName));\n    return service;\n  }\n\n  async createService(service: InsertServiceConfig): Promise<ServiceConfig> {\n    const [created] = await db.insert(serviceConfigs).values(service).returning();\n    return created;\n  }\n\n  async updateService(id: string, service: Partial<InsertServiceConfig>): Promise<ServiceConfig> {\n    const [updated] = await db\n      .update(serviceConfigs)\n      .set({ ...service, updatedAt: new Date() })\n      .where(eq(serviceConfigs.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteService(id: string): Promise<void> {\n    await db.delete(serviceConfigs).where(eq(serviceConfigs.id, id));\n  }\n\n  // Managed user operations\n  async getAllManagedUsers(): Promise<ManagedUser[]> {\n    return await db.select().from(managedUsers).orderBy(desc(managedUsers.createdAt));\n  }\n\n  async getManagedUser(id: string): Promise<ManagedUser | undefined> {\n    const [user] = await db.select().from(managedUsers).where(eq(managedUsers.id, id));\n    return user;\n  }\n\n  async createManagedUser(user: InsertManagedUser): Promise<ManagedUser> {\n    const [created] = await db.insert(managedUsers).values(user).returning();\n    return created;\n  }\n\n  async getManagedUserByTeamMemberId(teamMemberId: string): Promise<ManagedUser | undefined> {\n    const [user] = await db.select().from(managedUsers).where(eq(managedUsers.teamMemberId, teamMemberId));\n    return user;\n  }\n\n  async upsertManagedUserForTeamMember(teamMemberId: string, payload: Partial<InsertManagedUser>): Promise<ManagedUser> {\n    const existing = await this.getManagedUserByTeamMemberId(teamMemberId);\n    if (existing) {\n      const updated = await this.updateManagedUser(existing.id, { ...payload });\n      return updated;\n    }\n    const created = await this.createManagedUser({\n      email: (payload as any).email || '',\n      fullName: (payload as any).fullName || '',\n      platforms: (payload as any).platforms || [],\n      platformUserIds: (payload as any).platformUserIds || {},\n      roles: (payload as any).roles || {},\n      status: (payload as any).status || 'active',\n      teamMemberId,\n    } as InsertManagedUser);\n    return created;\n  }\n\n  async updateManagedUser(id: string, user: Partial<InsertManagedUser>): Promise<ManagedUser> {\n    const [updated] = await db\n      .update(managedUsers)\n      .set({ ...user, updatedAt: new Date() })\n      .where(eq(managedUsers.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteManagedUser(id: string): Promise<void> {\n    await db.delete(managedUsers).where(eq(managedUsers.id, id));\n  }\n\n  // Activity log operations\n  async createActivityLog(\n    adminId: string,\n    action: string,\n    targetType?: string,\n    targetId?: string,\n    platform?: string,\n    details?: any\n  ): Promise<ActivityLog> {\n    const [log] = await db\n      .insert(activityLogs)\n      .values({\n        adminId,\n        action,\n        targetType,\n        targetId,\n        platform,\n        details,\n      })\n      .returning();\n    return log;\n  }\n\n  async getActivityLogs(limit: number = 100): Promise<ActivityLog[]> {\n    return await db\n      .select()\n      .from(activityLogs)\n      .orderBy(desc(activityLogs.createdAt))\n      .limit(limit);\n  }\n\n  async getRecentActivityLogs(): Promise<ActivityLog[]> {\n    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);\n    return await db\n      .select()\n      .from(activityLogs)\n      .where(gte(activityLogs.createdAt, oneDayAgo))\n      .orderBy(desc(activityLogs.createdAt))\n      .limit(10);\n  }\n\n  // Analytics operations\n  async getAnalyticsMetrics(): Promise<any> {\n    const usersByPlatform = await db\n      .select({\n        platforms: managedUsers.platforms,\n        total: sql<number>`count(*)::int`,\n        active: sql<number>`count(*) filter (where ${managedUsers.status} = 'active')::int`,\n      })\n      .from(managedUsers)\n      .groupBy(managedUsers.platforms);\n\n    const metrics: any = {\n      metabase: { users: 0, active: 0 },\n      chatwoot: { users: 0, active: 0 },\n      typebot: { users: 0, active: 0 },\n      mailcow: { users: 0, active: 0 },\n    };\n\n    usersByPlatform.forEach((row) => {\n      if (row.platforms && Array.isArray(row.platforms)) {\n        row.platforms.forEach((platform) => {\n          if (metrics[platform]) {\n            metrics[platform].users += row.total;\n            metrics[platform].active += row.active;\n          }\n        });\n      }\n    });\n\n    return metrics;\n  }\n\n  async getStats(): Promise<{\n    totalUsers: number;\n    activeUsers: number;\n    totalActivities: number;\n    servicesEnabled: number;\n  }> {\n    const [userStats] = await db\n      .select({\n        total: sql<number>`count(*)::int`,\n        active: sql<number>`count(*) filter (where ${managedUsers.status} = 'active')::int`,\n      })\n      .from(managedUsers);\n\n    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);\n    const [activityStats] = await db\n      .select({\n        count: sql<number>`count(*)::int`,\n      })\n      .from(activityLogs)\n      .where(gte(activityLogs.createdAt, oneDayAgo));\n\n    const [serviceStats] = await db\n      .select({\n        enabled: sql<number>`count(*) filter (where ${serviceConfigs.enabled} = true)::int`,\n      })\n      .from(serviceConfigs);\n\n    return {\n      totalUsers: userStats?.total || 0,\n      activeUsers: userStats?.active || 0,\n      totalActivities: activityStats?.count || 0,\n      servicesEnabled: serviceStats?.enabled || 0,\n    };\n  }\n\n  // Task operations\n  async getAllTasks(): Promise<Task[]> {\n    return await db.select().from(tasks).orderBy(desc(tasks.createdAt));\n  }\n\n  async getTasksByDepartment(departmentId: string): Promise<Task[]> {\n    return await db\n      .select()\n      .from(tasks)\n      .where(eq(tasks.departmentId, departmentId))\n      .orderBy(desc(tasks.createdAt));\n  }\n\n  async getTasksByAssignee(teamMemberId: string): Promise<Task[]> {\n    return await db\n      .select()\n      .from(tasks)\n      .where(eq(tasks.assignedToId, teamMemberId))\n      .orderBy(desc(tasks.createdAt));\n  }\n\n  async getTask(id: string): Promise<Task | undefined> {\n    const [task] = await db.select().from(tasks).where(eq(tasks.id, id));\n    return task;\n  }\n\n  async createTask(task: InsertTask): Promise<Task> {\n    const [created] = await db.insert(tasks).values(task).returning();\n    return created;\n  }\n\n  async updateTask(id: string, task: Partial<InsertTask>): Promise<Task> {\n    const [updated] = await db\n      .update(tasks)\n      .set({ ...task, updatedAt: new Date() })\n      .where(eq(tasks.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteTask(id: string): Promise<void> {\n    await db.delete(tasks).where(eq(tasks.id, id));\n  }\n\n  // Task assignment operations\n  async getTaskAssignments(taskId: string): Promise<TaskAssignment[]> {\n    return await db\n      .select()\n      .from(taskAssignments)\n      .where(and(eq(taskAssignments.taskId, taskId), eq(taskAssignments.isActive, true)));\n  }\n\n  async assignTask(taskId: string, teamMemberId: string, assignedById: string): Promise<TaskAssignment> {\n    const [assignment] = await db\n      .insert(taskAssignments)\n      .values({\n        taskId,\n        teamMemberId,\n        assignedById,\n        isActive: true,\n      })\n      .returning();\n    return assignment;\n  }\n\n  async unassignTask(assignmentId: string): Promise<void> {\n    await db\n      .update(taskAssignments)\n      .set({ isActive: false, unassignedAt: new Date() })\n      .where(eq(taskAssignments.id, assignmentId));\n  }\n\n  // Task history operations\n  async createTaskHistory(\n    taskId: string,\n    changedById: string,\n    action: string,\n    previousValue?: any,\n    newValue?: any,\n    notes?: string\n  ): Promise<TaskHistory> {\n    const [history] = await db\n      .insert(taskHistory)\n      .values({\n        taskId,\n        changedById,\n        action,\n        previousValue,\n        newValue,\n        notes,\n      })\n      .returning();\n    return history;\n  }\n\n  async getTaskHistory(taskId: string): Promise<TaskHistory[]> {\n    return await db\n      .select()\n      .from(taskHistory)\n      .where(eq(taskHistory.taskId, taskId))\n      .orderBy(desc(taskHistory.createdAt));\n  }\n\n  // Worklog operations\n  async createWorklog(worklog: InsertWorklog): Promise<Worklog> {\n    const [created] = await db.insert(worklogs).values(worklog).returning();\n    return created;\n  }\n\n  async getWorklogsByTask(taskId: string): Promise<Worklog[]> {\n    return await db\n      .select()\n      .from(worklogs)\n      .where(eq(worklogs.taskId, taskId))\n      .orderBy(desc(worklogs.createdAt));\n  }\n\n  async getWorklogsByTeamMember(teamMemberId: string): Promise<Worklog[]> {\n    return await db\n      .select()\n      .from(worklogs)\n      .where(eq(worklogs.teamMemberId, teamMemberId))\n      .orderBy(desc(worklogs.createdAt));\n  }\n\n  // Pending Registration operations\n  async createPendingRegistration(registration: InsertPendingRegistration): Promise<PendingRegistration> {\n    const [created] = await db.insert(pendingRegistrations).values(registration).returning();\n    return created;\n  }\n\n  async getPendingRegistration(id: string): Promise<PendingRegistration | undefined> {\n    const [registration] = await db.select().from(pendingRegistrations).where(eq(pendingRegistrations.id, id));\n    return registration;\n  }\n\n  async getPendingRegistrationByEmail(email: string): Promise<PendingRegistration | undefined> {\n    const [registration] = await db.select().from(pendingRegistrations).where(eq(pendingRegistrations.email, email));\n    return registration;\n  }\n\n  async getAllPendingRegistrations(status?: string): Promise<PendingRegistration[]> {\n    if (status) {\n      return await db\n        .select()\n        .from(pendingRegistrations)\n        .where(eq(pendingRegistrations.status, status))\n        .orderBy(desc(pendingRegistrations.createdAt));\n    }\n    return await db.select().from(pendingRegistrations).orderBy(desc(pendingRegistrations.createdAt));\n  }\n\n  async updatePendingRegistration(id: string, data: Partial<PendingRegistration>): Promise<PendingRegistration> {\n    const [updated] = await db\n      .update(pendingRegistrations)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(pendingRegistrations.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deletePendingRegistration(id: string): Promise<void> {\n    await db.delete(pendingRegistrations).where(eq(pendingRegistrations.id, id));\n  }\n\n  // Approval OTP operations\n  async createApprovalOtp(registrationId: string, otpCode: string, expiresAt: Date): Promise<ApprovalOtp> {\n    const [created] = await db\n      .insert(approvalOtps)\n      .values({\n        registrationId,\n        otpCode,\n        expiresAt,\n      })\n      .returning();\n    return created;\n  }\n\n  async getValidApprovalOtp(registrationId: string, otpCode: string): Promise<ApprovalOtp | undefined> {\n    const [otp] = await db\n      .select()\n      .from(approvalOtps)\n      .where(\n        and(\n          eq(approvalOtps.registrationId, registrationId),\n          eq(approvalOtps.otpCode, otpCode),\n          eq(approvalOtps.isUsed, false),\n          gte(approvalOtps.expiresAt, new Date())\n        )\n      );\n    return otp;\n  }\n\n  async getLatestOtpForRegistration(registrationId: string): Promise<ApprovalOtp | undefined> {\n    const [otp] = await db\n      .select()\n      .from(approvalOtps)\n      .where(eq(approvalOtps.registrationId, registrationId))\n      .orderBy(desc(approvalOtps.createdAt))\n      .limit(1);\n    return otp;\n  }\n\n  async getAllApprovalOtps(registrationId: string): Promise<ApprovalOtp[]> {\n    return await db\n      .select()\n      .from(approvalOtps)\n      .where(eq(approvalOtps.registrationId, registrationId));\n  }\n\n  async markOtpAsUsed(otpId: string, usedById: string): Promise<void> {\n    await db\n      .update(approvalOtps)\n      .set({ isUsed: true, usedAt: new Date(), usedById })\n      .where(eq(approvalOtps.id, otpId));\n  }\n\n  async invalidateExpiredOtps(): Promise<void> {\n    await db\n      .update(approvalOtps)\n      .set({ isUsed: true })\n      .where(and(eq(approvalOtps.isUsed, false), lte(approvalOtps.expiresAt, new Date())));\n  }\n\n  // Admin Notification operations\n  async createAdminNotification(\n    type: string,\n    title: string,\n    message: string,\n    targetRoleLevel: number = 3,\n    relatedEntityType?: string,\n    relatedEntityId?: string,\n    metadata?: any\n  ): Promise<AdminNotification> {\n    const [notification] = await db\n      .insert(adminNotifications)\n      .values({\n        type,\n        title,\n        message,\n        targetRoleLevel,\n        relatedEntityType,\n        relatedEntityId,\n        metadata,\n      })\n      .returning();\n    return notification;\n  }\n\n  async getUnreadNotifications(roleLevel: number): Promise<AdminNotification[]> {\n    return await db\n      .select()\n      .from(adminNotifications)\n      .where(and(eq(adminNotifications.isRead, false), lte(adminNotifications.targetRoleLevel, roleLevel)))\n      .orderBy(desc(adminNotifications.createdAt));\n  }\n\n  async getAllNotifications(roleLevel: number, limit: number = 50): Promise<AdminNotification[]> {\n    return await db\n      .select()\n      .from(adminNotifications)\n      .where(lte(adminNotifications.targetRoleLevel, roleLevel))\n      .orderBy(desc(adminNotifications.createdAt))\n      .limit(limit);\n  }\n\n  async markNotificationAsRead(id: string, readById: string): Promise<void> {\n    await db\n      .update(adminNotifications)\n      .set({ isRead: true, readAt: new Date(), readById })\n      .where(eq(adminNotifications.id, id));\n  }\n\n  async markAllNotificationsAsRead(readById: string, roleLevel: number): Promise<void> {\n    await db\n      .update(adminNotifications)\n      .set({ isRead: true, readAt: new Date(), readById })\n      .where(and(eq(adminNotifications.isRead, false), lte(adminNotifications.targetRoleLevel, roleLevel)));\n  }\n\n  async getPendingRegistrationCount(): Promise<number> {\n    const [result] = await db\n      .select({ count: sql<number>`count(*)::int` })\n      .from(pendingRegistrations)\n      .where(eq(pendingRegistrations.status, 'pending'));\n    return result?.count || 0;\n  }\n\n  // ============================================\n  // TEAM OPERATIONS - Tiered Support Architecture\n  // ============================================\n\n  // Get all teams\n  async getAllTeams(): Promise<Team[]> {\n    return await db.select().from(teams).orderBy(teams.name);\n  }\n\n  // Get team by ID\n  async getTeam(id: string): Promise<Team | undefined> {\n    const [team] = await db.select().from(teams).where(eq(teams.id, id));\n    return team;\n  }\n\n  // Get team by code\n  async getTeamByCode(code: string): Promise<Team | undefined> {\n    const [team] = await db.select().from(teams).where(eq(teams.code, code));\n    return team;\n  }\n\n  // Create a new team\n  async createTeam(team: InsertTeam): Promise<Team> {\n    const [created] = await db.insert(teams).values(team).returning();\n    return created;\n  }\n\n  // Update a team\n  async updateTeam(id: string, team: Partial<InsertTeam>): Promise<Team> {\n    const [updated] = await db\n      .update(teams)\n      .set({ ...team, updatedAt: new Date() })\n      .where(eq(teams.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Delete a team\n  async deleteTeam(id: string): Promise<void> {\n    await db.delete(teams).where(eq(teams.id, id));\n  }\n\n  // Get teams for a specific team member (many-to-many)\n  async getTeamsForMember(teamMemberId: string): Promise<Team[]> {\n    return await db\n      .select({\n        id: teams.id,\n        name: teams.name,\n        code: teams.code,\n        description: teams.description,\n        teamType: teams.teamType,\n        departmentId: teams.departmentId,\n        chatwootTeamId: teams.chatwootTeamId,\n        chatwootInboxId: teams.chatwootInboxId,\n        emailAddress: teams.emailAddress,\n        isDefault: teams.isDefault,\n        status: teams.status,\n        createdAt: teams.createdAt,\n        updatedAt: teams.updatedAt,\n      })\n      .from(teamMemberTeams)\n      .innerJoin(teams, eq(teamMemberTeams.teamId, teams.id))\n      .where(and(eq(teamMemberTeams.teamMemberId, teamMemberId), eq(teamMemberTeams.isActive, true)));\n  }\n\n  // Get team IDs for a member (for filtering messages)\n  async getTeamIdsForMember(teamMemberId: string): Promise<string[]> {\n    const memberTeams = await db\n      .select({ teamId: teamMemberTeams.teamId })\n      .from(teamMemberTeams)\n      .where(and(eq(teamMemberTeams.teamMemberId, teamMemberId), eq(teamMemberTeams.isActive, true)));\n    return memberTeams.map(t => t.teamId);\n  }\n\n  // Get team members for a specific team\n  async getMembersInTeam(teamId: string): Promise<TeamMember[]> {\n    return await db\n      .select({\n        id: teamMembers.id,\n        userId: teamMembers.userId,\n        departmentId: teamMembers.departmentId,\n        roleId: teamMembers.roleId,\n        employeeId: teamMembers.employeeId,\n        email: teamMembers.email,\n        firstName: teamMembers.firstName,\n        lastName: teamMembers.lastName,\n        role: teamMembers.role,\n        passwordHash: teamMembers.passwordHash,\n        phone: teamMembers.phone,\n        status: teamMembers.status,\n        isVerified: teamMembers.isVerified,\n        lastLoginAt: teamMembers.lastLoginAt,\n        addressLine1: teamMembers.addressLine1,\n        addressLine2: teamMembers.addressLine2,\n        city: teamMembers.city,\n        state: teamMembers.state,\n        postalCode: teamMembers.postalCode,\n        country: teamMembers.country,\n        nextOfKin1Name: teamMembers.nextOfKin1Name,\n        nextOfKin1Relationship: teamMembers.nextOfKin1Relationship,\n        nextOfKin1Phone: teamMembers.nextOfKin1Phone,\n        nextOfKin1Email: teamMembers.nextOfKin1Email,\n        nextOfKin1Address: teamMembers.nextOfKin1Address,\n        nextOfKin2Name: teamMembers.nextOfKin2Name,\n        nextOfKin2Relationship: teamMembers.nextOfKin2Relationship,\n        nextOfKin2Phone: teamMembers.nextOfKin2Phone,\n        nextOfKin2Email: teamMembers.nextOfKin2Email,\n        nextOfKin2Address: teamMembers.nextOfKin2Address,\n        createdAt: teamMembers.createdAt,\n        updatedAt: teamMembers.updatedAt,\n      })\n      .from(teamMemberTeams)\n      .innerJoin(teamMembers, eq(teamMemberTeams.teamMemberId, teamMembers.id))\n      .where(and(eq(teamMemberTeams.teamId, teamId), eq(teamMemberTeams.isActive, true)));\n  }\n\n  // Add a team member to a team (upsert to prevent duplicates)\n  async addMemberToTeam(teamMemberId: string, teamId: string, addedById?: string): Promise<TeamMemberTeam> {\n    // Check if membership exists (including inactive)\n    const [existing] = await db\n      .select()\n      .from(teamMemberTeams)\n      .where(and(eq(teamMemberTeams.teamMemberId, teamMemberId), eq(teamMemberTeams.teamId, teamId)));\n    \n    if (existing) {\n      // Reactivate if inactive\n      if (!existing.isActive) {\n        const [updated] = await db\n          .update(teamMemberTeams)\n          .set({ isActive: true, addedAt: new Date(), addedById })\n          .where(eq(teamMemberTeams.id, existing.id))\n          .returning();\n        return updated;\n      }\n      return existing;\n    }\n    \n    // Create new membership\n    const [membership] = await db\n      .insert(teamMemberTeams)\n      .values({\n        teamMemberId,\n        teamId,\n        addedById,\n        isActive: true,\n      })\n      .returning();\n    return membership;\n  }\n\n  // Remove a team member from a team (soft delete)\n  async removeMemberFromTeam(teamMemberId: string, teamId: string): Promise<void> {\n    await db\n      .update(teamMemberTeams)\n      .set({ isActive: false })\n      .where(and(eq(teamMemberTeams.teamMemberId, teamMemberId), eq(teamMemberTeams.teamId, teamId)));\n  }\n\n  // Check if member is in team\n  async isMemberInTeam(teamMemberId: string, teamId: string): Promise<boolean> {\n    const [result] = await db\n      .select({ id: teamMemberTeams.id })\n      .from(teamMemberTeams)\n      .where(\n        and(\n          eq(teamMemberTeams.teamMemberId, teamMemberId),\n          eq(teamMemberTeams.teamId, teamId),\n          eq(teamMemberTeams.isActive, true)\n        )\n      );\n    return !!result;\n  }\n\n  // Get default teams (teams that new members auto-join)\n  async getDefaultTeams(): Promise<Team[]> {\n    return await db.select().from(teams).where(eq(teams.isDefault, true));\n  }\n\n  // Auto-join new member to default teams\n  async autoJoinDefaultTeams(teamMemberId: string): Promise<void> {\n    const defaultTeams = await this.getDefaultTeams();\n    for (const team of defaultTeams) {\n      await this.addMemberToTeam(teamMemberId, team.id);\n    }\n  }\n\n  // Get teams by department (for department-specific routing)\n  async getTeamsByDepartment(departmentId: string): Promise<Team[]> {\n    return await db.select().from(teams).where(eq(teams.departmentId, departmentId));\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":30469,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":4050,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    host: \"0.0.0.0\",\n    port: 5000,\n    strictPort: true,\n    allowedHosts: true,\n    hmr: {\n      clientPort: 443,\n      protocol: \"wss\",\n    },\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":782,"size_tokens":null},"docs/replit-legacy/replit-local-state/agent/progress_tracker.md":{"content":"[x] 1. Install the required packages\n[x] 2. Restart the workflow to see if the project is working\n[x] 3. Verify the project is working using the feedback tool\n[x] 4. Inform user the import is completed and they can start building, mark the import as completed using the complete_project_import tool\n[x] 5. Create PostgreSQL database\n[x] 6. Push database schema (roles, permissions, departments, team_members tables)\n[x] 7. Verify login page and demo accounts working","path":null,"size_bytes":466,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"verify-admin.ts":{"content":"import 'dotenv/config';\nimport pkg from 'pg';\nconst { Pool } = pkg;\n\nconst pool = new Pool({ \n  connectionString: process.env.DATABASE_URL \n});\n\nasync function verifyAdminAccount() {\n  try {\n    console.log('Verifying admin account...');\n    \n    // Check current admin status\n    const checkResult = await pool.query(\n      `SELECT id, email, is_verified FROM \"team_members\" WHERE email = $1`,\n      ['admin@company.com']\n    );\n    \n    if (checkResult.rows.length === 0) {\n      console.log('❌ Admin account not found');\n      await pool.end();\n      return;\n    }\n    \n    const admin = checkResult.rows[0];\n    console.log(`Found admin: ${admin.email}`);\n    console.log(`Current is_verified: ${admin.is_verified}`);\n    \n    // Set admin as verified\n    const updateResult = await pool.query(\n      `UPDATE \"team_members\" SET is_verified = true WHERE email = $1 RETURNING *`,\n      ['admin@company.com']\n    );\n    \n    if (updateResult.rowCount > 0) {\n      console.log('✓ Admin account verified successfully!');\n      console.log(`✓ Email: ${updateResult.rows[0].email}`);\n      console.log(`✓ is_verified: ${updateResult.rows[0].is_verified}`);\n    } else {\n      console.log('❌ Failed to update admin account');\n    }\n    \n    await pool.end();\n  } catch (error: any) {\n    console.error('Error:', error.message);\n    await pool.end();\n    process.exit(1);\n  }\n}\n\nverifyAdminAccount();\n","path":null,"size_bytes":1406,"size_tokens":null},"server/routes-team-managed.ts":{"content":"import { Express } from 'express';\nimport { isAuthenticated } from './auth';\n\nexport default function registerTeamManagedRoutes(app: Express, storage: any) {\n  app.post('/api/team-members/:id/assign-platforms', isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params; // team member id\n      const { platforms, platformUserIds, roles } = req.body;\n\n      // validate team member exists\n      const member = await storage.getTeamMember(id);\n      if (!member) return res.status(404).json({ message: 'Team member not found' });\n\n      // upsert managed user linked to this team member\n      const managed = await storage.upsertManagedUserForTeamMember(id, {\n        platforms: Array.isArray(platforms) ? platforms : [],\n        platformUserIds: platformUserIds || {},\n        roles: roles || {},\n        email: member.email,\n        fullName: `${member.firstName} ${member.lastName}`,\n      });\n\n      await storage.createActivityLog(\n        req.user.claims.sub,\n        'assigned_platforms',\n        'team_member',\n        id,\n        Array.isArray(platforms) ? platforms.join(', ') : undefined,\n        { assignedTo: member.email, platforms }\n      );\n\n      res.json(managed);\n    } catch (error) {\n      console.error('Error assigning platforms to team member:', error);\n      res.status(500).json({ message: 'Failed to assign platforms' });\n    }\n  });\n\n  // Fetch managed user record for a given team member (if any)\n  app.get('/api/team-members/:id/managed-user', isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const member = await storage.getTeamMember(id);\n      if (!member) return res.status(404).json({ message: 'Team member not found' });\n\n      const managed = await storage.getManagedUserByTeamMemberId(id);\n      res.json(managed || null);\n    } catch (error) {\n      console.error('Error fetching managed user for team member:', error);\n      res.status(500).json({ message: 'Failed to fetch managed user' });\n    }\n  });\n}\n","path":null,"size_bytes":2016,"size_tokens":null},"run-migration.ts":{"content":"import pkg from 'pg';\nconst { Client } = pkg;\n\nconst connectionString = process.env.DATABASE_URL || 'postgresql://postgres:postgres@localhost:5432/postgres';\n\nconst migrations = [\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"address_line_1\" varchar(255)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"address_line_2\" varchar(255)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"city\" varchar(100)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"state\" varchar(100)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"postal_code\" varchar(20)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"country\" varchar(100)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_1_name\" varchar(100)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_1_relationship\" varchar(50)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_1_phone\" varchar(20)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_1_email\" varchar`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_1_address\" text`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_2_name\" varchar(100)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_2_relationship\" varchar(50)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_2_phone\" varchar(20)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_2_email\" varchar`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_2_address\" text`,\n];\n\nasync function runMigrations() {\n  const client = new Client({ connectionString });\n  try {\n    await client.connect();\n    console.log('Connected to database');\n    \n    for (const migration of migrations) {\n      console.log(`Running: ${migration.substring(0, 60)}...`);\n      await client.query(migration);\n      console.log(`✓ Done`);\n    }\n    console.log('\\n✅ All migrations completed successfully!');\n    process.exit(0);\n  } catch (error) {\n    console.error('❌ Migration failed:', error);\n    process.exit(1);\n  } finally {\n    await client.end();\n  }\n}\n\nrunMigrations();\n","path":null,"size_bytes":2169,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/pages/department-channels.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Accordion,\n  AccordionContent,\n  AccordionItem,\n  AccordionTrigger,\n} from \"@/components/ui/accordion\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { \n  Mail, \n  MessageSquare, \n  Phone, \n  Save, \n  Plus,\n  Trash2,\n  Building2,\n  Settings,\n  Link2\n} from \"lucide-react\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport type { Department } from \"@shared/schema\";\n\ninterface DepartmentEmailSettings {\n  id: string;\n  departmentId: string;\n  parentEmail: string;\n  imapHost?: string;\n  imapPort?: number;\n  imapUsername?: string;\n  imapPassword?: string;\n  imapUseSsl: boolean;\n  smtpHost?: string;\n  smtpPort?: number;\n  smtpUsername?: string;\n  smtpPassword?: string;\n  smtpUseTls: boolean;\n  enabled: boolean;\n}\n\ninterface ChatwootInbox {\n  id: string;\n  departmentId: string;\n  chatwootInboxId: number;\n  chatwootInboxName: string;\n  inboxType: string;\n  enabled: boolean;\n}\n\ninterface ChatwootTeam {\n  id: string;\n  departmentId: string;\n  chatwootTeamId: number;\n  chatwootTeamName: string;\n  autoAssign: boolean;\n}\n\nfunction DepartmentEmailForm({ department, existingSettings }: { \n  department: Department; \n  existingSettings?: DepartmentEmailSettings | null;\n}) {\n  const { toast } = useToast();\n  const [showAdvanced, setShowAdvanced] = useState(false);\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: Partial<DepartmentEmailSettings>) => {\n      return await apiRequest(\"/api/integrations/department-emails\", \"POST\", {\n        ...data,\n        departmentId: department.id,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/integrations/department-emails\"] });\n      toast({ title: \"Email settings saved\", description: `Updated settings for ${department.name}` });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        window.location.href = \"/api/login\";\n        return;\n      }\n      toast({ title: \"Error\", description: \"Failed to save email settings\", variant: \"destructive\" });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    const formData = new FormData(e.currentTarget);\n    saveMutation.mutate({\n      parentEmail: formData.get(\"parentEmail\") as string,\n      imapHost: formData.get(\"imapHost\") as string || undefined,\n      imapPort: formData.get(\"imapPort\") ? parseInt(formData.get(\"imapPort\") as string, 10) : undefined,\n      imapUsername: formData.get(\"imapUsername\") as string || undefined,\n      imapPassword: formData.get(\"imapPassword\") as string || undefined,\n      imapUseSsl: formData.get(\"imapUseSsl\") === \"on\",\n      smtpHost: formData.get(\"smtpHost\") as string || undefined,\n      smtpPort: formData.get(\"smtpPort\") ? parseInt(formData.get(\"smtpPort\") as string, 10) : undefined,\n      smtpUsername: formData.get(\"smtpUsername\") as string || undefined,\n      smtpPassword: formData.get(\"smtpPassword\") as string || undefined,\n      smtpUseTls: formData.get(\"smtpUseTls\") === \"on\",\n      enabled: formData.get(\"enabled\") === \"on\",\n    });\n  };\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      <div className=\"space-y-2\">\n        <Label htmlFor={`email-${department.id}`}>Department Email (Parent Email)</Label>\n        <Input\n          id={`email-${department.id}`}\n          name=\"parentEmail\"\n          type=\"email\"\n          placeholder={`support.${department.code?.toLowerCase()}@company.com`}\n          defaultValue={existingSettings?.parentEmail || \"\"}\n          required\n          data-testid={`input-dept-email-${department.id}`}\n        />\n        <p className=\"text-xs text-muted-foreground\">\n          Emails sent to this address will create tickets for this department\n        </p>\n      </div>\n\n      <div className=\"flex items-center gap-2\">\n        <Switch\n          id={`enabled-${department.id}`}\n          name=\"enabled\"\n          defaultChecked={existingSettings?.enabled ?? true}\n          data-testid={`switch-dept-enabled-${department.id}`}\n        />\n        <Label htmlFor={`enabled-${department.id}`}>Enable email integration</Label>\n      </div>\n\n      <Button\n        type=\"button\"\n        variant=\"ghost\"\n        size=\"sm\"\n        onClick={() => setShowAdvanced(!showAdvanced)}\n        className=\"text-muted-foreground\"\n      >\n        <Settings className=\"h-4 w-4 mr-2\" />\n        {showAdvanced ? \"Hide\" : \"Show\"} Advanced Settings (IMAP/SMTP)\n      </Button>\n\n      {showAdvanced && (\n        <div className=\"space-y-4 p-4 rounded-md bg-muted/50\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-4\">\n              <h4 className=\"font-medium text-sm\">IMAP Settings (Incoming)</h4>\n              <div className=\"space-y-2\">\n                <Label htmlFor={`imap-host-${department.id}`}>IMAP Host</Label>\n                <Input\n                  id={`imap-host-${department.id}`}\n                  name=\"imapHost\"\n                  placeholder=\"imap.mail.com\"\n                  defaultValue={existingSettings?.imapHost || \"\"}\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-2\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor={`imap-port-${department.id}`}>Port</Label>\n                  <Input\n                    id={`imap-port-${department.id}`}\n                    name=\"imapPort\"\n                    type=\"number\"\n                    placeholder=\"993\"\n                    defaultValue={existingSettings?.imapPort || 993}\n                  />\n                </div>\n                <div className=\"space-y-2 flex items-end gap-2 pb-2\">\n                  <Switch\n                    id={`imap-ssl-${department.id}`}\n                    name=\"imapUseSsl\"\n                    defaultChecked={existingSettings?.imapUseSsl ?? true}\n                  />\n                  <Label htmlFor={`imap-ssl-${department.id}`}>Use SSL</Label>\n                </div>\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor={`imap-user-${department.id}`}>Username</Label>\n                <Input\n                  id={`imap-user-${department.id}`}\n                  name=\"imapUsername\"\n                  defaultValue={existingSettings?.imapUsername || \"\"}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor={`imap-pass-${department.id}`}>Password</Label>\n                <Input\n                  id={`imap-pass-${department.id}`}\n                  name=\"imapPassword\"\n                  type=\"password\"\n                  placeholder=\"Enter password\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-4\">\n              <h4 className=\"font-medium text-sm\">SMTP Settings (Outgoing)</h4>\n              <div className=\"space-y-2\">\n                <Label htmlFor={`smtp-host-${department.id}`}>SMTP Host</Label>\n                <Input\n                  id={`smtp-host-${department.id}`}\n                  name=\"smtpHost\"\n                  placeholder=\"smtp.mail.com\"\n                  defaultValue={existingSettings?.smtpHost || \"\"}\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-2\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor={`smtp-port-${department.id}`}>Port</Label>\n                  <Input\n                    id={`smtp-port-${department.id}`}\n                    name=\"smtpPort\"\n                    type=\"number\"\n                    placeholder=\"587\"\n                    defaultValue={existingSettings?.smtpPort || 587}\n                  />\n                </div>\n                <div className=\"space-y-2 flex items-end gap-2 pb-2\">\n                  <Switch\n                    id={`smtp-tls-${department.id}`}\n                    name=\"smtpUseTls\"\n                    defaultChecked={existingSettings?.smtpUseTls ?? true}\n                  />\n                  <Label htmlFor={`smtp-tls-${department.id}`}>Use TLS</Label>\n                </div>\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor={`smtp-user-${department.id}`}>Username</Label>\n                <Input\n                  id={`smtp-user-${department.id}`}\n                  name=\"smtpUsername\"\n                  defaultValue={existingSettings?.smtpUsername || \"\"}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor={`smtp-pass-${department.id}`}>Password</Label>\n                <Input\n                  id={`smtp-pass-${department.id}`}\n                  name=\"smtpPassword\"\n                  type=\"password\"\n                  placeholder=\"Enter password\"\n                />\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      <Button type=\"submit\" disabled={saveMutation.isPending} data-testid={`button-save-dept-${department.id}`}>\n        <Save className=\"h-4 w-4 mr-2\" />\n        {saveMutation.isPending ? \"Saving...\" : \"Save Email Settings\"}\n      </Button>\n    </form>\n  );\n}\n\nfunction ChatwootMappingForm({ department }: { department: Department }) {\n  const { toast } = useToast();\n  const [dialogOpen, setDialogOpen] = useState(false);\n\n  const { data: inboxes = [] } = useQuery<ChatwootInbox[]>({\n    queryKey: [\"/api/integrations/chatwoot/inboxes\"],\n  });\n\n  const { data: teams = [] } = useQuery<ChatwootTeam[]>({\n    queryKey: [\"/api/integrations/chatwoot/teams\"],\n  });\n\n  const deptInboxes = inboxes.filter(i => i.departmentId === department.id);\n  const deptTeams = teams.filter(t => t.departmentId === department.id);\n\n  const createInboxMutation = useMutation({\n    mutationFn: async (data: Partial<ChatwootInbox>) => {\n      return await apiRequest(\"/api/integrations/chatwoot/inboxes\", \"POST\", {\n        ...data,\n        departmentId: department.id,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/integrations/chatwoot/inboxes\"] });\n      toast({ title: \"Inbox mapping created\" });\n      setDialogOpen(false);\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        window.location.href = \"/api/login\";\n        return;\n      }\n      toast({ title: \"Error\", description: \"Failed to create inbox mapping\", variant: \"destructive\" });\n    },\n  });\n\n  const createTeamMutation = useMutation({\n    mutationFn: async (data: Partial<ChatwootTeam>) => {\n      return await apiRequest(\"/api/integrations/chatwoot/teams\", \"POST\", {\n        ...data,\n        departmentId: department.id,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/integrations/chatwoot/teams\"] });\n      toast({ title: \"Team mapping created\" });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        window.location.href = \"/api/login\";\n        return;\n      }\n      toast({ title: \"Error\", description: \"Failed to create team mapping\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteInboxMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(`/api/integrations/chatwoot/inboxes/${id}`, \"DELETE\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/integrations/chatwoot/inboxes\"] });\n      toast({ title: \"Inbox mapping removed\" });\n    },\n  });\n\n  const deleteTeamMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(`/api/integrations/chatwoot/teams/${id}`, \"DELETE\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/integrations/chatwoot/teams\"] });\n      toast({ title: \"Team mapping removed\" });\n    },\n  });\n\n  const handleAddInbox = (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    const formData = new FormData(e.currentTarget);\n    createInboxMutation.mutate({\n      chatwootInboxId: parseInt(formData.get(\"chatwootInboxId\") as string, 10),\n      chatwootInboxName: formData.get(\"chatwootInboxName\") as string,\n      inboxType: formData.get(\"inboxType\") as string,\n      enabled: true,\n    });\n  };\n\n  const handleAddTeam = (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    const formData = new FormData(e.currentTarget);\n    createTeamMutation.mutate({\n      chatwootTeamId: parseInt(formData.get(\"chatwootTeamId\") as string, 10),\n      chatwootTeamName: formData.get(\"chatwootTeamName\") as string,\n      autoAssign: formData.get(\"autoAssign\") === \"on\",\n    });\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <h4 className=\"font-medium text-sm flex items-center gap-2\">\n            <MessageSquare className=\"h-4 w-4\" />\n            Chatwoot Inboxes\n          </h4>\n          <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n            <DialogTrigger asChild>\n              <Button size=\"sm\" variant=\"outline\">\n                <Plus className=\"h-4 w-4 mr-1\" />\n                Add Inbox\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Map Chatwoot Inbox</DialogTitle>\n                <DialogDescription>\n                  Link a Chatwoot inbox to {department.name}\n                </DialogDescription>\n              </DialogHeader>\n              <form onSubmit={handleAddInbox} className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"chatwootInboxId\">Chatwoot Inbox ID</Label>\n                  <Input\n                    id=\"chatwootInboxId\"\n                    name=\"chatwootInboxId\"\n                    type=\"number\"\n                    placeholder=\"e.g., 1\"\n                    required\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"chatwootInboxName\">Inbox Name</Label>\n                  <Input\n                    id=\"chatwootInboxName\"\n                    name=\"chatwootInboxName\"\n                    placeholder={`${department.name} Support`}\n                    required\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"inboxType\">Inbox Type</Label>\n                  <Select name=\"inboxType\" defaultValue=\"email\">\n                    <SelectTrigger>\n                      <SelectValue placeholder=\"Select type\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"email\">Email</SelectItem>\n                      <SelectItem value=\"whatsapp\">WhatsApp</SelectItem>\n                      <SelectItem value=\"web\">Web Chat</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                <DialogFooter>\n                  <Button type=\"submit\" disabled={createInboxMutation.isPending}>\n                    {createInboxMutation.isPending ? \"Adding...\" : \"Add Inbox\"}\n                  </Button>\n                </DialogFooter>\n              </form>\n            </DialogContent>\n          </Dialog>\n        </div>\n\n        {deptInboxes.length === 0 ? (\n          <p className=\"text-sm text-muted-foreground\">No inboxes mapped to this department</p>\n        ) : (\n          <div className=\"space-y-2\">\n            {deptInboxes.map((inbox) => (\n              <div key={inbox.id} className=\"flex items-center justify-between p-3 rounded-md bg-muted\">\n                <div className=\"flex items-center gap-3\">\n                  <MessageSquare className=\"h-4 w-4 text-muted-foreground\" />\n                  <div>\n                    <p className=\"font-medium text-sm\">{inbox.chatwootInboxName}</p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      ID: {inbox.chatwootInboxId} | Type: {inbox.inboxType}\n                    </p>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <Badge variant={inbox.enabled ? \"default\" : \"secondary\"}>\n                    {inbox.enabled ? \"Active\" : \"Disabled\"}\n                  </Badge>\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={() => deleteInboxMutation.mutate(inbox.id)}\n                    disabled={deleteInboxMutation.isPending}\n                  >\n                    <Trash2 className=\"h-4 w-4 text-destructive\" />\n                  </Button>\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n\n      <div className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <h4 className=\"font-medium text-sm flex items-center gap-2\">\n            <Building2 className=\"h-4 w-4\" />\n            Chatwoot Teams\n          </h4>\n        </div>\n\n        {deptTeams.length === 0 ? (\n          <div className=\"space-y-2\">\n            <p className=\"text-sm text-muted-foreground\">No teams mapped to this department</p>\n            <form onSubmit={handleAddTeam} className=\"flex flex-wrap gap-2\">\n              <Input\n                name=\"chatwootTeamId\"\n                type=\"number\"\n                placeholder=\"Team ID\"\n                className=\"w-24\"\n                required\n              />\n              <Input\n                name=\"chatwootTeamName\"\n                placeholder=\"Team Name\"\n                className=\"flex-1 min-w-[150px]\"\n                required\n              />\n              <div className=\"flex items-center gap-2\">\n                <Switch name=\"autoAssign\" id={`auto-assign-${department.id}`} defaultChecked />\n                <Label htmlFor={`auto-assign-${department.id}`} className=\"text-sm\">Auto-assign</Label>\n              </div>\n              <Button type=\"submit\" size=\"sm\" disabled={createTeamMutation.isPending}>\n                <Plus className=\"h-4 w-4 mr-1\" />\n                Add\n              </Button>\n            </form>\n          </div>\n        ) : (\n          <div className=\"space-y-2\">\n            {deptTeams.map((team) => (\n              <div key={team.id} className=\"flex items-center justify-between p-3 rounded-md bg-muted\">\n                <div className=\"flex items-center gap-3\">\n                  <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n                  <div>\n                    <p className=\"font-medium text-sm\">{team.chatwootTeamName}</p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      ID: {team.chatwootTeamId} | Auto-assign: {team.autoAssign ? \"Yes\" : \"No\"}\n                    </p>\n                  </div>\n                </div>\n                <Button\n                  size=\"icon\"\n                  variant=\"ghost\"\n                  onClick={() => deleteTeamMutation.mutate(team.id)}\n                  disabled={deleteTeamMutation.isPending}\n                >\n                  <Trash2 className=\"h-4 w-4 text-destructive\" />\n                </Button>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nexport default function DepartmentChannels() {\n  const { isManagement, isDepartmentAdmin } = useAuth();\n\n  const { data: departments = [], isLoading: deptLoading } = useQuery<Department[]>({\n    queryKey: [\"/api/departments\"],\n  });\n\n  const { data: emailSettings = [], isLoading: emailLoading } = useQuery<DepartmentEmailSettings[]>({\n    queryKey: [\"/api/integrations/department-emails\"],\n  });\n\n  const getEmailSettings = (deptId: string) => \n    emailSettings.find(s => s.departmentId === deptId);\n\n  if (!isManagement && !isDepartmentAdmin) {\n    return (\n      <div className=\"space-y-6\">\n        <div>\n          <h1 className=\"text-3xl font-semibold text-foreground\">Department Channels</h1>\n          <p className=\"text-muted-foreground mt-1\">You need admin permissions to manage department channels.</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold text-foreground\">Department Communication Channels</h1>\n        <p className=\"text-muted-foreground mt-1\">\n          Configure email addresses and Chatwoot inbox mappings for each department\n        </p>\n      </div>\n\n      {(deptLoading || emailLoading) ? (\n        <div className=\"space-y-4\">\n          <Skeleton className=\"h-32 w-full\" />\n          <Skeleton className=\"h-32 w-full\" />\n        </div>\n      ) : (\n        <Accordion type=\"single\" collapsible className=\"space-y-4\">\n          {departments.map((dept) => {\n            const settings = getEmailSettings(dept.id);\n            return (\n              <AccordionItem\n                key={dept.id}\n                value={dept.id}\n                className=\"border border-border rounded-md\"\n              >\n                <AccordionTrigger className=\"px-6 hover:no-underline hover-elevate\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-muted\">\n                      <Building2 className=\"h-5 w-5 text-muted-foreground\" />\n                    </div>\n                    <div className=\"text-left\">\n                      <div className=\"flex items-center gap-2\">\n                        <h3 className=\"font-semibold\">{dept.name}</h3>\n                        <Badge variant=\"outline\">{dept.code}</Badge>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground\">\n                        {settings?.parentEmail || \"No email configured\"}\n                      </p>\n                    </div>\n                  </div>\n                </AccordionTrigger>\n                <AccordionContent className=\"px-6 pb-6\">\n                  <div className=\"space-y-6\">\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-base flex items-center gap-2\">\n                          <Mail className=\"h-4 w-4\" />\n                          Email Configuration\n                        </CardTitle>\n                        <CardDescription>\n                          Configure the department support email address\n                        </CardDescription>\n                      </CardHeader>\n                      <CardContent>\n                        <DepartmentEmailForm \n                          department={dept} \n                          existingSettings={settings} \n                        />\n                      </CardContent>\n                    </Card>\n\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-base flex items-center gap-2\">\n                          <Link2 className=\"h-4 w-4\" />\n                          Chatwoot Integration\n                        </CardTitle>\n                        <CardDescription>\n                          Map Chatwoot inboxes and teams to this department\n                        </CardDescription>\n                      </CardHeader>\n                      <CardContent>\n                        <ChatwootMappingForm department={dept} />\n                      </CardContent>\n                    </Card>\n                  </div>\n                </AccordionContent>\n              </AccordionItem>\n            );\n          })}\n        </Accordion>\n      )}\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Phone className=\"h-5 w-5\" />\n            WhatsApp Channel Mapping\n          </CardTitle>\n          <CardDescription>\n            WhatsApp routing is configured through Typebot flows in the Integrations settings.\n            Each Typebot flow can route to a specific department based on customer selection.\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Button variant=\"outline\" onClick={() => window.location.href = \"/integrations\"}>\n            <Settings className=\"h-4 w-4 mr-2\" />\n            Go to Integration Settings\n          </Button>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":25026,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2359,"size_tokens":null},"server/index-prod.ts":{"content":"import fs from \"node:fs\";\nimport path from \"node:path\";\nimport { fileURLToPath } from \"node:url\";\nimport { type Server } from \"node:http\";\n\nimport express, { type Express } from \"express\";\nimport runApp from \"./app\";\n\nexport async function serveStatic(app: Express, _server: Server) {\n  const __filename = fileURLToPath(import.meta.url);\n  const __dirname = path.dirname(__filename);\n  \n  const distPath = path.resolve(__dirname, \"public\");\n  \n  console.log(`[static] Looking for static files at: ${distPath}`);\n  console.log(`[static] Current directory: ${process.cwd()}`);\n  console.log(`[static] __dirname: ${__dirname}`);\n\n  if (!fs.existsSync(distPath)) {\n    console.error(`[static] Directory not found: ${distPath}`);\n    console.error(`[static] Available files in parent:`, fs.readdirSync(path.dirname(distPath)));\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  const files = fs.readdirSync(distPath);\n  console.log(`[static] Found ${files.length} items in public directory:`, files);\n\n  app.use(express.static(distPath, {\n    maxAge: '1d',\n    etag: true,\n  }));\n\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n\n(async () => {\n  await runApp(serveStatic);\n})();\n\n// Add process-level handlers to log unhandled errors and rejections.\n// Avoid crashing silently or rethrowing errors that bubble up.\nprocess.on('uncaughtException', (err) => {\n  console.error('[process] Uncaught Exception:', err && (err.stack || err));\n  // For now we do not exit immediately; pm2 or the orchestrator will handle restarts.\n});\n\nprocess.on('unhandledRejection', (reason, promise) => {\n  console.error('[process] Unhandled Promise Rejection at:', promise, 'reason:', reason);\n  // Optionally add logic to notify or gracefully shutdown. Keep the process alive to avoid 502s.\n});\n","path":null,"size_bytes":1897,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"docker-entrypoint.sh":{"content":"#!/bin/sh\nset -e\n\necho \"================================\"\necho \"AdminHub Container Initialization\"\necho \"================================\"\necho \"\"\n\n# Show environment info\necho \"[init] Node version: $(node --version)\"\necho \"[init] Working directory: $(pwd)\"\necho \"[init] Files in /app/dist:\"\nls -la /app/dist/ 2>/dev/null || echo \"  (dist folder not found!)\"\necho \"\"\necho \"[init] Files in /app/dist/public:\"\nls -la /app/dist/public/ 2>/dev/null || echo \"  (public folder not found!)\"\necho \"\"\n\n# Wait for database to be ready\necho \"[db] Waiting for PostgreSQL to be ready...\"\ncount=0\nwhile ! pg_isready -h postgres -U postgres -d postgres >/dev/null 2>&1; do\n  count=$((count + 1))\n  if [ $count -gt 30 ]; then\n    echo \"[db] ❌ PostgreSQL failed to start\"\n    exit 1\n  fi\n  echo \"[db] Attempt $count/30: Waiting for database...\"\n  sleep 1\ndone\n\necho \"[db] ✓ PostgreSQL is ready!\"\n\n# Initialize database schema from SQL file (creates tables if they don't exist)\necho \"[db] Initializing database schema...\"\nif [ -f /app/migrations/init.sql ]; then\n  # Run init.sql to create tables (will fail gracefully if tables already exist)\n  if PGPASSWORD=\"${PGPASSWORD:-postgres}\" psql -h postgres -U \"${PGUSER:-postgres}\" -d \"${PGDATABASE:-postgres}\" -f /app/migrations/init.sql 2>&1; then\n    echo \"[db] ✓ Database schema initialized\"\n  else\n    echo \"[db] ⚠️ Schema init completed (tables may already exist)\"\n  fi\nelse\n  echo \"[db] ⚠️ No init.sql found, skipping schema creation\"\nfi\n\n# Run migrations (ALTER TABLE statements for existing tables)\necho \"[db] Running database migrations...\"\nif node dist/run-migration.js 2>&1; then\n  echo \"[db] ✓ Migrations completed\"\nelse\n  echo \"[db] ⚠️ Migrations skipped (tables may not exist yet)\"\nfi\n\n# Run seed (creates initial data)\necho \"[db] Running database seed...\"\nif node dist/run-seed.js 2>&1; then\n  echo \"[db] ✓ Seed completed\"\nelse\n  echo \"[db] ⚠️ Seed skipped or already applied\"\nfi\n\necho \"\"\necho \"================================\"\necho \"✅ Initialization complete!\"\necho \"================================\"\necho \"\"\n\nexec \"$@\"\n","path":null,"size_bytes":2094,"size_tokens":null},"server/devAuth.ts":{"content":"import type { Express, RequestHandler } from \"express\";\nimport session from \"express-session\";\nimport { storage } from \"./storage\";\nimport { getTeamMemberWithPermissions, seedRolesAndPermissions, seedDefaultDepartments, type AuthenticatedTeamMember } from \"./rbac\";\nimport { db } from \"./db\";\nimport { roles, teamMembers, departments, ROLE_TYPES } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport bcrypt from \"bcryptjs\";\n\ndeclare module \"express-session\" {\n  interface SessionData {\n    user: {\n      id: string;\n      email: string;\n      firstName: string | null;\n      lastName: string | null;\n      profileImageUrl: string | null;\n    };\n    teamMemberId?: string;\n  }\n}\n\nconst DEV_USER = {\n  id: \"dev-user-123\",\n  email: \"admin@localhost.dev\",\n  firstName: \"Admin\",\n  lastName: \"User\",\n  profileImageUrl: null,\n};\n\nexport function getSession() {\n  const secureFlag = process.env.SESSION_COOKIE_SECURE ? process.env.SESSION_COOKIE_SECURE === 'true' : false;\n  const sameSiteVal = process.env.SESSION_COOKIE_SAME_SITE as any || (secureFlag ? 'none' : 'lax');\n\n  console.log(`[auth] Dev session cookie secure=${secureFlag} sameSite=${sameSiteVal}`);\n\n  return session({\n    name: process.env.SESSION_COOKIE_NAME || 'adminhub.sid',\n    secret: process.env.SESSION_SECRET || \"dev-secret-change-in-production\",\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: secureFlag,\n      sameSite: sameSiteVal,\n      maxAge: 7 * 24 * 60 * 60 * 1000,\n    },\n  });\n}\n\nasync function ensureDevTeamMember(): Promise<string | null> {\n  await seedRolesAndPermissions();\n  await seedDefaultDepartments();\n\n  const existingMember = await storage.getTeamMemberByEmail(DEV_USER.email);\n  if (existingMember) {\n    return existingMember.id;\n  }\n\n  const [mgmtRole] = await db.select().from(roles).where(eq(roles.code, ROLE_TYPES.MANAGEMENT));\n  const [dept] = await db.select().from(departments).limit(1);\n\n  if (!mgmtRole || !dept) {\n    console.error(\"Cannot create dev team member: missing role or department\");\n    return null;\n  }\n\n  const passwordHash = await bcrypt.hash(\"devpassword\", 10);\n  const member = await storage.createTeamMember({\n    userId: DEV_USER.id,\n    departmentId: dept.id,\n    roleId: mgmtRole.id,\n    email: DEV_USER.email,\n    firstName: DEV_USER.firstName || \"Admin\",\n    lastName: DEV_USER.lastName || \"User\",\n    role: \"management\",\n    passwordHash,\n    status: \"active\",\n  });\n\n  return member.id;\n}\n\nexport async function setupAuth(app: Express) {\n  app.set('trust proxy', 1);\n  app.use(getSession());\n\n  app.get(\"/api/dev-login\", async (req: any, res) => {\n    await storage.upsertUser(DEV_USER);\n    const teamMemberId = await ensureDevTeamMember();\n    req.session.user = DEV_USER;\n    req.session.teamMemberId = teamMemberId || undefined;\n    res.redirect(\"/\");\n  });\n\n  app.post(\"/api/auth/login\", async (req: any, res) => {\n    try {\n      const { email, password } = req.body;\n      \n      if (!email || !password) {\n        return res.status(400).json({ message: \"Email and password are required\" });\n      }\n\n      const member = await storage.getTeamMemberByEmail(email);\n      if (!member) {\n        return res.status(401).json({ message: \"Invalid credentials\" });\n      }\n\n      if (member.status !== \"active\") {\n        return res.status(401).json({ message: \"Account is deactivated\" });\n      }\n\n      if (!member.isVerified) {\n        return res.status(401).json({ message: \"Account is pending admin approval\" });\n      }\n\n      if (!member.passwordHash) {\n        return res.status(401).json({ message: \"Password not set for this account\" });\n      }\n\n      const isValid = await bcrypt.compare(password, member.passwordHash);\n      if (!isValid) {\n        return res.status(401).json({ message: \"Invalid credentials\" });\n      }\n\n      await storage.updateTeamMember(member.id, { lastLoginAt: new Date() } as any);\n\n      const user = {\n        id: member.id,\n        email: member.email,\n        firstName: member.firstName,\n        lastName: member.lastName,\n        profileImageUrl: null,\n      };\n\n      req.session.user = user;\n      req.session.teamMemberId = member.id;\n\n      const memberWithPerms = await getTeamMemberWithPermissions(member.id);\n      \n      res.json({ \n        user,\n        teamMember: memberWithPerms,\n      });\n    } catch (error) {\n      console.error(\"Login error:\", error);\n      res.status(500).json({ message: \"Login failed\" });\n    }\n  });\n\n  app.get(\"/api/auth/user\", async (req: any, res) => {\n    if (req.session.user) {\n      let teamMember: AuthenticatedTeamMember | null = null;\n      \n      if (req.session.teamMemberId) {\n        teamMember = await getTeamMemberWithPermissions(req.session.teamMemberId);\n      }\n\n      res.json({\n        ...req.session.user,\n        teamMember,\n      });\n    } else {\n      res.status(401).json({ message: \"Unauthorized\" });\n    }\n  });\n\n  app.get(\"/api/auth/me\", async (req: any, res) => {\n    if (!req.session.teamMemberId) {\n      return res.status(401).json({ message: \"Not authenticated as team member\" });\n    }\n\n    const teamMember = await getTeamMemberWithPermissions(req.session.teamMemberId);\n    if (!teamMember) {\n      return res.status(401).json({ message: \"Team member not found\" });\n    }\n\n    res.json(teamMember);\n  });\n\n  app.get(\"/api/logout\", (req: any, res) => {\n    req.session.destroy(() => {\n      res.redirect(\"/\");\n    });\n  });\n\n  app.post(\"/api/logout\", (req: any, res) => {\n    req.session.destroy(() => {\n      res.json({ message: \"Logged out successfully\" });\n    });\n  });\n\n  app.get(\"/api/login\", (req, res) => {\n    res.redirect(\"/api/dev-login\");\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req: any, res, next) => {\n  if (req.session?.user) {\n    req.user = { claims: { sub: req.session.user.id } };\n    \n    if (req.session.teamMemberId) {\n      const teamMember = await getTeamMemberWithPermissions(req.session.teamMemberId);\n      if (teamMember) {\n        req.teamMember = teamMember;\n      }\n    }\n    \n    return next();\n  }\n  res.status(401).json({ message: \"Unauthorized\" });\n};\n\nexport const isTeamMemberAuthenticated: RequestHandler = async (req: any, res, next) => {\n  if (!req.session?.teamMemberId) {\n    return res.status(401).json({ message: \"Team member authentication required\" });\n  }\n\n  const teamMember = await getTeamMemberWithPermissions(req.session.teamMemberId);\n  if (!teamMember) {\n    return res.status(401).json({ message: \"Team member not found\" });\n  }\n\n  if (teamMember.status !== \"active\") {\n    return res.status(401).json({ message: \"Account is deactivated\" });\n  }\n\n  req.teamMember = teamMember;\n  req.user = { claims: { sub: req.session.user?.id } };\n  \n  next();\n};\n","path":null,"size_bytes":6735,"size_tokens":null},"client/src/pages/integrations.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { \n  MessageSquare, \n  Phone, \n  Bot, \n  Mail, \n  Save, \n  TestTube, \n  CheckCircle2, \n  XCircle, \n  RefreshCw,\n  Settings,\n  Link2,\n  Shield\n} from \"lucide-react\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport { useAuth } from \"@/hooks/useAuth\";\n\ninterface IntegrationStatus {\n  chatwoot: { configured: boolean; enabled: boolean; lastSync: string | null };\n  evolution: { configured: boolean; enabled: boolean; connectionStatus: string };\n  typebot: { configured: boolean; enabled: boolean };\n  mailcow: { configured: boolean; enabled: boolean; lastSync: string | null };\n}\n\ninterface ChatwootConfig {\n  id?: string;\n  instanceUrl: string;\n  apiAccessToken: string;\n  accountId: number;\n  enabled: boolean;\n  ssoEnabled: boolean;\n  webhookSecret?: string;\n}\n\ninterface EvolutionConfig {\n  id?: string;\n  instanceUrl: string;\n  apiKey: string;\n  instanceName: string;\n  enabled: boolean;\n  webhookUrl?: string;\n}\n\ninterface TypebotConfig {\n  id?: string;\n  instanceUrl: string;\n  apiToken: string;\n  enabled: boolean;\n}\n\ninterface MailcowConfig {\n  id?: string;\n  instanceUrl: string;\n  apiKey: string;\n  domain: string;\n  enabled: boolean;\n}\n\ninterface EvolutionStatus {\n  connected: boolean;\n  state?: string;\n  qrCode?: string;\n  message?: string;\n}\n\nfunction StatusBadge({ configured, enabled }: { configured: boolean; enabled: boolean }) {\n  if (!configured) {\n    return <Badge variant=\"secondary\">Not Configured</Badge>;\n  }\n  return enabled ? (\n    <Badge variant=\"default\" className=\"bg-green-600\">Active</Badge>\n  ) : (\n    <Badge variant=\"outline\">Disabled</Badge>\n  );\n}\n\nfunction SetupGuide({ configured }: { configured: boolean }) {\n  const steps = [\n    {\n      number: 1,\n      title: \"Get your Chatwoot URL\",\n      description: \"Log into your Chatwoot instance. Copy the URL from your browser (e.g., https://app.chatwoot.com or your self-hosted URL).\",\n      completed: false,\n    },\n    {\n      number: 2,\n      title: \"Find your Account ID\",\n      description: \"In Chatwoot, go to Settings > Account Settings. Your Account ID is shown in the URL or on this page.\",\n      completed: false,\n    },\n    {\n      number: 3,\n      title: \"Generate an API Access Token\",\n      description: \"In Chatwoot, click your profile icon > Profile Settings > Access Token. Generate a new token and copy it.\",\n      completed: false,\n    },\n    {\n      number: 4,\n      title: \"Enter credentials below\",\n      description: \"Fill in the form with your Chatwoot URL, Account ID, and API token. Click 'Test Connection' to verify.\",\n      completed: configured,\n    },\n    {\n      number: 5,\n      title: \"Map departments to inboxes\",\n      description: \"After saving, go to Department Channels to link each department to their Chatwoot inbox.\",\n      completed: false,\n    },\n  ];\n\n  return (\n    <div className=\"mb-6 p-4 rounded-lg bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800\">\n      <div className=\"flex items-start gap-3 mb-4\">\n        <div className=\"h-8 w-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center flex-shrink-0\">\n          <Settings className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n        </div>\n        <div>\n          <h3 className=\"font-semibold text-blue-900 dark:text-blue-100\">Quick Setup Guide</h3>\n          <p className=\"text-sm text-blue-700 dark:text-blue-300\">Follow these steps to connect Chatwoot</p>\n        </div>\n      </div>\n      <div className=\"space-y-3\">\n        {steps.map((step) => (\n          <div key={step.number} className=\"flex items-start gap-3\">\n            <div className={`h-6 w-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-medium ${\n              step.completed \n                ? \"bg-green-500 text-white\" \n                : \"bg-blue-200 dark:bg-blue-800 text-blue-700 dark:text-blue-300\"\n            }`}>\n              {step.completed ? <CheckCircle2 className=\"h-4 w-4\" /> : step.number}\n            </div>\n            <div>\n              <p className=\"font-medium text-sm text-blue-900 dark:text-blue-100\">{step.title}</p>\n              <p className=\"text-xs text-blue-600 dark:text-blue-400\">{step.description}</p>\n            </div>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction ChatwootSettings() {\n  const { toast } = useToast();\n  const [testing, setTesting] = useState(false);\n  const [showGuide, setShowGuide] = useState(true);\n\n  const { data: config, isLoading } = useQuery<ChatwootConfig | null>({\n    queryKey: [\"/api/integrations/chatwoot/config\"],\n  });\n\n  const { data: status } = useQuery<IntegrationStatus>({\n    queryKey: [\"/api/integrations/status\"],\n  });\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: Partial<ChatwootConfig>) => {\n      return await apiRequest(\"/api/integrations/chatwoot/config\", \"POST\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/integrations/chatwoot/config\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/integrations/status\"] });\n      toast({ title: \"Chatwoot configuration saved\", description: \"Your settings have been updated successfully.\" });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        window.location.href = \"/api/login\";\n        return;\n      }\n      toast({ title: \"Error\", description: \"Failed to save configuration\", variant: \"destructive\" });\n    },\n  });\n\n  const testMutation = useMutation({\n    mutationFn: async (data: { instanceUrl: string; apiAccessToken: string; accountId: number }) => {\n      return await apiRequest(\"/api/integrations/chatwoot/test\", \"POST\", data);\n    },\n    onSuccess: (data: any) => {\n      toast({ \n        title: \"Connection successful\", \n        description: `Connected to Chatwoot! Found ${data.agentCount || 0} agents. You can now save your configuration.` \n      });\n      setTesting(false);\n    },\n    onError: () => {\n      toast({ title: \"Connection failed\", description: \"Please check your URL, Account ID, and API token are correct.\", variant: \"destructive\" });\n      setTesting(false);\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    const formData = new FormData(e.currentTarget);\n    saveMutation.mutate({\n      instanceUrl: formData.get(\"instanceUrl\") as string,\n      apiAccessToken: formData.get(\"apiAccessToken\") as string,\n      accountId: parseInt(formData.get(\"accountId\") as string, 10),\n      enabled: formData.get(\"enabled\") === \"on\",\n      ssoEnabled: formData.get(\"ssoEnabled\") === \"on\",\n      webhookSecret: formData.get(\"webhookSecret\") as string || undefined,\n    });\n  };\n\n  const handleTest = () => {\n    const form = document.querySelector('form') as HTMLFormElement;\n    if (!form) return;\n    const formData = new FormData(form);\n    const instanceUrl = formData.get(\"instanceUrl\") as string;\n    const apiAccessToken = formData.get(\"apiAccessToken\") as string;\n    const accountId = formData.get(\"accountId\") as string;\n    \n    if (!instanceUrl || !apiAccessToken || !accountId) {\n      toast({ title: \"Missing fields\", description: \"Please fill in all required fields before testing\", variant: \"destructive\" });\n      return;\n    }\n    \n    setTesting(true);\n    testMutation.mutate({\n      instanceUrl,\n      apiAccessToken,\n      accountId: parseInt(accountId, 10),\n    });\n  };\n\n  if (isLoading) {\n    return <div className=\"space-y-4\"><Skeleton className=\"h-10 w-full\" /><Skeleton className=\"h-10 w-full\" /></div>;\n  }\n\n  const isConfigured = status?.chatwoot?.configured || false;\n\n  return (\n    <div className=\"space-y-6\">\n      {showGuide && (\n        <div className=\"relative\">\n          <SetupGuide configured={isConfigured} />\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            className=\"absolute top-2 right-2 text-blue-600 dark:text-blue-400\"\n            onClick={() => setShowGuide(false)}\n          >\n            Hide Guide\n          </Button>\n        </div>\n      )}\n      \n      {!showGuide && !isConfigured && (\n        <Button variant=\"outline\" size=\"sm\" onClick={() => setShowGuide(true)}>\n          Show Setup Guide\n        </Button>\n      )}\n\n      <form onSubmit={handleSubmit} className=\"space-y-4\">\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"chatwoot-url\">Instance URL</Label>\n            <Input\n              id=\"chatwoot-url\"\n              name=\"instanceUrl\"\n              type=\"url\"\n              placeholder=\"https://app.chatwoot.com\"\n              defaultValue={config?.instanceUrl || \"\"}\n              required\n              data-testid=\"input-chatwoot-url\"\n            />\n            <p className=\"text-xs text-muted-foreground\">\n              Your Chatwoot instance URL (cloud or self-hosted)\n            </p>\n          </div>\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"chatwoot-account\">Account ID</Label>\n            <Input\n              id=\"chatwoot-account\"\n              name=\"accountId\"\n              type=\"number\"\n              placeholder=\"1\"\n              defaultValue={config?.accountId || \"\"}\n              required\n              data-testid=\"input-chatwoot-account\"\n            />\n            <p className=\"text-xs text-muted-foreground\">\n              Found in Settings &gt; Account Settings\n            </p>\n          </div>\n        </div>\n\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"chatwoot-token\">API Access Token</Label>\n          <Input\n            id=\"chatwoot-token\"\n            name=\"apiAccessToken\"\n            type=\"password\"\n            placeholder={isConfigured ? \"Leave blank to keep existing token\" : \"Enter your Chatwoot API access token\"}\n            required={!isConfigured}\n            data-testid=\"input-chatwoot-token\"\n          />\n          <p className=\"text-xs text-muted-foreground\">\n            {isConfigured \n              ? `Current token: ${config?.apiAccessToken || \"••••••••\"} (enter new value to change)`\n              : \"Profile Icon > Profile Settings > Access Token > Generate\"}\n          </p>\n        </div>\n\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"chatwoot-webhook\">Webhook Secret (Optional)</Label>\n          <Input\n            id=\"chatwoot-webhook\"\n            name=\"webhookSecret\"\n            type=\"password\"\n            placeholder={config?.webhookSecret ? \"Leave blank to keep existing\" : \"For receiving real-time updates\"}\n            data-testid=\"input-chatwoot-webhook\"\n          />\n          {config?.webhookSecret && (\n            <p className=\"text-xs text-muted-foreground\">\n              Current: {config.webhookSecret} (enter new value to change)\n            </p>\n          )}\n        </div>\n\n        <div className=\"flex flex-wrap gap-6\">\n          <div className=\"flex items-center gap-2\">\n            <Switch\n              id=\"chatwoot-enabled\"\n              name=\"enabled\"\n              defaultChecked={config?.enabled ?? true}\n              data-testid=\"switch-chatwoot-enabled\"\n            />\n            <Label htmlFor=\"chatwoot-enabled\">Enable Chatwoot</Label>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Switch\n              id=\"chatwoot-sso\"\n              name=\"ssoEnabled\"\n              defaultChecked={config?.ssoEnabled ?? false}\n              data-testid=\"switch-chatwoot-sso\"\n            />\n            <Label htmlFor=\"chatwoot-sso\">Enable SSO (Single Sign-On)</Label>\n          </div>\n        </div>\n\n        <div className=\"flex gap-2 pt-4\">\n          <Button\n            type=\"button\"\n            variant=\"outline\"\n            disabled={testing}\n            onClick={handleTest}\n            data-testid=\"button-test-chatwoot\"\n          >\n            <TestTube className=\"h-4 w-4 mr-2\" />\n            {testing ? \"Testing...\" : \"Test Connection\"}\n          </Button>\n          <Button type=\"submit\" disabled={saveMutation.isPending} data-testid=\"button-save-chatwoot\">\n            <Save className=\"h-4 w-4 mr-2\" />\n            {saveMutation.isPending ? \"Saving...\" : \"Save Configuration\"}\n          </Button>\n        </div>\n\n        {isConfigured && (\n          <div className=\"mt-4 p-4 rounded-md bg-green-50 dark:bg-green-950 border border-green-200 dark:border-green-800\">\n            <div className=\"flex items-center gap-2 text-green-700 dark:text-green-300\">\n              <CheckCircle2 className=\"h-5 w-5\" />\n              <span className=\"font-medium\">Chatwoot is connected!</span>\n            </div>\n            <p className=\"text-sm text-green-600 dark:text-green-400 mt-1\">\n              Next step: Go to <a href=\"/department-channels\" className=\"underline font-medium\">Department Channels</a> to link departments to Chatwoot inboxes.\n            </p>\n          </div>\n        )}\n      </form>\n    </div>\n  );\n}\n\nfunction EvolutionSettings() {\n  const { toast } = useToast();\n  const [testing, setTesting] = useState(false);\n\n  const { data: config, isLoading } = useQuery<EvolutionConfig | null>({\n    queryKey: [\"/api/integrations/evolution/config\"],\n  });\n\n  const { data: status } = useQuery<EvolutionStatus>({\n    queryKey: [\"/api/integrations/evolution/status\"],\n    refetchInterval: 30000,\n  });\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: Partial<EvolutionConfig>) => {\n      return await apiRequest(\"/api/integrations/evolution/config\", \"POST\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/integrations/evolution/config\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/integrations/status\"] });\n      toast({ title: \"Evolution API configuration saved\" });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        window.location.href = \"/api/login\";\n        return;\n      }\n      toast({ title: \"Error\", description: \"Failed to save configuration\", variant: \"destructive\" });\n    },\n  });\n\n  const testMutation = useMutation({\n    mutationFn: async (data: { instanceUrl: string; apiKey: string; instanceName: string }) => {\n      return await apiRequest(\"/api/integrations/evolution/test\", \"POST\", data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Connection successful\" });\n      setTesting(false);\n    },\n    onError: () => {\n      toast({ title: \"Connection failed\", description: \"Check your credentials\", variant: \"destructive\" });\n      setTesting(false);\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    const formData = new FormData(e.currentTarget);\n    saveMutation.mutate({\n      instanceUrl: formData.get(\"instanceUrl\") as string,\n      apiKey: formData.get(\"apiKey\") as string,\n      instanceName: formData.get(\"instanceName\") as string,\n      enabled: formData.get(\"enabled\") === \"on\",\n      webhookUrl: formData.get(\"webhookUrl\") as string || undefined,\n    });\n  };\n\n  if (isLoading) {\n    return <div className=\"space-y-4\"><Skeleton className=\"h-10 w-full\" /><Skeleton className=\"h-10 w-full\" /></div>;\n  }\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      {status && (\n        <div className=\"flex items-center gap-2 p-3 rounded-md bg-muted\">\n          {status.connected ? (\n            <>\n              <CheckCircle2 className=\"h-5 w-5 text-green-500\" />\n              <span className=\"text-sm\">WhatsApp Connected</span>\n            </>\n          ) : (\n            <>\n              <XCircle className=\"h-5 w-5 text-orange-500\" />\n              <span className=\"text-sm\">WhatsApp Disconnected - Scan QR code to connect</span>\n            </>\n          )}\n        </div>\n      )}\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"evolution-url\">Instance URL</Label>\n          <Input\n            id=\"evolution-url\"\n            name=\"instanceUrl\"\n            type=\"url\"\n            placeholder=\"https://evolution.yourdomain.com\"\n            defaultValue={config?.instanceUrl || \"\"}\n            required\n            data-testid=\"input-evolution-url\"\n          />\n        </div>\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"evolution-name\">Instance Name</Label>\n          <Input\n            id=\"evolution-name\"\n            name=\"instanceName\"\n            placeholder=\"my-instance\"\n            defaultValue={config?.instanceName || \"\"}\n            required\n            data-testid=\"input-evolution-name\"\n          />\n        </div>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"evolution-key\">API Key</Label>\n        <Input\n          id=\"evolution-key\"\n          name=\"apiKey\"\n          type=\"password\"\n          placeholder={config?.apiKey ? \"Leave blank to keep existing key\" : \"Enter your Evolution API key\"}\n          required={!config?.apiKey}\n          data-testid=\"input-evolution-key\"\n        />\n        {config?.apiKey && (\n          <p className=\"text-xs text-muted-foreground\">\n            Current: {config.apiKey} (enter new value to change)\n          </p>\n        )}\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"evolution-webhook\">Webhook URL (Optional)</Label>\n        <Input\n          id=\"evolution-webhook\"\n          name=\"webhookUrl\"\n          type=\"url\"\n          placeholder=\"URL for receiving WhatsApp events\"\n          defaultValue={config?.webhookUrl || \"\"}\n          data-testid=\"input-evolution-webhook\"\n        />\n      </div>\n\n      <div className=\"flex items-center gap-2\">\n        <Switch\n          id=\"evolution-enabled\"\n          name=\"enabled\"\n          defaultChecked={config?.enabled ?? true}\n          data-testid=\"switch-evolution-enabled\"\n        />\n        <Label htmlFor=\"evolution-enabled\">Enable Evolution API</Label>\n      </div>\n\n      <div className=\"flex gap-2 pt-4\">\n        <Button type=\"submit\" disabled={saveMutation.isPending} data-testid=\"button-save-evolution\">\n          <Save className=\"h-4 w-4 mr-2\" />\n          {saveMutation.isPending ? \"Saving...\" : \"Save Configuration\"}\n        </Button>\n        <Button\n          type=\"button\"\n          variant=\"outline\"\n          disabled={testing}\n          onClick={() => {\n            const form = document.querySelector('form') as HTMLFormElement;\n            const formData = new FormData(form);\n            setTesting(true);\n            testMutation.mutate({\n              instanceUrl: formData.get(\"instanceUrl\") as string,\n              apiKey: formData.get(\"apiKey\") as string,\n              instanceName: formData.get(\"instanceName\") as string,\n            });\n          }}\n          data-testid=\"button-test-evolution\"\n        >\n          <TestTube className=\"h-4 w-4 mr-2\" />\n          {testing ? \"Testing...\" : \"Test Connection\"}\n        </Button>\n      </div>\n    </form>\n  );\n}\n\nfunction TypebotSettings() {\n  const { toast } = useToast();\n\n  const { data: config, isLoading } = useQuery<TypebotConfig | null>({\n    queryKey: [\"/api/integrations/typebot/config\"],\n  });\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: Partial<TypebotConfig>) => {\n      return await apiRequest(\"/api/integrations/typebot/config\", \"POST\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/integrations/typebot/config\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/integrations/status\"] });\n      toast({ title: \"Typebot configuration saved\" });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        window.location.href = \"/api/login\";\n        return;\n      }\n      toast({ title: \"Error\", description: \"Failed to save configuration\", variant: \"destructive\" });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    const formData = new FormData(e.currentTarget);\n    saveMutation.mutate({\n      instanceUrl: formData.get(\"instanceUrl\") as string,\n      apiToken: formData.get(\"apiToken\") as string,\n      enabled: formData.get(\"enabled\") === \"on\",\n    });\n  };\n\n  if (isLoading) {\n    return <div className=\"space-y-4\"><Skeleton className=\"h-10 w-full\" /><Skeleton className=\"h-10 w-full\" /></div>;\n  }\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"typebot-url\">Instance URL</Label>\n        <Input\n          id=\"typebot-url\"\n          name=\"instanceUrl\"\n          type=\"url\"\n          placeholder=\"https://typebot.yourdomain.com\"\n          defaultValue={config?.instanceUrl || \"\"}\n          required\n          data-testid=\"input-typebot-url\"\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"typebot-token\">API Token</Label>\n        <Input\n          id=\"typebot-token\"\n          name=\"apiToken\"\n          type=\"password\"\n          placeholder=\"Enter your Typebot API token\"\n          defaultValue={config?.apiToken || \"\"}\n          required\n          data-testid=\"input-typebot-token\"\n        />\n      </div>\n\n      <div className=\"flex items-center gap-2\">\n        <Switch\n          id=\"typebot-enabled\"\n          name=\"enabled\"\n          defaultChecked={config?.enabled ?? true}\n          data-testid=\"switch-typebot-enabled\"\n        />\n        <Label htmlFor=\"typebot-enabled\">Enable Typebot</Label>\n      </div>\n\n      <div className=\"flex gap-2 pt-4\">\n        <Button type=\"submit\" disabled={saveMutation.isPending} data-testid=\"button-save-typebot\">\n          <Save className=\"h-4 w-4 mr-2\" />\n          {saveMutation.isPending ? \"Saving...\" : \"Save Configuration\"}\n        </Button>\n      </div>\n    </form>\n  );\n}\n\nfunction MailcowSettings() {\n  const { toast } = useToast();\n  const [testing, setTesting] = useState(false);\n\n  const { data: config, isLoading } = useQuery<MailcowConfig | null>({\n    queryKey: [\"/api/integrations/mailcow/config\"],\n  });\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: Partial<MailcowConfig>) => {\n      return await apiRequest(\"/api/integrations/mailcow/config\", \"POST\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/integrations/mailcow/config\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/integrations/status\"] });\n      toast({ title: \"Mailcow configuration saved\" });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        window.location.href = \"/api/login\";\n        return;\n      }\n      toast({ title: \"Error\", description: \"Failed to save configuration\", variant: \"destructive\" });\n    },\n  });\n\n  const testMutation = useMutation({\n    mutationFn: async (data: { instanceUrl: string; apiKey: string }) => {\n      return await apiRequest(\"/api/integrations/mailcow/test\", \"POST\", data);\n    },\n    onSuccess: () => {\n      toast({ title: \"Connection successful\" });\n      setTesting(false);\n    },\n    onError: () => {\n      toast({ title: \"Connection failed\", description: \"Check your credentials\", variant: \"destructive\" });\n      setTesting(false);\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    const formData = new FormData(e.currentTarget);\n    saveMutation.mutate({\n      instanceUrl: formData.get(\"instanceUrl\") as string,\n      apiKey: formData.get(\"apiKey\") as string,\n      domain: formData.get(\"domain\") as string,\n      enabled: formData.get(\"enabled\") === \"on\",\n    });\n  };\n\n  if (isLoading) {\n    return <div className=\"space-y-4\"><Skeleton className=\"h-10 w-full\" /><Skeleton className=\"h-10 w-full\" /></div>;\n  }\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"mailcow-url\">Instance URL</Label>\n          <Input\n            id=\"mailcow-url\"\n            name=\"instanceUrl\"\n            type=\"url\"\n            placeholder=\"https://mail.yourdomain.com\"\n            defaultValue={config?.instanceUrl || \"\"}\n            required\n            data-testid=\"input-mailcow-url\"\n          />\n        </div>\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"mailcow-domain\">Email Domain</Label>\n          <Input\n            id=\"mailcow-domain\"\n            name=\"domain\"\n            placeholder=\"yourdomain.com\"\n            defaultValue={config?.domain || \"\"}\n            required\n            data-testid=\"input-mailcow-domain\"\n          />\n        </div>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"mailcow-key\">API Key</Label>\n        <Input\n          id=\"mailcow-key\"\n          name=\"apiKey\"\n          type=\"password\"\n          placeholder={config?.apiKey ? \"Leave blank to keep existing key\" : \"Enter your Mailcow API key\"}\n          required={!config?.apiKey}\n          data-testid=\"input-mailcow-key\"\n        />\n        {config?.apiKey && (\n          <p className=\"text-xs text-muted-foreground\">\n            Current: {config.apiKey} (enter new value to change)\n          </p>\n        )}\n      </div>\n\n      <div className=\"flex items-center gap-2\">\n        <Switch\n          id=\"mailcow-enabled\"\n          name=\"enabled\"\n          defaultChecked={config?.enabled ?? true}\n          data-testid=\"switch-mailcow-enabled\"\n        />\n        <Label htmlFor=\"mailcow-enabled\">Enable Mailcow</Label>\n      </div>\n\n      <div className=\"flex gap-2 pt-4\">\n        <Button type=\"submit\" disabled={saveMutation.isPending} data-testid=\"button-save-mailcow\">\n          <Save className=\"h-4 w-4 mr-2\" />\n          {saveMutation.isPending ? \"Saving...\" : \"Save Configuration\"}\n        </Button>\n        <Button\n          type=\"button\"\n          variant=\"outline\"\n          disabled={testing}\n          onClick={() => {\n            const form = document.querySelector('form') as HTMLFormElement;\n            const formData = new FormData(form);\n            setTesting(true);\n            testMutation.mutate({\n              instanceUrl: formData.get(\"instanceUrl\") as string,\n              apiKey: formData.get(\"apiKey\") as string,\n            });\n          }}\n          data-testid=\"button-test-mailcow\"\n        >\n          <TestTube className=\"h-4 w-4 mr-2\" />\n          {testing ? \"Testing...\" : \"Test Connection\"}\n        </Button>\n      </div>\n    </form>\n  );\n}\n\nexport default function Integrations() {\n  const { isManagement } = useAuth();\n\n  const { data: status, isLoading: statusLoading } = useQuery<IntegrationStatus>({\n    queryKey: [\"/api/integrations/status\"],\n  });\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold text-foreground\">Communication Integrations</h1>\n        <p className=\"text-muted-foreground mt-1\">\n          Configure connections to Chatwoot, WhatsApp, Typebot, and email services\n        </p>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"h-10 w-10 rounded-md bg-blue-100 dark:bg-blue-900 flex items-center justify-center\">\n                  <MessageSquare className=\"h-5 w-5 text-blue-600 dark:text-blue-300\" />\n                </div>\n                <div>\n                  <p className=\"font-medium\">Chatwoot</p>\n                  <p className=\"text-xs text-muted-foreground\">Chat & Support</p>\n                </div>\n              </div>\n              {statusLoading ? (\n                <Skeleton className=\"h-5 w-16\" />\n              ) : (\n                <StatusBadge \n                  configured={status?.chatwoot?.configured || false} \n                  enabled={status?.chatwoot?.enabled || false} \n                />\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"h-10 w-10 rounded-md bg-green-100 dark:bg-green-900 flex items-center justify-center\">\n                  <Phone className=\"h-5 w-5 text-green-600 dark:text-green-300\" />\n                </div>\n                <div>\n                  <p className=\"font-medium\">Evolution API</p>\n                  <p className=\"text-xs text-muted-foreground\">WhatsApp</p>\n                </div>\n              </div>\n              {statusLoading ? (\n                <Skeleton className=\"h-5 w-16\" />\n              ) : (\n                <StatusBadge \n                  configured={status?.evolution?.configured || false} \n                  enabled={status?.evolution?.enabled || false} \n                />\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"h-10 w-10 rounded-md bg-purple-100 dark:bg-purple-900 flex items-center justify-center\">\n                  <Bot className=\"h-5 w-5 text-purple-600 dark:text-purple-300\" />\n                </div>\n                <div>\n                  <p className=\"font-medium\">Typebot</p>\n                  <p className=\"text-xs text-muted-foreground\">Chatbot Flows</p>\n                </div>\n              </div>\n              {statusLoading ? (\n                <Skeleton className=\"h-5 w-16\" />\n              ) : (\n                <StatusBadge \n                  configured={status?.typebot?.configured || false} \n                  enabled={status?.typebot?.enabled || false} \n                />\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"h-10 w-10 rounded-md bg-orange-100 dark:bg-orange-900 flex items-center justify-center\">\n                  <Mail className=\"h-5 w-5 text-orange-600 dark:text-orange-300\" />\n                </div>\n                <div>\n                  <p className=\"font-medium\">Mailcow</p>\n                  <p className=\"text-xs text-muted-foreground\">Email Server</p>\n                </div>\n              </div>\n              {statusLoading ? (\n                <Skeleton className=\"h-5 w-16\" />\n              ) : (\n                <StatusBadge \n                  configured={status?.mailcow?.configured || false} \n                  enabled={status?.mailcow?.enabled || false} \n                />\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {!isManagement ? (\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-3 text-muted-foreground\">\n              <Shield className=\"h-5 w-5\" />\n              <p>You need management permissions to configure integrations.</p>\n            </div>\n          </CardContent>\n        </Card>\n      ) : (\n        <Tabs defaultValue=\"chatwoot\" className=\"space-y-4\">\n          <TabsList className=\"grid w-full grid-cols-4\">\n            <TabsTrigger value=\"chatwoot\" className=\"gap-2\" data-testid=\"tab-chatwoot\">\n              <MessageSquare className=\"h-4 w-4\" />\n              <span className=\"hidden sm:inline\">Chatwoot</span>\n            </TabsTrigger>\n            <TabsTrigger value=\"evolution\" className=\"gap-2\" data-testid=\"tab-evolution\">\n              <Phone className=\"h-4 w-4\" />\n              <span className=\"hidden sm:inline\">Evolution</span>\n            </TabsTrigger>\n            <TabsTrigger value=\"typebot\" className=\"gap-2\" data-testid=\"tab-typebot\">\n              <Bot className=\"h-4 w-4\" />\n              <span className=\"hidden sm:inline\">Typebot</span>\n            </TabsTrigger>\n            <TabsTrigger value=\"mailcow\" className=\"gap-2\" data-testid=\"tab-mailcow\">\n              <Mail className=\"h-4 w-4\" />\n              <span className=\"hidden sm:inline\">Mailcow</span>\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"chatwoot\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <MessageSquare className=\"h-5 w-5\" />\n                  Chatwoot Configuration\n                </CardTitle>\n                <CardDescription>\n                  Connect to your Chatwoot instance for customer support and chat management\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <ChatwootSettings />\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"evolution\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Phone className=\"h-5 w-5\" />\n                  Evolution API Configuration\n                </CardTitle>\n                <CardDescription>\n                  Connect to Evolution API for WhatsApp messaging integration\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <EvolutionSettings />\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"typebot\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Bot className=\"h-5 w-5\" />\n                  Typebot Configuration\n                </CardTitle>\n                <CardDescription>\n                  Connect to Typebot for automated chat flows and routing\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <TypebotSettings />\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"mailcow\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Mail className=\"h-5 w-5\" />\n                  Mailcow Configuration\n                </CardTitle>\n                <CardDescription>\n                  Connect to your Mailcow email server for email management\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <MailcowSettings />\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n      )}\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Link2 className=\"h-5 w-5\" />\n            Integration Workflow\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex items-start gap-4\">\n            <div className=\"flex h-8 w-8 items-center justify-center rounded-full bg-primary text-primary-foreground text-sm font-medium\">1</div>\n            <div>\n              <p className=\"font-medium\">Email Flow (Mailcow to Chatwoot)</p>\n              <p className=\"text-sm text-muted-foreground\">Emails to department addresses are forwarded to Chatwoot inboxes</p>\n            </div>\n          </div>\n          <div className=\"flex items-start gap-4\">\n            <div className=\"flex h-8 w-8 items-center justify-center rounded-full bg-primary text-primary-foreground text-sm font-medium\">2</div>\n            <div>\n              <p className=\"font-medium\">WhatsApp Flow (Evolution to Typebot to Chatwoot)</p>\n              <p className=\"text-sm text-muted-foreground\">WhatsApp messages go through Typebot for routing, then to Chatwoot</p>\n            </div>\n          </div>\n          <div className=\"flex items-start gap-4\">\n            <div className=\"flex h-8 w-8 items-center justify-center rounded-full bg-primary text-primary-foreground text-sm font-medium\">3</div>\n            <div>\n              <p className=\"font-medium\">Department Routing</p>\n              <p className=\"text-sm text-muted-foreground\">Conversations are assigned to department teams based on inbox or Typebot selection</p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":36905,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/app-sidebar.tsx":{"content":"import { LayoutDashboard, Users, BarChart3, Activity, Settings, Database, MessageSquare, FormInput, Mail, Building2, UserCog, ClipboardList, Shield, UserPlus, ExternalLink, CheckCircle2, Link2, Inbox, MessageCircle } from \"lucide-react\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarHeader,\n  SidebarFooter,\n} from \"@/components/ui/sidebar\";\nimport { Link, useLocation } from \"wouter\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useQuery } from \"@tanstack/react-query\";\n\ninterface ManagedUser {\n  id: string;\n  platforms: string[];\n  platformUserIds: Record<string, string>;\n}\n\ninterface ServiceConfig {\n  id: string;\n  serviceName: string;\n  apiUrl: string;\n  enabled: boolean;\n}\n\nexport function AppSidebar() {\n  const [location] = useLocation();\n  const { teamMember, hasPermission, isManagement, isDepartmentAdmin, isTechnician, PERMISSION_TYPES } = useAuth();\n\n  const { data: myManagedUser } = useQuery<ManagedUser | null>({\n    queryKey: [\"/api/team-members\", teamMember?.id, \"managed-user\"],\n    queryFn: async () => {\n      if (!teamMember) return null;\n      const res = await fetch(`/api/team-members/${teamMember.id}/managed-user`);\n      if (!res.ok) return null;\n      return res.json();\n    },\n    enabled: !!teamMember?.id,\n  });\n\n  const { data: services = [] } = useQuery<ServiceConfig[]>({\n    queryKey: [\"/api/services\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/services\");\n      if (!res.ok) return [];\n      return res.json();\n    },\n  });\n\n  const mainMenuItems = [\n    {\n      title: \"Dashboard\",\n      url: \"/\",\n      icon: LayoutDashboard,\n      testId: \"nav-dashboard\",\n      show: true,\n    },\n    {\n      title: \"Tasks\",\n      url: \"/tasks\",\n      icon: ClipboardList,\n      testId: \"nav-tasks\",\n      show: hasPermission(PERMISSION_TYPES.VIEW_TASKS),\n    },\n    {\n      title: \"Departments\",\n      url: \"/departments\",\n      icon: Building2,\n      testId: \"nav-departments\",\n      show: hasPermission(PERMISSION_TYPES.VIEW_ALL_DEPARTMENTS) || hasPermission(PERMISSION_TYPES.VIEW_OWN_DEPARTMENT),\n    },\n    {\n      title: \"Team Members\",\n      url: \"/team\",\n      icon: UserCog,\n      testId: \"nav-team\",\n      show: hasPermission(PERMISSION_TYPES.MANAGE_DEPARTMENT_USERS) || hasPermission(PERMISSION_TYPES.MANAGE_GLOBAL_USERS),\n    },\n    {\n      title: \"User Management\",\n      url: \"/users\",\n      icon: Users,\n      testId: \"nav-users\",\n      show: hasPermission(PERMISSION_TYPES.MANAGE_GLOBAL_USERS),\n    },\n    {\n      title: \"Staff Registrations\",\n      url: \"/registrations\",\n      icon: UserPlus,\n      testId: \"nav-registrations\",\n      show: hasPermission(PERMISSION_TYPES.MANAGE_GLOBAL_USERS),\n    },\n    {\n      title: \"Pending Approvals\",\n      url: \"/pending-approvals\",\n      icon: CheckCircle2,\n      testId: \"nav-pending-approvals\",\n      show: isManagement,\n    },\n    {\n      title: \"Analytics\",\n      url: \"/analytics\",\n      icon: BarChart3,\n      testId: \"nav-analytics\",\n      show: hasPermission(PERMISSION_TYPES.VIEW_ANALYTICS),\n    },\n    {\n      title: \"Activity Logs\",\n      url: \"/activity\",\n      icon: Activity,\n      testId: \"nav-activity\",\n      show: hasPermission(PERMISSION_TYPES.VIEW_DEPARTMENT_LOGS) || hasPermission(PERMISSION_TYPES.VIEW_ALL_LOGS),\n    },\n    {\n      title: \"Configuration\",\n      url: \"/config\",\n      icon: Settings,\n      testId: \"nav-config\",\n      show: hasPermission(PERMISSION_TYPES.MANAGE_SERVICE_CONFIG),\n    },\n    {\n      title: \"Integrations\",\n      url: \"/integrations\",\n      icon: Link2,\n      testId: \"nav-integrations\",\n      show: isManagement,\n    },\n    {\n      title: \"Dept. Channels\",\n      url: \"/department-channels\",\n      icon: MessageCircle,\n      testId: \"nav-department-channels\",\n      show: isManagement || isDepartmentAdmin,\n    },\n    {\n      title: \"Inbox\",\n      url: \"/inbox\",\n      icon: Inbox,\n      testId: \"nav-inbox\",\n      show: true,\n    },\n  ];\n\n  const visibleMenuItems = mainMenuItems.filter(item => item.show);\n\n  const platformItems = [\n    {\n      title: \"Metabase\",\n      icon: Database,\n    },\n    {\n      title: \"Chatwoot\",\n      icon: MessageSquare,\n    },\n    {\n      title: \"Typebot\",\n      icon: FormInput,\n    },\n    {\n      title: \"Mailcow\",\n      icon: Mail,\n    },\n  ];\n\n  const getRoleBadge = () => {\n    if (isManagement) return { label: \"Management\", variant: \"default\" as const };\n    if (isDepartmentAdmin) return { label: \"Dept Admin\", variant: \"secondary\" as const };\n    if (isTechnician) return { label: \"Technician\", variant: \"outline\" as const };\n    return null;\n  };\n\n  const roleBadge = getRoleBadge();\n\n  return (\n    <Sidebar>\n      <SidebarHeader className=\"p-4 border-b border-sidebar-border\">\n        <div className=\"flex items-center gap-2\">\n          <div className=\"flex h-9 w-9 items-center justify-center rounded-md bg-primary text-primary-foreground\">\n            <LayoutDashboard className=\"h-5 w-5\" />\n          </div>\n          <div className=\"flex-1 min-w-0\">\n            <h2 className=\"text-lg font-semibold text-sidebar-foreground\">Admin Hub</h2>\n            <div className=\"flex items-center gap-2\">\n              {roleBadge && (\n                <Badge variant={roleBadge.variant} className=\"text-xs\">\n                  {roleBadge.label}\n                </Badge>\n              )}\n              {teamMember?.departmentCode && (\n                <span className=\"text-xs text-muted-foreground\">{teamMember.departmentCode}</span>\n              )}\n            </div>\n          </div>\n        </div>\n      </SidebarHeader>\n      <SidebarContent>\n        <SidebarGroup>\n          <SidebarGroupLabel>Navigation</SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {visibleMenuItems.map((item) => {\n                const isActive = location === item.url;\n                return (\n                  <SidebarMenuItem key={item.title}>\n                    <SidebarMenuButton asChild isActive={isActive} data-testid={item.testId}>\n                      <Link href={item.url}>\n                        <item.icon className=\"h-4 w-4\" />\n                        <span>{item.title}</span>\n                      </Link>\n                    </SidebarMenuButton>\n                  </SidebarMenuItem>\n                );\n              })}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n\n        {myManagedUser && Array.isArray(myManagedUser.platforms) && myManagedUser.platforms.length > 0 && (\n          <SidebarGroup>\n            <SidebarGroupLabel>My Platforms</SidebarGroupLabel>\n            <SidebarGroupContent>\n              <SidebarMenu>\n                {myManagedUser.platforms.map((platformName) => {\n                  const platformInfo = platformItems.find(p => p.title.toLowerCase() === platformName.toLowerCase());\n                  const service = services.find(s => s.serviceName.toLowerCase() === platformName.toLowerCase());\n                  const Icon = platformInfo?.icon || Database;\n                  const displayName = platformInfo?.title || platformName;\n                  \n                  return (\n                    <SidebarMenuItem key={platformName}>\n                      <SidebarMenuButton\n                        onClick={() => {\n                          if (service?.apiUrl) {\n                            window.open(service.apiUrl, '_blank');\n                          }\n                        }}\n                        className=\"cursor-pointer hover:bg-accent\"\n                        data-testid={`platform-${platformName}`}\n                      >\n                        <Icon className=\"h-4 w-4\" />\n                        <span className=\"flex-1\">{displayName}</span>\n                        {service?.apiUrl && <ExternalLink className=\"h-3 w-3 opacity-50\" />}\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  );\n                })}\n              </SidebarMenu>\n            </SidebarGroupContent>\n          </SidebarGroup>\n        )}\n      </SidebarContent>\n      <SidebarFooter className=\"p-4 border-t border-sidebar-border\">\n        <div className=\"space-y-1\">\n          {teamMember && (\n            <p className=\"text-xs text-muted-foreground truncate\">\n              {teamMember.firstName} {teamMember.lastName}\n            </p>\n          )}\n          <p className=\"text-xs text-muted-foreground\">\n            <span className=\"font-semibold\">@DevPulse.Inc</span>\n          </p>\n          <div className=\"text-[10px] opacity-70\">\n            &copy; {new Date().getFullYear()} MM ALL ELECTRONICS\n          </div>\n        </div>\n      </SidebarFooter>\n    </Sidebar>\n  );\n}\n","path":null,"size_bytes":8802,"size_tokens":null},"server/standaloneAuth.ts":{"content":"\n// Standalone Auth integration for admin authentication\nimport * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport { storage } from \"./storage\";\n\nconst getOidcConfig = memoize(\n  async () => {\n    // Return null if required env vars are not set\n    if (!process.env.ISSUER_URL || !process.env.STANDALONE_ID) {\n      console.warn('[auth] Standalone auth: missing ISSUER_URL or STANDALONE_ID, skipping OIDC setup');\n      return null;\n    }\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL),\n      process.env.STANDALONE_ID\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: false,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  const secureFlag = process.env.SESSION_COOKIE_SECURE ? process.env.SESSION_COOKIE_SECURE === 'true' : (process.env.NODE_ENV === 'production');\n  const sameSiteVal = process.env.SESSION_COOKIE_SAME_SITE as any || (secureFlag ? 'none' : 'lax');\n\n  console.log(`[auth] Standalone session cookie secure=${secureFlag} sameSite=${sameSiteVal}`);\n\n  return session({\n    name: process.env.SESSION_COOKIE_NAME || 'adminhub.sid',\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: secureFlag,\n      sameSite: sameSiteVal,\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(\n  claims: any,\n) {\n  await storage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  if (!config) {\n    console.log('[auth] OIDC config not available, skipping OpenID Connect setup');\n    return;\n  }\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    const user = {};\n    updateUserSession(user, tokens);\n    await upsertUser(tokens.claims());\n    verified(null, user);\n  };\n\n  // Keep track of registered strategies\n  const registeredStrategies = new Set<string>();\n\n  // Helper function to ensure strategy exists for a domain\n  const ensureStrategy = (domain: string) => {\n    const strategyName = `standaloneauth:${domain}`;\n    if (!registeredStrategies.has(strategyName)) {\n      const strategy = new Strategy(\n        {\n          name: strategyName,\n          config,\n          scope: \"openid email profile offline_access\",\n          callbackURL: `https://${domain}/api/callback`,\n        },\n        verify,\n      );\n      passport.use(strategy);\n      registeredStrategies.add(strategyName);\n    }\n  };\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`standaloneauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`standaloneauth:${req.hostname}`, {\n      successReturnToOrRedirect: \"/\",\n      failureRedirect: \"/api/login\",\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.STANDALONE_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n","path":null,"size_bytes":5326,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/pages/activity.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Activity, Calendar } from \"lucide-react\";\nimport type { ActivityLog } from \"@shared/schema\";\nimport { format } from \"date-fns\";\n\nexport default function ActivityPage() {\n  const { data: activities, isLoading } = useQuery<ActivityLog[]>({\n    queryKey: [\"/api/activity\"],\n  });\n\n  const getActionBadgeVariant = (action: string) => {\n    if (action.includes(\"create\")) return \"default\";\n    if (action.includes(\"delete\")) return \"destructive\";\n    if (action.includes(\"update\")) return \"secondary\";\n    return \"outline\";\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold text-foreground\">Activity Logs</h1>\n        <p className=\"text-muted-foreground mt-1\">Track all administrative actions and changes</p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Recent Activities</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"rounded-md border border-border\">\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Timestamp</TableHead>\n                  <TableHead>Action</TableHead>\n                  <TableHead>Platform</TableHead>\n                  <TableHead>Target</TableHead>\n                  <TableHead>Details</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {isLoading ? (\n                  Array.from({ length: 8 }).map((_, i) => (\n                    <TableRow key={i}>\n                      <TableCell><Skeleton className=\"h-4 w-32\" /></TableCell>\n                      <TableCell><Skeleton className=\"h-6 w-24\" /></TableCell>\n                      <TableCell><Skeleton className=\"h-6 w-20\" /></TableCell>\n                      <TableCell><Skeleton className=\"h-4 w-28\" /></TableCell>\n                      <TableCell><Skeleton className=\"h-4 w-40\" /></TableCell>\n                    </TableRow>\n                  ))\n                ) : activities && activities.length > 0 ? (\n                  activities.map((activity) => (\n                    <TableRow key={activity.id} data-testid={`activity-row-${activity.id}`}>\n                      <TableCell className=\"text-sm\">\n                        <div className=\"flex items-center gap-2\">\n                          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                          {format(new Date(activity.createdAt), \"MMM dd, yyyy HH:mm\")}\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant={getActionBadgeVariant(activity.action)}>\n                          {activity.action}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        {activity.platform ? (\n                          <Badge variant=\"outline\" className=\"capitalize\">\n                            {activity.platform}\n                          </Badge>\n                        ) : (\n                          <span className=\"text-muted-foreground text-sm\">N/A</span>\n                        )}\n                      </TableCell>\n                      <TableCell className=\"text-sm\">\n                        {activity.targetType || \"N/A\"}\n                      </TableCell>\n                      <TableCell className=\"text-sm text-muted-foreground max-w-md truncate\">\n                        {activity.details\n                          ? typeof activity.details === \"string\"\n                            ? activity.details\n                            : JSON.stringify(activity.details)\n                          : \"No additional details\"}\n                      </TableCell>\n                    </TableRow>\n                  ))\n                ) : (\n                  <TableRow>\n                    <TableCell colSpan={5} className=\"text-center py-12\">\n                      <div className=\"flex flex-col items-center gap-2 text-muted-foreground\">\n                        <Activity className=\"h-12 w-12 opacity-50\" />\n                        <p>No activity logs found</p>\n                        <p className=\"text-sm\">Admin actions will appear here</p>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                )}\n              </TableBody>\n            </Table>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":4754,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { AppSidebar } from \"@/components/app-sidebar\";\nimport { ThemeToggle } from \"@/components/theme-toggle\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Button } from \"@/components/ui/button\";\nimport { LogOut, User } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport Landing from \"@/pages/landing\";\nimport Login from \"@/pages/login\";\nimport Dashboard from \"@/pages/dashboard\";\nimport Users from \"@/pages/users\";\nimport Analytics from \"@/pages/analytics\";\nimport ActivityPage from \"@/pages/activity\";\nimport Config from \"@/pages/config\";\nimport Departments from \"@/pages/departments\";\nimport Team from \"@/pages/team\";\nimport Tasks from \"@/pages/tasks\";\nimport Profile from \"@/pages/profile\";\nimport NotFound from \"@/pages/not-found\";\nimport Register from \"@/pages/register\";\nimport Registrations from \"@/pages/registrations\";\nimport PendingApprovals from \"@/pages/pending-approvals\";\nimport Integrations from \"@/pages/integrations\";\nimport DepartmentChannels from \"@/pages/department-channels\";\nimport Inbox from \"@/pages/inbox\";\n\nfunction AuthenticatedLayout({ children }: { children: React.ReactNode }) {\n  const { user } = useAuth();\n\n  const handleLogout = () => {\n    window.location.href = \"/api/logout\";\n  };\n\n  return (\n    <SidebarProvider\n      style={\n        {\n          \"--sidebar-width\": \"16rem\",\n          \"--sidebar-width-icon\": \"3rem\",\n        } as React.CSSProperties\n      }\n    >\n      <div className=\"flex h-screen w-full\">\n        <AppSidebar />\n        <div className=\"flex flex-col flex-1 overflow-hidden\">\n          <header className=\"flex items-center justify-between gap-2 p-4 border-b border-border bg-background sticky top-0 z-10\">\n            <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n            <div className=\"flex items-center gap-2\">\n              <ThemeToggle />\n              <DropdownMenu>\n                <DropdownMenuTrigger asChild>\n                  <Button variant=\"ghost\" size=\"icon\" className=\"rounded-full\" data-testid=\"button-user-menu\">\n                    <Avatar className=\"h-9 w-9\">\n                      <AvatarImage src={user?.profileImageUrl || undefined} className=\"object-cover\" />\n                      <AvatarFallback>\n                        {user?.firstName?.[0] || user?.email?.[0]?.toUpperCase() || \"A\"}\n                      </AvatarFallback>\n                    </Avatar>\n                  </Button>\n                </DropdownMenuTrigger>\n                <DropdownMenuContent align=\"end\">\n                  <DropdownMenuLabel>\n                    <div className=\"flex flex-col\">\n                      <span className=\"font-medium\">\n                        {user?.firstName && user?.lastName\n                          ? `${user.firstName} ${user.lastName}`\n                          : user?.email || \"Admin\"}\n                      </span>\n                      {user?.email && (\n                        <span className=\"text-xs text-muted-foreground\">{user.email}</span>\n                      )}\n                    </div>\n                  </DropdownMenuLabel>\n                  <DropdownMenuSeparator />\n                  <Link href=\"/profile\">\n                    <DropdownMenuItem data-testid=\"button-profile\">\n                      <User className=\"h-4 w-4 mr-2\" />\n                      Profile Settings\n                    </DropdownMenuItem>\n                  </Link>\n                  <DropdownMenuItem onClick={handleLogout} data-testid=\"button-logout\">\n                    <LogOut className=\"h-4 w-4 mr-2\" />\n                    Logout\n                  </DropdownMenuItem>\n                </DropdownMenuContent>\n              </DropdownMenu>\n            </div>\n          </header>\n          <main className=\"flex-1 overflow-auto p-6 bg-background\">\n            {children}\n          </main>\n        </div>\n      </div>\n    </SidebarProvider>\n  );\n}\n\nfunction Router() {\n  const { isAuthenticated, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"text-center\">\n          <div className=\"text-lg text-muted-foreground\">Loading...</div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return (\n      <Switch>\n        <Route path=\"/login\" component={Login} />\n        <Route path=\"/register\" component={Register} />\n        <Route component={Landing} />\n      </Switch>\n    );\n  }\n\n  return (\n    <AuthenticatedLayout>\n      <Switch>\n        <Route path=\"/\" component={Dashboard} />\n        <Route path=\"/tasks\" component={Tasks} />\n        <Route path=\"/users\" component={Users} />\n        <Route path=\"/departments\" component={Departments} />\n        <Route path=\"/team\" component={Team} />\n        <Route path=\"/analytics\" component={Analytics} />\n        <Route path=\"/activity\" component={ActivityPage} />\n        <Route path=\"/config\" component={Config} />\n        <Route path=\"/profile\" component={Profile} />\n        <Route path=\"/registrations\" component={Registrations} />\n        <Route path=\"/pending-approvals\" component={PendingApprovals} />\n        <Route path=\"/integrations\" component={Integrations} />\n        <Route path=\"/department-channels\" component={DepartmentChannels} />\n        <Route path=\"/inbox\" component={Inbox} />\n        <Route component={NotFound} />\n      </Switch>\n    </AuthenticatedLayout>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <TooltipProvider>\n        <Router />\n        <Toaster />\n      </TooltipProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":6172,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"post-deploy.sh":{"content":"#!/bin/bash\n\n# Post-deployment setup script\n# Run this after containers are up to initialize the database\n\necho \"================================\"\necho \"AdminHub Post-Deployment Setup\"\necho \"================================\"\necho \"\"\n\n# Wait for database to be ready\necho \"⏳ Waiting for PostgreSQL to be ready...\"\nfor i in {1..30}; do\n    if docker exec adminhub-postgres pg_isready -U postgres &> /dev/null; then\n        echo \"✅ PostgreSQL is ready\"\n        break\n    fi\n    echo \"Attempt $i/30 - waiting for database...\"\n    sleep 1\ndone\n\necho \"\"\necho \"🔄 Running database migrations...\"\ndocker exec adminhub-app npx drizzle-kit migrate --config drizzle.config.ts\n\necho \"\"\necho \"🌱 Seeding database...\"\ndocker exec adminhub-app npx tsx server/seed.ts\n\necho \"\"\necho \"✅ Database setup complete!\"\necho \"\"\necho \"Login credentials:\"\necho \"  Email: admin@company.com\"\necho \"  Password: admin123\"\necho \"\"\necho \"⚠️  IMPORTANT: Change the admin password immediately after first login!\"\necho \"\"\n","path":null,"size_bytes":1000,"size_tokens":null},"client/src/pages/landing.tsx":{"content":"import { Link } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { LayoutDashboard, Users, BarChart3, Shield, Zap, Database } from \"lucide-react\";\n\nexport default function Landing() {\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <header className=\"border-b border-border\">\n        <div className=\"container mx-auto px-6 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-primary text-primary-foreground\">\n                <LayoutDashboard className=\"h-6 w-6\" />\n              </div>\n              <span className=\"text-xl font-semibold\">Admin Hub</span>\n            </div>\n            <Link href=\"/login\">\n              <Button data-testid=\"button-login\">\n                Sign In\n              </Button>\n            </Link>\n          </div>\n        </div>\n      </header>\n\n      <main className=\"container mx-auto px-6 py-16\">\n        <div className=\"max-w-4xl mx-auto text-center space-y-8\">\n          <div className=\"space-y-4\">\n            <h1 className=\"text-5xl font-bold tracking-tight\">\n              Unified Platform Management\n            </h1>\n            <p className=\"text-xl text-muted-foreground max-w-2xl mx-auto\">\n              Centralize control over Metabase, Chatwoot, Typebot, and Mailcow.\n              Manage users, monitor analytics, and streamline operations from one powerful dashboard.\n            </p>\n          </div>\n\n          <div className=\"flex justify-center gap-4\">\n            <Link href=\"/login\">\n              <Button size=\"lg\" data-testid=\"button-get-started\">\n                Get Started\n              </Button>\n            </Link>\n            <Link href=\"/register\">\n              <Button size=\"lg\" variant=\"outline\">\n                Staff Registration\n              </Button>\n            </Link>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6 mt-16\">\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"flex flex-col items-center text-center space-y-4\">\n                  <div className=\"flex h-12 w-12 items-center justify-center rounded-md bg-primary/10 text-primary\">\n                    <Users className=\"h-6 w-6\" />\n                  </div>\n                  <h3 className=\"text-lg font-semibold\">User Management</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Create, edit, and manage user accounts across all platforms from a single interface.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"flex flex-col items-center text-center space-y-4\">\n                  <div className=\"flex h-12 w-12 items-center justify-center rounded-md bg-primary/10 text-primary\">\n                    <BarChart3 className=\"h-6 w-6\" />\n                  </div>\n                  <h3 className=\"text-lg font-semibold\">Analytics Dashboard</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Monitor key metrics, track conversations, and visualize platform performance.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"flex flex-col items-center text-center space-y-4\">\n                  <div className=\"flex h-12 w-12 items-center justify-center rounded-md bg-primary/10 text-primary\">\n                    <Shield className=\"h-6 w-6\" />\n                  </div>\n                  <h3 className=\"text-lg font-semibold\">Activity Tracking</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Comprehensive audit logs for all admin actions and platform changes.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <div className=\"mt-16 pt-16 border-t border-border\">\n            <h2 className=\"text-2xl font-semibold mb-8\">Supported Platforms</h2>\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n              <Card>\n                <CardContent className=\"p-4\">\n                  <div className=\"flex flex-col items-center gap-2\">\n                    <Database className=\"h-8 w-8 text-primary\" />\n                    <span className=\"font-medium\">Metabase</span>\n                  </div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"p-4\">\n                  <div className=\"flex flex-col items-center gap-2\">\n                    <Zap className=\"h-8 w-8 text-primary\" />\n                    <span className=\"font-medium\">Chatwoot</span>\n                  </div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"p-4\">\n                  <div className=\"flex flex-col items-center gap-2\">\n                    <LayoutDashboard className=\"h-8 w-8 text-primary\" />\n                    <span className=\"font-medium\">Typebot</span>\n                  </div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"p-4\">\n                  <div className=\"flex flex-col items-center gap-2\">\n                    <Shield className=\"h-8 w-8 text-primary\" />\n                    <span className=\"font-medium\">Mailcow</span>\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n          </div>\n        </div>\n      </main>\n\n      <footer className=\"border-t border-border mt-24\">\n        <div className=\"container mx-auto px-6 py-8\">\n          <p className=\"text-center text-sm text-muted-foreground\">\n            <span className=\"font-semibold\">@DevPulse.Inc</span>\n          </p>\n        </div>\n      </footer>\n    </div>\n  );\n}\n","path":null,"size_bytes":6103,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"server/db.ts":{"content":"// Database connection setup - Local PostgreSQL\nimport pkg from 'pg';\nconst { Pool } = pkg;\nimport { drizzle } from 'drizzle-orm/node-postgres';\nimport * as schema from \"@shared/schema\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n","path":null,"size_bytes":452,"size_tokens":null},"client/src/pages/users.tsx":{"content":"/**\n * @fileoverview Managed Users page\n * Copyright (c) 2025 DevPulse.Inc\n * Designed for MM ALL ELECTRONICS\n *\n * Description: Manage platform users and mappings to internal team members.\n */\nimport { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { insertManagedUserSchema, type ManagedUser, type InsertManagedUser } from \"@shared/schema\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Plus, Search, Edit, Trash2, UserX, UserCheck } from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\n\nexport default function Users() {\n  const { toast } = useToast();\n  type GeneratedEmail = { email: string; password: string } | null;\n  const [generatedEmail, setGeneratedEmail] = useState<GeneratedEmail>(null);\n  const [showProvisionModal, setShowProvisionModal] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [platformFilter, setPlatformFilter] = useState<string>(\"all\");\n  const [statusFilter, setStatusFilter] = useState<string>(\"all\");\n  const [isCreateOpen, setIsCreateOpen] = useState(false);\n  const [editingUser, setEditingUser] = useState<ManagedUser | null>(null);\n  const [deletingUser, setDeletingUser] = useState<ManagedUser | null>(null);\n\n  const { data: users, isLoading } = useQuery<ManagedUser[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  // Use a flexible form type so we can include UI-only fields (provisionMailbox)\n  const form = useForm<any>({\n    resolver: zodResolver(insertManagedUserSchema),\n    defaultValues: {\n      email: \"\",\n      fullName: \"\",\n      platforms: [],\n      role: \"\",\n      status: \"active\",\n      platformUserIds: {},\n      roles: {},\n      teamMemberId: \"\",\n      provisionMailbox: true,\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: InsertManagedUser) => {\n      return await apiRequest(\"/api/users\", \"POST\", data);\n    },\n    onSuccess: (resp: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stats\"] });\n      setIsCreateOpen(false);\n      form.reset();\n      toast({\n        title: \"User created\",\n        description: \"The user has been created successfully.\",\n      });\n      // If backend returned generatedEmail (mailbox provisioning), show modal\n      try {\n        if (resp && resp.generatedEmail) {\n          setGeneratedEmail(resp.generatedEmail);\n          setShowProvisionModal(true);\n        }\n      } catch (e) {\n        console.warn('No generatedEmail in response', e);\n      }\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to create user. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Load team members for the dropdown so admin can attach a managed user to a team member\n  const { data: teamMembers } = useQuery({\n    queryKey: [\"/api/team-members\"],\n    queryFn: async () => await apiRequest(\"/api/team-members\", \"GET\"),\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: InsertManagedUser }) => {\n      return await apiRequest(`/api/users/${id}`, \"PATCH\", data);\n    },\n    onSuccess: (resp: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      setEditingUser(null);\n      form.reset();\n      toast({\n        title: \"User updated\",\n        description: \"The user has been updated successfully.\",\n      });\n      try {\n        if (resp && resp.generatedEmail) {\n          setGeneratedEmail(resp.generatedEmail);\n          setShowProvisionModal(true);\n        }\n      } catch (e) {\n        console.warn(\"No generatedEmail in update response\", e);\n      }\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to update user. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(`/api/users/${id}`, \"DELETE\", undefined);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stats\"] });\n      setDeletingUser(null);\n      toast({\n        title: \"User deleted\",\n        description: \"The user has been deleted successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete user. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const filteredUsers = users?.filter((user) => {\n    const matchesSearch =\n      user.fullName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      user.email.toLowerCase().includes(searchQuery.toLowerCase());\n    const matchesPlatform = platformFilter === \"all\" || (Array.isArray(user.platforms) && user.platforms.includes(platformFilter));\n    const matchesStatus = statusFilter === \"all\" || user.status === statusFilter;\n    return matchesSearch && matchesPlatform && matchesStatus;\n  });\n\n  const handleCreate = () => {\n    form.reset({\n      email: \"\",\n      fullName: \"\",\n      platforms: [],\n      role: \"\",\n      status: \"active\",\n      platformUserIds: {},\n      roles: {},\n    });\n    setIsCreateOpen(true);\n  };\n\n  const handleEdit = (user: ManagedUser) => {\n    form.reset({\n      email: user.email,\n      fullName: user.fullName,\n      platforms: Array.isArray(user.platforms) ? user.platforms : [],\n      role: user.role || \"\",\n      status: user.status,\n      platformUserIds: user.platformUserIds || {},\n      roles: user.roles || {},\n      teamMemberId: (user as any).teamMemberId || \"\",\n      // default to false when editing to avoid accidental reprovision\n      provisionMailbox: false,\n    });\n    setEditingUser(user);\n  };\n\n  const onSubmit = (data: InsertManagedUser) => {\n    if (editingUser) {\n      updateMutation.mutate({ id: editingUser.id, data });\n    } else {\n      createMutation.mutate(data);\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold text-foreground\">User Management</h1>\n          <p className=\"text-muted-foreground mt-1\">Manage users across all platforms</p>\n        </div>\n        <Button onClick={handleCreate} data-testid=\"button-add-user\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Add User\n        </Button>\n      </div>\n\n      <div className=\"flex flex-col sm:flex-row gap-4\">\n        <div className=\"relative flex-1\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search by name or email...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"input-search\"\n          />\n        </div>\n        <Select value={platformFilter} onValueChange={setPlatformFilter}>\n          <SelectTrigger className=\"w-full sm:w-48\" data-testid=\"select-platform-filter\">\n            <SelectValue placeholder=\"Filter by platform\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Platforms</SelectItem>\n            <SelectItem value=\"metabase\">Metabase</SelectItem>\n            <SelectItem value=\"chatwoot\">Chatwoot</SelectItem>\n            <SelectItem value=\"typebot\">Typebot</SelectItem>\n            <SelectItem value=\"mailcow\">Mailcow</SelectItem>\n          </SelectContent>\n        </Select>\n        <Select value={statusFilter} onValueChange={setStatusFilter}>\n          <SelectTrigger className=\"w-full sm:w-48\" data-testid=\"select-status-filter\">\n            <SelectValue placeholder=\"Filter by status\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Statuses</SelectItem>\n            <SelectItem value=\"active\">Active</SelectItem>\n            <SelectItem value=\"inactive\">Inactive</SelectItem>\n            <SelectItem value=\"suspended\">Suspended</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"rounded-md border border-border\">\n        <Table>\n          <TableHeader>\n            <TableRow>\n              <TableHead>Name</TableHead>\n              <TableHead>Email</TableHead>\n              <TableHead>Platform</TableHead>\n              <TableHead>Role</TableHead>\n              <TableHead>Status</TableHead>\n              <TableHead className=\"text-right\">Actions</TableHead>\n            </TableRow>\n          </TableHeader>\n          <TableBody>\n            {isLoading ? (\n              Array.from({ length: 5 }).map((_, i) => (\n                <TableRow key={i}>\n                  <TableCell><Skeleton className=\"h-4 w-32\" /></TableCell>\n                  <TableCell><Skeleton className=\"h-4 w-40\" /></TableCell>\n                  <TableCell><Skeleton className=\"h-4 w-24\" /></TableCell>\n                  <TableCell><Skeleton className=\"h-4 w-20\" /></TableCell>\n                  <TableCell><Skeleton className=\"h-6 w-16\" /></TableCell>\n                  <TableCell className=\"text-right\"><Skeleton className=\"h-8 w-20 ml-auto\" /></TableCell>\n                </TableRow>\n              ))\n            ) : filteredUsers && filteredUsers.length > 0 ? (\n              filteredUsers.map((user) => (\n                <TableRow key={user.id} data-testid={`user-row-${user.id}`}>\n                  <TableCell className=\"font-medium\">{user.fullName}</TableCell>\n                  <TableCell>{user.email}</TableCell>\n                  <TableCell>\n                    <div className=\"flex gap-1 flex-wrap\">\n                      {Array.isArray(user.platforms) && user.platforms.length > 0 ? (\n                        user.platforms.map((platform) => (\n                          <Badge key={platform} variant=\"outline\" className=\"capitalize\">\n                            {platform}\n                          </Badge>\n                        ))\n                      ) : (\n                        <span className=\"text-muted-foreground text-sm\">None</span>\n                      )}\n                      {/* Mailbox indicator */}\n                      {(user.platformUserIds && (user.platformUserIds as any).mailcow) && (\n                        <Badge variant=\"secondary\">Mailbox</Badge>\n                      )}\n                    </div>\n                  </TableCell>\n                  <TableCell className=\"capitalize\">{user.role || \"N/A\"}</TableCell>\n                  <TableCell>\n                    <Badge\n                      variant={\n                        user.status === \"active\"\n                          ? \"default\"\n                          : user.status === \"suspended\"\n                          ? \"destructive\"\n                          : \"secondary\"\n                      }\n                      className=\"capitalize\"\n                    >\n                      {user.status}\n                    </Badge>\n                  </TableCell>\n                  <TableCell className=\"text-right\">\n                    <div className=\"flex justify-end gap-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => handleEdit(user)}\n                        data-testid={`button-edit-${user.id}`}\n                      >\n                        <Edit className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => setDeletingUser(user)}\n                        data-testid={`button-delete-${user.id}`}\n                      >\n                        <Trash2 className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))\n            ) : (\n              <TableRow>\n                <TableCell colSpan={6} className=\"text-center py-12\">\n                  <div className=\"flex flex-col items-center gap-2 text-muted-foreground\">\n                    <UserX className=\"h-12 w-12 opacity-50\" />\n                    <p>No users found</p>\n                    {(searchQuery || platformFilter !== \"all\" || statusFilter !== \"all\") && (\n                      <Button\n                        variant=\"link\"\n                        onClick={() => {\n                          setSearchQuery(\"\");\n                          setPlatformFilter(\"all\");\n                          setStatusFilter(\"all\");\n                        }}\n                      >\n                        Clear filters\n                      </Button>\n                    )}\n                  </div>\n                </TableCell>\n              </TableRow>\n            )}\n          </TableBody>\n        </Table>\n      </div>\n\n      {/* Create/Edit Dialog */}\n      <Dialog open={isCreateOpen || !!editingUser} onOpenChange={(open) => {\n        if (!open) {\n          setIsCreateOpen(false);\n          setEditingUser(null);\n          form.reset();\n        }\n      }}>\n        <DialogContent data-testid=\"dialog-user-form\">\n          <DialogHeader>\n            <DialogTitle>{editingUser ? \"Edit User\" : \"Create User\"}</DialogTitle>\n            <DialogDescription>\n              {editingUser ? \"Update user information\" : \"Add a new user to the platform\"}\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"fullName\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Full Name</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"John Doe\" data-testid=\"input-fullname\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"email\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Email</FormLabel>\n                    <FormControl>\n                      <Input {...field} type=\"email\" placeholder=\"john@example.com\" data-testid=\"input-email\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"platforms\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Platforms</FormLabel>\n                    <div className=\"space-y-2\">\n                      {[\"metabase\", \"chatwoot\", \"typebot\", \"mailcow\"].map((platform) => (\n                        <div key={platform} className=\"flex items-center space-x-2\">\n                          <Checkbox\n                            id={`platform-${platform}`}\n                            checked={Array.isArray(field.value) && field.value.includes(platform)}\n                            onCheckedChange={(checked) => {\n                              const currentPlatforms = Array.isArray(field.value) ? field.value : [];\n                              if (checked) {\n                                field.onChange([...currentPlatforms, platform]);\n                              } else {\n                                field.onChange(currentPlatforms.filter((p) => p !== platform));\n                              }\n                            }}\n                            data-testid={`checkbox-platform-${platform}`}\n                          />\n                          <label\n                            htmlFor={`platform-${platform}`}\n                            className=\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 capitalize cursor-pointer\"\n                          >\n                            {platform}\n                          </label>\n                        </div>\n                      ))}\n                    </div>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              {/* Team Member (optional) */}\n              <FormField\n                control={form.control}\n                name=\"teamMemberId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Team Member (optional)</FormLabel>\n                    <FormControl>\n                      <Select value={field.value} onValueChange={field.onChange}>\n                        <SelectTrigger data-testid=\"select-team-member\">\n                          <SelectValue placeholder=\"Link to a team member (for department)\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"\">None</SelectItem>\n                          {Array.isArray(teamMembers) && teamMembers.map((tm: any) => (\n                            <SelectItem key={tm.id} value={tm.id}>{tm.firstName} {tm.lastName} — {tm.email}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              {/* Provision mailbox toggle */}\n              <FormItem>\n                <div className=\"flex items-center space-x-2\">\n                  <Checkbox\n                    id=\"provision-mailbox\"\n                    checked={!!form.getValues().provisionMailbox}\n                    onCheckedChange={(val) => form.setValue('provisionMailbox', !!val)}\n                    data-testid=\"checkbox-provision-mailbox\"\n                  />\n                  <label htmlFor=\"provision-mailbox\" className=\"text-sm\">Provision Mailbox (Mailcow)</label>\n                </div>\n              </FormItem>\n              <FormField\n                control={form.control}\n                name=\"role\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Role</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"Admin, Agent, Viewer, etc.\" data-testid=\"input-role\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"status\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Status</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-status\">\n                          <SelectValue placeholder=\"Select status\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"active\">Active</SelectItem>\n                        <SelectItem value=\"inactive\">Inactive</SelectItem>\n                        <SelectItem value=\"suspended\">Suspended</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <DialogFooter>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => {\n                    setIsCreateOpen(false);\n                    setEditingUser(null);\n                    form.reset();\n                  }}\n                  data-testid=\"button-cancel\"\n                >\n                  Cancel\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={createMutation.isPending || updateMutation.isPending}\n                  data-testid=\"button-save-user\"\n                >\n                  {createMutation.isPending || updateMutation.isPending ? \"Saving...\" : \"Save\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Confirmation Dialog */}\n      <Dialog open={!!deletingUser} onOpenChange={(open) => !open && setDeletingUser(null)}>\n        <DialogContent data-testid=\"dialog-delete-confirm\">\n          <DialogHeader>\n            <DialogTitle>Delete User</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete {deletingUser?.fullName}? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setDeletingUser(null)}\n              data-testid=\"button-cancel-delete\"\n            >\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => deletingUser && deleteMutation.mutate(deletingUser.id)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n        {/* Provisioned Email Modal */}\n        <Dialog open={showProvisionModal} onOpenChange={(open) => { if (!open) { setShowProvisionModal(false); setGeneratedEmail(null); } }}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Email Provisioned</DialogTitle>\n              <DialogDescription>\n                This password will only be shown once. Copy or download the credentials now.\n              </DialogDescription>\n            </DialogHeader>\n\n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"text-sm font-medium\">Email</label>\n                <div className=\"flex items-center justify-between gap-4\">\n                  <code className=\"break-all\">{generatedEmail?.email}</code>\n                  <div className=\"flex gap-2\">\n                    <Button onClick={async () => { if (generatedEmail?.email) { await navigator.clipboard.writeText(generatedEmail.email); toast({ title: 'Copied', description: 'Email copied to clipboard' }); } }}>Copy</Button>\n                  </div>\n                </div>\n              </div>\n\n              <div>\n                <label className=\"text-sm font-medium\">Password</label>\n                <div className=\"flex items-center justify-between gap-4\">\n                  <code className=\"break-all\">{generatedEmail?.password}</code>\n                  <div className=\"flex gap-2\">\n                    <Button onClick={async () => { if (generatedEmail?.password) { await navigator.clipboard.writeText(generatedEmail.password); toast({ title: 'Copied', description: 'Password copied to clipboard' }); } }}>Copy</Button>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"flex justify-end gap-2\">\n                <Button onClick={() => {\n                  // download CSV\n                  if (!generatedEmail) return;\n                  const content = `email,password\\n${generatedEmail.email},${generatedEmail.password}\\n`;\n                  const blob = new Blob([content], { type: 'text/csv' });\n                  const url = URL.createObjectURL(blob);\n                  const a = document.createElement('a');\n                  a.href = url;\n                  a.download = `credentials-${generatedEmail.email.replace(/[@]/g, '-')}.csv`;\n                  a.click();\n                  URL.revokeObjectURL(url);\n                }}>Download</Button>\n                <Button onClick={() => { setShowProvisionModal(false); setGeneratedEmail(null); }}>Done</Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":25999,"size_tokens":null},"fix-fk-constraint.ts":{"content":"import \"dotenv/config\";\nimport pkg from 'pg';\nconst { Client } = pkg;\n\nconst connectionString = process.env.DATABASE_URL || 'postgresql://postgres:postgres@localhost:5432/postgres';\n\nconst migrations = [\n  // Drop the old foreign key constraint by its actual name\n  `ALTER TABLE \"activity_logs\" DROP CONSTRAINT IF EXISTS \"activity_logs_admin_id_users_id_fk\"`,\n  `ALTER TABLE \"activity_logs\" DROP CONSTRAINT IF EXISTS \"activity_logs_admin_id_team_members_id_fk\"`,\n  \n  // Add the new foreign key constraint referencing team_members instead of users\n  `ALTER TABLE \"activity_logs\" ADD CONSTRAINT \"activity_logs_admin_id_team_members_id_fk\" FOREIGN KEY (\"admin_id\") REFERENCES \"team_members\"(\"id\") ON DELETE CASCADE`,\n];\n\nasync function runMigrations() {\n  const client = new Client({ connectionString });\n  try {\n    await client.connect();\n    console.log('✓ Connected to database\\n');\n    \n    for (const migration of migrations) {\n      const shortSQL = migration.substring(0, 80).replace(/\\n/g, ' ');\n      process.stdout.write(`Running: ${shortSQL}... `);\n      try {\n        await client.query(migration);\n        console.log('✓');\n      } catch (e) {\n        if (e.code === '42710') {\n          console.log('(already exists)');\n        } else {\n          throw e;\n        }\n      }\n    }\n    console.log('\\n✅ All migrations completed successfully!');\n    process.exit(0);\n  } catch (error) {\n    console.error('❌ Migration failed:', error);\n    process.exit(1);\n  } finally {\n    await client.end();\n  }\n}\n\nrunMigrations();\n","path":null,"size_bytes":1537,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"docs/TIERED_SUPPORT_IMPLEMENTATION_GUIDE.md":{"content":"# Tiered Support System - Implementation Guide\n\n## Overview\n\nThe Admin Hub implements a tiered support architecture where:\n- **Parent Email** (support@allelectronics.co.za) - Messages go to ALL staff\n- **Department Emails** (ha@, hhp@, dtv@) - Messages only visible to that department's team\n\n## Current Setup\n\n### Teams Created (via seed)\n\n| Team Name | Code | Type | Email Address | Who Sees It |\n|-----------|------|------|---------------|-------------|\n| All Staff | all_staff | all_staff | support@allelectronics.co.za | Everyone |\n| Home Appliances Team | ha_team | department | ha@allelectronics.co.za | HA staff only |\n| Home Entertainment Products Team | hhp_team | department | hhp@allelectronics.co.za | HHP staff only |\n| Digital Television Team | dtv_team | department | dtv@allelectronics.co.za | DTV staff only |\n\n### Default Admin Account\n\n- **Email**: admin@company.com\n- **Password**: admin123\n- **Role**: Management (full access to all teams)\n\n---\n\n## API Endpoints\n\n### Authentication\n\n```\nPOST /api/auth/login\nBody: { email: string, password: string }\nResponse: { user: TeamMember, message: \"Login successful\" }\n\nPOST /api/auth/logout\nResponse: { message: \"Logged out\" }\n\nGET /api/auth/me\nResponse: TeamMember object (current logged-in user)\n```\n\n### Teams Management\n\n```\nGET /api/teams\n- Returns all teams\n- Requires: Authenticated user\n\nGET /api/teams/:id\n- Get single team by ID\n- Requires: Authenticated user\n\nPOST /api/teams\n- Create new team\n- Requires: Management role\n- Body: { name, code, description, teamType, departmentId?, emailAddress?, isDefault? }\n\nPATCH /api/teams/:id\n- Update team\n- Requires: Management role\n\nDELETE /api/teams/:id\n- Delete team\n- Requires: Management role\n```\n\n### Team Membership\n\n```\nGET /api/teams/:id/members\n- Get all members in a specific team\n- Requires: Authenticated user\n\nPOST /api/teams/:teamId/members/:memberId\n- Add a staff member to a team\n- Requires: Department Admin or higher\n\nDELETE /api/teams/:teamId/members/:memberId\n- Remove a staff member from a team\n- Requires: Department Admin or higher\n```\n\n### User's Own Teams\n\n```\nGET /api/my-teams\n- Get all teams the logged-in user belongs to\n- Use for: Filtering messages by team membership\n\nGET /api/my-team-ids\n- Get just the team IDs (optimized for filtering)\n- Use for: Quick lookups when fetching messages\n\nGET /api/team-members/:id/teams\n- Get teams for a specific staff member\n- Use for: Admin viewing another user's team assignments\n```\n\n---\n\n## How to Use the System\n\n### Step 1: Chatwoot Configuration (Required)\n\nBefore Admin Hub can route messages, you must configure Chatwoot:\n\n1. **Create Chatwoot Inboxes** (one per email):\n   - \"General Support\" inbox → connect to support@allelectronics.co.za\n   - \"HA Direct\" inbox → connect to ha@allelectronics.co.za\n   - \"HHP Direct\" inbox → connect to hhp@allelectronics.co.za\n   - \"DTV Direct\" inbox → connect to dtv@allelectronics.co.za\n\n2. **Create Chatwoot Teams** (matching your Admin Hub teams):\n   - \"All Staff\" team → assign to General Support inbox\n   - \"HA Team\" → assign to HA Direct inbox\n   - \"HHP Team\" → assign to HHP Direct inbox\n   - \"DTV Team\" → assign to DTV Direct inbox\n\n3. **Link Chatwoot IDs to Admin Hub**:\n   Update the teams table with Chatwoot team/inbox IDs:\n   ```\n   PATCH /api/teams/:id\n   Body: { chatwootTeamId: 1, chatwootInboxId: 1 }\n   ```\n\n### Step 2: Staff Registration Flow\n\nWhen new staff register:\n\n1. Staff fills registration form at `/register`\n2. Registration goes to \"pending\" status\n3. Management receives notification\n4. Management approves with OTP verification\n5. On approval:\n   - Staff gets `isVerified = true`\n   - Auto-joined to \"All Staff\" team\n   - Auto-joined to their department's team\n   - Optional: Auto-provisioned in Mailcow + Chatwoot\n\n### Step 3: Fetching Messages for a User\n\nWhen displaying messages in your frontend:\n\n```typescript\n// 1. Get user's team IDs\nconst response = await fetch('/api/my-team-ids');\nconst teamIds = await response.json();\n// Example: ['uuid-all-staff', 'uuid-ha-team']\n\n// 2. Fetch messages from Chatwoot filtered by teams\n// Option A: Use Chatwoot team IDs stored in your teams\nconst teamsResponse = await fetch('/api/my-teams');\nconst teams = await teamsResponse.json();\nconst chatwootTeamIds = teams.map(t => t.chatwootTeamId).filter(Boolean);\n\n// 3. Query Chatwoot API for conversations\n// GET /api/v1/accounts/{account_id}/conversations?team_id={chatwootTeamIds.join(',')}\n\n// 4. Display only messages where teamId is in user's teams\n```\n\n### Step 4: Message Visibility Logic\n\n```typescript\n// Pseudo-code for your message display component\nasync function getVisibleMessages(userId: string) {\n  // Get user's team IDs from Admin Hub\n  const teamIds = await fetch('/api/my-team-ids').then(r => r.json());\n  \n  // Fetch all conversations from Chatwoot\n  const allConversations = await fetchChatwootConversations();\n  \n  // Filter to only show messages for user's teams\n  const visibleMessages = allConversations.filter(conv => \n    teamIds.includes(conv.teamId) || conv.teamId === null\n  );\n  \n  return visibleMessages;\n}\n```\n\n---\n\n## Database Schema\n\n### teams table\n```sql\nid              VARCHAR PRIMARY KEY\nname            VARCHAR(100) NOT NULL UNIQUE\ncode            VARCHAR(30) NOT NULL UNIQUE\ndescription     TEXT\nteam_type       VARCHAR(30) -- 'all_staff', 'department', 'custom'\ndepartment_id   VARCHAR (FK to departments)\nchatwoot_team_id    INTEGER  -- Chatwoot team ID\nchatwoot_inbox_id   INTEGER  -- Chatwoot inbox ID\nemail_address   VARCHAR      -- Email for this team\nis_default      BOOLEAN      -- If true, new staff auto-join\nstatus          VARCHAR(20)\ncreated_at      TIMESTAMP\nupdated_at      TIMESTAMP\n```\n\n### team_member_teams table (junction)\n```sql\nid              VARCHAR PRIMARY KEY\nteam_member_id  VARCHAR NOT NULL (FK to team_members)\nteam_id         VARCHAR NOT NULL (FK to teams)\nadded_at        TIMESTAMP\nadded_by_id     VARCHAR (FK to team_members)\nis_active       BOOLEAN DEFAULT true\n```\n\n---\n\n## Storage Methods Available\n\n```typescript\n// Get all teams\nstorage.getAllTeams(): Promise<Team[]>\n\n// Get specific team\nstorage.getTeam(id: string): Promise<Team | undefined>\nstorage.getTeamByCode(code: string): Promise<Team | undefined>\n\n// Create/Update/Delete teams\nstorage.createTeam(team: InsertTeam): Promise<Team>\nstorage.updateTeam(id: string, team: Partial<InsertTeam>): Promise<Team>\nstorage.deleteTeam(id: string): Promise<void>\n\n// Team membership\nstorage.getTeamsForMember(teamMemberId: string): Promise<Team[]>\nstorage.getTeamIdsForMember(teamMemberId: string): Promise<string[]>\nstorage.getMembersInTeam(teamId: string): Promise<TeamMember[]>\nstorage.addMemberToTeam(teamMemberId: string, teamId: string, addedById?: string): Promise<TeamMemberTeam>\nstorage.removeMemberFromTeam(teamMemberId: string, teamId: string): Promise<void>\nstorage.isMemberInTeam(teamMemberId: string, teamId: string): Promise<boolean>\n\n// Default teams\nstorage.getDefaultTeams(): Promise<Team[]>\nstorage.autoJoinDefaultTeams(teamMemberId: string): Promise<void>\nstorage.getTeamsByDepartment(departmentId: string): Promise<Team[]>\n```\n\n---\n\n## Example Scenarios\n\n### Scenario A: John (Works in HA Department)\n\n**John's Teams**: All Staff + HA Team\n\n**What John sees**:\n- Emails to support@ (via All Staff membership)\n- Emails to ha@ (via HA Team membership)\n- Does NOT see emails to hhp@ or dtv@\n\n### Scenario B: Sarah (Works in HHP Department)\n\n**Sarah's Teams**: All Staff + HHP Team\n\n**What Sarah sees**:\n- Emails to support@ (via All Staff membership)\n- Emails to hhp@ (via HHP Team membership)\n- Does NOT see emails to ha@ or dtv@\n\n### Scenario C: Admin (Management Role)\n\n**Admin's Teams**: All Staff + HA + HHP + DTV\n\n**What Admin sees**:\n- ALL emails from all sources\n\n---\n\n## Integration Checklist\n\n- [ ] Chatwoot inboxes created for each email address\n- [ ] Chatwoot teams created and assigned to inboxes\n- [ ] Admin Hub teams updated with chatwootTeamId and chatwootInboxId\n- [ ] Staff registration form working\n- [ ] Approval flow with OTP working\n- [ ] Auto-join to default teams on approval\n- [ ] Frontend message display filtering by team membership\n- [ ] Reply functionality sending through Chatwoot API\n\n---\n\n## Next Steps\n\n1. **Build Chatwoot Integration**: Connect to Chatwoot API to fetch/send messages\n2. **Build Message UI**: Create the inbox view filtered by user's teams\n3. **Add Real-time Updates**: WebSocket or polling for new messages\n4. **Build Reply Interface**: Allow staff to reply through Admin Hub\n","path":null,"size_bytes":8545,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"add-missing-columns.ts":{"content":"import \"dotenv/config\";\nimport pkg from 'pg';\nconst { Client } = pkg;\n\nconst connectionString = process.env.DATABASE_URL || 'postgresql://postgres:postgres@localhost:5432/postgres';\n\nconst migrations = [\n  // Add missing columns to pending_registrations\n  `ALTER TABLE \"pending_registrations\" ADD COLUMN IF NOT EXISTS \"reviewed_by_id\" varchar REFERENCES \"team_members\"(\"id\")`,\n  `ALTER TABLE \"pending_registrations\" ADD COLUMN IF NOT EXISTS \"reviewed_at\" timestamp`,\n  \n  // Update existing columns to be NOT NULL where needed\n  `ALTER TABLE \"pending_registrations\" ALTER COLUMN \"first_name\" SET NOT NULL`,\n  `ALTER TABLE \"pending_registrations\" ALTER COLUMN \"last_name\" SET NOT NULL`,\n  `ALTER TABLE \"pending_registrations\" ALTER COLUMN \"address_line_1\" SET NOT NULL`,\n  `ALTER TABLE \"pending_registrations\" ALTER COLUMN \"city\" SET NOT NULL`,\n  `ALTER TABLE \"pending_registrations\" ALTER COLUMN \"state\" SET NOT NULL`,\n  `ALTER TABLE \"pending_registrations\" ALTER COLUMN \"postal_code\" SET NOT NULL`,\n  `ALTER TABLE \"pending_registrations\" ALTER COLUMN \"country\" SET NOT NULL`,\n  `ALTER TABLE \"pending_registrations\" ALTER COLUMN \"next_of_kin_1_name\" SET NOT NULL`,\n  `ALTER TABLE \"pending_registrations\" ALTER COLUMN \"next_of_kin_1_relationship\" SET NOT NULL`,\n  `ALTER TABLE \"pending_registrations\" ALTER COLUMN \"next_of_kin_1_phone\" SET NOT NULL`,\n  `ALTER TABLE \"pending_registrations\" ALTER COLUMN \"next_of_kin_2_name\" SET NOT NULL`,\n  `ALTER TABLE \"pending_registrations\" ALTER COLUMN \"next_of_kin_2_relationship\" SET NOT NULL`,\n  `ALTER TABLE \"pending_registrations\" ALTER COLUMN \"next_of_kin_2_phone\" SET NOT NULL`,\n];\n\nasync function runMigrations() {\n  const client = new Client({ connectionString });\n  try {\n    await client.connect();\n    console.log('✓ Connected to database\\n');\n    \n    for (const migration of migrations) {\n      const shortSQL = migration.substring(0, 80).replace(/\\n/g, ' ');\n      process.stdout.write(`Running: ${shortSQL}... `);\n      await client.query(migration);\n      console.log('✓');\n    }\n    console.log('\\n✅ All migrations completed successfully!');\n    process.exit(0);\n  } catch (error) {\n    console.error('❌ Migration failed:', error);\n    process.exit(1);\n  } finally {\n    await client.end();\n  }\n}\n\nrunMigrations();\n","path":null,"size_bytes":2278,"size_tokens":null},"create-all-tables.ts":{"content":"import \"dotenv/config\";\nimport pkg from 'pg';\nconst { Client } = pkg;\n\nconst connectionString = process.env.DATABASE_URL || 'postgresql://postgres:postgres@localhost:5432/postgres';\n\nconst migrations = [\n  // Sessions table\n  `CREATE TABLE IF NOT EXISTS \"sessions\" (\n    \"sid\" varchar PRIMARY KEY NOT NULL,\n    \"sess\" jsonb NOT NULL,\n    \"expire\" timestamp NOT NULL\n  )`,\n  `CREATE INDEX IF NOT EXISTS \"IDX_session_expire\" on \"sessions\" (\"expire\")`,\n\n  // Users table\n  `CREATE TABLE IF NOT EXISTS \"users\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"email\" varchar UNIQUE,\n    \"first_name\" varchar,\n    \"last_name\" varchar,\n    \"profile_image_url\" varchar,\n    \"created_at\" timestamp DEFAULT now(),\n    \"updated_at\" timestamp DEFAULT now()\n  )`,\n\n  // Roles table\n  `CREATE TABLE IF NOT EXISTS \"roles\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"name\" varchar(50) UNIQUE NOT NULL,\n    \"code\" varchar(30) UNIQUE NOT NULL,\n    \"description\" text,\n    \"level\" integer NOT NULL DEFAULT 1,\n    \"created_at\" timestamp DEFAULT now(),\n    \"updated_at\" timestamp DEFAULT now()\n  )`,\n\n  // Permissions table\n  `CREATE TABLE IF NOT EXISTS \"permissions\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"name\" varchar(100) UNIQUE NOT NULL,\n    \"code\" varchar(50) UNIQUE NOT NULL,\n    \"description\" text,\n    \"category\" varchar(50),\n    \"created_at\" timestamp DEFAULT now()\n  )`,\n\n  // Role Permissions table\n  `CREATE TABLE IF NOT EXISTS \"role_permissions\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"role_id\" varchar NOT NULL REFERENCES \"roles\"(\"id\"),\n    \"permission_id\" varchar NOT NULL REFERENCES \"permissions\"(\"id\"),\n    \"created_at\" timestamp DEFAULT now()\n  )`,\n\n  // Departments table\n  `CREATE TABLE IF NOT EXISTS \"departments\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"name\" varchar(255) NOT NULL,\n    \"description\" text,\n    \"email\" varchar UNIQUE,\n    \"phone\" varchar(20),\n    \"created_at\" timestamp DEFAULT now(),\n    \"updated_at\" timestamp DEFAULT now()\n  )`,\n\n  // Team Members table - already exists with new columns, so we'll skip it\n\n  // Service Configs table\n  `CREATE TABLE IF NOT EXISTS \"service_configs\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"service_name\" varchar(100) NOT NULL,\n    \"config_type\" varchar(50) NOT NULL,\n    \"config_value\" jsonb,\n    \"description\" text,\n    \"is_active\" boolean DEFAULT true NOT NULL,\n    \"created_at\" timestamp DEFAULT now(),\n    \"updated_at\" timestamp DEFAULT now()\n  )`,\n\n  // Managed Users table\n  `CREATE TABLE IF NOT EXISTS \"managed_users\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"service_type\" varchar(50) NOT NULL,\n    \"username\" varchar(255) NOT NULL,\n    \"email\" varchar,\n    \"status\" varchar(20) DEFAULT 'active' NOT NULL,\n    \"metadata\" jsonb,\n    \"created_at\" timestamp DEFAULT now(),\n    \"updated_at\" timestamp DEFAULT now()\n  )`,\n\n  // Activity Logs table\n  `CREATE TABLE IF NOT EXISTS \"activity_logs\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"admin_id\" varchar NOT NULL,\n    \"action\" varchar(100) NOT NULL,\n    \"target_type\" varchar(50),\n    \"target_id\" varchar,\n    \"platform\" varchar(50),\n    \"details\" jsonb,\n    \"created_at\" timestamp DEFAULT now()\n  )`,\n\n  // Analytics Metrics table\n  `CREATE TABLE IF NOT EXISTS \"analytics_metrics\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"platform\" varchar(50) NOT NULL,\n    \"metric_type\" varchar(100) NOT NULL,\n    \"metric_value\" integer NOT NULL,\n    \"metric_data\" jsonb,\n    \"period_start\" timestamp,\n    \"period_end\" timestamp,\n    \"created_at\" timestamp DEFAULT now()\n  )`,\n\n  // Tasks table\n  `CREATE TABLE IF NOT EXISTS \"tasks\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"title\" varchar(255) NOT NULL,\n    \"description\" text,\n    \"status\" varchar(50) DEFAULT 'pending' NOT NULL,\n    \"priority\" varchar(20) DEFAULT 'medium' NOT NULL,\n    \"department_id\" varchar NOT NULL REFERENCES \"departments\"(\"id\"),\n    \"created_by_id\" varchar NOT NULL REFERENCES \"team_members\"(\"id\"),\n    \"assigned_to_id\" varchar REFERENCES \"team_members\"(\"id\"),\n    \"due_date\" timestamp,\n    \"completed_at\" timestamp,\n    \"tags\" varchar[],\n    \"created_at\" timestamp DEFAULT now(),\n    \"updated_at\" timestamp DEFAULT now()\n  )`,\n\n  // Task Assignments table\n  `CREATE TABLE IF NOT EXISTS \"task_assignments\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"task_id\" varchar NOT NULL REFERENCES \"tasks\"(\"id\"),\n    \"team_member_id\" varchar NOT NULL REFERENCES \"team_members\"(\"id\"),\n    \"assigned_by_id\" varchar NOT NULL REFERENCES \"team_members\"(\"id\"),\n    \"status\" varchar(50) DEFAULT 'pending' NOT NULL,\n    \"assigned_at\" timestamp DEFAULT now(),\n    \"completed_at\" timestamp\n  )`,\n\n  // Task History table\n  `CREATE TABLE IF NOT EXISTS \"task_history\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"task_id\" varchar NOT NULL REFERENCES \"tasks\"(\"id\"),\n    \"changed_by_id\" varchar NOT NULL REFERENCES \"team_members\"(\"id\"),\n    \"change_type\" varchar(50) NOT NULL,\n    \"old_value\" jsonb,\n    \"new_value\" jsonb,\n    \"created_at\" timestamp DEFAULT now()\n  )`,\n\n  // Worklogs table\n  `CREATE TABLE IF NOT EXISTS \"worklogs\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"task_id\" varchar,\n    \"team_member_id\" varchar NOT NULL REFERENCES \"team_members\"(\"id\"),\n    \"hours_logged\" numeric,\n    \"description\" text,\n    \"log_date\" timestamp DEFAULT now(),\n    \"created_at\" timestamp DEFAULT now(),\n    \"updated_at\" timestamp DEFAULT now()\n  )`,\n\n  // Pending Registrations table\n  `CREATE TABLE IF NOT EXISTS \"pending_registrations\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"email\" varchar UNIQUE NOT NULL,\n    \"password_hash\" text NOT NULL,\n    \"first_name\" varchar(100),\n    \"last_name\" varchar(100),\n    \"phone\" varchar(20),\n    \"department_id\" varchar NOT NULL REFERENCES \"departments\"(\"id\"),\n    \"address_line_1\" varchar(255),\n    \"address_line_2\" varchar(255),\n    \"city\" varchar(100),\n    \"state\" varchar(100),\n    \"postal_code\" varchar(20),\n    \"country\" varchar(100),\n    \"next_of_kin_1_name\" varchar(100),\n    \"next_of_kin_1_relationship\" varchar(50),\n    \"next_of_kin_1_phone\" varchar(20),\n    \"next_of_kin_1_email\" varchar,\n    \"next_of_kin_1_address\" text,\n    \"next_of_kin_2_name\" varchar(100),\n    \"next_of_kin_2_relationship\" varchar(50),\n    \"next_of_kin_2_phone\" varchar(20),\n    \"next_of_kin_2_email\" varchar,\n    \"next_of_kin_2_address\" text,\n    \"status\" varchar(50) DEFAULT 'pending' NOT NULL,\n    \"rejection_reason\" text,\n    \"created_at\" timestamp DEFAULT now(),\n    \"updated_at\" timestamp DEFAULT now()\n  )`,\n\n  // Approval OTPs table\n  `CREATE TABLE IF NOT EXISTS \"approval_otps\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"registration_id\" varchar NOT NULL REFERENCES \"pending_registrations\"(\"id\"),\n    \"otp_code\" varchar(6) NOT NULL,\n    \"expires_at\" timestamp NOT NULL,\n    \"is_used\" boolean DEFAULT false NOT NULL,\n    \"used_at\" timestamp,\n    \"used_by_id\" varchar REFERENCES \"team_members\"(\"id\"),\n    \"created_at\" timestamp DEFAULT now()\n  )`,\n\n  // Admin Notifications table\n  `CREATE TABLE IF NOT EXISTS \"admin_notifications\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"type\" varchar(50) NOT NULL,\n    \"title\" varchar(255) NOT NULL,\n    \"message\" text NOT NULL,\n    \"target_role_level\" integer DEFAULT 3,\n    \"related_entity_type\" varchar(50),\n    \"related_entity_id\" varchar,\n    \"is_read\" boolean DEFAULT false NOT NULL,\n    \"read_by_id\" varchar REFERENCES \"team_members\"(\"id\"),\n    \"read_at\" timestamp,\n    \"metadata\" jsonb,\n    \"created_at\" timestamp DEFAULT now()\n  )`\n];\n\nasync function runMigrations() {\n  const client = new Client({ connectionString });\n  try {\n    await client.connect();\n    console.log('✓ Connected to database\\n');\n    \n    for (const migration of migrations) {\n      const shortSQL = migration.substring(0, 80).replace(/\\n/g, ' ');\n      process.stdout.write(`Running: ${shortSQL}... `);\n      await client.query(migration);\n      console.log('✓');\n    }\n    console.log('\\n✅ All migrations completed successfully!');\n    process.exit(0);\n  } catch (error) {\n    console.error('❌ Migration failed:', error);\n    process.exit(1);\n  } finally {\n    await client.end();\n  }\n}\n\nrunMigrations();\n","path":null,"size_bytes":8476,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"apply-managed-users-teamid.ts":{"content":"import \"dotenv/config\";\nimport pkg from 'pg';\nconst { Client } = pkg;\n\nconst connectionString = process.env.DATABASE_URL || 'postgresql://postgres:postgres@localhost:5432/postgres';\n\nasync function run() {\n  const client = new Client({ connectionString });\n  await client.connect();\n  try {\n    await client.query(`ALTER TABLE managed_users ADD COLUMN IF NOT EXISTS team_member_id varchar`);\n    try {\n      await client.query(`ALTER TABLE managed_users ADD CONSTRAINT managed_users_team_member_id_fk FOREIGN KEY (team_member_id) REFERENCES team_members(id) ON DELETE SET NULL`);\n    } catch (e: any) {\n      if (e.code === '42710') {\n        console.log('constraint already exists, skipping');\n      } else {\n        throw e;\n      }\n    }\n    console.log('✅ Applied managed_users team_member_id migration');\n  } catch (e) {\n    console.error('Migration error', e);\n    process.exit(1);\n  } finally {\n    await client.end();\n    process.exit(0);\n  }\n}\n\nrun();\n","path":null,"size_bytes":963,"size_tokens":null},"client/src/pages/analytics.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  BarChart3,\n  TrendingUp,\n  TrendingDown,\n  Database,\n  MessageSquare,\n  FormInput,\n  Mail,\n} from \"lucide-react\";\nimport { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LineChart, Line } from \"recharts\";\n\nexport default function Analytics() {\n  const { data: metrics, isLoading } = useQuery<any>({\n    queryKey: [\"/api/analytics/metrics\"],\n  });\n\n  const platformData = [\n    { name: \"Metabase\", users: metrics?.metabase?.users || 0, active: metrics?.metabase?.active || 0, icon: Database },\n    { name: \"Chatwoot\", users: metrics?.chatwoot?.users || 0, active: metrics?.chatwoot?.active || 0, icon: MessageSquare },\n    { name: \"Typebot\", users: metrics?.typebot?.users || 0, active: metrics?.typebot?.active || 0, icon: FormInput },\n    { name: \"Mailcow\", users: metrics?.mailcow?.users || 0, active: metrics?.mailcow?.active || 0, icon: Mail },\n  ];\n\n  const conversationData = [\n    { month: \"Jan\", count: 45 },\n    { month: \"Feb\", count: 52 },\n    { month: \"Mar\", count: 61 },\n    { month: \"Apr\", count: 55 },\n    { month: \"May\", count: 67 },\n    { month: \"Jun\", count: 73 },\n  ];\n\n  const submissionData = [\n    { day: \"Mon\", count: 12 },\n    { day: \"Tue\", count: 19 },\n    { day: \"Wed\", count: 15 },\n    { day: \"Thu\", count: 22 },\n    { day: \"Fri\", count: 18 },\n    { day: \"Sat\", count: 8 },\n    { day: \"Sun\", count: 6 },\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold text-foreground\">Analytics</h1>\n        <p className=\"text-muted-foreground mt-1\">Monitor platform performance and user engagement</p>\n      </div>\n\n      <Tabs defaultValue=\"overview\" className=\"space-y-6\">\n        <TabsList>\n          <TabsTrigger value=\"overview\" data-testid=\"tab-overview\">Overview</TabsTrigger>\n          <TabsTrigger value=\"metabase\" data-testid=\"tab-metabase\">Metabase</TabsTrigger>\n          <TabsTrigger value=\"chatwoot\" data-testid=\"tab-chatwoot\">Chatwoot</TabsTrigger>\n          <TabsTrigger value=\"typebot\" data-testid=\"tab-typebot\">Typebot</TabsTrigger>\n          <TabsTrigger value=\"mailcow\" data-testid=\"tab-mailcow\">Mailcow</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"overview\" className=\"space-y-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n            {platformData.map((platform) => {\n              const Icon = platform.icon;\n              const growth = platform.active > 0\n                ? ((platform.active / platform.users) * 100).toFixed(1)\n                : \"0\";\n              return (\n                <Card key={platform.name}>\n                  <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n                    <CardTitle className=\"text-sm font-medium\">{platform.name}</CardTitle>\n                    <Icon className=\"h-4 w-4 text-muted-foreground\" />\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"text-2xl font-bold\">{platform.users}</div>\n                    <div className=\"flex items-center gap-1 mt-1\">\n                      <Badge variant=\"secondary\" className=\"text-xs\">\n                        {platform.active} active\n                      </Badge>\n                      <span className=\"text-xs text-muted-foreground\">\n                        {growth}%\n                      </span>\n                    </div>\n                  </CardContent>\n                </Card>\n              );\n            })}\n          </div>\n\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Conversations Trend</CardTitle>\n              </CardHeader>\n              <CardContent>\n                {isLoading ? (\n                  <Skeleton className=\"h-80 w-full\" />\n                ) : (\n                  <ResponsiveContainer width=\"100%\" height={300}>\n                    <LineChart data={conversationData}>\n                      <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-border\" />\n                      <XAxis\n                        dataKey=\"month\"\n                        className=\"text-xs\"\n                        tick={{ fill: \"hsl(var(--muted-foreground))\" }}\n                      />\n                      <YAxis\n                        className=\"text-xs\"\n                        tick={{ fill: \"hsl(var(--muted-foreground))\" }}\n                      />\n                      <Tooltip\n                        contentStyle={{\n                          backgroundColor: \"hsl(var(--popover))\",\n                          border: \"1px solid hsl(var(--border))\",\n                          borderRadius: \"6px\",\n                        }}\n                      />\n                      <Line\n                        type=\"monotone\"\n                        dataKey=\"count\"\n                        stroke=\"hsl(var(--primary))\"\n                        strokeWidth={2}\n                        dot={{ fill: \"hsl(var(--primary))\", r: 4 }}\n                      />\n                    </LineChart>\n                  </ResponsiveContainer>\n                )}\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle>Form Submissions</CardTitle>\n              </CardHeader>\n              <CardContent>\n                {isLoading ? (\n                  <Skeleton className=\"h-80 w-full\" />\n                ) : (\n                  <ResponsiveContainer width=\"100%\" height={300}>\n                    <BarChart data={submissionData}>\n                      <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-border\" />\n                      <XAxis\n                        dataKey=\"day\"\n                        className=\"text-xs\"\n                        tick={{ fill: \"hsl(var(--muted-foreground))\" }}\n                      />\n                      <YAxis\n                        className=\"text-xs\"\n                        tick={{ fill: \"hsl(var(--muted-foreground))\" }}\n                      />\n                      <Tooltip\n                        contentStyle={{\n                          backgroundColor: \"hsl(var(--popover))\",\n                          border: \"1px solid hsl(var(--border))\",\n                          borderRadius: \"6px\",\n                        }}\n                      />\n                      <Bar dataKey=\"count\" fill=\"hsl(var(--primary))\" radius={[4, 4, 0, 0]} />\n                    </BarChart>\n                  </ResponsiveContainer>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Platform Comparison</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                {platformData.map((platform) => {\n                  const Icon = platform.icon;\n                  const percentage = platform.users > 0\n                    ? ((platform.active / platform.users) * 100).toFixed(0)\n                    : \"0\";\n                  return (\n                    <div key={platform.name} className=\"flex items-center gap-4\">\n                      <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-muted\">\n                        <Icon className=\"h-5 w-5 text-muted-foreground\" />\n                      </div>\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center justify-between mb-1\">\n                          <span className=\"font-medium\">{platform.name}</span>\n                          <span className=\"text-sm text-muted-foreground\">\n                            {platform.active} / {platform.users}\n                          </span>\n                        </div>\n                        <div className=\"h-2 bg-muted rounded-full overflow-hidden\">\n                          <div\n                            className=\"h-full bg-primary transition-all\"\n                            style={{ width: `${percentage}%` }}\n                          />\n                        </div>\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {[\"metabase\", \"chatwoot\", \"typebot\", \"mailcow\"].map((platform) => (\n          <TabsContent key={platform} value={platform} className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Total Users</CardTitle>\n                  <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">\n                    {metrics?.[platform]?.users || 0}\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    All registered users\n                  </p>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Active Users</CardTitle>\n                  <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">\n                    {metrics?.[platform]?.active || 0}\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Currently enabled\n                  </p>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">Activity Rate</CardTitle>\n                  <BarChart3 className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">\n                    {metrics?.[platform]?.users > 0\n                      ? ((metrics[platform].active / metrics[platform].users) * 100).toFixed(1)\n                      : \"0\"}%\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Engagement rate\n                  </p>\n                </CardContent>\n              </Card>\n            </div>\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"capitalize\">{platform} Analytics</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-center py-12 text-muted-foreground\">\n                  <BarChart3 className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                  <p>Detailed {platform} analytics coming soon</p>\n                </div>\n              </CardContent>\n            </Card>\n          </TabsContent>\n        ))}\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":11470,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"server/app.ts":{"content":"import { type Server } from \"node:http\";\n\nimport express, {\n  type Express,\n  type Request,\n  Response,\n  NextFunction,\n} from \"express\";\nimport cors from 'cors';\n\nimport { registerRoutes } from \"./routes\";\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport const app = express();\n\n// trust proxy so secure cookies and forwarded headers are handled correctly\napp.set('trust proxy', 1);\n\ndeclare module 'http' {\n  interface IncomingMessage {\n    rawBody: unknown\n  }\n}\napp.use(express.json({\n  verify: (req, _res, buf) => {\n    req.rawBody = buf;\n  }\n}));\napp.use(express.urlencoded({ extended: false }));\n\n// Optional CORS configuration to allow frontend on a different origin to\n// set cookies via `credentials: include`. Configure via CORS_ORIGIN (comma separated list).\nconst corsOrigin = process.env.CORS_ORIGIN?.trim();\nconst defaultOrigins = [\n  'http://158.220.107.106:8080',\n  'http://158.220.107.106:5000',\n  'http://localhost:5000',\n  'http://localhost:8080',\n];\nconst origins = corsOrigin ? corsOrigin.split(',').map(s => s.trim()) : defaultOrigins;\nconsole.log('[auth] CORS allowed origins:', origins);\napp.use(cors({\n  origin: function (origin, callback) {\n    // In development or Replit environment, allow all origins\n    if (process.env.NODE_ENV === 'development' || process.env.REPL_ID) {\n      return callback(null, true);\n    }\n    // allow requests with no origin (like curl / Postman) as well\n    if (!origin || origins.indexOf(origin) !== -1) return callback(null, true);\n    return callback(new Error('Not allowed by CORS'));\n  },\n  credentials: true,\n} as any));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n// Debug middleware to log Set-Cookie for successful auth endpoints for easier debugging\napp.use((req, res, next) => {\n  // only attach to auth login and callback paths\n  if (req.path === '/api/auth/login' || req.path === '/api/callback') {\n    const originalSend = res.send;\n    res.send = function (body: any) {\n      const cookie = res.getHeader('set-cookie');\n      console.log(`[auth] set-cookie header for ${req.path}:`, cookie);\n      return originalSend.call(this, body);\n    } as any;\n  }\n  next();\n});\n\n// Body parser JSON error handler - produce a friendly 400 instead of crashing\napp.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n  if (err instanceof SyntaxError && 'body' in err) {\n    console.warn('[express] JSON parse error:', err.message);\n    return res.status(400).json({ message: 'Malformed JSON in request body' });\n  }\n  // fallback to other error handlers\n  return _next(err);\n});\n\nexport default async function runApp(\n  setup: (app: Express, server: Server) => Promise<void>,\n) {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly run the final setup after setting up all the other routes so\n  // the catch-all route doesn't interfere with the other routes\n  await setup(app, server);\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen(\n    {\n      port,\n      host: \"0.0.0.0\",\n    },\n    () => {\n      log(`serving on port ${port}`);\n    }\n  );\n}\n","path":null,"size_bytes":4525,"size_tokens":null},"check_ports.sh":{"content":"#!/bin/bash\necho \"Checking which ports are in use...\"\ndocker ps -a --format \"table {{.Names}}\\t{{.Ports}}\"\necho \"\"\necho \"All containers and their port mappings shown above\"\n","path":null,"size_bytes":173,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"deploy.sh":{"content":"#!/bin/bash\n\n# AdminHub Docker Deployment Script\n# Run this on your VPS to deploy the application\n\nset -e\n\necho \"================================\"\necho \"AdminHub Docker Deployment\"\necho \"================================\"\necho \"\"\n\n# Check if Docker is installed\nif ! command -v docker &> /dev/null; then\n    echo \"❌ Docker is not installed. Installing Docker...\"\n    curl -fsSL https://get.docker.com -o get-docker.sh\n    sudo sh get-docker.sh\n    rm get-docker.sh\n    sudo usermod -aG docker $USER\n    echo \"✅ Docker installed successfully\"\nelse\n    echo \"✅ Docker is already installed\"\nfi\n\n# Check if Docker Compose is installed\nif ! command -v docker-compose &> /dev/null; then\n    echo \"❌ Docker Compose is not installed. Installing Docker Compose...\"\n    sudo curl -L \"https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose\n    sudo chmod +x /usr/local/bin/docker-compose\n    echo \"✅ Docker Compose installed successfully\"\nelse\n    echo \"✅ Docker Compose is already installed\"\nfi\n\necho \"\"\necho \"Current working directory: $(pwd)\"\necho \"\"\n\n# Check if docker-compose.yml exists\nif [ ! -f \"docker-compose.yml\" ]; then\n    echo \"❌ Error: docker-compose.yml not found in current directory\"\n    exit 1\nfi\n\n# Check if .env.production exists\nif [ ! -f \".env.production\" ]; then\n    echo \"❌ Error: .env.production not found. Please copy .env.production.example to .env.production\"\n    echo \"   Command: cp .env.production.example .env.production\"\n    exit 1\nfi\n\necho \"✅ Configuration files found\"\necho \"\"\n\n# Build images\necho \"🔨 Building Docker images...\"\ndocker-compose build\n\necho \"\"\necho \"🚀 Starting containers...\"\ndocker-compose up -d\n\necho \"\"\necho \"⏳ Waiting for services to be healthy...\"\nsleep 10\n\n# Check container status\necho \"\"\necho \"📊 Container Status:\"\ndocker-compose ps\n\necho \"\"\necho \"✅ Deployment complete!\"\necho \"\"\necho \"Useful commands:\"\necho \"  View logs:        docker-compose logs -f app\"\necho \"  Stop containers:  docker-compose down\"\necho \"  Restart app:      docker-compose restart app\"\necho \"  Database logs:    docker-compose logs -f postgres\"\necho \"\"\n","path":null,"size_bytes":2179,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"server/run-seed.ts":{"content":"import pkg from 'pg';\nconst { Client } = pkg;\n\nconst connectionString = process.env.DATABASE_URL || 'postgresql://postgres:0109115188087@Kdn@postgres:5432/postgres';\n\nasync function seed() {\n  const client = new Client({ connectionString });\n  try {\n    await client.connect();\n    console.log('✓ Connected to database');\n\n    // Check if super admin already exists\n    const result = await client.query(\n      'SELECT id FROM team_members WHERE email = $1',\n      ['admin@company.com']\n    );\n\n    if (result.rows.length > 0) {\n      console.log('✓ Super admin already exists, skipping seed');\n      process.exit(0);\n    }\n\n    // Create Management role if it doesn't exist\n    console.log('Creating/checking Management role...');\n    await client.query(`\n      INSERT INTO roles (name, code, description, level)\n      VALUES ('Management', 'management', 'Full access to all departments and global user management', 3)\n      ON CONFLICT (code) DO NOTHING\n    `);\n    const roleResult = await client.query(\n      'SELECT id FROM roles WHERE code = $1',\n      ['management']\n    );\n    const roleId = roleResult.rows[0].id;\n    console.log('  ✓ Management role ready (ID: ' + roleId + ')');\n\n    // Get or create Home Appliances department\n    console.log('Creating/checking Home Appliances department...');\n    await client.query(`\n      INSERT INTO departments (name, code, description, status)\n      VALUES ('Home Appliances', 'HA', 'Home Appliances Division', 'active')\n      ON CONFLICT (code) DO NOTHING\n    `);\n    const deptResult = await client.query(\n      'SELECT id FROM departments WHERE code = $1',\n      ['HA']\n    );\n    const deptId = deptResult.rows[0].id;\n    console.log('  ✓ Department ready (ID: ' + deptId + ')');\n\n    // Hash password: admin123 → bcrypt hash\n    // Using a pre-computed hash: $2a$10$...\n    const passwordHash = '$2a$10$eImiTXuWVxfaHNYY0NyGCeTZ.d4DB3jVgaYvMRLqK8FPz1vQaIJhC';\n\n    // Create super admin\n    console.log('Creating super admin user...');\n    await client.query(`\n      INSERT INTO team_members (\n        department_id, role_id, employee_id, email, first_name, last_name,\n        role, password_hash, phone, status, is_verified\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)\n      ON CONFLICT (email) DO NOTHING\n    `, [\n      deptId,\n      roleId,\n      'ADMIN001',\n      'admin@company.com',\n      'System',\n      'Administrator',\n      'admin',\n      passwordHash,\n      '',\n      'active',\n      true  // isVerified = true for super admin\n    ]);\n\n    const adminResult = await client.query(\n      'SELECT id, email FROM team_members WHERE email = $1',\n      ['admin@company.com']\n    );\n\n    if (adminResult.rows.length > 0) {\n      console.log('✅ Super admin created successfully!');\n      console.log('   Email: admin@company.com');\n      console.log('   Password: admin123');\n      console.log('   Status: Verified (ready to login)');\n    }\n\n    console.log('\\n✅ Seed completed successfully!');\n    process.exit(0);\n  } catch (error) {\n    console.error('❌ Seed failed:', error);\n    process.exit(1);\n  } finally {\n    await client.end();\n  }\n}\n\nseed();\n","path":null,"size_bytes":3146,"size_tokens":null},"client/src/pages/login.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { LayoutDashboard, Eye, EyeOff, AlertCircle, Loader2 } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\nexport default function Login() {\n  const [, setLocation] = useLocation();\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [showPassword, setShowPassword] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  const loginMutation = useMutation({\n    mutationFn: async (credentials: { email: string; password: string }) => {\n      return await apiRequest(\"/api/auth/login\", \"POST\", credentials);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      setLocation(\"/\");\n    },\n    onError: (err: any) => {\n      const message = err?.message || \"Login failed. Please check your credentials.\";\n      setError(message);\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(null);\n    \n    if (!email || !password) {\n      setError(\"Please enter both email and password\");\n      return;\n    }\n\n    loginMutation.mutate({ email, password });\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col\">\n      <header className=\"border-b border-border\">\n        <div className=\"container mx-auto px-6 py-4\">\n          <div className=\"flex items-center gap-2\">\n            <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-primary text-primary-foreground\">\n              <LayoutDashboard className=\"h-6 w-6\" />\n            </div>\n            <span className=\"text-xl font-semibold\">Admin Hub</span>\n          </div>\n        </div>\n      </header>\n\n      <main className=\"flex-1 flex items-center justify-center px-6 py-12\">\n        <Card className=\"w-full max-w-md\">\n          <CardHeader className=\"space-y-1\">\n            <CardTitle className=\"text-2xl font-bold text-center\">Sign In</CardTitle>\n            <CardDescription className=\"text-center\">\n              Enter your credentials to access the platform\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              {error && (\n                <Alert variant=\"destructive\">\n                  <AlertCircle className=\"h-4 w-4\" />\n                  <AlertDescription>{error}</AlertDescription>\n                </Alert>\n              )}\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"email\">Email</Label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  placeholder=\"you@company.com\"\n                  value={email}\n                  onChange={(e) => setEmail(e.target.value)}\n                  disabled={loginMutation.isPending}\n                  data-testid=\"input-email\"\n                  autoComplete=\"email\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"password\">Password</Label>\n                <div className=\"relative\">\n                  <Input\n                    id=\"password\"\n                    type={showPassword ? \"text\" : \"password\"}\n                    placeholder=\"Enter your password\"\n                    value={password}\n                    onChange={(e) => setPassword(e.target.value)}\n                    disabled={loginMutation.isPending}\n                    data-testid=\"input-password\"\n                    autoComplete=\"current-password\"\n                    className=\"pr-10\"\n                  />\n                  <Button\n                    type=\"button\"\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"absolute right-0 top-0 h-full px-3 hover:bg-transparent\"\n                    onClick={() => setShowPassword(!showPassword)}\n                    data-testid=\"button-toggle-password\"\n                  >\n                    {showPassword ? (\n                      <EyeOff className=\"h-4 w-4 text-muted-foreground\" />\n                    ) : (\n                      <Eye className=\"h-4 w-4 text-muted-foreground\" />\n                    )}\n                  </Button>\n                </div>\n              </div>\n\n              <Button \n                type=\"submit\" \n                className=\"w-full\" \n                disabled={loginMutation.isPending}\n                data-testid=\"button-submit-login\"\n              >\n                {loginMutation.isPending ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Signing in...\n                  </>\n                ) : (\n                  \"Sign In\"\n                )}\n              </Button>\n            </form>\n\n            {/* Demo accounts removed for production deployment */}\n\n            <div className=\"mt-6 pt-6 border-t text-center\">\n              <p className=\"text-sm text-muted-foreground mb-2\">New staff member?</p>\n              <Button variant=\"outline\" className=\"w-full\" onClick={() => setLocation(\"/register\")}>\n                Apply for Staff Access\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":5657,"size_tokens":null},"setup_ssh_key.sh":{"content":"#!/bin/bash\necho \"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJjQufPh1aAAMX4ffAln/5jivE7ZuolZZNzHB8tW+/3k ntulodk@allelectronics.co.za\" >> /root/.ssh/authorized_keys\nchmod 600 /root/.ssh/authorized_keys\nsystemctl restart sshd\necho \"SUCCESS: SSH key added and sshd restarted\"\n","path":null,"size_bytes":268,"size_tokens":null},"server/routes.ts":{"content":"/**\n * @fileoverview API routes for Admin Hub\n * Copyright (c) 2025 DevPulse.Inc\n * Designed for MM ALL ELECTRONICS\n *\n * Description: Central Express route definitions for Admin Hub.\n */\n// API routes for admin dashboard\nimport type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\n// Use environment-based auth router (dev / replit / standalone)\nimport { setupAuth, isAuthenticated, isTeamMemberAuthenticated } from \"./auth\";\nimport {\n  insertServiceConfigSchema,\n  insertManagedUserSchema,\n  insertDepartmentSchema,\n  insertTeamMemberSchema,\n  insertTaskSchema,\n  insertWorklogSchema,\n  PERMISSION_TYPES,\n  ROLE_TYPES,\n} from \"@shared/schema\";\nimport { createMailcowMailbox } from './provisioning';\nimport { z } from \"zod\";\n\nconst updateProfileSchema = z.object({\n  firstName: z.string().min(1).optional(),\n  lastName: z.string().min(1).optional(),\n  phone: z.string().optional().nullable(),\n  currentPassword: z.string().optional(),\n  newPassword: z.string().min(6).optional(),\n}).strict();\nimport {\n  requirePermission,\n  requireAnyPermission,\n  requireRole,\n  requireRoleOrHigher,\n  requireDepartmentAccess,\n  hasPermission,\n  isRole,\n  canAccessDepartment,\n} from \"./rbac\";\nimport bcrypt from \"bcryptjs\";\nimport registerTeamManagedRoutes from './routes-team-managed';\nimport registerIntegrationRoutes from './routes-integrations';\nimport registerTeamRoutes from './routes-teams';\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Setup Replit Auth middleware\n  await setupAuth(app);\n\n  // Auth routes\n  app.get('/api/auth/user', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n\n  // Profile routes - Update own profile\n  app.get('/api/profile', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const member = req.teamMember;\n      const { passwordHash, ...memberWithoutPassword } = member;\n      res.json(memberWithoutPassword);\n    } catch (error) {\n      console.error(\"Error fetching profile:\", error);\n      res.status(500).json({ message: \"Failed to fetch profile\" });\n    }\n  });\n\n  app.patch('/api/profile', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const member = req.teamMember;\n      \n      const parsed = updateProfileSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ message: \"Invalid input\", errors: parsed.error.errors });\n      }\n      \n      const { firstName, lastName, phone, currentPassword, newPassword } = parsed.data;\n\n      const updateData: any = {};\n      const changedFields: string[] = [];\n      \n      if (firstName !== undefined && firstName !== member.firstName) {\n        updateData.firstName = firstName;\n        changedFields.push('firstName');\n      }\n      if (lastName !== undefined && lastName !== member.lastName) {\n        updateData.lastName = lastName;\n        changedFields.push('lastName');\n      }\n      if (phone !== undefined && phone !== member.phone) {\n        updateData.phone = phone;\n        changedFields.push('phone');\n      }\n\n      // Handle password change separately\n      if (newPassword) {\n        if (!currentPassword) {\n          return res.status(400).json({ message: \"Current password is required to change password\" });\n        }\n\n        // Get full member with password hash\n        const fullMember = await storage.getTeamMember(member.id);\n        if (!fullMember?.passwordHash) {\n          return res.status(400).json({ message: \"Cannot change password - no password set\" });\n        }\n\n        const isValidPassword = await bcrypt.compare(currentPassword, fullMember.passwordHash);\n        if (!isValidPassword) {\n          return res.status(400).json({ message: \"Current password is incorrect\" });\n        }\n\n        updateData.passwordHash = await bcrypt.hash(newPassword, 10);\n        changedFields.push('password');\n      }\n\n      // Nothing to update\n      if (Object.keys(updateData).length === 0) {\n        const { passwordHash, ...memberWithoutPassword } = member;\n        return res.json(memberWithoutPassword);\n      }\n\n      const updatedMember = await storage.updateTeamMember(member.id, updateData);\n\n      await storage.createActivityLog(\n        member.userId || member.id,\n        \"updated_own_profile\",\n        \"team_member\",\n        member.id,\n        undefined,\n        { fields: changedFields }\n      );\n\n      const { passwordHash, ...memberWithoutPassword } = updatedMember;\n      res.json(memberWithoutPassword);\n    } catch (error) {\n      console.error(\"Error updating profile:\", error);\n      res.status(400).json({ message: \"Failed to update profile\" });\n    }\n  });\n\n  // Department routes\n  app.get('/api/departments', isAuthenticated, async (req: any, res) => {\n    try {\n      const departments = await storage.getAllDepartments();\n      res.json(departments);\n    } catch (error) {\n      console.error(\"Error fetching departments:\", error);\n      res.status(500).json({ message: \"Failed to fetch departments\" });\n    }\n  });\n\n  app.post('/api/departments', isAuthenticated, async (req: any, res) => {\n    try {\n      const validatedData = insertDepartmentSchema.parse(req.body);\n      const department = await storage.createDepartment(validatedData);\n      \n      await storage.createActivityLog(\n        req.user.claims.sub,\n        \"created_department\",\n        \"department\",\n        department.id\n      );\n\n      res.json(department);\n    } catch (error) {\n      console.error(\"Error creating department:\", error instanceof Error ? error.message : error);\n      const message = error instanceof Error ? error.message : \"Failed to create department\";\n      res.status(400).json({ message, error: message });\n    }\n  });\n\n  app.patch('/api/departments/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const validatedData = insertDepartmentSchema.partial().parse(req.body);\n      const department = await storage.updateDepartment(id, validatedData);\n      \n      await storage.createActivityLog(\n        req.user.claims.sub,\n        \"updated_department\",\n        \"department\",\n        id\n      );\n\n      res.json(department);\n    } catch (error) {\n      console.error(\"Error updating department:\", error);\n      res.status(400).json({ message: \"Failed to update department\" });\n    }\n  });\n\n  app.delete('/api/departments/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      await storage.deleteDepartment(id);\n      \n      await storage.createActivityLog(\n        req.user.claims.sub,\n        \"deleted_department\",\n        \"department\",\n        id\n      );\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting department:\", error);\n      res.status(400).json({ message: \"Failed to delete department\" });\n    }\n  });\n\n  // Team Member routes\n  // Register routes for assigning managed platform access to existing team members\n  registerTeamManagedRoutes(app, storage);\n\n  // Register team routes for tiered support architecture\n  registerTeamRoutes(app, storage);\n\n  // Register communication integration routes (Chatwoot, Evolution API, Typebot, Mailcow)\n  registerIntegrationRoutes(app);\n\n  app.get('/api/team-members', isAuthenticated, async (req: any, res) => {\n    try {\n      const { departmentId } = req.query;\n      const members = departmentId \n        ? await storage.getTeamMembersByDepartment(departmentId as string)\n        : await storage.getAllTeamMembers();\n      res.json(members);\n    } catch (error) {\n      console.error(\"Error fetching team members:\", error);\n      res.status(500).json({ message: \"Failed to fetch team members\" });\n    }\n  });\n\n  app.post('/api/team-members', isAuthenticated, async (req: any, res) => {\n    try {\n      const validatedData = insertTeamMemberSchema.parse(req.body);\n      const member = await storage.createTeamMember(validatedData);\n      \n      await storage.createActivityLog(\n        req.user.claims.sub,\n        \"created_team_member\",\n        \"team_member\",\n        member.id,\n        undefined,\n        { employeeId: member.employeeId, role: member.role }\n      );\n\n      res.json(member);\n    } catch (error) {\n      console.error(\"Error creating team member:\", error instanceof Error ? error.message : error);\n      const message = error instanceof Error ? error.message : \"Failed to create team member\";\n      res.status(400).json({ message, error: message });\n    }\n  });\n\n  app.patch('/api/team-members/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const validatedData = insertTeamMemberSchema.partial().parse(req.body);\n      const member = await storage.updateTeamMember(id, validatedData);\n      \n      await storage.createActivityLog(\n        req.user.claims.sub,\n        \"updated_team_member\",\n        \"team_member\",\n        id\n      );\n\n      res.json(member);\n    } catch (error) {\n      console.error(\"Error updating team member:\", error);\n      res.status(400).json({ message: \"Failed to update team member\" });\n    }\n  });\n\n  app.delete('/api/team-members/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      await storage.deleteTeamMember(id);\n      \n      await storage.createActivityLog(\n        req.user.claims.sub,\n        \"deleted_team_member\",\n        \"team_member\",\n        id\n      );\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting team member:\", error);\n      res.status(400).json({ message: \"Failed to delete team member\" });\n    }\n  });\n\n  // Service configuration routes\n  app.get('/api/services', isAuthenticated, async (req: any, res) => {\n    try {\n      const services = await storage.getAllServices();\n      res.json(services);\n    } catch (error) {\n      console.error(\"Error fetching services:\", error);\n      res.status(500).json({ message: \"Failed to fetch services\" });\n    }\n  });\n\n  app.post('/api/services', isAuthenticated, async (req: any, res) => {\n    try {\n      const validatedData = insertServiceConfigSchema.parse(req.body);\n      \n      // Check if service already exists\n      const existing = await storage.getServiceByName(validatedData.serviceName);\n      if (existing) {\n        return res.status(400).json({ message: \"Service already exists\" });\n      }\n\n      const service = await storage.createService(validatedData);\n      \n      // Log activity\n      await storage.createActivityLog(\n        req.user.claims.sub,\n        \"created_service_config\",\n        \"service_config\",\n        service.id,\n        validatedData.serviceName\n      );\n\n      res.json(service);\n    } catch (error) {\n      console.error(\"Error creating service:\", error);\n      res.status(400).json({ message: \"Failed to create service\" });\n    }\n  });\n\n  app.patch('/api/services/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const validatedData = insertServiceConfigSchema.partial().parse(req.body);\n      \n      const service = await storage.updateService(id, validatedData);\n      \n      // Log activity\n      await storage.createActivityLog(\n        req.user.claims.sub,\n        \"updated_service_config\",\n        \"service_config\",\n        id,\n        service.serviceName\n      );\n\n      res.json(service);\n    } catch (error) {\n      console.error(\"Error updating service:\", error);\n      res.status(400).json({ message: \"Failed to update service\" });\n    }\n  });\n\n  app.delete('/api/services/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      await storage.deleteService(id);\n      \n      // Log activity\n      await storage.createActivityLog(\n        req.user.claims.sub,\n        \"deleted_service_config\",\n        \"service_config\",\n        id\n      );\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting service:\", error);\n      res.status(400).json({ message: \"Failed to delete service\" });\n    }\n  });\n\n  app.post('/api/services/:serviceName/test', isAuthenticated, async (req: any, res) => {\n    try {\n      const { serviceName } = req.params;\n      \n      // In a real implementation, this would test the actual API connection\n      // For now, we'll just check if the service is configured\n      const service = await storage.getServiceByName(serviceName);\n      \n      if (!service) {\n        return res.status(404).json({ message: \"Service not configured\" });\n      }\n\n      if (!service.enabled) {\n        return res.status(400).json({ message: \"Service is disabled\" });\n      }\n\n      // Log activity\n      await storage.createActivityLog(\n        req.user.claims.sub,\n        \"tested_service_connection\",\n        \"service_config\",\n        service.id,\n        serviceName\n      );\n\n      res.json({ success: true, message: \"Connection test successful\" });\n    } catch (error) {\n      console.error(\"Error testing service:\", error);\n      res.status(500).json({ message: \"Connection test failed\" });\n    }\n  });\n\n  // Managed user routes\n  app.get('/api/users', isAuthenticated, async (req: any, res) => {\n    try {\n      const users = await storage.getAllManagedUsers();\n      res.json(users);\n    } catch (error) {\n      console.error(\"Error fetching users:\", error);\n      res.status(500).json({ message: \"Failed to fetch users\" });\n    }\n  });\n\n  app.post('/api/users', isAuthenticated, async (req: any, res) => {\n    try {\n      const validatedData = insertManagedUserSchema.parse(req.body);\n      const user = await storage.createManagedUser(validatedData);\n      \n      // Log activity\n      await storage.createActivityLog(\n        req.user.claims.sub,\n        \"created_user\",\n        \"managed_user\",\n        user.id,\n        Array.isArray(validatedData.platforms) ? validatedData.platforms.join(\", \") : \"unknown\",\n        { email: validatedData.email, fullName: validatedData.fullName, platforms: validatedData.platforms }\n      );\n\n      // Try to provision a Mailcow mailbox for this managed user (optional)\n      // The frontend can send `provisionMailbox` boolean in the body to opt-in/out.\n      let generatedEmail = null;\n      const provisionMailbox = req.body?.provisionMailbox !== false; // default true\n      if (provisionMailbox) {\n        try {\n          // Derive first/last name from fullName if available\n          const fullName = validatedData.fullName || '';\n          const parts = fullName.trim().split(/\\s+/);\n          const firstName = parts.length > 0 ? parts[0] : 'user';\n          const lastName = parts.length > 1 ? parts.slice(1).join(' ') : 'user';\n\n          // Determine department tag for email (prefer department code, fallback to name)\n          let deptTag = 'staff';\n          if (validatedData.teamMemberId) {\n            try {\n              const teamMember = await storage.getTeamMember(validatedData.teamMemberId);\n              if (teamMember && teamMember.departmentId) {\n                const dept = await storage.getDepartment(teamMember.departmentId);\n                if (dept) {\n                  deptTag = (dept.code || dept.name || 'staff').toString().toLowerCase().replace(/[^a-z0-9]/g, '');\n                }\n              }\n            } catch (dErr) {\n              console.warn('Could not resolve department for mailbox tag, defaulting to staff', dErr);\n            }\n          }\n\n          generatedEmail = await createMailcowMailbox(firstName, lastName, deptTag);\n\n          // Activity log: provisioning success\n          try {\n            await storage.createActivityLog(\n              req.user.claims.sub,\n              'provision_mailbox',\n              'managed_user',\n              user.id,\n              'mailcow',\n              { success: true, email: generatedEmail?.email }\n            );\n          } catch (logErr) {\n            console.warn('Failed to write provisioning activity log', logErr);\n          }\n        } catch (emailErr) {\n          console.error('Failed to provision Mailcow mailbox:', emailErr);\n          // Activity log: provisioning failure\n          try {\n            await storage.createActivityLog(\n              req.user.claims.sub,\n              'provision_mailbox',\n              'managed_user',\n              user.id,\n              'mailcow',\n              { success: false, error: (emailErr && emailErr.message) || String(emailErr) }\n            );\n          } catch (logErr) {\n            console.warn('Failed to write provisioning failure activity log', logErr);\n          }\n        }\n      } else {\n        // Admin chose to skip mailbox provisioning — log that choice\n        try {\n          await storage.createActivityLog(\n            req.user.claims.sub,\n            'provision_mailbox_skipped',\n            'managed_user',\n            user.id,\n            'mailcow',\n            { success: null }\n          );\n        } catch (logErr) {\n          console.warn('Failed to write provisioning-skipped activity log', logErr);\n        }\n      }\n\n      res.json({ user, generatedEmail });\n    } catch (error) {\n      console.error(\"Error creating user:\", error);\n      res.status(400).json({ message: \"Failed to create user\" });\n    }\n  });\n\n  app.patch('/api/users/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const validatedData = insertManagedUserSchema.partial().parse(req.body);\n      \n      const existingUser = await storage.getManagedUser(id);\n      if (!existingUser) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const user = await storage.updateManagedUser(id, validatedData);\n\n      // Log activity for update\n      await storage.createActivityLog(\n        req.user.claims.sub,\n        \"updated_user\",\n        \"managed_user\",\n        id,\n        Array.isArray(user.platforms) ? user.platforms.join(\", \") : \"unknown\",\n        { email: user.email, platforms: user.platforms }\n      );\n\n      // Optionally provision a Mailcow mailbox during update if requested\n      let generatedEmail = null;\n      const provisionMailbox = req.body?.provisionMailbox === true; // only provision when explicitly true on edit\n      if (provisionMailbox) {\n        try {\n          const fullName = validatedData.fullName || existingUser.fullName || '';\n          const parts = fullName.trim().split(/\\s+/);\n          const firstName = parts.length > 0 ? parts[0] : 'user';\n          const lastName = parts.length > 1 ? parts.slice(1).join(' ') : 'user';\n\n          // Determine department tag (prefer updated teamMemberId, fallback to existing)\n          let deptTag = 'staff';\n          const teamMemberId = validatedData.teamMemberId || (existingUser as any).teamMemberId;\n          if (teamMemberId) {\n            try {\n              const teamMember = await storage.getTeamMember(teamMemberId);\n              if (teamMember && teamMember.departmentId) {\n                const dept = await storage.getDepartment(teamMember.departmentId);\n                if (dept) {\n                  deptTag = (dept.code || dept.name || 'staff').toString().toLowerCase().replace(/[^a-z0-9]/g, '');\n                }\n              }\n            } catch (dErr) {\n              console.warn('Could not resolve department for mailbox tag during update, defaulting to staff', dErr);\n            }\n          }\n\n          generatedEmail = await createMailcowMailbox(firstName, lastName, deptTag);\n\n          // Update managed user to record mailbox info in platformUserIds\n          try {\n            const mergedPlatformIds = {\n              ...(existingUser.platformUserIds || {}),\n              ...(user.platformUserIds || {}),\n              mailcow: generatedEmail?.email,\n            };\n            await storage.updateManagedUser(id, { platformUserIds: mergedPlatformIds });\n          } catch (updErr) {\n            console.warn('Failed to update managed user with mailcow info', updErr);\n          }\n\n          // Activity log: provisioning success\n          try {\n            await storage.createActivityLog(\n              req.user.claims.sub,\n              'provision_mailbox',\n              'managed_user',\n              id,\n              'mailcow',\n              { success: true, email: generatedEmail?.email }\n            );\n          } catch (logErr) {\n            console.warn('Failed to write provisioning activity log (update)', logErr);\n          }\n        } catch (emailErr) {\n          console.error('Failed to provision Mailcow mailbox during update:', emailErr);\n          try {\n            await storage.createActivityLog(\n              req.user.claims.sub,\n              'provision_mailbox',\n              'managed_user',\n              id,\n              'mailcow',\n              { success: false, error: (emailErr && emailErr.message) || String(emailErr) }\n            );\n          } catch (logErr) {\n            console.warn('Failed to write provisioning failure activity log (update)', logErr);\n          }\n        }\n      }\n\n      // Return updated user and any generatedEmail so frontend can show credentials\n      res.json({ user: await storage.getManagedUser(id), generatedEmail });\n    } catch (error) {\n      console.error(\"Error updating user:\", error);\n      res.status(400).json({ message: \"Failed to update user\" });\n    }\n  });\n\n  app.delete('/api/users/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const user = await storage.getManagedUser(id);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      await storage.deleteManagedUser(id);\n      \n      // Log activity\n      await storage.createActivityLog(\n        req.user.claims.sub,\n        \"deleted_user\",\n        \"managed_user\",\n        id,\n        Array.isArray(user.platforms) ? user.platforms.join(\", \") : \"unknown\",\n        { email: user.email, fullName: user.fullName }\n      );\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting user:\", error);\n      res.status(400).json({ message: \"Failed to delete user\" });\n    }\n  });\n\n  // Activity log routes\n  app.get('/api/activity', isAuthenticated, async (req: any, res) => {\n    try {\n      const activities = await storage.getActivityLogs(100);\n      res.json(activities);\n    } catch (error) {\n      console.error(\"Error fetching activities:\", error);\n      res.status(500).json({ message: \"Failed to fetch activities\" });\n    }\n  });\n\n  app.get('/api/activity/recent', isAuthenticated, async (req: any, res) => {\n    try {\n      const activities = await storage.getRecentActivityLogs();\n      res.json(activities);\n    } catch (error) {\n      console.error(\"Error fetching recent activities:\", error);\n      res.status(500).json({ message: \"Failed to fetch recent activities\" });\n    }\n  });\n\n  // Analytics routes\n  app.get('/api/analytics/metrics', isAuthenticated, async (req: any, res) => {\n    try {\n      const metrics = await storage.getAnalyticsMetrics();\n      res.json(metrics);\n    } catch (error) {\n      console.error(\"Error fetching analytics:\", error);\n      res.status(500).json({ message: \"Failed to fetch analytics\" });\n    }\n  });\n\n  // Dashboard stats route\n  app.get('/api/stats', isAuthenticated, async (req: any, res) => {\n    try {\n      const stats = await storage.getStats();\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch stats\" });\n    }\n  });\n\n  // RBAC Routes - Roles and Permissions\n  app.get('/api/roles', isAuthenticated, async (req: any, res) => {\n    try {\n      const allRoles = await storage.getAllRoles();\n      res.json(allRoles);\n    } catch (error) {\n      console.error(\"Error fetching roles:\", error);\n      res.status(500).json({ message: \"Failed to fetch roles\" });\n    }\n  });\n\n  app.get('/api/permissions', isAuthenticated, async (req: any, res) => {\n    try {\n      const allPermissions = await storage.getAllPermissions();\n      res.json(allPermissions);\n    } catch (error) {\n      console.error(\"Error fetching permissions:\", error);\n      res.status(500).json({ message: \"Failed to fetch permissions\" });\n    }\n  });\n\n  app.get('/api/roles/:roleId/permissions', isAuthenticated, async (req: any, res) => {\n    try {\n      const { roleId } = req.params;\n      const rolePermissions = await storage.getPermissionsByRole(roleId);\n      res.json(rolePermissions);\n    } catch (error) {\n      console.error(\"Error fetching role permissions:\", error);\n      res.status(500).json({ message: \"Failed to fetch role permissions\" });\n    }\n  });\n\n  // Task Routes\n  app.get('/api/tasks', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const member = req.teamMember;\n      const { departmentId } = req.query;\n\n      let taskList;\n      \n      if (isRole(member, ROLE_TYPES.MANAGEMENT) || hasPermission(member, PERMISSION_TYPES.VIEW_ALL_DEPARTMENTS)) {\n        taskList = departmentId \n          ? await storage.getTasksByDepartment(departmentId as string)\n          : await storage.getAllTasks();\n      } else if (isRole(member, ROLE_TYPES.DEPARTMENT_ADMIN)) {\n        taskList = await storage.getTasksByDepartment(member.departmentId);\n      } else {\n        taskList = await storage.getTasksByAssignee(member.id);\n      }\n\n      res.json(taskList);\n    } catch (error) {\n      console.error(\"Error fetching tasks:\", error);\n      res.status(500).json({ message: \"Failed to fetch tasks\" });\n    }\n  });\n\n  app.get('/api/tasks/:id', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const task = await storage.getTask(id);\n      \n      if (!task) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n\n      const member = req.teamMember;\n      if (!canAccessDepartment(member, task.departmentId)) {\n        return res.status(403).json({ message: \"Access denied to this task\" });\n      }\n\n      res.json(task);\n    } catch (error) {\n      console.error(\"Error fetching task:\", error);\n      res.status(500).json({ message: \"Failed to fetch task\" });\n    }\n  });\n\n  app.post('/api/tasks', isTeamMemberAuthenticated, requireAnyPermission(PERMISSION_TYPES.CREATE_TASK, PERMISSION_TYPES.ASSIGN_TASK), async (req: any, res) => {\n    try {\n      const member = req.teamMember;\n      const validatedData = insertTaskSchema.parse({\n        ...req.body,\n        createdById: member.id,\n        departmentId: req.body.departmentId || member.departmentId,\n      });\n\n      if (!canAccessDepartment(member, validatedData.departmentId)) {\n        return res.status(403).json({ message: \"Cannot create task in this department\" });\n      }\n\n      const task = await storage.createTask(validatedData);\n\n      await storage.createTaskHistory(task.id, member.id, \"created\", null, validatedData);\n\n      await storage.createActivityLog(\n        member.userId || member.id,\n        \"created_task\",\n        \"task\",\n        task.id,\n        undefined,\n        { title: task.title, departmentId: task.departmentId }\n      );\n\n      res.json(task);\n    } catch (error) {\n      console.error(\"Error creating task:\", error);\n      res.status(400).json({ message: \"Failed to create task\" });\n    }\n  });\n\n  app.patch('/api/tasks/:id', isTeamMemberAuthenticated, requirePermission(PERMISSION_TYPES.UPDATE_TASK), async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const member = req.teamMember;\n\n      const existingTask = await storage.getTask(id);\n      if (!existingTask) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n\n      if (!canAccessDepartment(member, existingTask.departmentId)) {\n        return res.status(403).json({ message: \"Access denied to this task\" });\n      }\n\n      const validatedData = insertTaskSchema.partial().parse(req.body);\n      \n      if (validatedData.status === 'completed' && existingTask.status !== 'completed') {\n        (validatedData as any).completedAt = new Date();\n      }\n\n      const task = await storage.updateTask(id, validatedData);\n\n      await storage.createTaskHistory(task.id, member.id, \"updated\", existingTask, validatedData);\n\n      await storage.createActivityLog(\n        member.userId || member.id,\n        \"updated_task\",\n        \"task\",\n        task.id,\n        undefined,\n        { title: task.title, changes: Object.keys(validatedData) }\n      );\n\n      res.json(task);\n    } catch (error) {\n      console.error(\"Error updating task:\", error);\n      res.status(400).json({ message: \"Failed to update task\" });\n    }\n  });\n\n  app.delete('/api/tasks/:id', isTeamMemberAuthenticated, requirePermission(PERMISSION_TYPES.DELETE_TASK), async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const member = req.teamMember;\n\n      const existingTask = await storage.getTask(id);\n      if (!existingTask) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n\n      if (!canAccessDepartment(member, existingTask.departmentId)) {\n        return res.status(403).json({ message: \"Access denied to this task\" });\n      }\n\n      await storage.deleteTask(id);\n\n      await storage.createActivityLog(\n        member.userId || member.id,\n        \"deleted_task\",\n        \"task\",\n        id,\n        undefined,\n        { title: existingTask.title }\n      );\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting task:\", error);\n      res.status(400).json({ message: \"Failed to delete task\" });\n    }\n  });\n\n  // Task Assignment Routes\n  app.post('/api/tasks/:id/assign', isTeamMemberAuthenticated, requirePermission(PERMISSION_TYPES.ASSIGN_TASK), async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { teamMemberId } = req.body;\n      const member = req.teamMember;\n\n      const task = await storage.getTask(id);\n      if (!task) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n\n      if (!canAccessDepartment(member, task.departmentId)) {\n        return res.status(403).json({ message: \"Access denied to this task\" });\n      }\n\n      const assignment = await storage.assignTask(id, teamMemberId, member.id);\n      \n      await storage.updateTask(id, { assignedToId: teamMemberId });\n\n      await storage.createTaskHistory(task.id, member.id, \"assigned\", null, { assignedTo: teamMemberId });\n\n      await storage.createActivityLog(\n        member.userId || member.id,\n        \"assigned_task\",\n        \"task\",\n        task.id,\n        undefined,\n        { assignedTo: teamMemberId }\n      );\n\n      res.json(assignment);\n    } catch (error) {\n      console.error(\"Error assigning task:\", error);\n      res.status(400).json({ message: \"Failed to assign task\" });\n    }\n  });\n\n  app.get('/api/tasks/:id/history', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const member = req.teamMember;\n\n      const task = await storage.getTask(id);\n      if (!task) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n\n      if (!canAccessDepartment(member, task.departmentId)) {\n        return res.status(403).json({ message: \"Access denied to this task\" });\n      }\n\n      const history = await storage.getTaskHistory(id);\n      res.json(history);\n    } catch (error) {\n      console.error(\"Error fetching task history:\", error);\n      res.status(500).json({ message: \"Failed to fetch task history\" });\n    }\n  });\n\n  // Worklog Routes\n  app.post('/api/worklogs', isTeamMemberAuthenticated, requirePermission(PERMISSION_TYPES.SUBMIT_WORKLOG), async (req: any, res) => {\n    try {\n      const member = req.teamMember;\n      const validatedData = insertWorklogSchema.parse({\n        ...req.body,\n        teamMemberId: member.id,\n      });\n\n      const task = await storage.getTask(validatedData.taskId);\n      if (!task) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n\n      if (!canAccessDepartment(member, task.departmentId)) {\n        return res.status(403).json({ message: \"Access denied to this task\" });\n      }\n\n      const worklog = await storage.createWorklog(validatedData);\n\n      await storage.createTaskHistory(task.id, member.id, \"worklog_added\", null, {\n        hoursWorked: validatedData.hoursWorked,\n        minutesWorked: validatedData.minutesWorked,\n      });\n\n      res.json(worklog);\n    } catch (error) {\n      console.error(\"Error creating worklog:\", error);\n      res.status(400).json({ message: \"Failed to create worklog\" });\n    }\n  });\n\n  app.get('/api/tasks/:id/worklogs', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const member = req.teamMember;\n\n      const task = await storage.getTask(id);\n      if (!task) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n\n      if (!canAccessDepartment(member, task.departmentId)) {\n        return res.status(403).json({ message: \"Access denied to this task\" });\n      }\n\n      const taskWorklogs = await storage.getWorklogsByTask(id);\n      res.json(taskWorklogs);\n    } catch (error) {\n      console.error(\"Error fetching worklogs:\", error);\n      res.status(500).json({ message: \"Failed to fetch worklogs\" });\n    }\n  });\n\n  app.get('/api/my-worklogs', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const member = req.teamMember;\n      const myWorklogs = await storage.getWorklogsByTeamMember(member.id);\n      res.json(myWorklogs);\n    } catch (error) {\n      console.error(\"Error fetching worklogs:\", error);\n      res.status(500).json({ message: \"Failed to fetch worklogs\" });\n    }\n  });\n\n  // Enhanced Team Member Routes with RBAC\n  app.post('/api/team-members/create-with-password', \n    isTeamMemberAuthenticated, \n    requireAnyPermission(PERMISSION_TYPES.MANAGE_DEPARTMENT_USERS, PERMISSION_TYPES.MANAGE_GLOBAL_USERS), \n    async (req: any, res) => {\n    try {\n      const member = req.teamMember;\n      const { password, ...memberData } = req.body;\n\n      if (!hasPermission(member, PERMISSION_TYPES.MANAGE_GLOBAL_USERS)) {\n        if (memberData.departmentId !== member.departmentId) {\n          return res.status(403).json({ message: \"Can only create members in your department\" });\n        }\n        if (memberData.roleId) {\n          const targetRole = await storage.getRole(memberData.roleId);\n          if (targetRole && targetRole.code === ROLE_TYPES.MANAGEMENT) {\n            return res.status(403).json({ message: \"Cannot create management users\" });\n          }\n        }\n      }\n\n      const validatedData = insertTeamMemberSchema.parse(memberData);\n      \n      let passwordHash = null;\n      if (password) {\n        passwordHash = await bcrypt.hash(password, 10);\n      }\n\n      const newMember = await storage.createTeamMember({\n        ...validatedData,\n        passwordHash,\n      } as any);\n\n      // Auto-join default teams (All Staff, department team)\n      await storage.autoJoinDefaultTeams(newMember.id);\n      \n      // Also add to their department's team if it exists\n      const deptTeams = await storage.getTeamsByDepartment(newMember.departmentId);\n      for (const team of deptTeams) {\n        await storage.addMemberToTeam(newMember.id, team.id, member.id);\n      }\n\n      await storage.createActivityLog(\n        member.userId || member.id,\n        \"created_team_member\",\n        \"team_member\",\n        newMember.id,\n        undefined,\n        { email: newMember.email, role: newMember.role }\n      );\n\n      const { passwordHash: _, ...memberWithoutPassword } = newMember;\n      res.json(memberWithoutPassword);\n    } catch (error) {\n      console.error(\"Error creating team member:\", error);\n      res.status(400).json({ message: \"Failed to create team member\" });\n    }\n  });\n\n  app.patch('/api/team-members/:id/deactivate', \n    isTeamMemberAuthenticated, \n    requireAnyPermission(PERMISSION_TYPES.MANAGE_DEPARTMENT_USERS, PERMISSION_TYPES.MANAGE_GLOBAL_USERS), \n    async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const member = req.teamMember;\n\n      const targetMember = await storage.getTeamMember(id);\n      if (!targetMember) {\n        return res.status(404).json({ message: \"Team member not found\" });\n      }\n\n      if (!hasPermission(member, PERMISSION_TYPES.MANAGE_GLOBAL_USERS)) {\n        if (targetMember.departmentId !== member.departmentId) {\n          return res.status(403).json({ message: \"Can only deactivate members in your department\" });\n        }\n      }\n\n      const updated = await storage.updateTeamMember(id, { status: \"inactive\" });\n\n      await storage.createActivityLog(\n        member.userId || member.id,\n        \"deactivated_team_member\",\n        \"team_member\",\n        id,\n        undefined,\n        { email: targetMember.email }\n      );\n\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error deactivating team member:\", error);\n      res.status(400).json({ message: \"Failed to deactivate team member\" });\n    }\n  });\n\n  app.patch('/api/team-members/:id/activate', \n    isTeamMemberAuthenticated, \n    requireAnyPermission(PERMISSION_TYPES.MANAGE_DEPARTMENT_USERS, PERMISSION_TYPES.MANAGE_GLOBAL_USERS), \n    async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const member = req.teamMember;\n\n      const targetMember = await storage.getTeamMember(id);\n      if (!targetMember) {\n        return res.status(404).json({ message: \"Team member not found\" });\n      }\n\n      if (!hasPermission(member, PERMISSION_TYPES.MANAGE_GLOBAL_USERS)) {\n        if (targetMember.departmentId !== member.departmentId) {\n          return res.status(403).json({ message: \"Can only activate members in your department\" });\n        }\n      }\n\n      const updated = await storage.updateTeamMember(id, { status: \"active\" });\n\n      await storage.createActivityLog(\n        member.userId || member.id,\n        \"activated_team_member\",\n        \"team_member\",\n        id,\n        undefined,\n        { email: targetMember.email }\n      );\n\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error activating team member:\", error);\n      res.status(400).json({ message: \"Failed to activate team member\" });\n    }\n  });\n\n  app.patch('/api/team-members/:id/change-role', \n    isTeamMemberAuthenticated, \n    requirePermission(PERMISSION_TYPES.MANAGE_GLOBAL_USERS), \n    async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { roleId } = req.body;\n      const member = req.teamMember;\n\n      const targetMember = await storage.getTeamMember(id);\n      if (!targetMember) {\n        return res.status(404).json({ message: \"Team member not found\" });\n      }\n\n      const newRole = await storage.getRole(roleId);\n      if (!newRole) {\n        return res.status(400).json({ message: \"Invalid role\" });\n      }\n\n      const updated = await storage.updateTeamMember(id, { \n        roleId, \n        role: newRole.code,\n      });\n\n      await storage.createActivityLog(\n        member.userId || member.id,\n        \"changed_team_member_role\",\n        \"team_member\",\n        id,\n        undefined,\n        { email: targetMember.email, newRole: newRole.code }\n      );\n\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error changing team member role:\", error);\n      res.status(400).json({ message: \"Failed to change team member role\" });\n    }\n  });\n\n  app.patch('/api/team-members/:id/change-department', \n    isTeamMemberAuthenticated, \n    requirePermission(PERMISSION_TYPES.MANAGE_GLOBAL_USERS), \n    async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { departmentId } = req.body;\n      const member = req.teamMember;\n\n      const targetMember = await storage.getTeamMember(id);\n      if (!targetMember) {\n        return res.status(404).json({ message: \"Team member not found\" });\n      }\n\n      const dept = await storage.getDepartment(departmentId);\n      if (!dept) {\n        return res.status(400).json({ message: \"Invalid department\" });\n      }\n\n      const updated = await storage.updateTeamMember(id, { departmentId });\n\n      await storage.createActivityLog(\n        member.userId || member.id,\n        \"changed_team_member_department\",\n        \"team_member\",\n        id,\n        undefined,\n        { email: targetMember.email, newDepartment: dept.code }\n      );\n\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error changing team member department:\", error);\n      res.status(400).json({ message: \"Failed to change team member department\" });\n    }\n  });\n\n  // ==================== STAFF REGISTRATION ROUTES ====================\n  \n  // Generate a 6-digit OTP\n  function generateOtp(): string {\n    return Math.floor(100000 + Math.random() * 900000).toString();\n  }\n\n  // Validate simple CAPTCHA - using a basic challenge/response for dev\n  // In production, integrate with hCaptcha or Google reCAPTCHA\n  function validateCaptcha(token: string): boolean {\n    // Simple validation - token must be present and non-empty\n    // In production, verify with actual CAPTCHA service\n    if (!token || token.length === 0 || token === 'test-invalid') {\n      return false;\n    }\n    return true;\n  }\n\n  // Staff Registration - Creates a pending registration\n  app.post('/api/auth/register', async (req: any, res) => {\n    try {\n      const {\n        email, password, firstName, lastName, phone, departmentId,\n        addressLine1, addressLine2, city, state, postalCode, country,\n        nextOfKin1Name, nextOfKin1Relationship, nextOfKin1Phone, nextOfKin1Email, nextOfKin1Address,\n        nextOfKin2Name, nextOfKin2Relationship, nextOfKin2Phone, nextOfKin2Email, nextOfKin2Address,\n        captchaToken\n      } = req.body;\n\n      // Map country codes to full names\n      const countryMap: Record<string, string> = {\n        \"NG\": \"Nigeria\",\n        \"US\": \"United States\",\n        \"UK\": \"United Kingdom\",\n        \"CA\": \"Canada\",\n        \"AU\": \"Australia\"\n      };\n\n      const countryName = countryMap[country] || country || 'Nigeria';\n\n      // Validate CAPTCHA\n      if (!validateCaptcha(captchaToken)) {\n        return res.status(400).json({ message: \"CAPTCHA verification failed. Please try again.\" });\n      }\n\n      // Check if email already exists in team members\n      const existingMember = await storage.getTeamMemberByEmail(email);\n      if (existingMember) {\n        return res.status(400).json({ message: \"An account with this email already exists.\" });\n      }\n\n      // Check if email already exists in pending registrations\n      const existingPending = await storage.getPendingRegistrationByEmail(email);\n      if (existingPending) {\n        if (existingPending.status === 'pending') {\n          return res.status(400).json({ message: \"A registration with this email is already pending approval.\" });\n        } else if (existingPending.status === 'rejected') {\n          // Delete the old rejected registration and allow a new one\n          await storage.deletePendingRegistration(existingPending.id);\n        }\n      }\n\n      // Validate department exists\n      const dept = await storage.getDepartment(departmentId);\n      if (!dept) {\n        return res.status(400).json({ message: \"Invalid department selected.\" });\n      }\n\n      // Hash the password\n      const passwordHash = await bcrypt.hash(password, 10);\n\n      // Create pending registration (for OTP audit trail)\n      const registration = await storage.createPendingRegistration({\n        email,\n        passwordHash,\n        firstName,\n        lastName,\n        phone,\n        departmentId,\n        addressLine1,\n        addressLine2,\n        city,\n        state,\n        postalCode,\n        country: countryName,\n        nextOfKin1Name,\n        nextOfKin1Relationship,\n        nextOfKin1Phone,\n        nextOfKin1Email: nextOfKin1Email || null,\n        nextOfKin1Address: nextOfKin1Address || null,\n        nextOfKin2Name,\n        nextOfKin2Relationship,\n        nextOfKin2Phone,\n        nextOfKin2Email: nextOfKin2Email || null,\n        nextOfKin2Address: nextOfKin2Address || null,\n      });\n\n      // ALSO create team_member entry with isVerified = false\n      // This allows both approval workflows to work together\n      const teamMember = await storage.createTeamMember({\n        departmentId,\n        email,\n        firstName,\n        lastName,\n        role: 'technician', // Default role, can be changed on approval\n        passwordHash,\n        phone: phone || '',\n        status: 'active',\n        isVerified: false, // Locked until approved\n      });\n\n      // Generate OTP for approval (valid for 24 hours)\n      const otpCode = generateOtp();\n      const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);\n      await storage.createApprovalOtp(registration.id, otpCode, expiresAt);\n\n      // Create admin notification\n      await storage.createAdminNotification(\n        'registration_pending',\n        'New Staff Registration',\n        `${firstName} ${lastName} (${email}) has submitted a registration request for ${dept.name} department. OTP: ${otpCode}`,\n        3, // Management level\n        'pending_registration',\n        registration.id,\n        { otpCode, departmentName: dept.name, applicantName: `${firstName} ${lastName}` }\n      );\n\n      res.status(201).json({\n        message: \"Registration submitted successfully! Your application is pending approval by management.\",\n        registrationId: registration.id,\n      });\n    } catch (error) {\n      console.error(\"Registration error:\", error);\n      res.status(500).json({ message: \"Failed to submit registration. Please try again.\" });\n    }\n  });\n\n  // Get departments for registration (public endpoint)\n  app.get('/api/public/departments', async (req: any, res) => {\n    try {\n      const departments = await storage.getAllDepartments();\n      // Return only active departments with minimal info\n      const publicDepts = departments\n        .filter(d => d.status === 'active')\n        .map(d => ({ id: d.id, name: d.name, code: d.code }));\n      res.json(publicDepts);\n    } catch (error) {\n      console.error(\"Error fetching departments:\", error);\n      res.status(500).json({ message: \"Failed to fetch departments\" });\n    }\n  });\n\n  // Get all pending registrations (Management only)\n  app.get('/api/registrations', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { status } = req.query;\n      const registrations = await storage.getAllPendingRegistrations(status as string);\n      \n      // Enrich with department info\n      const enrichedRegistrations = await Promise.all(registrations.map(async (reg) => {\n        const dept = await storage.getDepartment(reg.departmentId);\n        const otp = await storage.getLatestOtpForRegistration(reg.id);\n        return {\n          ...reg,\n          passwordHash: undefined, // Don't expose password hash\n          department: dept ? { id: dept.id, name: dept.name, code: dept.code } : null,\n          latestOtp: otp && !otp.isUsed && otp.expiresAt > new Date() ? {\n            code: otp.otpCode,\n            expiresAt: otp.expiresAt,\n          } : null,\n        };\n      }));\n\n      res.json(enrichedRegistrations);\n    } catch (error) {\n      console.error(\"Error fetching registrations:\", error);\n      res.status(500).json({ message: \"Failed to fetch registrations\" });\n    }\n  });\n\n  // Get single pending registration\n  app.get('/api/registrations/:id', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const registration = await storage.getPendingRegistration(id);\n      \n      if (!registration) {\n        return res.status(404).json({ message: \"Registration not found\" });\n      }\n\n      const dept = await storage.getDepartment(registration.departmentId);\n      const otp = await storage.getLatestOtpForRegistration(registration.id);\n\n      res.json({\n        ...registration,\n        passwordHash: undefined,\n        department: dept ? { id: dept.id, name: dept.name, code: dept.code } : null,\n        latestOtp: otp && !otp.isUsed && otp.expiresAt > new Date() ? {\n          code: otp.otpCode,\n          expiresAt: otp.expiresAt,\n        } : null,\n      });\n    } catch (error) {\n      console.error(\"Error fetching registration:\", error);\n      res.status(500).json({ message: \"Failed to fetch registration\" });\n    }\n  });\n\n  // Generate new OTP for a registration\n  app.post('/api/registrations/:id/generate-otp', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const member = req.teamMember;\n\n      const registration = await storage.getPendingRegistration(id);\n      if (!registration) {\n        return res.status(404).json({ message: \"Registration not found\" });\n      }\n\n      if (registration.status !== 'pending') {\n        return res.status(400).json({ message: \"Registration is no longer pending\" });\n      }\n\n      // Generate new OTP (valid for 24 hours)\n      const otpCode = generateOtp();\n      const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);\n      await storage.createApprovalOtp(registration.id, otpCode, expiresAt);\n\n      await storage.createActivityLog(\n        member.userId || member.id,\n        \"generated_registration_otp\",\n        \"pending_registration\",\n        id,\n        undefined,\n        { applicantEmail: registration.email }\n      );\n\n      res.json({ \n        message: \"New OTP generated successfully\",\n        otp: { code: otpCode, expiresAt }\n      });\n    } catch (error) {\n      console.error(\"Error generating OTP:\", error);\n      res.status(500).json({ message: \"Failed to generate OTP\" });\n    }\n  });\n\n  // Approve registration with OTP\n  app.post('/api/registrations/:id/approve', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { otpCode, roleId, employeeId, provisionPlatforms = false } = req.body;\n      const member = req.teamMember;\n\n      if (!otpCode) {\n        return res.status(400).json({ message: \"OTP is required for approval\" });\n      }\n\n      const registration = await storage.getPendingRegistration(id);\n      if (!registration) {\n        return res.status(404).json({ message: \"Registration not found\" });\n      }\n\n      if (registration.status !== 'pending') {\n        return res.status(400).json({ message: \"Registration is no longer pending\" });\n      }\n\n      // Validate OTP\n      const validOtp = await storage.getValidApprovalOtp(id, otpCode);\n      if (!validOtp) {\n        return res.status(400).json({ message: \"Invalid or expired OTP\" });\n      }\n\n      // Validate role if provided\n      let selectedRole = null;\n      if (roleId) {\n        selectedRole = await storage.getRole(roleId);\n        if (!selectedRole) {\n          return res.status(400).json({ message: \"Invalid role selected\" });\n        }\n      } else {\n        // Default to technician role\n        selectedRole = await storage.getRoleByCode(ROLE_TYPES.TECHNICIAN);\n      }\n\n      // Get the existing team member created during registration\n      const existingMember = await storage.getTeamMemberByEmail(registration.email);\n      \n      let newMember;\n      if (existingMember) {\n        // Update existing member to verify and set role\n        newMember = await storage.updateTeamMember(existingMember.id, {\n          isVerified: true,\n          roleId: selectedRole?.id,\n          role: selectedRole?.code || ROLE_TYPES.TECHNICIAN,\n          employeeId: employeeId || null,\n          // Update extended fields from registration\n          addressLine1: registration.addressLine1,\n          addressLine2: registration.addressLine2,\n          city: registration.city,\n          state: registration.state,\n          postalCode: registration.postalCode,\n          country: registration.country,\n          nextOfKin1Name: registration.nextOfKin1Name,\n          nextOfKin1Relationship: registration.nextOfKin1Relationship,\n          nextOfKin1Phone: registration.nextOfKin1Phone,\n          nextOfKin1Email: registration.nextOfKin1Email,\n          nextOfKin1Address: registration.nextOfKin1Address,\n          nextOfKin2Name: registration.nextOfKin2Name,\n          nextOfKin2Relationship: registration.nextOfKin2Relationship,\n          nextOfKin2Phone: registration.nextOfKin2Phone,\n          nextOfKin2Email: registration.nextOfKin2Email,\n          nextOfKin2Address: registration.nextOfKin2Address,\n        } as any);\n      } else {\n        // Fallback: Create new member if somehow it doesn't exist\n        newMember = await storage.createTeamMember({\n          email: registration.email,\n          passwordHash: registration.passwordHash,\n          firstName: registration.firstName,\n          lastName: registration.lastName,\n          phone: registration.phone,\n          departmentId: registration.departmentId,\n          roleId: selectedRole?.id,\n          role: selectedRole?.code || ROLE_TYPES.TECHNICIAN,\n          employeeId: employeeId || null,\n          status: 'active',\n          isVerified: true,\n          addressLine1: registration.addressLine1,\n          addressLine2: registration.addressLine2,\n          city: registration.city,\n          state: registration.state,\n          postalCode: registration.postalCode,\n          country: registration.country,\n          nextOfKin1Name: registration.nextOfKin1Name,\n          nextOfKin1Relationship: registration.nextOfKin1Relationship,\n          nextOfKin1Phone: registration.nextOfKin1Phone,\n          nextOfKin1Email: registration.nextOfKin1Email,\n          nextOfKin1Address: registration.nextOfKin1Address,\n          nextOfKin2Name: registration.nextOfKin2Name,\n          nextOfKin2Relationship: registration.nextOfKin2Relationship,\n          nextOfKin2Phone: registration.nextOfKin2Phone,\n          nextOfKin2Email: registration.nextOfKin2Email,\n          nextOfKin2Address: registration.nextOfKin2Address,\n        });\n      }\n\n      // Auto-join default teams (All Staff) and department team on approval\n      await storage.autoJoinDefaultTeams(newMember.id);\n      const deptTeams = await storage.getTeamsByDepartment(registration.departmentId);\n      for (const team of deptTeams) {\n        await storage.addMemberToTeam(newMember.id, team.id, member.id);\n      }\n\n      // Mark OTP as used\n      await storage.markOtpAsUsed(validOtp.id, member.id);\n\n      // Update registration status\n      await storage.updatePendingRegistration(id, {\n        status: 'approved',\n        reviewedById: member.id,\n        reviewedAt: new Date(),\n      });\n\n      // Create activity log\n      await storage.createActivityLog(\n        member.userId || member.id,\n        \"approved_registration\",\n        \"team_member\",\n        newMember.id,\n        undefined,\n        { applicantEmail: registration.email, role: selectedRole?.code }\n      );\n\n      // Create notification about approval\n      await storage.createAdminNotification(\n        'registration_approved',\n        'Registration Approved',\n        `${registration.firstName} ${registration.lastName} (${registration.email}) has been approved and added as a ${selectedRole?.name || 'Technician'}.`,\n        2, // Department Admin and above\n        'team_member',\n        newMember.id,\n        { approvedBy: `${member.firstName} ${member.lastName}` }\n      );\n\n      // Optionally provision on external platforms (Mailcow + Chatwoot)\n      let provisioningResult = null;\n      if (provisionPlatforms) {\n        try {\n          const { provisioning } = await import('./provisioning');\n          const department = await storage.getDepartment(registration.departmentId);\n          if (department) {\n            provisioningResult = await provisioning.provisionTeamMember(newMember, department, {\n              createMailbox: true,\n              createChatwootAgent: true,\n              assignToTeam: true,\n            });\n            \n            // Log provisioning activity\n            await storage.createActivityLog(\n              member.userId || member.id,\n              \"provisioned_on_approval\",\n              \"team_member\",\n              newMember.id,\n              undefined,\n              { \n                mailcowSuccess: provisioningResult.mailcow?.success,\n                chatwootSuccess: provisioningResult.chatwoot?.success,\n                generatedEmail: provisioningResult.generatedEmail,\n              }\n            );\n          }\n        } catch (provError) {\n          console.error(\"Provisioning error (non-blocking):\", provError);\n          // Don't fail the approval, just log the error\n        }\n      }\n\n      res.json({\n        message: \"Registration approved successfully\",\n        teamMember: {\n          id: newMember.id,\n          email: newMember.email,\n          firstName: newMember.firstName,\n          lastName: newMember.lastName,\n          role: newMember.role,\n        },\n        provisioning: provisioningResult ? {\n          success: provisioningResult.mailcow?.success || provisioningResult.chatwoot?.success,\n          generatedEmail: provisioningResult.generatedEmail,\n          mailcow: provisioningResult.mailcow,\n          chatwoot: provisioningResult.chatwoot,\n        } : null,\n      });\n    } catch (error: any) {\n      console.error(\"Error approving registration:\", error);\n      if (error.message?.includes('duplicate')) {\n        return res.status(400).json({ message: \"A team member with this email already exists\" });\n      }\n      res.status(500).json({ message: \"Failed to approve registration\" });\n    }\n  });\n\n  // Reject registration\n  app.post('/api/registrations/:id/reject', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { reason } = req.body;\n      const member = req.teamMember;\n\n      const registration = await storage.getPendingRegistration(id);\n      if (!registration) {\n        return res.status(404).json({ message: \"Registration not found\" });\n      }\n\n      if (registration.status !== 'pending') {\n        return res.status(400).json({ message: \"Registration is no longer pending\" });\n      }\n\n      // Update registration status\n      await storage.updatePendingRegistration(id, {\n        status: 'rejected',\n        rejectionReason: reason || 'Application rejected by management',\n        reviewedById: member.id,\n        reviewedAt: new Date(),\n      });\n\n      // Create activity log\n      await storage.createActivityLog(\n        member.userId || member.id,\n        \"rejected_registration\",\n        \"pending_registration\",\n        id,\n        undefined,\n        { applicantEmail: registration.email, reason }\n      );\n\n      res.json({ message: \"Registration rejected successfully\" });\n    } catch (error) {\n      console.error(\"Error rejecting registration:\", error);\n      res.status(500).json({ message: \"Failed to reject registration\" });\n    }\n  });\n\n  // Get pending registration count\n  app.get('/api/registrations/count/pending', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const count = await storage.getPendingRegistrationCount();\n      res.json({ count });\n    } catch (error) {\n      console.error(\"Error fetching pending count:\", error);\n      res.status(500).json({ message: \"Failed to fetch pending count\" });\n    }\n  });\n\n  // ==================== NOTIFICATION ROUTES ====================\n\n  // Get notifications for current user\n  app.get('/api/notifications', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const member = req.teamMember;\n      const { unreadOnly, limit } = req.query;\n\n      // Get role level from member's role\n      const role = await storage.getRole(member.roleId);\n      const roleLevel = role?.level || 1;\n\n      let notifications;\n      if (unreadOnly === 'true') {\n        notifications = await storage.getUnreadNotifications(roleLevel);\n      } else {\n        notifications = await storage.getAllNotifications(roleLevel, parseInt(limit as string) || 50);\n      }\n\n      res.json(notifications);\n    } catch (error) {\n      console.error(\"Error fetching notifications:\", error);\n      res.status(500).json({ message: \"Failed to fetch notifications\" });\n    }\n  });\n\n  // Get unread notification count\n  app.get('/api/notifications/count', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const member = req.teamMember;\n      const role = await storage.getRole(member.roleId);\n      const roleLevel = role?.level || 1;\n\n      const notifications = await storage.getUnreadNotifications(roleLevel);\n      res.json({ count: notifications.length });\n    } catch (error) {\n      console.error(\"Error fetching notification count:\", error);\n      res.status(500).json({ message: \"Failed to fetch notification count\" });\n    }\n  });\n\n  // Mark notification as read\n  app.post('/api/notifications/:id/read', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const member = req.teamMember;\n\n      await storage.markNotificationAsRead(id, member.id);\n      res.json({ message: \"Notification marked as read\" });\n    } catch (error) {\n      console.error(\"Error marking notification as read:\", error);\n      res.status(500).json({ message: \"Failed to mark notification as read\" });\n    }\n  });\n\n  // Mark all notifications as read\n  app.post('/api/notifications/read-all', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const member = req.teamMember;\n      const role = await storage.getRole(member.roleId);\n      const roleLevel = role?.level || 1;\n\n      await storage.markAllNotificationsAsRead(member.id, roleLevel);\n      res.json({ message: \"All notifications marked as read\" });\n    } catch (error) {\n      console.error(\"Error marking all notifications as read:\", error);\n      res.status(500).json({ message: \"Failed to mark all notifications as read\" });\n    }\n  });\n\n  // Admin: Get pending users awaiting approval\n  app.get('/api/admin/pending-users', isTeamMemberAuthenticated, requireRole(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const members = await storage.getAllTeamMembers();\n      const pendingUsers = members.filter(m => !m.isVerified);\n      \n      // Return without password hash\n      const safeUsers = pendingUsers.map(({ passwordHash, ...user }) => user);\n      res.json(safeUsers);\n    } catch (error) {\n      console.error(\"Error fetching pending users:\", error);\n      res.status(500).json({ message: \"Failed to fetch pending users\" });\n    }\n  });\n\n  // Admin: Approve a user (also updates pending registration if exists)\n  app.patch('/api/admin/approve-user/:userId', isTeamMemberAuthenticated, requireRole(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { userId } = req.params;\n      const adminId = req.teamMember.id;\n\n      const user = await storage.getTeamMember(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      if (user.isVerified) {\n        return res.status(400).json({ message: \"User is already verified\" });\n      }\n\n      // Update user to verified\n      const updatedUser = await storage.updateTeamMember(userId, { isVerified: true } as any);\n\n      // Also update pending registration if it exists\n      const pendingReg = await storage.getPendingRegistrationByEmail(user.email);\n      if (pendingReg && pendingReg.status === 'pending') {\n        await storage.updatePendingRegistration(pendingReg.id, {\n          status: 'approved',\n          reviewedById: adminId,\n          reviewedAt: new Date(),\n        });\n        \n        // Mark any OTP as used\n        const otps = await storage.getAllApprovalOtps(pendingReg.id);\n        if (otps && otps.length > 0) {\n          for (const otp of otps) {\n            if (!otp.isUsed) {\n              await storage.markOtpAsUsed(otp.id, adminId);\n            }\n          }\n        }\n      }\n\n      // Log the activity\n      await storage.createActivityLog(\n        adminId,\n        \"approved_user\",\n        \"team_member\",\n        userId,\n        undefined,\n        { email: user.email, approvedAt: new Date().toISOString() }\n      );\n\n      // Return without password hash\n      const { passwordHash, ...safeUser } = updatedUser;\n      res.json(safeUser);\n    } catch (error) {\n      console.error(\"Error approving user:\", error);\n      res.status(500).json({ message: \"Failed to approve user\" });\n    }\n  });\n\n  // Admin: Reject a user (also updates pending registration if exists)\n  app.delete('/api/admin/reject-user/:userId', isTeamMemberAuthenticated, requireRole(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { userId } = req.params;\n      const adminId = req.teamMember.id;\n      const { reason } = req.body;\n\n      const user = await storage.getTeamMember(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      if (user.isVerified) {\n        return res.status(400).json({ message: \"Cannot reject an already verified user\" });\n      }\n\n      // Check for pending registration and reject it first\n      const pendingReg = await storage.getPendingRegistrationByEmail(user.email);\n      if (pendingReg && pendingReg.status === 'pending') {\n        await storage.updatePendingRegistration(pendingReg.id, {\n          status: 'rejected',\n          rejectionReason: reason || 'Rejected by admin',\n          reviewedById: adminId,\n          reviewedAt: new Date(),\n        });\n      }\n\n      // Log the rejection\n      await storage.createActivityLog(\n        adminId,\n        \"rejected_user\",\n        \"team_member\",\n        userId,\n        undefined,\n        { email: user.email, reason: reason || \"No reason provided\", rejectedAt: new Date().toISOString() }\n      );\n\n      // Instead of deleting, mark as not verified (rejected state)\n      // This preserves any associated data (tasks, etc.) and prevents deletion conflicts\n      await storage.updateTeamMember(userId, {\n        isVerified: false,\n        // Optionally add a rejection note/timestamp if your schema supports it\n      });\n\n      res.json({ message: \"User rejected successfully\" });\n    } catch (error) {\n      console.error(\"Error rejecting user:\", error);\n      res.status(500).json({ message: \"Failed to reject user\" });\n    }\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","path":null,"size_bytes":66754,"size_tokens":null},"readme.md":{"content":"# Admin Hub - Staff Onboarding Application\n\n## Overview\nAdmin Hub is an Express + React application that provides a unified management platform with role-based access control (RBAC). The platform includes staff onboarding with a comprehensive registration workflow, approval system, and permission management.\n\n## Project Structure\n```\n├── client/                 # React frontend\n│   └── src/\n│       ├── components/     # UI components\n│       ├── hooks/          # Custom React hooks\n│       ├── lib/            # Utility functions\n│       └── pages/          # Page components\n├── server/                 # Express backend\n│   ├── routes.ts          # API routes\n│   ├── storage.ts         # Database operations\n│   ├── devAuth.ts         # Development authentication\n│   └── index.ts           # Server entry point\n└── shared/\n    └── schema.ts          # Drizzle ORM schema definitions\n```\n\n## Recent Changes\n- **Staff Registration System** (Nov 2025)\n  - Multi-step registration form with extended data collection\n  - Residential address and two next-of-kin contacts\n  - Simple math CAPTCHA verification\n  - Pending registration workflow with admin approval\n  - OTP-based approval verification\n  - Role assignment upon activation\n\n## Key Features\n\n### Role-Based Access Control (RBAC)\nThree role types with hierarchical permissions:\n- **MANAGEMENT**: Full system access, can approve registrations\n- **DEPARTMENT_ADMIN**: Department-level management\n- **TECHNICIAN**: Task-focused access\n\n### Staff Onboarding Workflow\n1. New staff fills multi-step registration form\n2. Application stored as pending registration\n3. Management receives notification with OTP\n4. Management reviews and approves/rejects with OTP verification\n5. On approval, team member account is created with assigned role\n\n### Database Schema\nKey tables:\n- `team_members`: Staff accounts with extended profile data\n- `pending_registrations`: Pending staff applications\n- `approval_otps`: One-time passwords for approval verification\n- `admin_notifications`: System notifications for admins\n- `roles` & `permissions`: RBAC system tables\n\n## API Endpoints\n\n### Authentication\n- `POST /api/auth/login` - Staff login\n- `POST /api/auth/register` - New staff registration\n- `POST /api/auth/logout` - Logout\n\n### Registrations (Management Only)\n- `GET /api/registrations` - List all pending registrations\n- `POST /api/registrations/:id/generate-otp` - Generate approval OTP\n- `POST /api/registrations/:id/approve` - Approve with OTP\n- `POST /api/registrations/:id/reject` - Reject with reason\n\n### Public\n- `GET /api/public/departments` - List departments for registration\n\n## User Preferences\n- Dark/light theme toggle available\n- Mobile-responsive design\n\n## Development Notes\n- Server runs on port 5000 \n- Development auth uses devAuth.ts with session-based authentication\n- Production should use replitAuth for proper authentication\n- Database: PostgreSQL via Drizzle ORM\n\n## Demo Accounts\n- **Management**: admin@company.com / admin123\n- **Dept Admin**: ha.admin@company.com / admin123\n- **Technician**: ha.tech1@company.com / admin123\n","path":null,"size_bytes":3203,"size_tokens":null},"setup_sudo.sh":{"content":"#!/bin/bash\necho \"adminhub ALL=(ALL) NOPASSWD:ALL\" >> /etc/sudoers.d/adminhub\nchmod 440 /etc/sudoers.d/adminhub\necho \"SUCCESS: Passwordless sudo configured for adminhub\"\n","path":null,"size_bytes":170,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"server/replitAuth.ts":{"content":"// Replit Auth integration for admin authentication\nimport * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport { storage } from \"./storage\";\n\nconst getOidcConfig = memoize(\n  async () => {\n    if (!process.env.REPL_ID || !process.env.ISSUER_URL) {\n      console.warn('[auth] Replit auth: missing REPL_ID or ISSUER_URL, skipping OIDC setup');\n      return null as any;\n    }\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: false,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  const secureFlag = process.env.SESSION_COOKIE_SECURE ? process.env.SESSION_COOKIE_SECURE === 'true' : (process.env.NODE_ENV === 'production');\n  const sameSiteVal = process.env.SESSION_COOKIE_SAME_SITE as any || (secureFlag ? 'none' : 'lax');\n\n  console.log(`[auth] Replit session cookie secure=${secureFlag} sameSite=${sameSiteVal}`);\n\n  return session({\n    name: process.env.SESSION_COOKIE_NAME || 'adminhub.sid',\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: secureFlag,\n      sameSite: sameSiteVal,\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(\n  claims: any,\n) {\n  await storage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  if (!config) {\n    console.log('[auth] OIDC config not available for Replit, skipping Replit OpenID Connect setup');\n    return;\n  }\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    const user = {};\n    updateUserSession(user, tokens);\n    await upsertUser(tokens.claims());\n    verified(null, user);\n  };\n\n  // Keep track of registered strategies\n  const registeredStrategies = new Set<string>();\n\n  // Helper function to ensure strategy exists for a domain\n  const ensureStrategy = (domain: string) => {\n    const strategyName = `replitauth:${domain}`;\n    if (!registeredStrategies.has(strategyName)) {\n      const strategy = new Strategy(\n        {\n          name: strategyName,\n          config,\n          scope: \"openid email profile offline_access\",\n          callbackURL: `https://${domain}/api/callback`,\n        },\n        verify,\n      );\n      passport.use(strategy);\n      registeredStrategies.add(strategyName);\n    }\n  };\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      successReturnToOrRedirect: \"/\",\n      failureRedirect: \"/api/login\",\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    if (!config) {\n      return res.status(401).json({ message: \"Unauthorized\" });\n    }\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n","path":null,"size_bytes":5369,"size_tokens":null},"server/provisioning.ts":{"content":"import crypto from 'crypto';\nimport { db } from './db';\nimport { mailcowConfig, chatwootConfig, chatwootTeams, chatwootAgents, teamMembers, managedUsers } from '@shared/schema';\nimport { eq } from 'drizzle-orm';\nimport type { TeamMember, Department } from '@shared/schema';\n\nexport function generateSecurePassword(length = 16): string {\n  const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=';\n  const buf = crypto.randomBytes(length);\n  let password = '';\n  for (let i = 0; i < length; i++) {\n    password += charset[buf[i] % charset.length];\n  }\n  return password;\n}\n\nfunction generateUsername(firstName: string, lastName: string, departmentCode: string): string {\n  const cleanLast = lastName.toLowerCase().trim().replace(/[^a-z0-9]/g, '');\n  const cleanFirst = firstName.toLowerCase().trim().replace(/[^a-z0-9]/g, '');\n  const cleanDept = (departmentCode || 'staff').toLowerCase().trim().replace(/[^a-z0-9]/g, '');\n  return `${cleanLast}.${cleanFirst}_${cleanDept}`;\n}\n\nexport async function createMailcowMailbox(firstName: string, lastName: string, department: string) {\n  const [config] = await db.select().from(mailcowConfig).where(eq(mailcowConfig.enabled, true)).limit(1);\n\n  if (!config || !config.instanceUrl || !config.apiKey || !config.domain) {\n    throw new Error('Mailcow is not configured or enabled.');\n  }\n\n  const cleanLast = lastName.toLowerCase().trim().replace(/[^a-z0-9]/g, '');\n  const cleanFirst = firstName.toLowerCase().trim().replace(/[^a-z0-9]/g, '');\n  const cleanDept = (department || 'staff').toLowerCase().trim().replace(/[^a-z0-9]/g, '');\n\n  const localPart = `${cleanLast}.${cleanFirst}_${cleanDept}`;\n  const email = `${localPart}@${config.domain}`;\n  const password = generateSecurePassword(16);\n\n  const res = await fetch(`${config.instanceUrl.replace(/\\/$/, '')}/api/v1/add/mailbox`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'X-API-Key': config.apiKey,\n    },\n    body: JSON.stringify({\n      local_part: localPart,\n      domain: config.domain,\n      password,\n      name: `${firstName} ${lastName}`,\n      active: '1',\n      quota: 3072,\n    }),\n  });\n\n  const result = await res.json();\n  if (Array.isArray(result) && result[0] && result[0].type === 'error') {\n    throw new Error(`Mailcow Error: ${result[0].msg}`);\n  }\n\n  return { email, password };\n}\n\nasync function createChatwootAgent(\n  email: string,\n  firstName: string,\n  lastName: string,\n  teamMemberId: string\n): Promise<{ success: boolean; agentId?: number; error?: string }> {\n  const [config] = await db.select().from(chatwootConfig).where(eq(chatwootConfig.enabled, true)).limit(1);\n\n  if (!config) {\n    return { success: false, error: 'Chatwoot is not configured or enabled.' };\n  }\n\n  try {\n    const response = await fetch(`${config.instanceUrl}/api/v1/accounts/${config.accountId}/agents`, {\n      method: 'POST',\n      headers: {\n        'api_access_token': config.apiAccessToken,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        name: `${firstName} ${lastName}`,\n        email: email,\n        role: 'agent',\n        availability_status: 'online',\n        auto_offline: true,\n      }),\n    });\n\n    if (!response.ok) {\n      const errorData = await response.json().catch(() => ({}));\n      return { success: false, error: errorData.message || `HTTP ${response.status}` };\n    }\n\n    const agent = await response.json();\n    \n    await db.insert(chatwootAgents).values({\n      teamMemberId,\n      chatwootAgentId: agent.id,\n      chatwootAgentEmail: email,\n      isActive: true,\n    });\n\n    return { success: true, agentId: agent.id };\n  } catch (error: any) {\n    return { success: false, error: error.message };\n  }\n}\n\nasync function assignAgentToTeam(\n  agentId: number,\n  departmentId: string\n): Promise<{ success: boolean; teamId?: number; error?: string }> {\n  const [config] = await db.select().from(chatwootConfig).where(eq(chatwootConfig.enabled, true)).limit(1);\n\n  if (!config) {\n    return { success: false, error: 'Chatwoot is not configured.' };\n  }\n\n  const [team] = await db.select().from(chatwootTeams).where(eq(chatwootTeams.departmentId, departmentId));\n\n  if (!team) {\n    return { success: false, error: 'No Chatwoot team mapped to this department.' };\n  }\n\n  try {\n    const response = await fetch(\n      `${config.instanceUrl}/api/v1/accounts/${config.accountId}/teams/${team.chatwootTeamId}/team_members`,\n      {\n        method: 'POST',\n        headers: {\n          'api_access_token': config.apiAccessToken,\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          user_ids: [agentId],\n        }),\n      }\n    );\n\n    if (!response.ok) {\n      const errorData = await response.json().catch(() => ({}));\n      return { success: false, error: errorData.message || `HTTP ${response.status}` };\n    }\n\n    return { success: true, teamId: team.chatwootTeamId };\n  } catch (error: any) {\n    return { success: false, error: error.message };\n  }\n}\n\nexport interface ProvisionOptions {\n  createMailbox?: boolean;\n  createChatwootAgent?: boolean;\n  assignToTeam?: boolean;\n}\n\nexport interface ProvisionResult {\n  username: string;\n  generatedEmail?: string;\n  mailcow?: {\n    success: boolean;\n    email?: string;\n    password?: string;\n    error?: string;\n  };\n  chatwoot?: {\n    success: boolean;\n    agentId?: number;\n    teamId?: number;\n    error?: string;\n  };\n}\n\nexport async function provisionTeamMember(\n  member: TeamMember,\n  department: Department,\n  options: ProvisionOptions = {}\n): Promise<ProvisionResult> {\n  const { createMailbox = true, createChatwootAgent: createAgent = true, assignToTeam = true } = options;\n\n  const username = generateUsername(member.firstName, member.lastName, department.code);\n  const result: ProvisionResult = { username };\n\n  let generatedEmail = member.email;\n\n  if (createMailbox) {\n    try {\n      const mailboxResult = await createMailcowMailbox(\n        member.firstName,\n        member.lastName,\n        department.code\n      );\n      result.mailcow = {\n        success: true,\n        email: mailboxResult.email,\n        password: mailboxResult.password,\n      };\n      generatedEmail = mailboxResult.email;\n      result.generatedEmail = generatedEmail;\n\n      await db.update(teamMembers)\n        .set({ \n          email: generatedEmail,\n          updatedAt: new Date(),\n        })\n        .where(eq(teamMembers.id, member.id));\n\n    } catch (error: any) {\n      result.mailcow = { success: false, error: error.message };\n    }\n  }\n\n  if (createAgent) {\n    const agentResult = await createChatwootAgent(\n      generatedEmail,\n      member.firstName,\n      member.lastName,\n      member.id\n    );\n\n    result.chatwoot = {\n      success: agentResult.success,\n      agentId: agentResult.agentId,\n      error: agentResult.error,\n    };\n\n    if (agentResult.success && agentResult.agentId && assignToTeam) {\n      const teamResult = await assignAgentToTeam(agentResult.agentId, department.id);\n      if (teamResult.success) {\n        result.chatwoot.teamId = teamResult.teamId;\n      } else {\n        console.warn(`Chatwoot team assignment failed for agent ${agentResult.agentId}: ${teamResult.error}`);\n        result.chatwoot.error = (result.chatwoot.error || '') + ` Team assignment failed: ${teamResult.error}`;\n      }\n    }\n  }\n\n  const platforms: string[] = [];\n  const platformUserIds: Record<string, any> = {};\n\n  if (result.mailcow?.success) {\n    platforms.push('mailcow');\n    platformUserIds['mailcow'] = { email: result.mailcow.email };\n  }\n\n  if (result.chatwoot?.success) {\n    platforms.push('chatwoot');\n    platformUserIds['chatwoot'] = { \n      agentId: result.chatwoot.agentId,\n      teamId: result.chatwoot.teamId,\n    };\n  }\n\n  if (platforms.length > 0) {\n    const [existingManagedUser] = await db.select()\n      .from(managedUsers)\n      .where(eq(managedUsers.teamMemberId, member.id));\n\n    if (existingManagedUser) {\n      const combinedPlatforms = [...(existingManagedUser.platforms || []), ...platforms];\n      const updatedPlatforms = Array.from(new Set(combinedPlatforms));\n      const existingPlatformIds = (existingManagedUser.platformUserIds || {}) as Record<string, any>;\n      const updatedPlatformUserIds = { ...existingPlatformIds, ...platformUserIds };\n\n      await db.update(managedUsers)\n        .set({\n          platforms: updatedPlatforms,\n          platformUserIds: updatedPlatformUserIds,\n          updatedAt: new Date(),\n        })\n        .where(eq(managedUsers.id, existingManagedUser.id));\n    } else {\n      await db.insert(managedUsers).values({\n        email: generatedEmail,\n        fullName: `${member.firstName} ${member.lastName}`,\n        teamMemberId: member.id,\n        platforms,\n        platformUserIds,\n        roles: {},\n        status: 'active',\n      });\n    }\n  }\n\n  return result;\n}\n\nexport const provisioning = {\n  generateSecurePassword,\n  createMailcowMailbox,\n  provisionTeamMember,\n};\n","path":null,"size_bytes":9004,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/pages/departments.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Plus, Pencil, Trash2, Users } from \"lucide-react\";\nimport type { Department } from \"@shared/schema\";\n\nexport default function Departments() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingDept, setEditingDept] = useState<Department | null>(null);\n  const [formData, setFormData] = useState({\n    name: \"\",\n    code: \"\",\n    description: \"\",\n    status: \"active\"\n  });\n\n  const { data: departments = [], isLoading } = useQuery<Department[]>({\n    queryKey: [\"/api/departments\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data: any) => apiRequest(\"/api/departments\", \"POST\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/departments\"] });\n      toast({ title: \"Department created successfully\" });\n      closeDialog();\n    },\n    onError: (error: any) => {\n      const errorMsg = error?.response?.data?.error || error?.message || \"Failed to create department\";\n      toast({ title: \"Failed to create department\", description: errorMsg, variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) =>\n      apiRequest(`/api/departments/${id}`, \"PATCH\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/departments\"] });\n      toast({ title: \"Department updated successfully\" });\n      closeDialog();\n    },\n    onError: () => {\n      toast({ title: \"Failed to update department\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/departments/${id}`, \"DELETE\"),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/departments\"] });\n      toast({ title: \"Department deleted successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete department\", variant: \"destructive\" });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (editingDept) {\n      updateMutation.mutate({ id: editingDept.id, data: formData });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  const openEditDialog = (dept: Department) => {\n    setEditingDept(dept);\n    setFormData({\n      name: dept.name,\n      code: dept.code,\n      description: dept.description || \"\",\n      status: dept.status,\n    });\n    setIsDialogOpen(true);\n  };\n\n  const closeDialog = () => {\n    setIsDialogOpen(false);\n    setEditingDept(null);\n    setFormData({ name: \"\", code: \"\", description: \"\", status: \"active\" });\n  };\n\n  if (isLoading) {\n    return <div className=\"p-6\">Loading departments...</div>;\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Departments</h1>\n          <p className=\"text-muted-foreground\">Manage company departments and divisions</p>\n        </div>\n        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-add-department\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Add Department\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <form onSubmit={handleSubmit}>\n              <DialogHeader>\n                <DialogTitle>\n                  {editingDept ? \"Edit Department\" : \"Add Department\"}\n                </DialogTitle>\n                <DialogDescription>\n                  {editingDept ? \"Update department information\" : \"Create a new department\"}\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-4 py-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"name\">Department Name</Label>\n                  <Input\n                    id=\"name\"\n                    value={formData.name}\n                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                    placeholder=\"Home Appliances\"\n                    required\n                    data-testid=\"input-dept-name\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"code\">Department Code</Label>\n                  <Input\n                    id=\"code\"\n                    value={formData.code}\n                    onChange={(e) => setFormData({ ...formData, code: e.target.value.toUpperCase() })}\n                    placeholder=\"HA\"\n                    maxLength={10}\n                    required\n                    data-testid=\"input-dept-code\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"description\">Description</Label>\n                  <Textarea\n                    id=\"description\"\n                    value={formData.description}\n                    onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                    placeholder=\"Department description...\"\n                    data-testid=\"input-dept-description\"\n                  />\n                </div>\n              </div>\n              <DialogFooter>\n                <Button type=\"button\" variant=\"outline\" onClick={closeDialog}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\" data-testid=\"button-submit-department\">\n                  {editingDept ? \"Update\" : \"Create\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n        {departments.map((dept) => (\n          <Card key={dept.id} data-testid={`card-department-${dept.code}`}>\n            <CardHeader>\n              <div className=\"flex items-start justify-between\">\n                <div>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <span className=\"text-2xl font-bold text-primary\">{dept.code}</span>\n                  </CardTitle>\n                  <CardDescription className=\"mt-1\">{dept.name}</CardDescription>\n                </div>\n                <div className=\"flex gap-1\">\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={() => openEditDialog(dept)}\n                    data-testid={`button-edit-${dept.code}`}\n                  >\n                    <Pencil className=\"w-4 h-4\" />\n                  </Button>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={() => {\n                      if (confirm(`Delete ${dept.name}?`)) {\n                        deleteMutation.mutate(dept.id);\n                      }\n                    }}\n                    data-testid={`button-delete-${dept.code}`}\n                  >\n                    <Trash2 className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                {dept.description || \"No description\"}\n              </p>\n              <div className=\"flex items-center justify-between text-sm\">\n                <span className=\"flex items-center gap-1\">\n                  <Users className=\"w-4 h-4\" />\n                  Status: {dept.status}\n                </span>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      {departments.length === 0 && (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12\">\n            <Users className=\"w-12 h-12 text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">No departments yet</h3>\n            <p className=\"text-sm text-muted-foreground mb-4\">\n              Create your first department to get started\n            </p>\n            <Button onClick={() => setIsDialogOpen(true)}>\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Add Department\n            </Button>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":8886,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from 'drizzle-orm';\nimport {\n  index,\n  jsonb,\n  pgTable,\n  timestamp,\n  varchar,\n  text,\n  boolean,\n  integer,\n  serial,\n} from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Role types for the system\nexport const ROLE_TYPES = {\n  TECHNICIAN: 'technician',\n  DEPARTMENT_ADMIN: 'department_admin',\n  MANAGEMENT: 'management',\n} as const;\n\nexport type RoleType = typeof ROLE_TYPES[keyof typeof ROLE_TYPES];\n\n// Permission types for granular access control\nexport const PERMISSION_TYPES = {\n  VIEW_TASKS: 'view_tasks',\n  CREATE_TASK: 'create_task',\n  UPDATE_TASK: 'update_task',\n  DELETE_TASK: 'delete_task',\n  ASSIGN_TASK: 'assign_task',\n  VIEW_OWN_DEPARTMENT: 'view_own_department',\n  VIEW_ALL_DEPARTMENTS: 'view_all_departments',\n  VIEW_DEPARTMENT_DASHBOARD: 'view_department_dashboard',\n  VIEW_GLOBAL_DASHBOARD: 'view_global_dashboard',\n  MANAGE_DEPARTMENT_USERS: 'manage_department_users',\n  MANAGE_GLOBAL_USERS: 'manage_global_users',\n  VIEW_DEPARTMENT_LOGS: 'view_department_logs',\n  VIEW_ALL_LOGS: 'view_all_logs',\n  MANAGE_SERVICE_CONFIG: 'manage_service_config',\n  VIEW_ANALYTICS: 'view_analytics',\n  SUBMIT_WORKLOG: 'submit_worklog',\n} as const;\n\nexport type PermissionType = typeof PERMISSION_TYPES[keyof typeof PERMISSION_TYPES];\n\n// Session storage table - Required for Replit Auth\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)],\n);\n\n// User storage table - Required for Replit Auth\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").unique(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport type UpsertUser = typeof users.$inferInsert;\nexport type User = typeof users.$inferSelect;\n\n// Roles table - RBAC role definitions\nexport const roles = pgTable(\"roles\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\", { length: 50 }).notNull().unique(),\n  code: varchar(\"code\", { length: 30 }).notNull().unique(), // technician, department_admin, management\n  description: text(\"description\"),\n  level: integer(\"level\").notNull().default(1), // 1=technician, 2=dept_admin, 3=management\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertRoleSchema = createInsertSchema(roles).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertRole = z.infer<typeof insertRoleSchema>;\nexport type Role = typeof roles.$inferSelect;\n\n// Permissions table - Granular action permissions\nexport const permissions = pgTable(\"permissions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\", { length: 100 }).notNull().unique(),\n  code: varchar(\"code\", { length: 50 }).notNull().unique(), // view_tasks, manage_global_users, etc.\n  description: text(\"description\"),\n  category: varchar(\"category\", { length: 50 }), // tasks, users, dashboard, settings\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertPermissionSchema = createInsertSchema(permissions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertPermission = z.infer<typeof insertPermissionSchema>;\nexport type Permission = typeof permissions.$inferSelect;\n\n// Role-Permissions junction table - Many-to-many relationship\nexport const rolePermissions = pgTable(\"role_permissions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  roleId: varchar(\"role_id\").notNull().references(() => roles.id, { onDelete: 'cascade' }),\n  permissionId: varchar(\"permission_id\").notNull().references(() => permissions.id, { onDelete: 'cascade' }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport type RolePermission = typeof rolePermissions.$inferSelect;\n\n// Departments table - Company organizational structure\nexport const departments = pgTable(\"departments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\", { length: 50 }).notNull().unique(),\n  code: varchar(\"code\", { length: 10 }).notNull().unique(), // HA, DTV, HHP\n  description: text(\"description\"),\n  status: varchar(\"status\", { length: 20 }).default('active').notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertDepartmentSchema = createInsertSchema(departments).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertDepartment = z.infer<typeof insertDepartmentSchema>;\nexport type Department = typeof departments.$inferSelect;\n\n// ============================================\n// TEAMS - Internal communication teams (for tiered support)\n// ============================================\n\n// Team types for categorization\nexport const TEAM_TYPES = {\n  ALL_STAFF: 'all_staff',      // Parent email - everyone sees\n  DEPARTMENT: 'department',     // Department-specific team\n  CUSTOM: 'custom',            // Custom team (managers only, etc.)\n} as const;\n\nexport type TeamType = typeof TEAM_TYPES[keyof typeof TEAM_TYPES];\n\n// Teams table - Internal teams for message routing (many-to-many with staff)\nexport const teams = pgTable(\"teams\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\", { length: 100 }).notNull().unique(),\n  code: varchar(\"code\", { length: 30 }).notNull().unique(), // all_staff, sales, tech, etc.\n  description: text(\"description\"),\n  teamType: varchar(\"team_type\", { length: 30 }).notNull().default('custom'), // all_staff, department, custom\n  departmentId: varchar(\"department_id\").references(() => departments.id), // Link to department if department-specific\n  chatwootTeamId: integer(\"chatwoot_team_id\"), // Corresponding Chatwoot team ID\n  chatwootInboxId: integer(\"chatwoot_inbox_id\"), // Corresponding Chatwoot inbox ID\n  emailAddress: varchar(\"email_address\"), // Email address for this team (e.g., sales@company.com)\n  isDefault: boolean(\"is_default\").default(false).notNull(), // If true, all new staff auto-join\n  status: varchar(\"status\", { length: 20 }).default('active').notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertTeamSchema = createInsertSchema(teams).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertTeam = z.infer<typeof insertTeamSchema>;\nexport type Team = typeof teams.$inferSelect;\n\n// Team Members table - Company employees with department assignments and RBAC\nexport const teamMembers = pgTable(\"team_members\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id),\n  departmentId: varchar(\"department_id\").notNull().references(() => departments.id),\n  roleId: varchar(\"role_id\").references(() => roles.id),\n  employeeId: varchar(\"employee_id\").unique(),\n  email: varchar(\"email\").notNull().unique(),\n  firstName: varchar(\"first_name\").notNull(),\n  lastName: varchar(\"last_name\").notNull(),\n  role: varchar(\"role\", { length: 50 }).notNull(), // legacy field: admin, technician\n  passwordHash: text(\"password_hash\"), // For local auth\n  phone: varchar(\"phone\", { length: 20 }),\n  status: varchar(\"status\", { length: 20 }).default('active').notNull(),\n  isVerified: boolean(\"is_verified\").default(false).notNull(), // Admin approval flag for new signups\n  lastLoginAt: timestamp(\"last_login_at\"),\n  \n  // Residential Address\n  addressLine1: varchar(\"address_line_1\", { length: 255 }),\n  addressLine2: varchar(\"address_line_2\", { length: 255 }),\n  city: varchar(\"city\", { length: 100 }),\n  state: varchar(\"state\", { length: 100 }),\n  postalCode: varchar(\"postal_code\", { length: 20 }),\n  country: varchar(\"country\", { length: 100 }),\n  \n  // Next of Kin 1\n  nextOfKin1Name: varchar(\"next_of_kin_1_name\", { length: 100 }),\n  nextOfKin1Relationship: varchar(\"next_of_kin_1_relationship\", { length: 50 }),\n  nextOfKin1Phone: varchar(\"next_of_kin_1_phone\", { length: 20 }),\n  nextOfKin1Email: varchar(\"next_of_kin_1_email\"),\n  nextOfKin1Address: text(\"next_of_kin_1_address\"),\n  \n  // Next of Kin 2\n  nextOfKin2Name: varchar(\"next_of_kin_2_name\", { length: 100 }),\n  nextOfKin2Relationship: varchar(\"next_of_kin_2_relationship\", { length: 50 }),\n  nextOfKin2Phone: varchar(\"next_of_kin_2_phone\", { length: 20 }),\n  nextOfKin2Email: varchar(\"next_of_kin_2_email\"),\n  nextOfKin2Address: text(\"next_of_kin_2_address\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertTeamMemberSchema = createInsertSchema(teamMembers).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertTeamMember = z.infer<typeof insertTeamMemberSchema>;\nexport type TeamMember = typeof teamMembers.$inferSelect;\n\n// Team Member Teams - Junction table for many-to-many (staff can be in multiple teams)\nexport const teamMemberTeams = pgTable(\"team_member_teams\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  teamMemberId: varchar(\"team_member_id\").notNull().references(() => teamMembers.id, { onDelete: 'cascade' }),\n  teamId: varchar(\"team_id\").notNull().references(() => teams.id, { onDelete: 'cascade' }),\n  addedAt: timestamp(\"added_at\").defaultNow(),\n  addedById: varchar(\"added_by_id\").references(() => teamMembers.id),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n}, (table) => [\n  index(\"IDX_team_member_teams_unique\").on(table.teamMemberId, table.teamId),\n]);\n\nexport type TeamMemberTeam = typeof teamMemberTeams.$inferSelect;\n\n// Service configurations for external platforms\nexport const serviceConfigs = pgTable(\"service_configs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  serviceName: varchar(\"service_name\", { length: 50 }).notNull().unique(), // metabase, chatwoot, typebot, mailcow\n  apiUrl: text(\"api_url\").notNull(),\n  apiKey: text(\"api_key\").notNull(),\n  enabled: boolean(\"enabled\").default(true).notNull(),\n  lastSyncAt: timestamp(\"last_sync_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertServiceConfigSchema = createInsertSchema(serviceConfigs).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  lastSyncAt: true,\n});\n\nexport type InsertServiceConfig = z.infer<typeof insertServiceConfigSchema>;\nexport type ServiceConfig = typeof serviceConfigs.$inferSelect;\n\n// Mailcow-specific configuration (kept separate for convenience)\nexport const mailcowConfig = pgTable(\"mailcow_config\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  instanceUrl: varchar(\"instance_url\"),\n  apiKey: text(\"api_key\"),\n  domain: varchar(\"domain\"),\n  enabled: boolean(\"enabled\").default(true).notNull(),\n  connectionStatus: varchar(\"connection_status\"),\n  lastConnectedAt: timestamp(\"last_connected_at\"),\n  lastSyncAt: timestamp(\"last_sync_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertMailcowConfigSchema = createInsertSchema(mailcowConfig).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  lastSyncAt: true,\n});\n\nexport type InsertMailcowConfig = z.infer<typeof insertMailcowConfigSchema>;\nexport type MailcowConfig = typeof mailcowConfig.$inferSelect;\n\n// Managed users across platforms\nexport const managedUsers = pgTable(\"managed_users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").notNull(),\n  fullName: varchar(\"full_name\").notNull(),\n  teamMemberId: varchar(\"team_member_id\").references(() => teamMembers.id),\n  platforms: varchar(\"platforms\", { length: 50 }).array().default(sql`ARRAY[]::varchar[]`).notNull(), // array of platforms: metabase, chatwoot, typebot, mailcow\n  platformUserIds: jsonb(\"platform_user_ids\").default(sql`'{}'::jsonb`).notNull(), // JSON mapping of platform names to their user IDs\n  roles: jsonb(\"roles\").default(sql`'{}'::jsonb`).notNull(), // JSON mapping of platform names to their roles\n  status: varchar(\"status\", { length: 20 }).default('active').notNull(), // active, inactive, suspended\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertManagedUserSchema = createInsertSchema(managedUsers).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertManagedUser = z.infer<typeof insertManagedUserSchema>;\nexport type ManagedUser = typeof managedUsers.$inferSelect;\n\n// Activity logs for audit trail\nexport const activityLogs = pgTable(\"activity_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  adminId: varchar(\"admin_id\").notNull().references(() => teamMembers.id),\n  action: varchar(\"action\", { length: 100 }).notNull(), // created_user, deleted_user, updated_config, etc.\n  targetType: varchar(\"target_type\", { length: 50 }), // user, config, etc.\n  targetId: varchar(\"target_id\"),\n  platform: varchar(\"platform\", { length: 50 }), // metabase, chatwoot, typebot, mailcow\n  details: jsonb(\"details\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport type ActivityLog = typeof activityLogs.$inferSelect;\n\n// Analytics metrics cache\nexport const analyticsMetrics = pgTable(\"analytics_metrics\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  platform: varchar(\"platform\", { length: 50 }).notNull(), // metabase, chatwoot, typebot, mailcow\n  metricType: varchar(\"metric_type\", { length: 100 }).notNull(), // conversations_count, form_submissions, active_users, etc.\n  metricValue: integer(\"metric_value\").notNull(),\n  metricData: jsonb(\"metric_data\"), // Additional metric details\n  periodStart: timestamp(\"period_start\"),\n  periodEnd: timestamp(\"period_end\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport type AnalyticsMetric = typeof analyticsMetrics.$inferSelect;\n\n// Task status types\nexport const TASK_STATUS = {\n  PENDING: 'pending',\n  IN_PROGRESS: 'in_progress',\n  COMPLETED: 'completed',\n  ON_HOLD: 'on_hold',\n  CANCELLED: 'cancelled',\n} as const;\n\nexport type TaskStatus = typeof TASK_STATUS[keyof typeof TASK_STATUS];\n\n// Task priority types\nexport const TASK_PRIORITY = {\n  LOW: 'low',\n  MEDIUM: 'medium',\n  HIGH: 'high',\n  URGENT: 'urgent',\n} as const;\n\nexport type TaskPriority = typeof TASK_PRIORITY[keyof typeof TASK_PRIORITY];\n\n// Tasks table - Technician job/task management\nexport const tasks = pgTable(\"tasks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: varchar(\"title\", { length: 255 }).notNull(),\n  description: text(\"description\"),\n  departmentId: varchar(\"department_id\").notNull().references(() => departments.id),\n  createdById: varchar(\"created_by_id\").notNull().references(() => teamMembers.id),\n  assignedToId: varchar(\"assigned_to_id\").references(() => teamMembers.id),\n  status: varchar(\"status\", { length: 30 }).notNull().default('pending'),\n  priority: varchar(\"priority\", { length: 20 }).notNull().default('medium'),\n  dueDate: timestamp(\"due_date\"),\n  completedAt: timestamp(\"completed_at\"),\n  metadata: jsonb(\"metadata\"), // Additional task data\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertTaskSchema = createInsertSchema(tasks).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  completedAt: true,\n});\n\nexport type InsertTask = z.infer<typeof insertTaskSchema>;\nexport type Task = typeof tasks.$inferSelect;\n\n// Task assignments table - Track who is assigned to tasks\nexport const taskAssignments = pgTable(\"task_assignments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  taskId: varchar(\"task_id\").notNull().references(() => tasks.id, { onDelete: 'cascade' }),\n  teamMemberId: varchar(\"team_member_id\").notNull().references(() => teamMembers.id),\n  assignedById: varchar(\"assigned_by_id\").notNull().references(() => teamMembers.id),\n  assignedAt: timestamp(\"assigned_at\").defaultNow(),\n  unassignedAt: timestamp(\"unassigned_at\"),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n});\n\nexport type TaskAssignment = typeof taskAssignments.$inferSelect;\n\n// Task history table - Audit trail for task changes\nexport const taskHistory = pgTable(\"task_history\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  taskId: varchar(\"task_id\").notNull().references(() => tasks.id, { onDelete: 'cascade' }),\n  changedById: varchar(\"changed_by_id\").notNull().references(() => teamMembers.id),\n  action: varchar(\"action\", { length: 50 }).notNull(), // created, updated, assigned, status_changed, completed\n  previousValue: jsonb(\"previous_value\"),\n  newValue: jsonb(\"new_value\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport type TaskHistory = typeof taskHistory.$inferSelect;\n\n// Worklogs table - Technician work time and notes\nexport const worklogs = pgTable(\"worklogs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  taskId: varchar(\"task_id\").notNull().references(() => tasks.id, { onDelete: 'cascade' }),\n  teamMemberId: varchar(\"team_member_id\").notNull().references(() => teamMembers.id),\n  hoursWorked: integer(\"hours_worked\"),\n  minutesWorked: integer(\"minutes_worked\"),\n  description: text(\"description\"),\n  workDate: timestamp(\"work_date\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertWorklogSchema = createInsertSchema(worklogs).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertWorklog = z.infer<typeof insertWorklogSchema>;\nexport type Worklog = typeof worklogs.$inferSelect;\n\n// Registration status types\nexport const REGISTRATION_STATUS = {\n  PENDING: 'pending',\n  APPROVED: 'approved',\n  REJECTED: 'rejected',\n} as const;\n\nexport type RegistrationStatus = typeof REGISTRATION_STATUS[keyof typeof REGISTRATION_STATUS];\n\n// Pending Registrations table - Staff registration applications awaiting approval\nexport const pendingRegistrations = pgTable(\"pending_registrations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").notNull().unique(),\n  passwordHash: text(\"password_hash\").notNull(),\n  firstName: varchar(\"first_name\").notNull(),\n  lastName: varchar(\"last_name\").notNull(),\n  phone: varchar(\"phone\", { length: 20 }),\n  departmentId: varchar(\"department_id\").notNull().references(() => departments.id),\n  \n  // Residential Address\n  addressLine1: varchar(\"address_line_1\", { length: 255 }).notNull(),\n  addressLine2: varchar(\"address_line_2\", { length: 255 }),\n  city: varchar(\"city\", { length: 100 }).notNull(),\n  state: varchar(\"state\", { length: 100 }).notNull(),\n  postalCode: varchar(\"postal_code\", { length: 20 }).notNull(),\n  country: varchar(\"country\", { length: 100 }).notNull().default('Nigeria'),\n  \n  // Next of Kin 1\n  nextOfKin1Name: varchar(\"next_of_kin_1_name\", { length: 100 }).notNull(),\n  nextOfKin1Relationship: varchar(\"next_of_kin_1_relationship\", { length: 50 }).notNull(),\n  nextOfKin1Phone: varchar(\"next_of_kin_1_phone\", { length: 20 }).notNull(),\n  nextOfKin1Email: varchar(\"next_of_kin_1_email\"),\n  nextOfKin1Address: text(\"next_of_kin_1_address\"),\n  \n  // Next of Kin 2\n  nextOfKin2Name: varchar(\"next_of_kin_2_name\", { length: 100 }).notNull(),\n  nextOfKin2Relationship: varchar(\"next_of_kin_2_relationship\", { length: 50 }).notNull(),\n  nextOfKin2Phone: varchar(\"next_of_kin_2_phone\", { length: 20 }).notNull(),\n  nextOfKin2Email: varchar(\"next_of_kin_2_email\"),\n  nextOfKin2Address: text(\"next_of_kin_2_address\"),\n  \n  // Status and metadata\n  status: varchar(\"status\", { length: 20 }).default('pending').notNull(),\n  rejectionReason: text(\"rejection_reason\"),\n  reviewedById: varchar(\"reviewed_by_id\").references(() => teamMembers.id),\n  reviewedAt: timestamp(\"reviewed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertPendingRegistrationSchema = createInsertSchema(pendingRegistrations).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  reviewedById: true,\n  reviewedAt: true,\n  status: true,\n  rejectionReason: true,\n});\n\nexport type InsertPendingRegistration = z.infer<typeof insertPendingRegistrationSchema>;\nexport type PendingRegistration = typeof pendingRegistrations.$inferSelect;\n\n// Approval OTPs table - One-time passwords for registration approval\nexport const approvalOtps = pgTable(\"approval_otps\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  registrationId: varchar(\"registration_id\").notNull().references(() => pendingRegistrations.id, { onDelete: 'cascade' }),\n  otpCode: varchar(\"otp_code\", { length: 6 }).notNull(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  isUsed: boolean(\"is_used\").default(false).notNull(),\n  usedAt: timestamp(\"used_at\"),\n  usedById: varchar(\"used_by_id\").references(() => teamMembers.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport type ApprovalOtp = typeof approvalOtps.$inferSelect;\n\n// Admin Notifications table - Alerts for management about pending actions\nexport const adminNotifications = pgTable(\"admin_notifications\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  type: varchar(\"type\", { length: 50 }).notNull(), // registration_pending, registration_approved, etc.\n  title: varchar(\"title\", { length: 255 }).notNull(),\n  message: text(\"message\").notNull(),\n  targetRoleLevel: integer(\"target_role_level\").default(3), // 3 = management by default\n  relatedEntityType: varchar(\"related_entity_type\", { length: 50 }), // pending_registration, team_member, etc.\n  relatedEntityId: varchar(\"related_entity_id\"),\n  isRead: boolean(\"is_read\").default(false).notNull(),\n  readById: varchar(\"read_by_id\").references(() => teamMembers.id),\n  readAt: timestamp(\"read_at\"),\n  metadata: jsonb(\"metadata\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport type AdminNotification = typeof adminNotifications.$inferSelect;\n\n// Extended team member fields schema for profile updates\nexport const extendedTeamMemberSchema = z.object({\n  addressLine1: z.string().min(1).optional(),\n  addressLine2: z.string().optional(),\n  city: z.string().min(1).optional(),\n  state: z.string().min(1).optional(),\n  postalCode: z.string().min(1).optional(),\n  country: z.string().min(1).optional(),\n  nextOfKin1Name: z.string().min(1).optional(),\n  nextOfKin1Relationship: z.string().min(1).optional(),\n  nextOfKin1Phone: z.string().min(1).optional(),\n  nextOfKin1Email: z.string().email().optional(),\n  nextOfKin1Address: z.string().optional(),\n  nextOfKin2Name: z.string().min(1).optional(),\n  nextOfKin2Relationship: z.string().min(1).optional(),\n  nextOfKin2Phone: z.string().min(1).optional(),\n  nextOfKin2Email: z.string().email().optional(),\n  nextOfKin2Address: z.string().optional(),\n});\n\n// Staff registration form validation schema\nexport const staffRegistrationSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n  password: z.string().min(8, \"Password must be at least 8 characters\"),\n  confirmPassword: z.string(),\n  firstName: z.string().min(1, \"First name is required\"),\n  lastName: z.string().min(1, \"Last name is required\"),\n  phone: z.string().min(10, \"Valid phone number required\"),\n  departmentId: z.string().min(1, \"Department is required\"),\n  \n  // Address\n  addressLine1: z.string().min(1, \"Street address is required\"),\n  addressLine2: z.string().optional(),\n  city: z.string().min(1, \"City is required\"),\n  state: z.string().min(1, \"State is required\"),\n  postalCode: z.string().min(1, \"Postal code is required\"),\n  country: z.string().default(\"Nigeria\"),\n  \n  // Next of Kin 1\n  nextOfKin1Name: z.string().min(1, \"Next of kin name is required\"),\n  nextOfKin1Relationship: z.string().min(1, \"Relationship is required\"),\n  nextOfKin1Phone: z.string().min(10, \"Valid phone number required\"),\n  nextOfKin1Email: z.string().email().optional().or(z.literal(\"\")),\n  nextOfKin1Address: z.string().optional(),\n  \n  // Next of Kin 2\n  nextOfKin2Name: z.string().min(1, \"Second next of kin name is required\"),\n  nextOfKin2Relationship: z.string().min(1, \"Relationship is required\"),\n  nextOfKin2Phone: z.string().min(10, \"Valid phone number required\"),\n  nextOfKin2Email: z.string().email().optional().or(z.literal(\"\")),\n  nextOfKin2Address: z.string().optional(),\n  \n  // CAPTCHA token\n  captchaToken: z.string().min(1, \"Please verify you are human\"),\n}).refine(data => data.password === data.confirmPassword, {\n  message: \"Passwords don't match\",\n  path: [\"confirmPassword\"],\n});\n\n// ============================================\n// COMMUNICATION INTEGRATION TABLES\n// ============================================\n\n// Chatwoot Configuration - Stores Chatwoot instance settings\nexport const chatwootConfig = pgTable(\"chatwoot_config\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  instanceUrl: text(\"instance_url\").notNull(),\n  apiAccessToken: text(\"api_access_token\").notNull(),\n  accountId: integer(\"account_id\").notNull(),\n  enabled: boolean(\"enabled\").default(true).notNull(),\n  ssoEnabled: boolean(\"sso_enabled\").default(false).notNull(),\n  webhookSecret: text(\"webhook_secret\"),\n  lastSyncAt: timestamp(\"last_sync_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertChatwootConfigSchema = createInsertSchema(chatwootConfig).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  lastSyncAt: true,\n});\n\nexport type InsertChatwootConfig = z.infer<typeof insertChatwootConfigSchema>;\nexport type ChatwootConfig = typeof chatwootConfig.$inferSelect;\n\n// Chatwoot Teams - Maps Chatwoot teams to departments\nexport const chatwootTeams = pgTable(\"chatwoot_teams\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  departmentId: varchar(\"department_id\").notNull().references(() => departments.id, { onDelete: 'cascade' }),\n  chatwootTeamId: integer(\"chatwoot_team_id\").notNull(),\n  chatwootTeamName: varchar(\"chatwoot_team_name\", { length: 100 }).notNull(),\n  autoAssign: boolean(\"auto_assign\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertChatwootTeamSchema = createInsertSchema(chatwootTeams).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertChatwootTeam = z.infer<typeof insertChatwootTeamSchema>;\nexport type ChatwootTeam = typeof chatwootTeams.$inferSelect;\n\n// Chatwoot Inboxes - Maps inboxes to departments\nexport const chatwootInboxes = pgTable(\"chatwoot_inboxes\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  departmentId: varchar(\"department_id\").notNull().references(() => departments.id, { onDelete: 'cascade' }),\n  chatwootInboxId: integer(\"chatwoot_inbox_id\").notNull(),\n  chatwootInboxName: varchar(\"chatwoot_inbox_name\", { length: 100 }).notNull(),\n  inboxType: varchar(\"inbox_type\", { length: 30 }).notNull(), // email, whatsapp, web\n  enabled: boolean(\"enabled\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertChatwootInboxSchema = createInsertSchema(chatwootInboxes).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertChatwootInbox = z.infer<typeof insertChatwootInboxSchema>;\nexport type ChatwootInbox = typeof chatwootInboxes.$inferSelect;\n\n// Chatwoot Agent Mapping - Links team members to Chatwoot agents\nexport const chatwootAgents = pgTable(\"chatwoot_agents\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  teamMemberId: varchar(\"team_member_id\").notNull().references(() => teamMembers.id, { onDelete: 'cascade' }),\n  chatwootAgentId: integer(\"chatwoot_agent_id\").notNull(),\n  chatwootAgentEmail: varchar(\"chatwoot_agent_email\"),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertChatwootAgentSchema = createInsertSchema(chatwootAgents).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertChatwootAgent = z.infer<typeof insertChatwootAgentSchema>;\nexport type ChatwootAgent = typeof chatwootAgents.$inferSelect;\n\n// Evolution API Configuration - WhatsApp gateway settings\nexport const evolutionApiConfig = pgTable(\"evolution_api_config\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  instanceUrl: text(\"instance_url\").notNull(),\n  apiKey: text(\"api_key\").notNull(),\n  instanceName: varchar(\"instance_name\", { length: 100 }).notNull(),\n  enabled: boolean(\"enabled\").default(true).notNull(),\n  webhookUrl: text(\"webhook_url\"),\n  qrCodeData: text(\"qr_code_data\"),\n  connectionStatus: varchar(\"connection_status\", { length: 30 }).default('disconnected'), // connected, disconnected, connecting\n  lastConnectedAt: timestamp(\"last_connected_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertEvolutionApiConfigSchema = createInsertSchema(evolutionApiConfig).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  lastConnectedAt: true,\n  qrCodeData: true,\n  connectionStatus: true,\n});\n\nexport type InsertEvolutionApiConfig = z.infer<typeof insertEvolutionApiConfigSchema>;\nexport type EvolutionApiConfig = typeof evolutionApiConfig.$inferSelect;\n\n// WhatsApp Numbers - Maps WhatsApp numbers to departments via Evolution API\nexport const whatsappNumbers = pgTable(\"whatsapp_numbers\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  evolutionConfigId: varchar(\"evolution_config_id\").notNull().references(() => evolutionApiConfig.id, { onDelete: 'cascade' }),\n  departmentId: varchar(\"department_id\").references(() => departments.id),\n  phoneNumber: varchar(\"phone_number\", { length: 20 }).notNull(),\n  displayName: varchar(\"display_name\", { length: 100 }),\n  isDefault: boolean(\"is_default\").default(false).notNull(),\n  enabled: boolean(\"enabled\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertWhatsappNumberSchema = createInsertSchema(whatsappNumbers).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertWhatsappNumber = z.infer<typeof insertWhatsappNumberSchema>;\nexport type WhatsappNumber = typeof whatsappNumbers.$inferSelect;\n\n// Typebot Configuration - Chatbot flow settings\nexport const typebotConfig = pgTable(\"typebot_config\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  instanceUrl: text(\"instance_url\").notNull(),\n  apiToken: text(\"api_token\").notNull(),\n  enabled: boolean(\"enabled\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertTypebotConfigSchema = createInsertSchema(typebotConfig).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertTypebotConfig = z.infer<typeof insertTypebotConfigSchema>;\nexport type TypebotConfig = typeof typebotConfig.$inferSelect;\n\n// Typebot Flows - Maps Typebot flows to departments for routing\nexport const typebotFlows = pgTable(\"typebot_flows\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  typebotConfigId: varchar(\"typebot_config_id\").notNull().references(() => typebotConfig.id, { onDelete: 'cascade' }),\n  departmentId: varchar(\"department_id\").references(() => departments.id),\n  typebotId: varchar(\"typebot_id\", { length: 100 }).notNull(),\n  flowName: varchar(\"flow_name\", { length: 100 }).notNull(),\n  flowDescription: text(\"flow_description\"),\n  triggerKeywords: varchar(\"trigger_keywords\", { length: 255 }).array().default(sql`ARRAY[]::varchar[]`),\n  isMainMenu: boolean(\"is_main_menu\").default(false).notNull(),\n  enabled: boolean(\"enabled\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertTypebotFlowSchema = createInsertSchema(typebotFlows).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertTypebotFlow = z.infer<typeof insertTypebotFlowSchema>;\nexport type TypebotFlow = typeof typebotFlows.$inferSelect;\n\n// Department Email Settings - Email configuration per department\nexport const departmentEmailSettings = pgTable(\"department_email_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  departmentId: varchar(\"department_id\").notNull().references(() => departments.id, { onDelete: 'cascade' }).unique(),\n  parentEmail: varchar(\"parent_email\").notNull(), // e.g., support.dtv@company.com\n  imapHost: varchar(\"imap_host\", { length: 255 }),\n  imapPort: integer(\"imap_port\").default(993),\n  imapUsername: varchar(\"imap_username\"),\n  imapPassword: text(\"imap_password\"),\n  imapUseSsl: boolean(\"imap_use_ssl\").default(true).notNull(),\n  smtpHost: varchar(\"smtp_host\", { length: 255 }),\n  smtpPort: integer(\"smtp_port\").default(587),\n  smtpUsername: varchar(\"smtp_username\"),\n  smtpPassword: text(\"smtp_password\"),\n  smtpUseTls: boolean(\"smtp_use_tls\").default(true).notNull(),\n  enabled: boolean(\"enabled\").default(true).notNull(),\n  lastSyncAt: timestamp(\"last_sync_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertDepartmentEmailSettingsSchema = createInsertSchema(departmentEmailSettings).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  lastSyncAt: true,\n});\n\nexport type InsertDepartmentEmailSettings = z.infer<typeof insertDepartmentEmailSettingsSchema>;\nexport type DepartmentEmailSettings = typeof departmentEmailSettings.$inferSelect;\n\n// Communication Channels - Unified view of all channels\nexport const CHANNEL_TYPES = {\n  EMAIL: 'email',\n  WHATSAPP: 'whatsapp',\n  WEB_CHAT: 'web_chat',\n} as const;\n\nexport type ChannelType = typeof CHANNEL_TYPES[keyof typeof CHANNEL_TYPES];\n\n// Conversation status types\nexport const CONVERSATION_STATUS = {\n  OPEN: 'open',\n  PENDING: 'pending',\n  RESOLVED: 'resolved',\n  SNOOZED: 'snoozed',\n} as const;\n\nexport type ConversationStatus = typeof CONVERSATION_STATUS[keyof typeof CONVERSATION_STATUS];\n","path":null,"size_bytes":34750,"size_tokens":null},"fix-schema.ts":{"content":"import \"dotenv/config\";\nimport { db } from \"./server/db.ts\";\nimport { sql } from \"drizzle-orm\";\n\nasync function fixSchema() {\n  try {\n    console.log(\"Adding missing columns to team_members table...\");\n    \n    // Add missing address columns\n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS address_line_1 varchar(255)`\n    );\n    console.log(\"✓ Added address_line_1\");\n    \n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS address_line_2 varchar(255)`\n    );\n    console.log(\"✓ Added address_line_2\");\n    \n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS city varchar(100)`\n    );\n    console.log(\"✓ Added city\");\n    \n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS state varchar(100)`\n    );\n    console.log(\"✓ Added state\");\n    \n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS postal_code varchar(20)`\n    );\n    console.log(\"✓ Added postal_code\");\n    \n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS country varchar(100)`\n    );\n    console.log(\"✓ Added country\");\n    \n    // Add missing next of kin columns\n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS next_of_kin_1_name varchar(100)`\n    );\n    console.log(\"✓ Added next_of_kin_1_name\");\n    \n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS next_of_kin_1_relationship varchar(50)`\n    );\n    console.log(\"✓ Added next_of_kin_1_relationship\");\n    \n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS next_of_kin_1_phone varchar(20)`\n    );\n    console.log(\"✓ Added next_of_kin_1_phone\");\n    \n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS next_of_kin_1_email varchar`\n    );\n    console.log(\"✓ Added next_of_kin_1_email\");\n    \n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS next_of_kin_1_address text`\n    );\n    console.log(\"✓ Added next_of_kin_1_address\");\n    \n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS next_of_kin_2_name varchar(100)`\n    );\n    console.log(\"✓ Added next_of_kin_2_name\");\n    \n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS next_of_kin_2_relationship varchar(50)`\n    );\n    console.log(\"✓ Added next_of_kin_2_relationship\");\n    \n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS next_of_kin_2_phone varchar(20)`\n    );\n    console.log(\"✓ Added next_of_kin_2_phone\");\n    \n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS next_of_kin_2_email varchar`\n    );\n    console.log(\"✓ Added next_of_kin_2_email\");\n    \n    await db.execute(\n      sql`ALTER TABLE team_members ADD COLUMN IF NOT EXISTS next_of_kin_2_address text`\n    );\n    console.log(\"✓ Added next_of_kin_2_address\");\n    \n    console.log(\"\\n✅ Schema fix complete! All missing columns have been added.\");\n    process.exit(0);\n  } catch (error) {\n    console.error(\"❌ Error fixing schema:\", error);\n    process.exit(1);\n  }\n}\n\nfixSchema();\n","path":null,"size_bytes":3232,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"client/src/pages/config.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Accordion,\n  AccordionContent,\n  AccordionItem,\n  AccordionTrigger,\n} from \"@/components/ui/accordion\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Database, MessageSquare, FormInput, Mail, Save, TestTube } from \"lucide-react\";\nimport type { ServiceConfig, InsertServiceConfig } from \"@shared/schema\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\n\nconst platformConfigs = [\n  {\n    name: \"metabase\",\n    title: \"Metabase\",\n    description: \"Business intelligence and analytics platform\",\n    icon: Database,\n    defaultUrl: \"https://metabase.yourdomain.com\",\n  },\n  {\n    name: \"chatwoot\",\n    title: \"Chatwoot\",\n    description: \"Customer engagement and support platform\",\n    icon: MessageSquare,\n    defaultUrl: \"https://chatwoot.yourdomain.com\",\n  },\n  {\n    name: \"typebot\",\n    title: \"Typebot\",\n    description: \"Conversational forms and chatbot builder\",\n    icon: FormInput,\n    defaultUrl: \"https://typebot.yourdomain.com\",\n  },\n  {\n    name: \"mailcow\",\n    title: \"Mailcow\",\n    description: \"Email server management platform\",\n    icon: Mail,\n    defaultUrl: \"https://mail.yourdomain.com\",\n  },\n];\n\nexport default function Config() {\n  const { toast } = useToast();\n  const [testingService, setTestingService] = useState<string | null>(null);\n\n  const { data: services, isLoading } = useQuery<ServiceConfig[]>({\n    queryKey: [\"/api/services\"],\n  });\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: { serviceName: string; config: InsertServiceConfig }) => {\n      const existingService = services?.find(s => s.serviceName === data.serviceName);\n      if (existingService) {\n        return await apiRequest(`/api/services/${existingService.id}`, \"PATCH\", data.config);\n      } else {\n        return await apiRequest(\"/api/services\", \"POST\", data.config);\n      }\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/services\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stats\"] });\n      toast({\n        title: \"Configuration saved\",\n        description: \"Service configuration has been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to save configuration. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const testConnectionMutation = useMutation({\n    mutationFn: async (serviceName: string) => {\n      return await apiRequest(`/api/services/${serviceName}/test`, \"POST\", undefined);\n    },\n    onSuccess: (_, serviceName) => {\n      toast({\n        title: \"Connection successful\",\n        description: `Successfully connected to ${serviceName}.`,\n      });\n      setTestingService(null);\n    },\n    onError: (error: Error, serviceName) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Connection failed\",\n        description: `Failed to connect to ${serviceName}. Check your configuration.`,\n        variant: \"destructive\",\n      });\n      setTestingService(null);\n    },\n  });\n\n  const getServiceConfig = (serviceName: string): ServiceConfig | undefined => {\n    return services?.find(s => s.serviceName === serviceName);\n  };\n\n  const handleSave = (serviceName: string, formData: FormData) => {\n    const config: InsertServiceConfig = {\n      serviceName,\n      apiUrl: formData.get(\"apiUrl\") as string,\n      apiKey: formData.get(\"apiKey\") as string,\n      enabled: formData.get(\"enabled\") === \"true\",\n    };\n\n    saveMutation.mutate({ serviceName, config });\n  };\n\n  const handleTestConnection = (serviceName: string) => {\n    setTestingService(serviceName);\n    testConnectionMutation.mutate(serviceName);\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold text-foreground\">Configuration</h1>\n        <p className=\"text-muted-foreground mt-1\">Configure API connections for all platforms</p>\n      </div>\n\n      <Accordion type=\"single\" collapsible className=\"space-y-4\">\n        {platformConfigs.map((platform) => {\n          const Icon = platform.icon;\n          const serviceConfig = getServiceConfig(platform.name);\n\n          return (\n            <AccordionItem\n              key={platform.name}\n              value={platform.name}\n              className=\"border border-border rounded-md\"\n            >\n              <AccordionTrigger\n                className=\"px-6 hover:no-underline hover-elevate\"\n                data-testid={`accordion-${platform.name}`}\n              >\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-muted\">\n                    <Icon className=\"h-5 w-5 text-muted-foreground\" />\n                  </div>\n                  <div className=\"text-left\">\n                    <h3 className=\"font-semibold\">{platform.title}</h3>\n                    <p className=\"text-sm text-muted-foreground\">{platform.description}</p>\n                  </div>\n                </div>\n              </AccordionTrigger>\n              <AccordionContent className=\"px-6 pb-6\">\n                {isLoading ? (\n                  <div className=\"space-y-4\">\n                    <Skeleton className=\"h-10 w-full\" />\n                    <Skeleton className=\"h-10 w-full\" />\n                    <Skeleton className=\"h-10 w-full\" />\n                  </div>\n                ) : (\n                  <form\n                    onSubmit={(e) => {\n                      e.preventDefault();\n                      handleSave(platform.name, new FormData(e.currentTarget));\n                    }}\n                    className=\"space-y-4\"\n                  >\n                    <div className=\"space-y-2\">\n                      <Label htmlFor={`${platform.name}-url`}>API URL</Label>\n                      <Input\n                        id={`${platform.name}-url`}\n                        name=\"apiUrl\"\n                        type=\"url\"\n                        placeholder={platform.defaultUrl}\n                        defaultValue={serviceConfig?.apiUrl || \"\"}\n                        data-testid={`input-${platform.name}-url`}\n                      />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor={`${platform.name}-key`}>API Key</Label>\n                      <Input\n                        id={`${platform.name}-key`}\n                        name=\"apiKey\"\n                        type=\"password\"\n                        placeholder=\"Enter API key\"\n                        defaultValue={serviceConfig?.apiKey || \"\"}\n                        data-testid={`input-${platform.name}-key`}\n                      />\n                    </div>\n\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2\">\n                        <Switch\n                          id={`${platform.name}-enabled`}\n                          name=\"enabled\"\n                          value=\"true\"\n                          defaultChecked={serviceConfig?.enabled ?? true}\n                          data-testid={`switch-${platform.name}-enabled`}\n                        />\n                        <Label htmlFor={`${platform.name}-enabled`} className=\"cursor-pointer\">\n                          Enable this service\n                        </Label>\n                      </div>\n                    </div>\n\n                    <div className=\"flex gap-2 pt-4\">\n                      <Button\n                        type=\"submit\"\n                        disabled={saveMutation.isPending}\n                        data-testid={`button-save-${platform.name}`}\n                      >\n                        <Save className=\"h-4 w-4 mr-2\" />\n                        {saveMutation.isPending ? \"Saving...\" : \"Save Configuration\"}\n                      </Button>\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        onClick={() => handleTestConnection(platform.name)}\n                        disabled={testingService === platform.name || !serviceConfig}\n                        data-testid={`button-test-${platform.name}`}\n                      >\n                        <TestTube className=\"h-4 w-4 mr-2\" />\n                        {testingService === platform.name ? \"Testing...\" : \"Test Connection\"}\n                      </Button>\n                    </div>\n                  </form>\n                )}\n              </AccordionContent>\n            </AccordionItem>\n          );\n        })}\n      </Accordion>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Setup Instructions</CardTitle>\n          <CardDescription>How to obtain API credentials for each platform</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div>\n            <h4 className=\"font-semibold mb-2\">Metabase</h4>\n            <p className=\"text-sm text-muted-foreground\">\n              Generate an API key from Settings → Admin → API Keys in your Metabase instance.\n            </p>\n          </div>\n          <div>\n            <h4 className=\"font-semibold mb-2\">Chatwoot</h4>\n            <p className=\"text-sm text-muted-foreground\">\n              Create an access token from Profile Settings → Access Token in Chatwoot.\n            </p>\n          </div>\n          <div>\n            <h4 className=\"font-semibold mb-2\">Typebot</h4>\n            <p className=\"text-sm text-muted-foreground\">\n              Generate an API token from your Typebot dashboard settings.\n            </p>\n          </div>\n          <div>\n            <h4 className=\"font-semibold mb-2\">Mailcow</h4>\n            <p className=\"text-sm text-muted-foreground\">\n              Create an API key from Mailcow Admin → Configuration → API.\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":11020,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  url: string,\n  method: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1383,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"server/rbac.ts":{"content":"import { RequestHandler, Request, Response, NextFunction } from \"express\";\nimport { db } from \"./db\";\nimport { \n  roles, \n  permissions, \n  rolePermissions, \n  teamMembers,\n  departments,\n  ROLE_TYPES,\n  PERMISSION_TYPES,\n  type Role,\n  type Permission,\n  type TeamMember,\n  type PermissionType,\n  type RoleType,\n} from \"@shared/schema\";\nimport { eq, and, inArray } from \"drizzle-orm\";\n\nexport interface AuthenticatedTeamMember extends TeamMember {\n  roleName?: string;\n  roleCode?: RoleType;\n  roleLevel?: number;\n  departmentCode?: string;\n  departmentName?: string;\n  permissions?: string[];\n}\n\ndeclare global {\n  namespace Express {\n    interface Request {\n      teamMember?: AuthenticatedTeamMember;\n    }\n  }\n}\n\nexport async function getTeamMemberWithPermissions(teamMemberId: string): Promise<AuthenticatedTeamMember | null> {\n  const [member] = await db\n    .select()\n    .from(teamMembers)\n    .where(eq(teamMembers.id, teamMemberId));\n  \n  if (!member) return null;\n\n  let roleData: Role | undefined;\n  let departmentData: { code: string; name: string } | undefined;\n  let memberPermissions: string[] = [];\n\n  if (member.roleId) {\n    const [role] = await db.select().from(roles).where(eq(roles.id, member.roleId));\n    roleData = role;\n\n    if (role) {\n      const rolePerms = await db\n        .select({ code: permissions.code })\n        .from(rolePermissions)\n        .innerJoin(permissions, eq(rolePermissions.permissionId, permissions.id))\n        .where(eq(rolePermissions.roleId, role.id));\n      \n      memberPermissions = rolePerms.map(p => p.code);\n    }\n  }\n\n  const [dept] = await db\n    .select({ code: departments.code, name: departments.name })\n    .from(departments)\n    .where(eq(departments.id, member.departmentId));\n  departmentData = dept;\n\n  return {\n    ...member,\n    roleName: roleData?.name,\n    roleCode: roleData?.code as RoleType,\n    roleLevel: roleData?.level,\n    departmentCode: departmentData?.code,\n    departmentName: departmentData?.name,\n    permissions: memberPermissions,\n  };\n}\n\nexport function hasPermission(member: AuthenticatedTeamMember, permission: PermissionType): boolean {\n  if (!member.permissions) return false;\n  return member.permissions.includes(permission);\n}\n\nexport function hasAnyPermission(member: AuthenticatedTeamMember, permissions: PermissionType[]): boolean {\n  if (!member.permissions) return false;\n  return permissions.some(p => member.permissions?.includes(p));\n}\n\nexport function hasAllPermissions(member: AuthenticatedTeamMember, permissions: PermissionType[]): boolean {\n  if (!member.permissions) return false;\n  return permissions.every(p => member.permissions?.includes(p));\n}\n\nexport function isRole(member: AuthenticatedTeamMember, roleCode: RoleType): boolean {\n  return member.roleCode === roleCode;\n}\n\nexport function isRoleOrHigher(member: AuthenticatedTeamMember, roleCode: RoleType): boolean {\n  const roleLevels: Record<RoleType, number> = {\n    [ROLE_TYPES.TECHNICIAN]: 1,\n    [ROLE_TYPES.DEPARTMENT_ADMIN]: 2,\n    [ROLE_TYPES.MANAGEMENT]: 3,\n  };\n  \n  const requiredLevel = roleLevels[roleCode];\n  return (member.roleLevel ?? 0) >= requiredLevel;\n}\n\nexport function canAccessDepartment(member: AuthenticatedTeamMember, departmentId: string): boolean {\n  if (isRole(member, ROLE_TYPES.MANAGEMENT)) return true;\n  return member.departmentId === departmentId;\n}\n\nexport const requirePermission = (permission: PermissionType): RequestHandler => {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const member = req.teamMember;\n    \n    if (!member) {\n      return res.status(401).json({ message: \"Authentication required\" });\n    }\n\n    if (!hasPermission(member, permission)) {\n      return res.status(403).json({ \n        message: \"Access denied\",\n        required: permission,\n      });\n    }\n\n    next();\n  };\n};\n\nexport const requireAnyPermission = (...permissions: PermissionType[]): RequestHandler => {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const member = req.teamMember;\n    \n    if (!member) {\n      return res.status(401).json({ message: \"Authentication required\" });\n    }\n\n    if (!hasAnyPermission(member, permissions)) {\n      return res.status(403).json({ \n        message: \"Access denied\",\n        required: permissions,\n      });\n    }\n\n    next();\n  };\n};\n\nexport const requireRole = (roleCode: RoleType): RequestHandler => {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const member = req.teamMember;\n    \n    if (!member) {\n      return res.status(401).json({ message: \"Authentication required\" });\n    }\n\n    if (!isRole(member, roleCode)) {\n      return res.status(403).json({ \n        message: \"Access denied\",\n        requiredRole: roleCode,\n      });\n    }\n\n    next();\n  };\n};\n\nexport const requireRoleOrHigher = (roleCode: RoleType): RequestHandler => {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const member = req.teamMember;\n    \n    if (!member) {\n      return res.status(401).json({ message: \"Authentication required\" });\n    }\n\n    if (!isRoleOrHigher(member, roleCode)) {\n      return res.status(403).json({ \n        message: \"Access denied\",\n        minimumRole: roleCode,\n      });\n    }\n\n    next();\n  };\n};\n\nexport const requireDepartmentAccess = (getDepartmentId: (req: Request) => string | undefined): RequestHandler => {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const member = req.teamMember;\n    \n    if (!member) {\n      return res.status(401).json({ message: \"Authentication required\" });\n    }\n\n    const departmentId = getDepartmentId(req);\n    if (!departmentId) {\n      return res.status(400).json({ message: \"Department ID required\" });\n    }\n\n    if (!canAccessDepartment(member, departmentId)) {\n      return res.status(403).json({ \n        message: \"Access denied to this department\",\n      });\n    }\n\n    next();\n  };\n};\n\nexport async function seedRolesAndPermissions(): Promise<void> {\n  const existingRoles = await db.select().from(roles);\n  if (existingRoles.length > 0) {\n    console.log(\"Roles already seeded, skipping...\");\n    return;\n  }\n\n  console.log(\"Seeding roles and permissions...\");\n\n  const roleData = [\n    { name: \"Technician\", code: ROLE_TYPES.TECHNICIAN, description: \"Field technician with task execution access\", level: 1 },\n    { name: \"Department Admin\", code: ROLE_TYPES.DEPARTMENT_ADMIN, description: \"Department administrator with department-level management\", level: 2 },\n    { name: \"Management\", code: ROLE_TYPES.MANAGEMENT, description: \"Global management with full system access\", level: 3 },\n  ];\n\n  const insertedRoles = await db.insert(roles).values(roleData).returning();\n  console.log(`Inserted ${insertedRoles.length} roles`);\n\n  const permissionData = [\n    { name: \"View Tasks\", code: PERMISSION_TYPES.VIEW_TASKS, category: \"tasks\" },\n    { name: \"Create Task\", code: PERMISSION_TYPES.CREATE_TASK, category: \"tasks\" },\n    { name: \"Update Task\", code: PERMISSION_TYPES.UPDATE_TASK, category: \"tasks\" },\n    { name: \"Delete Task\", code: PERMISSION_TYPES.DELETE_TASK, category: \"tasks\" },\n    { name: \"Assign Task\", code: PERMISSION_TYPES.ASSIGN_TASK, category: \"tasks\" },\n    { name: \"View Own Department\", code: PERMISSION_TYPES.VIEW_OWN_DEPARTMENT, category: \"departments\" },\n    { name: \"View All Departments\", code: PERMISSION_TYPES.VIEW_ALL_DEPARTMENTS, category: \"departments\" },\n    { name: \"View Department Dashboard\", code: PERMISSION_TYPES.VIEW_DEPARTMENT_DASHBOARD, category: \"dashboard\" },\n    { name: \"View Global Dashboard\", code: PERMISSION_TYPES.VIEW_GLOBAL_DASHBOARD, category: \"dashboard\" },\n    { name: \"Manage Department Users\", code: PERMISSION_TYPES.MANAGE_DEPARTMENT_USERS, category: \"users\" },\n    { name: \"Manage Global Users\", code: PERMISSION_TYPES.MANAGE_GLOBAL_USERS, category: \"users\" },\n    { name: \"View Department Logs\", code: PERMISSION_TYPES.VIEW_DEPARTMENT_LOGS, category: \"logs\" },\n    { name: \"View All Logs\", code: PERMISSION_TYPES.VIEW_ALL_LOGS, category: \"logs\" },\n    { name: \"Manage Service Config\", code: PERMISSION_TYPES.MANAGE_SERVICE_CONFIG, category: \"settings\" },\n    { name: \"View Analytics\", code: PERMISSION_TYPES.VIEW_ANALYTICS, category: \"analytics\" },\n    { name: \"Submit Worklog\", code: PERMISSION_TYPES.SUBMIT_WORKLOG, category: \"tasks\" },\n  ];\n\n  const insertedPermissions = await db.insert(permissions).values(permissionData).returning();\n  console.log(`Inserted ${insertedPermissions.length} permissions`);\n\n  const permissionMap = new Map(insertedPermissions.map(p => [p.code, p.id]));\n  const roleMap = new Map(insertedRoles.map(r => [r.code, r.id]));\n\n  const technicianPerms = [\n    PERMISSION_TYPES.VIEW_TASKS,\n    PERMISSION_TYPES.UPDATE_TASK,\n    PERMISSION_TYPES.VIEW_OWN_DEPARTMENT,\n    PERMISSION_TYPES.SUBMIT_WORKLOG,\n  ];\n\n  const deptAdminPerms = [\n    ...technicianPerms,\n    PERMISSION_TYPES.CREATE_TASK,\n    PERMISSION_TYPES.ASSIGN_TASK,\n    PERMISSION_TYPES.VIEW_DEPARTMENT_DASHBOARD,\n    PERMISSION_TYPES.MANAGE_DEPARTMENT_USERS,\n    PERMISSION_TYPES.VIEW_DEPARTMENT_LOGS,\n    PERMISSION_TYPES.VIEW_ANALYTICS,\n  ];\n\n  const managementPerms = [\n    ...Object.values(PERMISSION_TYPES),\n  ];\n\n  const rolePermissionData: { roleId: string; permissionId: string }[] = [];\n\n  const techRoleId = roleMap.get(ROLE_TYPES.TECHNICIAN);\n  const deptAdminRoleId = roleMap.get(ROLE_TYPES.DEPARTMENT_ADMIN);\n  const mgmtRoleId = roleMap.get(ROLE_TYPES.MANAGEMENT);\n\n  if (techRoleId) {\n    technicianPerms.forEach(perm => {\n      const permId = permissionMap.get(perm);\n      if (permId) rolePermissionData.push({ roleId: techRoleId, permissionId: permId });\n    });\n  }\n\n  if (deptAdminRoleId) {\n    deptAdminPerms.forEach(perm => {\n      const permId = permissionMap.get(perm);\n      if (permId) rolePermissionData.push({ roleId: deptAdminRoleId, permissionId: permId });\n    });\n  }\n\n  if (mgmtRoleId) {\n    managementPerms.forEach(perm => {\n      const permId = permissionMap.get(perm);\n      if (permId) rolePermissionData.push({ roleId: mgmtRoleId, permissionId: permId });\n    });\n  }\n\n  await db.insert(rolePermissions).values(rolePermissionData);\n  console.log(`Inserted ${rolePermissionData.length} role-permission mappings`);\n\n  console.log(\"Roles and permissions seeded successfully!\");\n}\n\nexport async function seedDefaultDepartments(): Promise<void> {\n  const existingDepts = await db.select().from(departments);\n  if (existingDepts.length > 0) {\n    console.log(\"Departments already seeded, skipping...\");\n    return;\n  }\n\n  console.log(\"Seeding default departments...\");\n\n  const deptData = [\n    { name: \"Home Appliances\", code: \"HA\", description: \"Home Appliances Department\" },\n    { name: \"Home Healthcare Products\", code: \"HHP\", description: \"Home Healthcare Products Department\" },\n    { name: \"Digital TV\", code: \"DTV\", description: \"Digital TV Department\" },\n  ];\n\n  const insertedDepts = await db.insert(departments).values(deptData).returning();\n  console.log(`Inserted ${insertedDepts.length} departments`);\n}\n","path":null,"size_bytes":11006,"size_tokens":null},"client/src/pages/profile.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { User, Shield, Building2, Mail, Phone, Lock, Save, Eye, EyeOff, AlertCircle, CheckCircle2 } from \"lucide-react\";\nimport type { AuthenticatedTeamMember } from \"@/hooks/useAuth\";\n\nexport default function Profile() {\n  const { teamMember, isLoading: authLoading } = useAuth();\n  const { toast } = useToast();\n\n  const [firstName, setFirstName] = useState(\"\");\n  const [lastName, setLastName] = useState(\"\");\n  const [phone, setPhone] = useState(\"\");\n  const [currentPassword, setCurrentPassword] = useState(\"\");\n  const [newPassword, setNewPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [showCurrentPassword, setShowCurrentPassword] = useState(false);\n  const [showNewPassword, setShowNewPassword] = useState(false);\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\n\n  const { data: profile, isLoading: profileLoading } = useQuery<AuthenticatedTeamMember>({\n    queryKey: [\"/api/profile\"],\n    enabled: !!teamMember,\n  });\n\n  useEffect(() => {\n    if (profile) {\n      setFirstName(profile.firstName || \"\");\n      setLastName(profile.lastName || \"\");\n      setPhone(profile.phone || \"\");\n    }\n  }, [profile]);\n\n  const updateProfileMutation = useMutation({\n    mutationFn: async (data: { firstName?: string; lastName?: string; phone?: string }) => {\n      return await apiRequest(\"/api/profile\", \"PATCH\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/profile\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      toast({\n        title: \"Profile Updated\",\n        description: \"Your profile has been updated successfully.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Update Failed\",\n        description: error.message || \"Failed to update profile.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const changePasswordMutation = useMutation({\n    mutationFn: async (data: { currentPassword: string; newPassword: string }) => {\n      return await apiRequest(\"/api/profile\", \"PATCH\", data);\n    },\n    onSuccess: () => {\n      setCurrentPassword(\"\");\n      setNewPassword(\"\");\n      setConfirmPassword(\"\");\n      toast({\n        title: \"Password Changed\",\n        description: \"Your password has been updated successfully.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Password Change Failed\",\n        description: error.message || \"Failed to change password.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleProfileSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    updateProfileMutation.mutate({ firstName, lastName, phone });\n  };\n\n  const handlePasswordSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!currentPassword || !newPassword) {\n      toast({\n        title: \"Missing Fields\",\n        description: \"Please fill in all password fields.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (newPassword !== confirmPassword) {\n      toast({\n        title: \"Passwords Don't Match\",\n        description: \"New password and confirmation must match.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (newPassword.length < 6) {\n      toast({\n        title: \"Password Too Short\",\n        description: \"Password must be at least 6 characters.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    changePasswordMutation.mutate({ currentPassword, newPassword });\n  };\n\n  if (authLoading || profileLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <Skeleton className=\"h-10 w-64\" />\n        <Skeleton className=\"h-64 w-full\" />\n        <Skeleton className=\"h-64 w-full\" />\n      </div>\n    );\n  }\n\n  if (!profile) {\n    return (\n      <div className=\"space-y-6\">\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertDescription>Unable to load profile. Please try again.</AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6 max-w-2xl\">\n      <div>\n        <h1 className=\"text-3xl font-semibold text-foreground\">Profile Settings</h1>\n        <p className=\"text-muted-foreground mt-1\">\n          Manage your account details and preferences\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center gap-3\">\n            <div className=\"flex h-12 w-12 items-center justify-center rounded-full bg-primary/10\">\n              <User className=\"h-6 w-6 text-primary\" />\n            </div>\n            <div className=\"flex-1\">\n              <CardTitle>{profile.firstName} {profile.lastName}</CardTitle>\n              <CardDescription className=\"flex items-center gap-2 flex-wrap mt-1\">\n                <Badge variant=\"outline\" className=\"gap-1\">\n                  <Shield className=\"h-3 w-3\" />\n                  {profile.roleName || profile.role}\n                </Badge>\n                <Badge variant=\"secondary\" className=\"gap-1\">\n                  <Building2 className=\"h-3 w-3\" />\n                  {profile.departmentName || profile.departmentCode}\n                </Badge>\n              </CardDescription>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid gap-4 text-sm\">\n            <div className=\"flex items-center gap-2 text-muted-foreground\">\n              <Mail className=\"h-4 w-4\" />\n              <span>{profile.email}</span>\n            </div>\n            {profile.phone && (\n              <div className=\"flex items-center gap-2 text-muted-foreground\">\n                <Phone className=\"h-4 w-4\" />\n                <span>{profile.phone}</span>\n              </div>\n            )}\n            {profile.employeeId && (\n              <div className=\"flex items-center gap-2 text-muted-foreground\">\n                <span className=\"font-medium\">Employee ID:</span>\n                <span>{profile.employeeId}</span>\n              </div>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <User className=\"h-5 w-5\" />\n            Personal Information\n          </CardTitle>\n          <CardDescription>\n            Update your personal details\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleProfileSubmit} className=\"space-y-4\">\n            <div className=\"grid gap-4 sm:grid-cols-2\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"firstName\">First Name</Label>\n                <Input\n                  id=\"firstName\"\n                  value={firstName}\n                  onChange={(e) => setFirstName(e.target.value)}\n                  placeholder=\"Enter first name\"\n                  data-testid=\"input-first-name\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"lastName\">Last Name</Label>\n                <Input\n                  id=\"lastName\"\n                  value={lastName}\n                  onChange={(e) => setLastName(e.target.value)}\n                  placeholder=\"Enter last name\"\n                  data-testid=\"input-last-name\"\n                />\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"phone\">Phone Number</Label>\n              <Input\n                id=\"phone\"\n                type=\"tel\"\n                value={phone}\n                onChange={(e) => setPhone(e.target.value)}\n                placeholder=\"Enter phone number\"\n                data-testid=\"input-phone\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\">Email</Label>\n              <Input\n                id=\"email\"\n                type=\"email\"\n                value={profile.email}\n                disabled\n                className=\"bg-muted\"\n                data-testid=\"input-email\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Email cannot be changed. Contact an administrator if needed.\n              </p>\n            </div>\n            <Button \n              type=\"submit\" \n              disabled={updateProfileMutation.isPending}\n              data-testid=\"button-save-profile\"\n            >\n              {updateProfileMutation.isPending ? (\n                \"Saving...\"\n              ) : (\n                <>\n                  <Save className=\"h-4 w-4 mr-2\" />\n                  Save Changes\n                </>\n              )}\n            </Button>\n          </form>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Lock className=\"h-5 w-5\" />\n            Change Password\n          </CardTitle>\n          <CardDescription>\n            Update your account password\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handlePasswordSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"currentPassword\">Current Password</Label>\n              <div className=\"relative\">\n                <Input\n                  id=\"currentPassword\"\n                  type={showCurrentPassword ? \"text\" : \"password\"}\n                  value={currentPassword}\n                  onChange={(e) => setCurrentPassword(e.target.value)}\n                  placeholder=\"Enter current password\"\n                  data-testid=\"input-current-password\"\n                />\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"absolute right-0 top-0 h-full px-3\"\n                  onClick={() => setShowCurrentPassword(!showCurrentPassword)}\n                  data-testid=\"button-toggle-current-password\"\n                >\n                  {showCurrentPassword ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                </Button>\n              </div>\n            </div>\n            <Separator />\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"newPassword\">New Password</Label>\n              <div className=\"relative\">\n                <Input\n                  id=\"newPassword\"\n                  type={showNewPassword ? \"text\" : \"password\"}\n                  value={newPassword}\n                  onChange={(e) => setNewPassword(e.target.value)}\n                  placeholder=\"Enter new password\"\n                  data-testid=\"input-new-password\"\n                />\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"absolute right-0 top-0 h-full px-3\"\n                  onClick={() => setShowNewPassword(!showNewPassword)}\n                  data-testid=\"button-toggle-new-password\"\n                >\n                  {showNewPassword ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                </Button>\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"confirmPassword\">Confirm New Password</Label>\n              <div className=\"relative\">\n                <Input\n                  id=\"confirmPassword\"\n                  type={showConfirmPassword ? \"text\" : \"password\"}\n                  value={confirmPassword}\n                  onChange={(e) => setConfirmPassword(e.target.value)}\n                  placeholder=\"Confirm new password\"\n                  data-testid=\"input-confirm-password\"\n                />\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"absolute right-0 top-0 h-full px-3\"\n                  onClick={() => setShowConfirmPassword(!showConfirmPassword)}\n                  data-testid=\"button-toggle-confirm-password\"\n                >\n                  {showConfirmPassword ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                </Button>\n              </div>\n              {newPassword && confirmPassword && newPassword !== confirmPassword && (\n                <p className=\"text-xs text-destructive flex items-center gap-1\">\n                  <AlertCircle className=\"h-3 w-3\" />\n                  Passwords do not match\n                </p>\n              )}\n              {newPassword && confirmPassword && newPassword === confirmPassword && (\n                <p className=\"text-xs text-green-600 flex items-center gap-1\">\n                  <CheckCircle2 className=\"h-3 w-3\" />\n                  Passwords match\n                </p>\n              )}\n            </div>\n            <Button \n              type=\"submit\" \n              disabled={changePasswordMutation.isPending || !currentPassword || !newPassword || newPassword !== confirmPassword}\n              data-testid=\"button-change-password\"\n            >\n              {changePasswordMutation.isPending ? (\n                \"Changing...\"\n              ) : (\n                <>\n                  <Lock className=\"h-4 w-4 mr-2\" />\n                  Change Password\n                </>\n              )}\n            </Button>\n          </form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":14099,"size_tokens":null},"client/src/pages/pending-approvals.tsx":{"content":"/**\n * @fileoverview Pending User Approvals page\n * Copyright (c) 2025 DevPulse.Inc\n * Designed for MM ALL ELECTRONICS\n *\n * Description: Admin page to review and approve/reject pending user registrations.\n */\nimport { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { CheckCircle, XCircle, Eye, Calendar, Mail, Phone, MapPin } from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport type { TeamMember } from \"@shared/schema\";\nimport { formatDistanceToNow } from \"date-fns\";\n\nexport default function PendingApprovals() {\n  const { toast } = useToast();\n  const [viewingUser, setViewingUser] = useState<TeamMember | null>(null);\n  const [rejectingUser, setRejectingUser] = useState<TeamMember | null>(null);\n\n  const { data: pendingUsers, isLoading, refetch } = useQuery<TeamMember[]>({\n    queryKey: [\"/api/admin/pending-users\"],\n    retry: false,\n  });\n\n  const approveMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      const response = await fetch(`/api/admin/approve-user/${userId}`, {\n        method: \"PATCH\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to approve user\");\n      }\n      return response.json();\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"Success\",\n        description: `${data.firstName} ${data.lastName} has been approved!`,\n      });\n      refetch();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to approve user\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const rejectMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      const response = await fetch(`/api/admin/reject-user/${userId}`, {\n        method: \"DELETE\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({ reason: \"Rejected by admin\" }),\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to reject user\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Rejected\",\n        description: \"User has been rejected and removed from the system\",\n      });\n      setRejectingUser(null);\n      refetch();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to reject user\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleApprove = async (userId: string) => {\n    try {\n      const response = await fetch(`/api/admin/approve-user/${userId}`, {\n        method: \"PATCH\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Failed to approve user\");\n      }\n\n      // Refetch the pending users list\n      queryClient.invalidateQueries({ queryKey: [\"pending-users\"] });\n      toast.success(\"User approved successfully\");\n    } catch (error) {\n      console.error(\"Error approving user:\", error);\n      toast.error(\"Failed to approve user\");\n    }\n  };\n\n  const handleReject = async (userId: string) => {\n    try {\n      const response = await fetch(`/api/admin/reject-user/${userId}`, {\n        method: \"DELETE\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Failed to reject user\");\n      }\n\n      // Refetch the pending users list\n      queryClient.invalidateQueries({ queryKey: [\"pending-users\"] });\n      toast.success(\"User rejected successfully\");\n    } catch (error) {\n      console.error(\"Error rejecting user:\", error);\n      toast.error(\"Failed to reject user\");\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"space-y-4\">\n          <Skeleton className=\"h-10 w-full\" />\n          <Skeleton className=\"h-10 w-full\" />\n          <Skeleton className=\"h-10 w-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  const hasPendingUsers = pendingUsers && pendingUsers.length > 0;\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\">Pending User Approvals</h1>\n        <p className=\"text-gray-600 dark:text-gray-400 mt-1\">\n          Review and approve new user registrations\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>\n            Pending Users\n            {hasPendingUsers && (\n              <Badge className=\"ml-3\" variant=\"destructive\">\n                {pendingUsers.length}\n              </Badge>\n            )}\n          </CardTitle>\n          <CardDescription>\n            {hasPendingUsers\n              ? \"Users below are waiting for admin approval to access the system\"\n              : \"No pending users at this time\"}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {!hasPendingUsers ? (\n            <div className=\"text-center py-8\">\n              <CheckCircle className=\"w-12 h-12 mx-auto text-green-500 mb-4\" />\n              <p className=\"text-gray-600 dark:text-gray-400\">\n                All registered users have been approved\n              </p>\n            </div>\n          ) : (\n            <div className=\"border rounded-lg overflow-hidden\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Name</TableHead>\n                    <TableHead>Email</TableHead>\n                    <TableHead>Department</TableHead>\n                    <TableHead>Signup Date</TableHead>\n                    <TableHead className=\"text-right\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {pendingUsers.map((user) => (\n                    <TableRow key={user.id}>\n                      <TableCell className=\"font-medium\">\n                        {user.firstName} {user.lastName}\n                      </TableCell>\n                      <TableCell className=\"text-sm\">{user.email}</TableCell>\n                      <TableCell>{user.departmentId}</TableCell>\n                      <TableCell className=\"text-sm\">\n                        {formatDistanceToNow(new Date(user.createdAt), {\n                          addSuffix: true,\n                        })}\n                      </TableCell>\n                      <TableCell className=\"text-right space-x-2 flex justify-end\">\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => setViewingUser(user)}\n                        >\n                          <Eye className=\"w-4 h-4 mr-1\" />\n                          View\n                        </Button>\n                        <Button\n                          size=\"sm\"\n                          className=\"bg-green-600 hover:bg-green-700\"\n                          onClick={() => approveMutation.mutate(user.id)}\n                          disabled={approveMutation.isPending}\n                        >\n                          <CheckCircle className=\"w-4 h-4 mr-1\" />\n                          Approve\n                        </Button>\n                        <Button\n                          size=\"sm\"\n                          variant=\"destructive\"\n                          onClick={() => setRejectingUser(user)}\n                          disabled={rejectMutation.isPending}\n                        >\n                          <XCircle className=\"w-4 h-4 mr-1\" />\n                          Reject\n                        </Button>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* View User Details Dialog */}\n      <Dialog open={!!viewingUser} onOpenChange={() => setViewingUser(null)}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>\n              User Details: {viewingUser?.firstName} {viewingUser?.lastName}\n            </DialogTitle>\n            <DialogDescription>Complete registration information</DialogDescription>\n          </DialogHeader>\n\n          {viewingUser && (\n            <div className=\"space-y-6\">\n              {/* Basic Information */}\n              <div>\n                <h3 className=\"font-semibold mb-3\">Basic Information</h3>\n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                  <div className=\"space-y-1\">\n                    <p className=\"text-gray-600 dark:text-gray-400\">First Name</p>\n                    <p className=\"font-medium\">{viewingUser.firstName}</p>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <p className=\"text-gray-600 dark:text-gray-400\">Last Name</p>\n                    <p className=\"font-medium\">{viewingUser.lastName}</p>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <p className=\"text-gray-600 dark:text-gray-400 flex items-center gap-2\">\n                      <Mail className=\"w-4 h-4\" />\n                      Email\n                    </p>\n                    <p className=\"font-medium\">{viewingUser.email}</p>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <p className=\"text-gray-600 dark:text-gray-400 flex items-center gap-2\">\n                      <Phone className=\"w-4 h-4\" />\n                      Phone\n                    </p>\n                    <p className=\"font-medium\">{viewingUser.phone || \"N/A\"}</p>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <p className=\"text-gray-600 dark:text-gray-400\">Employee ID</p>\n                    <p className=\"font-medium\">{viewingUser.employeeId || \"N/A\"}</p>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <p className=\"text-gray-600 dark:text-gray-400 flex items-center gap-2\">\n                      <Calendar className=\"w-4 h-4\" />\n                      Signup Date\n                    </p>\n                    <p className=\"font-medium\">\n                      {new Date(viewingUser.createdAt).toLocaleDateString()}\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              {/* Address Information */}\n              {viewingUser.addressLine1 && (\n                <div>\n                  <h3 className=\"font-semibold mb-3 flex items-center gap-2\">\n                    <MapPin className=\"w-4 h-4\" />\n                    Residential Address\n                  </h3>\n                  <div className=\"text-sm space-y-1\">\n                    <p>{viewingUser.addressLine1}</p>\n                    {viewingUser.addressLine2 && <p>{viewingUser.addressLine2}</p>}\n                    <p>\n                      {viewingUser.city}, {viewingUser.state} {viewingUser.postalCode}\n                    </p>\n                    <p>{viewingUser.country}</p>\n                  </div>\n                </div>\n              )}\n\n              {/* Next of Kin Information */}\n              {viewingUser.nextOfKin1Name && (\n                <div>\n                  <h3 className=\"font-semibold mb-3\">Next of Kin #1</h3>\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                    <div>\n                      <p className=\"text-gray-600 dark:text-gray-400\">Name</p>\n                      <p className=\"font-medium\">{viewingUser.nextOfKin1Name}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-gray-600 dark:text-gray-400\">Relationship</p>\n                      <p className=\"font-medium\">\n                        {viewingUser.nextOfKin1Relationship}\n                      </p>\n                    </div>\n                    <div>\n                      <p className=\"text-gray-600 dark:text-gray-400\">Phone</p>\n                      <p className=\"font-medium\">{viewingUser.nextOfKin1Phone}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-gray-600 dark:text-gray-400\">Email</p>\n                      <p className=\"font-medium\">{viewingUser.nextOfKin1Email || \"N/A\"}</p>\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              {viewingUser.nextOfKin2Name && (\n                <div>\n                  <h3 className=\"font-semibold mb-3\">Next of Kin #2</h3>\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                    <div>\n                      <p className=\"text-gray-600 dark:text-gray-400\">Name</p>\n                      <p className=\"font-medium\">{viewingUser.nextOfKin2Name}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-gray-600 dark:text-gray-400\">Relationship</p>\n                      <p className=\"font-medium\">\n                        {viewingUser.nextOfKin2Relationship}\n                      </p>\n                    </div>\n                    <div>\n                      <p className=\"text-gray-600 dark:text-gray-400\">Phone</p>\n                      <p className=\"font-medium\">{viewingUser.nextOfKin2Phone}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-gray-600 dark:text-gray-400\">Email</p>\n                      <p className=\"font-medium\">{viewingUser.nextOfKin2Email || \"N/A\"}</p>\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              <div className=\"flex gap-3 pt-4 border-t\">\n                <Button\n                  className=\"flex-1 bg-green-600 hover:bg-green-700\"\n                  onClick={() => {\n                    approveMutation.mutate(viewingUser.id);\n                    setViewingUser(null);\n                  }}\n                  disabled={approveMutation.isPending}\n                >\n                  <CheckCircle className=\"w-4 h-4 mr-2\" />\n                  Approve User\n                </Button>\n                <Button\n                  variant=\"destructive\"\n                  className=\"flex-1\"\n                  onClick={() => {\n                    setRejectingUser(viewingUser);\n                    setViewingUser(null);\n                  }}\n                >\n                  <XCircle className=\"w-4 h-4 mr-2\" />\n                  Reject User\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Reject Confirmation Dialog */}\n      <AlertDialog open={!!rejectingUser} onOpenChange={() => setRejectingUser(null)}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Reject User Registration</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to reject {rejectingUser?.firstName}{\" \"}\n              {rejectingUser?.lastName}'s registration? This action will remove their\n              account from the system.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              onClick={() => {\n                if (rejectingUser) {\n                  rejectMutation.mutate(rejectingUser.id);\n                }\n              }}\n              disabled={rejectMutation.isPending}\n            >\n              Reject\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":16664,"size_tokens":null},"server/routes-integrations.ts":{"content":"/**\n * @fileoverview Communication Integration Routes\n * Routes for managing Chatwoot, Evolution API, Typebot, and Mailcow integrations\n */\n\nimport type { Express } from \"express\";\nimport { db } from \"./db\";\nimport { eq } from \"drizzle-orm\";\nimport {\n  chatwootConfig,\n  chatwootTeams,\n  chatwootInboxes,\n  chatwootAgents,\n  evolutionApiConfig,\n  whatsappNumbers,\n  typebotConfig,\n  typebotFlows,\n  departmentEmailSettings,\n  mailcowConfig,\n  managedUsers,\n  insertChatwootConfigSchema,\n  insertChatwootTeamSchema,\n  insertChatwootInboxSchema,\n  insertChatwootAgentSchema,\n  insertEvolutionApiConfigSchema,\n  insertWhatsappNumberSchema,\n  insertTypebotConfigSchema,\n  insertTypebotFlowSchema,\n  insertDepartmentEmailSettingsSchema,\n  insertMailcowConfigSchema,\n} from \"@shared/schema\";\nimport { isTeamMemberAuthenticated } from \"./devAuth\";\nimport { requirePermission, requireRoleOrHigher } from \"./rbac\";\nimport { PERMISSION_TYPES, ROLE_TYPES } from \"@shared/schema\";\nimport { storage } from \"./storage\";\n// import { provisioning } from \"./provisioning\"; // TODO: Re-implement full provisioning class if needed\n\nexport default function registerIntegrationRoutes(app: Express) {\n  // ============================================\n  // CHATWOOT CONFIGURATION ROUTES\n  // ============================================\n\n  // Get Chatwoot configuration\n  app.get('/api/integrations/chatwoot/config', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const [config] = await db.select().from(chatwootConfig).limit(1);\n      if (!config) {\n        return res.json(null);\n      }\n      // Don't expose the full API token\n      const safeConfig = {\n        ...config,\n        apiAccessToken: config.apiAccessToken ? '••••••••' + config.apiAccessToken.slice(-4) : null,\n      };\n      res.json(safeConfig);\n    } catch (error) {\n      console.error(\"Error fetching Chatwoot config:\", error);\n      res.status(500).json({ message: \"Failed to fetch Chatwoot configuration\" });\n    }\n  });\n\n  // Create or update Chatwoot configuration\n  app.post('/api/integrations/chatwoot/config', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { apiAccessToken, webhookSecret, ...otherData } = req.body;\n      \n      // Check if config already exists\n      const [existing] = await db.select().from(chatwootConfig).limit(1);\n      \n      // Build update data, preserving existing tokens if new ones aren't provided\n      const updateData: any = { ...otherData, updatedAt: new Date() };\n      \n      // Only update apiAccessToken if a new one is provided (non-empty, non-masked)\n      if (apiAccessToken && apiAccessToken.trim() && !apiAccessToken.startsWith('••••')) {\n        updateData.apiAccessToken = apiAccessToken;\n      } else if (!existing) {\n        // For new configs, token is required\n        return res.status(400).json({ message: \"API Access Token is required for new configuration\" });\n      }\n      \n      // Only update webhookSecret if a new one is provided\n      if (webhookSecret && webhookSecret.trim() && !webhookSecret.startsWith('••••')) {\n        updateData.webhookSecret = webhookSecret;\n      }\n      \n      let result;\n      if (existing) {\n        [result] = await db.update(chatwootConfig)\n          .set(updateData)\n          .where(eq(chatwootConfig.id, existing.id))\n          .returning();\n      } else {\n        // For new configs, use the provided token\n        [result] = await db.insert(chatwootConfig).values({\n          ...updateData,\n          apiAccessToken: apiAccessToken,\n          webhookSecret: webhookSecret || null,\n        }).returning();\n      }\n\n      await storage.createActivityLog(\n        req.teamMember.id,\n        existing ? \"updated_chatwoot_config\" : \"created_chatwoot_config\",\n        \"chatwoot_config\",\n        result.id,\n        \"chatwoot\"\n      );\n\n      res.json({ \n        ...result, \n        apiAccessToken: '••••••••' + result.apiAccessToken.slice(-4),\n        webhookSecret: result.webhookSecret ? '••••••••' + result.webhookSecret.slice(-4) : null \n      });\n    } catch (error) {\n      console.error(\"Error saving Chatwoot config:\", error);\n      res.status(400).json({ message: \"Failed to save Chatwoot configuration\" });\n    }\n  });\n\n  // Test Chatwoot connection\n  app.post('/api/integrations/chatwoot/test', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { instanceUrl, apiAccessToken, accountId } = req.body;\n      \n      // Make a test API call to Chatwoot\n      const response = await fetch(`${instanceUrl}/api/v1/accounts/${accountId}/agents`, {\n        headers: {\n          'api_access_token': apiAccessToken,\n          'Content-Type': 'application/json',\n        },\n      });\n\n      if (!response.ok) {\n        return res.status(400).json({ success: false, message: \"Connection failed: Invalid credentials or URL\" });\n      }\n\n      const data = await response.json();\n      res.json({ success: true, message: \"Connection successful\", agentCount: data.length || 0 });\n    } catch (error) {\n      console.error(\"Error testing Chatwoot connection:\", error);\n      res.status(400).json({ success: false, message: \"Connection failed: Unable to reach Chatwoot server\" });\n    }\n  });\n\n  // Get Chatwoot teams (mapped to departments)\n  app.get('/api/integrations/chatwoot/teams', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const teams = await db.select().from(chatwootTeams);\n      res.json(teams);\n    } catch (error) {\n      console.error(\"Error fetching Chatwoot teams:\", error);\n      res.status(500).json({ message: \"Failed to fetch Chatwoot teams\" });\n    }\n  });\n\n  // Create Chatwoot team mapping\n  app.post('/api/integrations/chatwoot/teams', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const validatedData = insertChatwootTeamSchema.parse(req.body);\n      const [team] = await db.insert(chatwootTeams).values(validatedData).returning();\n      res.json(team);\n    } catch (error) {\n      console.error(\"Error creating Chatwoot team:\", error);\n      res.status(400).json({ message: \"Failed to create Chatwoot team mapping\" });\n    }\n  });\n\n  // Delete Chatwoot team mapping\n  app.delete('/api/integrations/chatwoot/teams/:id', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      await db.delete(chatwootTeams).where(eq(chatwootTeams.id, req.params.id));\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting Chatwoot team:\", error);\n      res.status(400).json({ message: \"Failed to delete Chatwoot team mapping\" });\n    }\n  });\n\n  // Get Chatwoot inboxes\n  app.get('/api/integrations/chatwoot/inboxes', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const inboxes = await db.select().from(chatwootInboxes);\n      res.json(inboxes);\n    } catch (error) {\n      console.error(\"Error fetching Chatwoot inboxes:\", error);\n      res.status(500).json({ message: \"Failed to fetch Chatwoot inboxes\" });\n    }\n  });\n\n  // Create Chatwoot inbox mapping\n  app.post('/api/integrations/chatwoot/inboxes', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const validatedData = insertChatwootInboxSchema.parse(req.body);\n      const [inbox] = await db.insert(chatwootInboxes).values(validatedData).returning();\n      res.json(inbox);\n    } catch (error) {\n      console.error(\"Error creating Chatwoot inbox:\", error);\n      res.status(400).json({ message: \"Failed to create Chatwoot inbox mapping\" });\n    }\n  });\n\n  // Delete Chatwoot inbox mapping\n  app.delete('/api/integrations/chatwoot/inboxes/:id', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      await db.delete(chatwootInboxes).where(eq(chatwootInboxes.id, req.params.id));\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting Chatwoot inbox:\", error);\n      res.status(400).json({ message: \"Failed to delete Chatwoot inbox mapping\" });\n    }\n  });\n\n  // Get Chatwoot agents (linked team members)\n  app.get('/api/integrations/chatwoot/agents', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const agents = await db.select().from(chatwootAgents);\n      res.json(agents);\n    } catch (error) {\n      console.error(\"Error fetching Chatwoot agents:\", error);\n      res.status(500).json({ message: \"Failed to fetch Chatwoot agents\" });\n    }\n  });\n\n  // Sync agents from Chatwoot\n  app.post('/api/integrations/chatwoot/sync-agents', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const [config] = await db.select().from(chatwootConfig).limit(1);\n      if (!config) {\n        return res.status(400).json({ message: \"Chatwoot not configured\" });\n      }\n\n      // Fetch agents from Chatwoot\n      const response = await fetch(`${config.instanceUrl}/api/v1/accounts/${config.accountId}/agents`, {\n        headers: {\n          'api_access_token': config.apiAccessToken,\n          'Content-Type': 'application/json',\n        },\n      });\n\n      if (!response.ok) {\n        return res.status(400).json({ message: \"Failed to fetch agents from Chatwoot\" });\n      }\n\n      const chatwootAgentsList = await response.json();\n      \n      // Update last sync time\n      await db.update(chatwootConfig)\n        .set({ lastSyncAt: new Date() })\n        .where(eq(chatwootConfig.id, config.id));\n\n      res.json({ success: true, agents: chatwootAgentsList, syncedAt: new Date() });\n    } catch (error) {\n      console.error(\"Error syncing Chatwoot agents:\", error);\n      res.status(500).json({ message: \"Failed to sync agents from Chatwoot\" });\n    }\n  });\n\n  // ============================================\n  // EVOLUTION API CONFIGURATION ROUTES\n  // ============================================\n\n  // Get Evolution API configuration\n  app.get('/api/integrations/evolution/config', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const [config] = await db.select().from(evolutionApiConfig).limit(1);\n      if (!config) {\n        return res.json(null);\n      }\n      const safeConfig = {\n        ...config,\n        apiKey: config.apiKey ? '••••••••' + config.apiKey.slice(-4) : null,\n      };\n      res.json(safeConfig);\n    } catch (error) {\n      console.error(\"Error fetching Evolution API config:\", error);\n      res.status(500).json({ message: \"Failed to fetch Evolution API configuration\" });\n    }\n  });\n\n  // Create or update Evolution API configuration\n  app.post('/api/integrations/evolution/config', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { apiKey, ...otherData } = req.body;\n      \n      const [existing] = await db.select().from(evolutionApiConfig).limit(1);\n      \n      // Build update data, preserving existing API key if new one isn't provided\n      const updateData: any = { ...otherData, updatedAt: new Date() };\n      \n      // Only update apiKey if a new one is provided (non-empty, non-masked)\n      if (apiKey && apiKey.trim() && !apiKey.startsWith('••••')) {\n        updateData.apiKey = apiKey;\n      } else if (!existing) {\n        return res.status(400).json({ message: \"API Key is required for new configuration\" });\n      }\n      \n      let result;\n      if (existing) {\n        [result] = await db.update(evolutionApiConfig)\n          .set(updateData)\n          .where(eq(evolutionApiConfig.id, existing.id))\n          .returning();\n      } else {\n        [result] = await db.insert(evolutionApiConfig).values({\n          ...updateData,\n          apiKey: apiKey,\n        }).returning();\n      }\n\n      await storage.createActivityLog(\n        req.teamMember.id,\n        existing ? \"updated_evolution_config\" : \"created_evolution_config\",\n        \"evolution_config\",\n        result.id,\n        \"evolution_api\"\n      );\n\n      res.json({ ...result, apiKey: '••••••••' + result.apiKey.slice(-4) });\n    } catch (error) {\n      console.error(\"Error saving Evolution API config:\", error);\n      res.status(400).json({ message: \"Failed to save Evolution API configuration\" });\n    }\n  });\n\n  // Test Evolution API connection\n  app.post('/api/integrations/evolution/test', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { instanceUrl, apiKey, instanceName } = req.body;\n      \n      const response = await fetch(`${instanceUrl}/instance/fetchInstances`, {\n        headers: {\n          'apikey': apiKey,\n          'Content-Type': 'application/json',\n        },\n      });\n\n      if (!response.ok) {\n        return res.status(400).json({ success: false, message: \"Connection failed: Invalid credentials or URL\" });\n      }\n\n      const data = await response.json();\n      res.json({ success: true, message: \"Connection successful\", instances: data });\n    } catch (error) {\n      console.error(\"Error testing Evolution API connection:\", error);\n      res.status(400).json({ success: false, message: \"Connection failed: Unable to reach Evolution API server\" });\n    }\n  });\n\n  // Get connection status and QR code\n  app.get('/api/integrations/evolution/status', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const [config] = await db.select().from(evolutionApiConfig).limit(1);\n      if (!config) {\n        return res.json({ connected: false, message: \"Evolution API not configured\" });\n      }\n\n      // Check connection status\n      const response = await fetch(`${config.instanceUrl}/instance/connectionState/${config.instanceName}`, {\n        headers: {\n          'apikey': config.apiKey,\n          'Content-Type': 'application/json',\n        },\n      });\n\n      if (!response.ok) {\n        return res.json({ connected: false, message: \"Unable to check connection status\" });\n      }\n\n      const data = await response.json();\n      res.json({\n        connected: data.state === 'open',\n        state: data.state,\n        qrCode: config.qrCodeData,\n      });\n    } catch (error) {\n      console.error(\"Error checking Evolution status:\", error);\n      res.status(500).json({ message: \"Failed to check Evolution API status\" });\n    }\n  });\n\n  // Get WhatsApp numbers\n  app.get('/api/integrations/evolution/numbers', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const numbers = await db.select().from(whatsappNumbers);\n      res.json(numbers);\n    } catch (error) {\n      console.error(\"Error fetching WhatsApp numbers:\", error);\n      res.status(500).json({ message: \"Failed to fetch WhatsApp numbers\" });\n    }\n  });\n\n  // Add WhatsApp number\n  app.post('/api/integrations/evolution/numbers', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const validatedData = insertWhatsappNumberSchema.parse(req.body);\n      const [number] = await db.insert(whatsappNumbers).values(validatedData).returning();\n      res.json(number);\n    } catch (error) {\n      console.error(\"Error adding WhatsApp number:\", error);\n      res.status(400).json({ message: \"Failed to add WhatsApp number\" });\n    }\n  });\n\n  // Delete WhatsApp number\n  app.delete('/api/integrations/evolution/numbers/:id', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      await db.delete(whatsappNumbers).where(eq(whatsappNumbers.id, req.params.id));\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting WhatsApp number:\", error);\n      res.status(400).json({ message: \"Failed to delete WhatsApp number\" });\n    }\n  });\n\n  // ============================================\n  // TYPEBOT CONFIGURATION ROUTES\n  // ============================================\n\n  // Get Typebot configuration\n  app.get('/api/integrations/typebot/config', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const [config] = await db.select().from(typebotConfig).limit(1);\n      if (!config) {\n        return res.json(null);\n      }\n      const safeConfig = {\n        ...config,\n        apiToken: config.apiToken ? '••••••••' + config.apiToken.slice(-4) : null,\n      };\n      res.json(safeConfig);\n    } catch (error) {\n      console.error(\"Error fetching Typebot config:\", error);\n      res.status(500).json({ message: \"Failed to fetch Typebot configuration\" });\n    }\n  });\n\n  // Create or update Typebot configuration\n  app.post('/api/integrations/typebot/config', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const validatedData = insertTypebotConfigSchema.parse(req.body);\n      \n      const [existing] = await db.select().from(typebotConfig).limit(1);\n      \n      let result;\n      if (existing) {\n        [result] = await db.update(typebotConfig)\n          .set({ ...validatedData, updatedAt: new Date() })\n          .where(eq(typebotConfig.id, existing.id))\n          .returning();\n      } else {\n        [result] = await db.insert(typebotConfig).values(validatedData).returning();\n      }\n\n      await storage.createActivityLog(\n        req.teamMember.id,\n        existing ? \"updated_typebot_config\" : \"created_typebot_config\",\n        \"typebot_config\",\n        result.id,\n        \"typebot\"\n      );\n\n      res.json({ ...result, apiToken: '••••••••' + result.apiToken.slice(-4) });\n    } catch (error) {\n      console.error(\"Error saving Typebot config:\", error);\n      res.status(400).json({ message: \"Failed to save Typebot configuration\" });\n    }\n  });\n\n  // Get Typebot flows\n  app.get('/api/integrations/typebot/flows', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const flows = await db.select().from(typebotFlows);\n      res.json(flows);\n    } catch (error) {\n      console.error(\"Error fetching Typebot flows:\", error);\n      res.status(500).json({ message: \"Failed to fetch Typebot flows\" });\n    }\n  });\n\n  // Create Typebot flow mapping\n  app.post('/api/integrations/typebot/flows', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const validatedData = insertTypebotFlowSchema.parse(req.body);\n      const [flow] = await db.insert(typebotFlows).values(validatedData).returning();\n      res.json(flow);\n    } catch (error) {\n      console.error(\"Error creating Typebot flow:\", error);\n      res.status(400).json({ message: \"Failed to create Typebot flow mapping\" });\n    }\n  });\n\n  // Delete Typebot flow mapping\n  app.delete('/api/integrations/typebot/flows/:id', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      await db.delete(typebotFlows).where(eq(typebotFlows.id, req.params.id));\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting Typebot flow:\", error);\n      res.status(400).json({ message: \"Failed to delete Typebot flow mapping\" });\n    }\n  });\n\n  // ============================================\n  // MAILCOW CONFIGURATION ROUTES\n  // ============================================\n\n  // Get Mailcow configuration\n  app.get('/api/integrations/mailcow/config', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const [config] = await db.select().from(mailcowConfig).limit(1);\n      if (!config) {\n        return res.json(null);\n      }\n      const safeConfig = {\n        ...config,\n        apiKey: config.apiKey ? '••••••••' + config.apiKey.slice(-4) : null,\n      };\n      res.json(safeConfig);\n    } catch (error) {\n      console.error(\"Error fetching Mailcow config:\", error);\n      res.status(500).json({ message: \"Failed to fetch Mailcow configuration\" });\n    }\n  });\n\n  // Create or update Mailcow configuration\n  app.post('/api/integrations/mailcow/config', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { apiKey, ...otherData } = req.body;\n      \n      const [existing] = await db.select().from(mailcowConfig).limit(1);\n      \n      // Build update data, preserving existing API key if new one isn't provided\n      const updateData: any = { ...otherData, updatedAt: new Date() };\n      \n      // Only update apiKey if a new one is provided (non-empty, non-masked)\n      if (apiKey && apiKey.trim() && !apiKey.startsWith('••••')) {\n        updateData.apiKey = apiKey;\n      } else if (!existing) {\n        return res.status(400).json({ message: \"API Key is required for new configuration\" });\n      }\n      \n      let result;\n      if (existing) {\n        [result] = await db.update(mailcowConfig)\n          .set(updateData)\n          .where(eq(mailcowConfig.id, existing.id))\n          .returning();\n      } else {\n        [result] = await db.insert(mailcowConfig).values({\n          ...updateData,\n          apiKey: apiKey,\n        }).returning();\n      }\n\n      await storage.createActivityLog(\n        req.teamMember.id,\n        existing ? \"updated_mailcow_config\" : \"created_mailcow_config\",\n        \"mailcow_config\",\n        result.id,\n        \"mailcow\"\n      );\n\n      res.json({ ...result, apiKey: '••••••••' + result.apiKey.slice(-4) });\n    } catch (error) {\n      console.error(\"Error saving Mailcow config:\", error);\n      res.status(400).json({ message: \"Failed to save Mailcow configuration\" });\n    }\n  });\n\n  // Test Mailcow connection\n  app.post('/api/integrations/mailcow/test', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { instanceUrl, apiKey } = req.body;\n      \n      const response = await fetch(`${instanceUrl}/api/v1/get/status/containers`, {\n        headers: {\n          'X-API-Key': apiKey,\n          'Content-Type': 'application/json',\n        },\n      });\n\n      if (!response.ok) {\n        return res.status(400).json({ success: false, message: \"Connection failed: Invalid credentials or URL\" });\n      }\n\n      res.json({ success: true, message: \"Connection successful\" });\n    } catch (error) {\n      console.error(\"Error testing Mailcow connection:\", error);\n      res.status(400).json({ success: false, message: \"Connection failed: Unable to reach Mailcow server\" });\n    }\n  });\n\n  // ============================================\n  // DEPARTMENT EMAIL SETTINGS ROUTES\n  // ============================================\n\n  // Get all department email settings\n  app.get('/api/integrations/department-emails', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const settings = await db.select().from(departmentEmailSettings);\n      // Mask passwords\n      const safeSettings = settings.map(s => ({\n        ...s,\n        imapPassword: s.imapPassword ? '••••••••' : null,\n        smtpPassword: s.smtpPassword ? '••••••••' : null,\n      }));\n      res.json(safeSettings);\n    } catch (error) {\n      console.error(\"Error fetching department email settings:\", error);\n      res.status(500).json({ message: \"Failed to fetch department email settings\" });\n    }\n  });\n\n  // Get department email settings by department ID\n  app.get('/api/integrations/department-emails/:departmentId', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const [settings] = await db.select()\n        .from(departmentEmailSettings)\n        .where(eq(departmentEmailSettings.departmentId, req.params.departmentId));\n      \n      if (!settings) {\n        return res.json(null);\n      }\n\n      const safeSettings = {\n        ...settings,\n        imapPassword: settings.imapPassword ? '••••••••' : null,\n        smtpPassword: settings.smtpPassword ? '••••••••' : null,\n      };\n      res.json(safeSettings);\n    } catch (error) {\n      console.error(\"Error fetching department email settings:\", error);\n      res.status(500).json({ message: \"Failed to fetch department email settings\" });\n    }\n  });\n\n  // Create or update department email settings\n  app.post('/api/integrations/department-emails', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.DEPARTMENT_ADMIN), async (req: any, res) => {\n    try {\n      const validatedData = insertDepartmentEmailSettingsSchema.parse(req.body);\n      \n      // Check if settings exist for this department\n      const [existing] = await db.select()\n        .from(departmentEmailSettings)\n        .where(eq(departmentEmailSettings.departmentId, validatedData.departmentId));\n      \n      let result;\n      if (existing) {\n        [result] = await db.update(departmentEmailSettings)\n          .set({ ...validatedData, updatedAt: new Date() })\n          .where(eq(departmentEmailSettings.id, existing.id))\n          .returning();\n      } else {\n        [result] = await db.insert(departmentEmailSettings).values(validatedData).returning();\n      }\n\n      await storage.createActivityLog(\n        req.teamMember.id,\n        existing ? \"updated_department_email\" : \"created_department_email\",\n        \"department_email_settings\",\n        result.id,\n        undefined,\n        { departmentId: validatedData.departmentId }\n      );\n\n      const safeResult = {\n        ...result,\n        imapPassword: result.imapPassword ? '••••••••' : null,\n        smtpPassword: result.smtpPassword ? '••••••••' : null,\n      };\n      res.json(safeResult);\n    } catch (error) {\n      console.error(\"Error saving department email settings:\", error);\n      res.status(400).json({ message: \"Failed to save department email settings\" });\n    }\n  });\n\n  // Delete department email settings\n  app.delete('/api/integrations/department-emails/:id', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      await db.delete(departmentEmailSettings).where(eq(departmentEmailSettings.id, req.params.id));\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting department email settings:\", error);\n      res.status(400).json({ message: \"Failed to delete department email settings\" });\n    }\n  });\n\n  // ============================================\n  // CHATWOOT EMBED / SSO ROUTES\n  // ============================================\n\n  // Get Chatwoot SSO URL for embedding\n  app.get('/api/integrations/chatwoot/sso-url', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const [config] = await db.select().from(chatwootConfig).limit(1);\n      if (!config || !config.enabled) {\n        return res.status(400).json({ message: \"Chatwoot not configured or disabled\" });\n      }\n\n      // Get the team member's Chatwoot agent mapping\n      const [agentMapping] = await db.select()\n        .from(chatwootAgents)\n        .where(eq(chatwootAgents.teamMemberId, req.teamMember.id));\n\n      // Build the embed URL\n      const embedUrl = `${config.instanceUrl}/app/accounts/${config.accountId}/dashboard`;\n      \n      res.json({\n        embedUrl,\n        instanceUrl: config.instanceUrl,\n        accountId: config.accountId,\n        agentId: agentMapping?.chatwootAgentId || null,\n        ssoEnabled: config.ssoEnabled,\n      });\n    } catch (error) {\n      console.error(\"Error getting Chatwoot SSO URL:\", error);\n      res.status(500).json({ message: \"Failed to get Chatwoot embed URL\" });\n    }\n  });\n\n  // Get department's Chatwoot inbox for filtered view\n  app.get('/api/integrations/chatwoot/department-inbox', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const member = req.teamMember;\n      \n      // Get inbox mapped to user's department\n      const [inbox] = await db.select()\n        .from(chatwootInboxes)\n        .where(eq(chatwootInboxes.departmentId, member.departmentId));\n\n      if (!inbox) {\n        return res.json({ inbox: null, message: \"No inbox configured for your department\" });\n      }\n\n      const [config] = await db.select().from(chatwootConfig).limit(1);\n      if (!config) {\n        return res.status(400).json({ message: \"Chatwoot not configured\" });\n      }\n\n      res.json({\n        inbox,\n        embedUrl: `${config.instanceUrl}/app/accounts/${config.accountId}/inbox/${inbox.chatwootInboxId}`,\n      });\n    } catch (error) {\n      console.error(\"Error getting department inbox:\", error);\n      res.status(500).json({ message: \"Failed to get department inbox\" });\n    }\n  });\n\n  // Get conversation statistics from Chatwoot\n  app.get('/api/integrations/chatwoot/stats', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const [config] = await db.select().from(chatwootConfig).limit(1);\n      if (!config || !config.enabled) {\n        return res.json({ \n          open: 0, \n          pending: 0, \n          resolved: 0, \n          unassigned: 0,\n          available: false \n        });\n      }\n\n      const member = req.teamMember;\n      \n      // Get department inbox if not management\n      let inboxFilter = '';\n      if (member.roleCode !== 'management') {\n        const [inbox] = await db.select()\n          .from(chatwootInboxes)\n          .where(eq(chatwootInboxes.departmentId, member.departmentId));\n        if (inbox) {\n          inboxFilter = `&inbox_id=${inbox.chatwootInboxId}`;\n        }\n      }\n\n      // Fetch conversation counts from Chatwoot API\n      const fetchConversationCount = async (status: string) => {\n        try {\n          const response = await fetch(\n            `${config.instanceUrl}/api/v1/accounts/${config.accountId}/conversations?status=${status}${inboxFilter}`,\n            {\n              headers: {\n                'api_access_token': config.apiAccessToken,\n                'Content-Type': 'application/json',\n              },\n            }\n          );\n          if (response.ok) {\n            const data = await response.json();\n            return data.meta?.all_count || data.payload?.length || 0;\n          }\n          return 0;\n        } catch (e) {\n          return 0;\n        }\n      };\n\n      const [open, pending, resolved] = await Promise.all([\n        fetchConversationCount('open'),\n        fetchConversationCount('pending'),\n        fetchConversationCount('resolved'),\n      ]);\n\n      res.json({\n        open,\n        pending,\n        resolved,\n        unassigned: 0, // Would need separate API call\n        available: true,\n        lastUpdated: new Date().toISOString(),\n      });\n    } catch (error) {\n      console.error(\"Error fetching Chatwoot stats:\", error);\n      res.json({ \n        open: 0, \n        pending: 0, \n        resolved: 0, \n        unassigned: 0,\n        available: false,\n        error: \"Failed to fetch statistics\" \n      });\n    }\n  });\n\n  // ============================================\n  // INTEGRATION STATUS OVERVIEW\n  // ============================================\n\n  // Get status of all integrations\n  app.get('/api/integrations/status', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const [chatwoot] = await db.select().from(chatwootConfig).limit(1);\n      const [evolution] = await db.select().from(evolutionApiConfig).limit(1);\n      const [typebot] = await db.select().from(typebotConfig).limit(1);\n      const [mailcow] = await db.select().from(mailcowConfig).limit(1);\n\n      res.json({\n        chatwoot: {\n          configured: !!chatwoot,\n          enabled: chatwoot?.enabled || false,\n          lastSync: chatwoot?.lastSyncAt || null,\n        },\n        evolution: {\n          configured: !!evolution,\n          enabled: evolution?.enabled || false,\n          connectionStatus: evolution?.connectionStatus || 'disconnected',\n        },\n        typebot: {\n          configured: !!typebot,\n          enabled: typebot?.enabled || false,\n        },\n        mailcow: {\n          configured: !!mailcow,\n          enabled: mailcow?.enabled || false,\n          lastSync: mailcow?.lastSyncAt || null,\n        },\n      });\n    } catch (error) {\n      console.error(\"Error fetching integration status:\", error);\n      res.status(500).json({ message: \"Failed to fetch integration status\" });\n    }\n  });\n\n  // ============================================\n  // PLATFORM PROVISIONING ROUTES\n  // ============================================\n\n  // Provision a team member on external platforms (Mailcow + Chatwoot)\n  app.post('/api/integrations/provision/:teamMemberId', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { teamMemberId } = req.params;\n      const { createMailbox = true, createChatwootAgent = true, assignToTeam = true } = req.body;\n\n      // Get team member\n      const member = await storage.getTeamMember(teamMemberId);\n      if (!member) {\n        return res.status(404).json({ message: \"Team member not found\" });\n      }\n\n      // Get department\n      const department = await storage.getDepartment(member.departmentId);\n      if (!department) {\n        return res.status(404).json({ message: \"Department not found\" });\n      }\n\n      // Run provisioning\n      // TODO: Re-implement using simpler approach from routes.ts\n      res.status(501).json({\n        success: false,\n        message: \"Full team member provisioning not yet re-implemented. Use managed user provisioning in routes.ts instead.\",\n      });\n      return;\n    } catch (error) {\n      console.error(\"Error provisioning team member:\", error);\n      res.status(500).json({ message: \"Failed to provision team member\" });\n    }\n  });\n\n  // Get provisioning status for a team member\n  app.get('/api/integrations/provision/:teamMemberId/status', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { teamMemberId } = req.params;\n\n      // Check Chatwoot agent mapping\n      const [chatwootAgent] = await db.select()\n        .from(chatwootAgents)\n        .where(eq(chatwootAgents.teamMemberId, teamMemberId));\n\n      // Check managed users for platform info\n      const [managedUser] = await db.select()\n        .from(managedUsers)\n        .where(eq(managedUsers.teamMemberId, teamMemberId));\n\n      res.json({\n        chatwoot: {\n          provisioned: !!chatwootAgent,\n          agentId: chatwootAgent?.chatwootAgentId || null,\n          email: chatwootAgent?.chatwootAgentEmail || null,\n        },\n        mailcow: {\n          provisioned: managedUser?.platforms?.includes('mailcow') || false,\n          email: (managedUser?.platformUserIds as any)?.mailcow || null,\n        },\n        platforms: managedUser?.platforms || [],\n      });\n    } catch (error) {\n      console.error(\"Error fetching provisioning status:\", error);\n      res.status(500).json({ message: \"Failed to fetch provisioning status\" });\n    }\n  });\n\n  // Test provisioning connections\n  app.post('/api/integrations/provision/test-connections', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      // TODO: Implement connection testing\n      res.status(501).json({\n        mailcow: { success: false, message: \"Test not yet implemented\" },\n        chatwoot: { success: false, message: \"Test not yet implemented\" },\n      });\n    } catch (error) {\n      console.error(\"Error testing provisioning connections:\", error);\n      res.status(500).json({ message: \"Failed to test connections\" });\n    }\n  });\n\n  // Generate Chatwoot SSO URL for current user\n  app.get('/api/integrations/chatwoot/sso-login', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const member = req.teamMember;\n      \n      // Get Chatwoot agent email for SSO\n      const [agentMapping] = await db.select()\n        .from(chatwootAgents)\n        .where(eq(chatwootAgents.teamMemberId, member.id));\n\n      const ssoEmail = agentMapping?.chatwootAgentEmail || member.email;\n      const ssoUrl = null; // TODO: Implement SSO URL generation\n\n      if (!ssoUrl) {\n        // Fall back to regular embed URL\n        const [config] = await db.select().from(chatwootConfig).limit(1);\n        if (!config) {\n          return res.status(400).json({ message: \"Chatwoot not configured\" });\n        }\n        return res.json({\n          ssoEnabled: false,\n          embedUrl: `${config.instanceUrl}/app/accounts/${config.accountId}/dashboard`,\n        });\n      }\n\n      res.json({\n        ssoEnabled: true,\n        ssoUrl,\n      });\n    } catch (error) {\n      console.error(\"Error generating SSO URL:\", error);\n      res.status(500).json({ message: \"Failed to generate SSO URL\" });\n    }\n  });\n\n  // Preview username that would be generated\n  app.post('/api/integrations/provision/preview-username', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { firstName, lastName } = req.body;\n\n      if (!firstName || !lastName) {\n        return res.status(400).json({ message: \"First name and last name are required\" });\n      }\n\n      const [mailcowConf] = await db.select().from(mailcowConfig).limit(1);\n      const domain = mailcowConf?.domain || 'mmallelectronics.co.za';\n\n      // TODO: Implement username generation using simplified approach\n      const username = `${firstName.toLowerCase()}.${lastName.toLowerCase()}`;\n      res.status(501).json({\n        username,\n        email: `${username}@${domain}`,\n        domain,\n        message: \"Simplified preview - full collision handling not yet implemented\"\n      });\n      return;\n    } catch (error) {\n      console.error(\"Error previewing username:\", error);\n      res.status(500).json({ message: \"Failed to preview username\" });\n    }\n  });\n\n  // Bulk provision multiple team members\n  app.post('/api/integrations/provision/bulk', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { teamMemberIds, createMailbox = true, createChatwootAgent = true } = req.body;\n\n      if (!teamMemberIds || !Array.isArray(teamMemberIds) || teamMemberIds.length === 0) {\n        return res.status(400).json({ message: \"Team member IDs are required\" });\n      }\n\n      const results = [];\n      for (const teamMemberId of teamMemberIds) {\n        const member = await storage.getTeamMember(teamMemberId);\n        if (!member) {\n          results.push({ teamMemberId, success: false, error: \"Member not found\" });\n          continue;\n        }\n\n        const department = await storage.getDepartment(member.departmentId);\n        if (!department) {\n          results.push({ teamMemberId, success: false, error: \"Department not found\" });\n          continue;\n        }\n\n        try {\n          // TODO: Re-implement full provisioning\n          results.push({\n            teamMemberId,\n            success: false,\n            error: \"Full provisioning not yet re-implemented\"\n          });\n        } catch (err) {\n          results.push({\n            teamMemberId,\n            success: false,\n            error: err instanceof Error ? err.message : \"Provisioning failed\",\n          });\n        }\n      }\n\n      // Log activity\n      await storage.createActivityLog(\n        req.teamMember.id,\n        \"bulk_provisioned_team_members\",\n        \"team_member\",\n        undefined,\n        undefined,\n        { count: teamMemberIds.length, results }\n      );\n\n      res.json({\n        success: true,\n        totalRequested: teamMemberIds.length,\n        results,\n      });\n    } catch (error) {\n      console.error(\"Error bulk provisioning:\", error);\n      res.status(500).json({ message: \"Failed to bulk provision team members\" });\n    }\n  });\n}\n","path":null,"size_bytes":39903,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"create_adminhub.sh":{"content":"#!/bin/bash\nadduser --disabled-password --gecos \"\" adminhub\nusermod -aG sudo adminhub\nmkdir -p /home/adminhub/.ssh\nchmod 700 /home/adminhub/.ssh\ncp /root/.ssh/authorized_keys /home/adminhub/.ssh/\nchown -R adminhub:adminhub /home/adminhub/.ssh\nchmod 600 /home/adminhub/.ssh/authorized_keys\necho \"SUCCESS: adminhub user created with SSH access\"\n","path":null,"size_bytes":343,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"server/index-dev.ts":{"content":"import \"dotenv/config\";\nimport fs from \"node:fs\";\nimport path from \"node:path\";\nimport { type Server } from \"node:http\";\n\nimport { nanoid } from \"nanoid\";\nimport { type Express } from \"express\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\n\nimport viteConfig from \"../vite.config\";\nimport runApp from \"./app\";\n\nexport async function setupVite(app: Express, server: Server) {\n  const viteLogger = createLogger();\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        // Forward error to vite logger but do not exit process on warnings\n        viteLogger.error(msg, options);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\n(async () => {\n  await runApp(setupVite);\n})();\n","path":null,"size_bytes":1684,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"server/newroutes.ts":{"content":"","path":null,"size_bytes":0,"size_tokens":null},"client/src/lib/authUtils.ts":{"content":"// Replit Auth utility functions\nexport function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}\n","path":null,"size_bytes":149,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"migrate-managed-users.ts":{"content":"import \"dotenv/config\";\nimport pkg from 'pg';\nconst { Client } = pkg;\n\nconst connectionString = process.env.DATABASE_URL || 'postgresql://postgres:postgres@localhost:5432/postgres';\n\nconst migrations = [\n  // Drop the old managed_users table and recreate with new schema\n  `DROP TABLE IF EXISTS \"managed_users\" CASCADE`,\n  \n  // Create the new managed_users table with support for multiple platforms\n  `CREATE TABLE \"managed_users\" (\n    \"id\" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n    \"email\" varchar NOT NULL,\n    \"full_name\" varchar NOT NULL,\n    \"platforms\" varchar(50)[] DEFAULT ARRAY[]::varchar[] NOT NULL,\n    \"platform_user_ids\" jsonb DEFAULT '{}'::jsonb NOT NULL,\n    \"roles\" jsonb DEFAULT '{}'::jsonb NOT NULL,\n    \"status\" varchar(20) DEFAULT 'active' NOT NULL,\n    \"created_at\" timestamp DEFAULT now(),\n    \"updated_at\" timestamp DEFAULT now()\n  )`,\n];\n\nasync function runMigrations() {\n  const client = new Client({ connectionString });\n  try {\n    await client.connect();\n    console.log('✓ Connected to database\\n');\n    \n    for (const migration of migrations) {\n      const shortSQL = migration.substring(0, 80).replace(/\\n/g, ' ');\n      process.stdout.write(`Running: ${shortSQL}... `);\n      await client.query(migration);\n      console.log('✓');\n    }\n    console.log('\\n✅ All migrations completed successfully!');\n    process.exit(0);\n  } catch (error) {\n    console.error('❌ Migration failed:', error);\n    process.exit(1);\n  } finally {\n    await client.end();\n  }\n}\n\nrunMigrations();\n","path":null,"size_bytes":1534,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"full-deploy.sh":{"content":"#!/bin/bash\nset -e\n\necho \"================================\"\necho \"AdminHub Full Deployment\"\necho \"================================\"\necho \"\"\n\n# Create app directory\nmkdir -p /home/adminhub/app\ncd /home/adminhub/app\n\necho \"ℹ️ Waiting for app files to be copied...\"\nsleep 5\n\n# Build and start Docker\necho \"ℹ️ Building Docker images...\"\ndocker-compose build\n\necho \"ℹ️ Starting Docker containers...\"\ndocker-compose up -d\n\n# Wait for services to be ready\necho \"ℹ️ Waiting for services to start (30 seconds)...\"\nsleep 30\n\n# Check if containers are running\necho \"ℹ️ Checking container status...\"\ndocker-compose ps\n\necho \"\"\necho \"✅ Deployment complete!\"\necho \"ℹ️ App will be available at: http://158.220.107.106:8080\"\necho \"ℹ️ Run 'docker-compose logs -f' to see live logs\"\n","path":null,"size_bytes":795,"size_tokens":null},"client/src/pages/tasks.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { \n  Plus, \n  Clock, \n  CheckCircle2, \n  AlertCircle, \n  Pause, \n  XCircle,\n  Calendar,\n  User\n} from \"lucide-react\";\nimport type { Task, Department, TeamMember } from \"@shared/schema\";\n\nconst statusIcons = {\n  pending: Clock,\n  in_progress: AlertCircle,\n  completed: CheckCircle2,\n  on_hold: Pause,\n  cancelled: XCircle,\n};\n\nconst statusColors = {\n  pending: \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200\",\n  in_progress: \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\",\n  completed: \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\",\n  on_hold: \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200\",\n  cancelled: \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200\",\n};\n\nconst priorityColors = {\n  low: \"bg-slate-100 text-slate-800 dark:bg-slate-800 dark:text-slate-200\",\n  medium: \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\",\n  high: \"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200\",\n  urgent: \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200\",\n};\n\nexport default function Tasks() {\n  const { teamMember, hasPermission, PERMISSION_TYPES, isManagement, isDepartmentAdmin } = useAuth();\n  const { toast } = useToast();\n  const [isCreateOpen, setIsCreateOpen] = useState(false);\n  const [selectedStatus, setSelectedStatus] = useState<string>(\"all\");\n\n  const { data: tasks = [], isLoading } = useQuery<Task[]>({\n    queryKey: [\"/api/tasks\"],\n  });\n\n  const { data: departments = [] } = useQuery<Department[]>({\n    queryKey: [\"/api/departments\"],\n  });\n\n  const { data: teamMembers = [] } = useQuery<TeamMember[]>({\n    queryKey: [\"/api/team-members\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: Partial<Task>) => {\n      const res = await apiRequest(\"/api/tasks\", \"POST\", data);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tasks\"] });\n      setIsCreateOpen(false);\n      toast({ title: \"Task created successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Failed to create task\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async ({ id, status }: { id: string; status: string }) => {\n      const res = await apiRequest(`/api/tasks/${id}`, \"PATCH\", { status });\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tasks\"] });\n      toast({ title: \"Task status updated\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Failed to update task\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const canCreateTask = hasPermission(PERMISSION_TYPES.CREATE_TASK) || hasPermission(PERMISSION_TYPES.ASSIGN_TASK);\n  const canUpdateTask = hasPermission(PERMISSION_TYPES.UPDATE_TASK);\n\n  const filteredTasks = selectedStatus === \"all\" \n    ? tasks \n    : tasks.filter(task => task.status === selectedStatus);\n\n  const handleCreateTask = (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    const formData = new FormData(e.currentTarget);\n    createMutation.mutate({\n      title: formData.get(\"title\") as string,\n      description: formData.get(\"description\") as string,\n      priority: formData.get(\"priority\") as string || \"medium\",\n      departmentId: formData.get(\"departmentId\") as string || teamMember?.departmentId,\n      assignedToId: formData.get(\"assignedToId\") as string || undefined,\n    });\n  };\n\n  const getDepartmentName = (departmentId: string) => {\n    const dept = departments.find(d => d.id === departmentId);\n    return dept?.name || dept?.code || \"Unknown\";\n  };\n\n  const getAssigneeName = (assignedToId: string | null) => {\n    if (!assignedToId) return \"Unassigned\";\n    const member = teamMembers.find(m => m.id === assignedToId);\n    return member ? `${member.firstName} ${member.lastName}` : \"Unknown\";\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"text-muted-foreground\">Loading tasks...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-page-title\">Tasks</h1>\n          <p className=\"text-muted-foreground\">\n            {isManagement ? \"All tasks across departments\" : \n             isDepartmentAdmin ? `Tasks in ${teamMember?.departmentName || \"your department\"}` :\n             \"Your assigned tasks\"}\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2 flex-wrap\">\n          <Select value={selectedStatus} onValueChange={setSelectedStatus}>\n            <SelectTrigger className=\"w-[150px]\" data-testid=\"select-status-filter\">\n              <SelectValue placeholder=\"Filter status\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Status</SelectItem>\n              <SelectItem value=\"pending\">Pending</SelectItem>\n              <SelectItem value=\"in_progress\">In Progress</SelectItem>\n              <SelectItem value=\"completed\">Completed</SelectItem>\n              <SelectItem value=\"on_hold\">On Hold</SelectItem>\n              <SelectItem value=\"cancelled\">Cancelled</SelectItem>\n            </SelectContent>\n          </Select>\n          {canCreateTask && (\n            <Dialog open={isCreateOpen} onOpenChange={setIsCreateOpen}>\n              <DialogTrigger asChild>\n                <Button data-testid=\"button-create-task\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  New Task\n                </Button>\n              </DialogTrigger>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Create New Task</DialogTitle>\n                  <DialogDescription>\n                    Add a new task to be assigned to a technician.\n                  </DialogDescription>\n                </DialogHeader>\n                <form onSubmit={handleCreateTask} className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"title\">Title</Label>\n                    <Input \n                      id=\"title\" \n                      name=\"title\" \n                      placeholder=\"Task title\" \n                      required \n                      data-testid=\"input-task-title\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"description\">Description</Label>\n                    <Textarea \n                      id=\"description\" \n                      name=\"description\" \n                      placeholder=\"Task description\" \n                      data-testid=\"input-task-description\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"priority\">Priority</Label>\n                    <Select name=\"priority\" defaultValue=\"medium\">\n                      <SelectTrigger data-testid=\"select-task-priority\">\n                        <SelectValue placeholder=\"Select priority\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"low\">Low</SelectItem>\n                        <SelectItem value=\"medium\">Medium</SelectItem>\n                        <SelectItem value=\"high\">High</SelectItem>\n                        <SelectItem value=\"urgent\">Urgent</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  {isManagement && (\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"departmentId\">Department</Label>\n                      <Select name=\"departmentId\" defaultValue={teamMember?.departmentId}>\n                        <SelectTrigger data-testid=\"select-task-department\">\n                          <SelectValue placeholder=\"Select department\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {departments.map(dept => (\n                            <SelectItem key={dept.id} value={dept.id}>\n                              {dept.name} ({dept.code})\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  )}\n                  {(isManagement || isDepartmentAdmin) && (\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"assignedToId\">Assign To</Label>\n                      <Select name=\"assignedToId\">\n                        <SelectTrigger data-testid=\"select-task-assignee\">\n                          <SelectValue placeholder=\"Select team member\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {teamMembers\n                            .filter(m => isManagement || m.departmentId === teamMember?.departmentId)\n                            .map(member => (\n                            <SelectItem key={member.id} value={member.id}>\n                              {member.firstName} {member.lastName}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  )}\n                  <Button type=\"submit\" className=\"w-full\" disabled={createMutation.isPending} data-testid=\"button-submit-task\">\n                    {createMutation.isPending ? \"Creating...\" : \"Create Task\"}\n                  </Button>\n                </form>\n              </DialogContent>\n            </Dialog>\n          )}\n        </div>\n      </div>\n\n      {filteredTasks.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12\">\n            <Clock className=\"h-12 w-12 text-muted-foreground mb-4\" />\n            <p className=\"text-muted-foreground\">No tasks found</p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4\">\n          {filteredTasks.map(task => {\n            const StatusIcon = statusIcons[task.status as keyof typeof statusIcons] || Clock;\n            return (\n              <Card key={task.id} data-testid={`card-task-${task.id}`}>\n                <CardHeader className=\"pb-2\">\n                  <div className=\"flex items-start justify-between gap-4 flex-wrap\">\n                    <div className=\"space-y-1\">\n                      <CardTitle className=\"text-lg\">{task.title}</CardTitle>\n                      {task.description && (\n                        <CardDescription>{task.description}</CardDescription>\n                      )}\n                    </div>\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      <Badge className={priorityColors[task.priority as keyof typeof priorityColors] || priorityColors.medium}>\n                        {task.priority}\n                      </Badge>\n                      <Badge className={statusColors[task.status as keyof typeof statusColors] || statusColors.pending}>\n                        <StatusIcon className=\"h-3 w-3 mr-1\" />\n                        {task.status.replace(\"_\", \" \")}\n                      </Badge>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex items-center justify-between gap-4 flex-wrap text-sm text-muted-foreground\">\n                    <div className=\"flex items-center gap-4 flex-wrap\">\n                      <span className=\"flex items-center gap-1\">\n                        <User className=\"h-4 w-4\" />\n                        {getAssigneeName(task.assignedToId)}\n                      </span>\n                      <span>\n                        {getDepartmentName(task.departmentId)}\n                      </span>\n                      {task.dueDate && (\n                        <span className=\"flex items-center gap-1\">\n                          <Calendar className=\"h-4 w-4\" />\n                          {new Date(task.dueDate).toLocaleDateString()}\n                        </span>\n                      )}\n                    </div>\n                    {canUpdateTask && (\n                      <Select \n                        value={task.status} \n                        onValueChange={(status) => updateStatusMutation.mutate({ id: task.id, status })}\n                      >\n                        <SelectTrigger className=\"w-[140px]\" data-testid={`select-status-${task.id}`}>\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"pending\">Pending</SelectItem>\n                          <SelectItem value=\"in_progress\">In Progress</SelectItem>\n                          <SelectItem value=\"completed\">Completed</SelectItem>\n                          <SelectItem value=\"on_hold\">On Hold</SelectItem>\n                          <SelectItem value=\"cancelled\">Cancelled</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":14336,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"add-is-verified.ts":{"content":"import 'dotenv/config';\nimport pkg from 'pg';\nconst { Pool } = pkg;\n\nconst pool = new Pool({ \n  connectionString: process.env.DATABASE_URL \n});\n\nasync function addIsVerifiedColumn() {\n  try {\n    console.log('Adding is_verified column to team_members table...');\n    console.log('Database URL:', process.env.DATABASE_URL?.replace(/:[^:]*@/, ':***@'));\n    \n    await pool.query(`\n      ALTER TABLE \"team_members\" ADD COLUMN \"is_verified\" boolean DEFAULT false NOT NULL;\n    `);\n    \n    console.log('✓ Successfully added is_verified column');\n    \n    // Mark all existing users as verified so they can still login\n    const result = await pool.query(`\n      UPDATE \"team_members\" SET \"is_verified\" = true WHERE \"is_verified\" IS NULL;\n    `);\n    \n    console.log(`✓ Updated existing users - ${result.rowCount} rows affected`);\n    \n    await pool.end();\n    console.log('Done!');\n  } catch (error: any) {\n    if (error.message.includes('already exists')) {\n      console.log('✓ Column already exists - skipping');\n      // Mark all existing users as verified\n      try {\n        await pool.query(`\n          UPDATE \"team_members\" SET \"is_verified\" = true WHERE \"is_verified\" IS NULL;\n        `);\n        console.log('✓ Updated existing users to verified');\n      } catch (e) {\n        console.log('No updates needed');\n      }\n      await pool.end();\n    } else {\n      console.error('Error adding column:', error.message);\n      await pool.end();\n      process.exit(1);\n    }\n  }\n}\n\naddIsVerifiedColumn();\n","path":null,"size_bytes":1516,"size_tokens":null},"server/migrate.ts":{"content":"import pkg from 'pg';\nconst { Client } = pkg;\n\nconst connectionString = process.env.DATABASE_URL || 'postgresql://postgres:postgres@postgres:5432/postgres';\n\nconst migrations = [\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"address_line_1\" varchar(255)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"address_line_2\" varchar(255)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"city\" varchar(100)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"state\" varchar(100)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"postal_code\" varchar(20)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"country\" varchar(100)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_1_name\" varchar(100)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_1_relationship\" varchar(50)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_1_phone\" varchar(20)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_1_email\" varchar`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_1_address\" text`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_2_name\" varchar(100)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_2_relationship\" varchar(50)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_2_phone\" varchar(20)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_2_email\" varchar`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_2_address\" text`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"is_verified\" boolean DEFAULT false NOT NULL`,\n];\n\nasync function runMigrations() {\n  const client = new Client({ connectionString });\n  try {\n    await client.connect();\n    console.log('Connected to database');\n    \n    for (const migration of migrations) {\n      console.log(`Running: ${migration.substring(0, 60)}...`);\n      await client.query(migration);\n      console.log(`✓ Done`);\n    }\n    console.log('\\n✅ All migrations completed successfully!');\n    process.exit(0);\n  } catch (error) {\n    console.error('❌ Migration failed:', error);\n    process.exit(1);\n  } finally {\n    await client.end();\n  }\n}\n\nrunMigrations();\n","path":null,"size_bytes":2270,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/pages/registrations.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\";\nimport { \n  UserPlus, \n  Clock, \n  CheckCircle2, \n  XCircle, \n  Eye,\n  RefreshCw,\n  AlertCircle,\n  Loader2,\n  MapPin,\n  Users,\n  Phone,\n  Mail,\n  Building,\n  KeyRound,\n  Copy,\n  Check\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\ninterface Department {\n  id: string;\n  name: string;\n  code: string;\n}\n\ninterface LatestOtp {\n  code: string;\n  expiresAt: string;\n}\n\ninterface PendingRegistration {\n  id: string;\n  email: string;\n  firstName: string;\n  lastName: string;\n  phone: string;\n  departmentId: string;\n  department: Department | null;\n  addressLine1: string;\n  addressLine2: string | null;\n  city: string;\n  state: string;\n  postalCode: string;\n  country: string;\n  nextOfKin1Name: string;\n  nextOfKin1Relationship: string;\n  nextOfKin1Phone: string;\n  nextOfKin1Email: string | null;\n  nextOfKin1Address: string | null;\n  nextOfKin2Name: string;\n  nextOfKin2Relationship: string;\n  nextOfKin2Phone: string;\n  nextOfKin2Email: string | null;\n  nextOfKin2Address: string | null;\n  status: string;\n  rejectionReason: string | null;\n  createdAt: string;\n  latestOtp: LatestOtp | null;\n}\n\ninterface Role {\n  id: string;\n  name: string;\n  code: string;\n  level: number;\n}\n\nexport default function Registrations() {\n  const [selectedRegistration, setSelectedRegistration] = useState<PendingRegistration | null>(null);\n  const [showDetails, setShowDetails] = useState(false);\n  const [showApproveDialog, setShowApproveDialog] = useState(false);\n  const [showRejectDialog, setShowRejectDialog] = useState(false);\n  const [otpInput, setOtpInput] = useState(\"\");\n  const [selectedRoleId, setSelectedRoleId] = useState(\"\");\n  const [employeeId, setEmployeeId] = useState(\"\");\n  const [rejectionReason, setRejectionReason] = useState(\"\");\n  const [error, setError] = useState<string | null>(null);\n  const [copiedOtp, setCopiedOtp] = useState(false);\n  const [activeTab, setActiveTab] = useState(\"pending\");\n\n  const { data: registrations = [], isLoading, refetch } = useQuery<PendingRegistration[]>({\n    queryKey: [\"/api/registrations\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/registrations\");\n      if (!response.ok) throw new Error(\"Failed to fetch registrations\");\n      return response.json();\n    },\n  });\n\n  const { data: roles = [] } = useQuery<Role[]>({\n    queryKey: [\"/api/roles\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/roles\");\n      if (!response.ok) throw new Error(\"Failed to fetch roles\");\n      return response.json();\n    },\n  });\n\n  const generateOtpMutation = useMutation({\n    mutationFn: async (registrationId: string) => {\n      return await apiRequest(`/api/registrations/${registrationId}/generate-otp`, \"POST\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/registrations\"] });\n    },\n  });\n\n  const approveMutation = useMutation({\n    mutationFn: async ({ id, otpCode, roleId, employeeId }: { id: string; otpCode: string; roleId?: string; employeeId?: string }) => {\n      return await apiRequest(`/api/registrations/${id}/approve`, \"POST\", { otpCode, roleId, employeeId });\n    },\n    onSuccess: () => {\n      setShowApproveDialog(false);\n      setOtpInput(\"\");\n      setSelectedRoleId(\"\");\n      setEmployeeId(\"\");\n      setError(null);\n      queryClient.invalidateQueries({ queryKey: [\"/api/registrations\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/team-members\"] });\n    },\n    onError: (err: any) => {\n      setError(err?.message || \"Failed to approve registration\");\n    },\n  });\n\n  const rejectMutation = useMutation({\n    mutationFn: async ({ id, reason }: { id: string; reason: string }) => {\n      return await apiRequest(`/api/registrations/${id}/reject`, \"POST\", { reason });\n    },\n    onSuccess: () => {\n      setShowRejectDialog(false);\n      setRejectionReason(\"\");\n      setError(null);\n      queryClient.invalidateQueries({ queryKey: [\"/api/registrations\"] });\n    },\n    onError: (err: any) => {\n      setError(err?.message || \"Failed to reject registration\");\n    },\n  });\n\n  const filteredRegistrations = registrations.filter(reg => {\n    if (activeTab === \"pending\") return reg.status === \"pending\";\n    if (activeTab === \"approved\") return reg.status === \"approved\";\n    if (activeTab === \"rejected\") return reg.status === \"rejected\";\n    return true;\n  });\n\n  const pendingCount = registrations.filter(r => r.status === \"pending\").length;\n  const approvedCount = registrations.filter(r => r.status === \"approved\").length;\n  const rejectedCount = registrations.filter(r => r.status === \"rejected\").length;\n\n  const copyOtp = (otp: string) => {\n    navigator.clipboard.writeText(otp);\n    setCopiedOtp(true);\n    setTimeout(() => setCopiedOtp(false), 2000);\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"pending\":\n        return <Badge variant=\"outline\" className=\"bg-yellow-50 text-yellow-700 border-yellow-200\"><Clock className=\"h-3 w-3 mr-1\" /> Pending</Badge>;\n      case \"approved\":\n        return <Badge variant=\"outline\" className=\"bg-green-50 text-green-700 border-green-200\"><CheckCircle2 className=\"h-3 w-3 mr-1\" /> Approved</Badge>;\n      case \"rejected\":\n        return <Badge variant=\"outline\" className=\"bg-red-50 text-red-700 border-red-200\"><XCircle className=\"h-3 w-3 mr-1\" /> Rejected</Badge>;\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold flex items-center gap-2\">\n            <UserPlus className=\"h-8 w-8\" />\n            Staff Registrations\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Review and manage pending staff registration applications\n          </p>\n        </div>\n        <Button onClick={() => refetch()} variant=\"outline\">\n          <RefreshCw className=\"h-4 w-4 mr-2\" />\n          Refresh\n        </Button>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">Pending</p>\n                <p className=\"text-3xl font-bold text-yellow-600\">{pendingCount}</p>\n              </div>\n              <Clock className=\"h-8 w-8 text-yellow-600\" />\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">Approved</p>\n                <p className=\"text-3xl font-bold text-green-600\">{approvedCount}</p>\n              </div>\n              <CheckCircle2 className=\"h-8 w-8 text-green-600\" />\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">Rejected</p>\n                <p className=\"text-3xl font-bold text-red-600\">{rejectedCount}</p>\n              </div>\n              <XCircle className=\"h-8 w-8 text-red-600\" />\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <Tabs value={activeTab} onValueChange={setActiveTab}>\n            <TabsList>\n              <TabsTrigger value=\"pending\">\n                Pending ({pendingCount})\n              </TabsTrigger>\n              <TabsTrigger value=\"approved\">\n                Approved ({approvedCount})\n              </TabsTrigger>\n              <TabsTrigger value=\"rejected\">\n                Rejected ({rejectedCount})\n              </TabsTrigger>\n            </TabsList>\n          </Tabs>\n        </CardHeader>\n        <CardContent>\n          {filteredRegistrations.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              <UserPlus className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n              <p>No {activeTab} registrations found</p>\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              {filteredRegistrations.map((registration) => (\n                <Card key={registration.id} className=\"hover:bg-muted/50 transition-colors\">\n                  <CardContent className=\"pt-4\">\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center gap-3\">\n                          <h3 className=\"font-semibold text-lg\">\n                            {registration.firstName} {registration.lastName}\n                          </h3>\n                          {getStatusBadge(registration.status)}\n                        </div>\n                        <div className=\"flex flex-wrap gap-4 text-sm text-muted-foreground\">\n                          <span className=\"flex items-center gap-1\">\n                            <Mail className=\"h-4 w-4\" />\n                            {registration.email}\n                          </span>\n                          <span className=\"flex items-center gap-1\">\n                            <Phone className=\"h-4 w-4\" />\n                            {registration.phone}\n                          </span>\n                          <span className=\"flex items-center gap-1\">\n                            <Building className=\"h-4 w-4\" />\n                            {registration.department?.name || \"Unknown\"}\n                          </span>\n                        </div>\n                        <p className=\"text-xs text-muted-foreground\">\n                          Applied: {format(new Date(registration.createdAt), \"PPP 'at' p\")}\n                        </p>\n                        \n                        {registration.status === \"pending\" && registration.latestOtp && (\n                          <div className=\"flex items-center gap-2 mt-2 p-2 bg-muted rounded-md\">\n                            <KeyRound className=\"h-4 w-4 text-primary\" />\n                            <span className=\"font-mono font-semibold\">{registration.latestOtp.code}</span>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\"\n                              onClick={() => copyOtp(registration.latestOtp!.code)}\n                            >\n                              {copiedOtp ? <Check className=\"h-4 w-4\" /> : <Copy className=\"h-4 w-4\" />}\n                            </Button>\n                            <span className=\"text-xs text-muted-foreground\">\n                              Expires: {format(new Date(registration.latestOtp.expiresAt), \"PPp\")}\n                            </span>\n                          </div>\n                        )}\n                        \n                        {registration.status === \"rejected\" && registration.rejectionReason && (\n                          <p className=\"text-sm text-red-600 mt-2\">\n                            Reason: {registration.rejectionReason}\n                          </p>\n                        )}\n                      </div>\n                      \n                      <div className=\"flex gap-2\">\n                        <Button \n                          variant=\"outline\" \n                          size=\"sm\"\n                          onClick={() => {\n                            setSelectedRegistration(registration);\n                            setShowDetails(true);\n                          }}\n                        >\n                          <Eye className=\"h-4 w-4 mr-1\" />\n                          View\n                        </Button>\n                        \n                        {registration.status === \"pending\" && (\n                          <>\n                            <Button \n                              variant=\"outline\" \n                              size=\"sm\"\n                              onClick={() => generateOtpMutation.mutate(registration.id)}\n                              disabled={generateOtpMutation.isPending}\n                            >\n                              <RefreshCw className={`h-4 w-4 mr-1 ${generateOtpMutation.isPending ? 'animate-spin' : ''}`} />\n                              New OTP\n                            </Button>\n                            <Button \n                              size=\"sm\"\n                              onClick={() => {\n                                setSelectedRegistration(registration);\n                                setShowApproveDialog(true);\n                              }}\n                            >\n                              <CheckCircle2 className=\"h-4 w-4 mr-1\" />\n                              Approve\n                            </Button>\n                            <Button \n                              variant=\"destructive\"\n                              size=\"sm\"\n                              onClick={() => {\n                                setSelectedRegistration(registration);\n                                setShowRejectDialog(true);\n                              }}\n                            >\n                              <XCircle className=\"h-4 w-4 mr-1\" />\n                              Reject\n                            </Button>\n                          </>\n                        )}\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Sheet open={showDetails} onOpenChange={setShowDetails}>\n        <SheetContent className=\"overflow-y-auto sm:max-w-lg\">\n          {selectedRegistration && (\n            <>\n              <SheetHeader>\n                <SheetTitle>\n                  {selectedRegistration.firstName} {selectedRegistration.lastName}\n                </SheetTitle>\n                <SheetDescription>\n                  Registration details and personal information\n                </SheetDescription>\n              </SheetHeader>\n              \n              <div className=\"mt-6 space-y-6\">\n                <div className=\"space-y-4\">\n                  <h3 className=\"font-semibold flex items-center gap-2\">\n                    <Users className=\"h-4 w-4\" />\n                    Personal Information\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                    <div>\n                      <Label className=\"text-muted-foreground\">Email</Label>\n                      <p>{selectedRegistration.email}</p>\n                    </div>\n                    <div>\n                      <Label className=\"text-muted-foreground\">Phone</Label>\n                      <p>{selectedRegistration.phone}</p>\n                    </div>\n                    <div>\n                      <Label className=\"text-muted-foreground\">Department</Label>\n                      <p>{selectedRegistration.department?.name || \"Unknown\"}</p>\n                    </div>\n                    <div>\n                      <Label className=\"text-muted-foreground\">Status</Label>\n                      <div className=\"mt-1\">{getStatusBadge(selectedRegistration.status)}</div>\n                    </div>\n                  </div>\n                </div>\n\n                <div className=\"space-y-4\">\n                  <h3 className=\"font-semibold flex items-center gap-2\">\n                    <MapPin className=\"h-4 w-4\" />\n                    Residential Address\n                  </h3>\n                  <div className=\"text-sm space-y-1\">\n                    <p>{selectedRegistration.addressLine1}</p>\n                    {selectedRegistration.addressLine2 && <p>{selectedRegistration.addressLine2}</p>}\n                    <p>{selectedRegistration.city}, {selectedRegistration.state} {selectedRegistration.postalCode}</p>\n                    <p>{selectedRegistration.country}</p>\n                  </div>\n                </div>\n\n                <div className=\"space-y-4\">\n                  <h3 className=\"font-semibold flex items-center gap-2\">\n                    <Users className=\"h-4 w-4\" />\n                    Next of Kin (Primary)\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                    <div>\n                      <Label className=\"text-muted-foreground\">Name</Label>\n                      <p>{selectedRegistration.nextOfKin1Name}</p>\n                    </div>\n                    <div>\n                      <Label className=\"text-muted-foreground\">Relationship</Label>\n                      <p>{selectedRegistration.nextOfKin1Relationship}</p>\n                    </div>\n                    <div>\n                      <Label className=\"text-muted-foreground\">Phone</Label>\n                      <p>{selectedRegistration.nextOfKin1Phone}</p>\n                    </div>\n                    {selectedRegistration.nextOfKin1Email && (\n                      <div>\n                        <Label className=\"text-muted-foreground\">Email</Label>\n                        <p>{selectedRegistration.nextOfKin1Email}</p>\n                      </div>\n                    )}\n                  </div>\n                  {selectedRegistration.nextOfKin1Address && (\n                    <div className=\"text-sm\">\n                      <Label className=\"text-muted-foreground\">Address</Label>\n                      <p>{selectedRegistration.nextOfKin1Address}</p>\n                    </div>\n                  )}\n                </div>\n\n                <div className=\"space-y-4\">\n                  <h3 className=\"font-semibold flex items-center gap-2\">\n                    <Users className=\"h-4 w-4\" />\n                    Next of Kin (Secondary)\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                    <div>\n                      <Label className=\"text-muted-foreground\">Name</Label>\n                      <p>{selectedRegistration.nextOfKin2Name}</p>\n                    </div>\n                    <div>\n                      <Label className=\"text-muted-foreground\">Relationship</Label>\n                      <p>{selectedRegistration.nextOfKin2Relationship}</p>\n                    </div>\n                    <div>\n                      <Label className=\"text-muted-foreground\">Phone</Label>\n                      <p>{selectedRegistration.nextOfKin2Phone}</p>\n                    </div>\n                    {selectedRegistration.nextOfKin2Email && (\n                      <div>\n                        <Label className=\"text-muted-foreground\">Email</Label>\n                        <p>{selectedRegistration.nextOfKin2Email}</p>\n                      </div>\n                    )}\n                  </div>\n                  {selectedRegistration.nextOfKin2Address && (\n                    <div className=\"text-sm\">\n                      <Label className=\"text-muted-foreground\">Address</Label>\n                      <p>{selectedRegistration.nextOfKin2Address}</p>\n                    </div>\n                  )}\n                </div>\n\n                <div className=\"text-xs text-muted-foreground\">\n                  Applied on: {format(new Date(selectedRegistration.createdAt), \"PPP 'at' p\")}\n                </div>\n              </div>\n            </>\n          )}\n        </SheetContent>\n      </Sheet>\n\n      <Dialog open={showApproveDialog} onOpenChange={setShowApproveDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Approve Registration</DialogTitle>\n            <DialogDescription>\n              Approve {selectedRegistration?.firstName} {selectedRegistration?.lastName}'s registration and assign a role.\n            </DialogDescription>\n          </DialogHeader>\n          \n          {error && (\n            <Alert variant=\"destructive\">\n              <AlertCircle className=\"h-4 w-4\" />\n              <AlertDescription>{error}</AlertDescription>\n            </Alert>\n          )}\n\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"otp\">Approval OTP *</Label>\n              <Input\n                id=\"otp\"\n                placeholder=\"Enter the 6-digit OTP\"\n                value={otpInput}\n                onChange={(e) => setOtpInput(e.target.value)}\n                maxLength={6}\n              />\n              {selectedRegistration?.latestOtp && (\n                <p className=\"text-xs text-muted-foreground\">\n                  Current OTP: <span className=\"font-mono font-semibold\">{selectedRegistration.latestOtp.code}</span>\n                </p>\n              )}\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"role\">Role *</Label>\n              <Select value={selectedRoleId} onValueChange={setSelectedRoleId}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"Select a role\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {roles.map((role) => (\n                    <SelectItem key={role.id} value={role.id}>\n                      {role.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"employeeId\">Employee ID (Optional)</Label>\n              <Input\n                id=\"employeeId\"\n                placeholder=\"e.g., EMP001\"\n                value={employeeId}\n                onChange={(e) => setEmployeeId(e.target.value)}\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowApproveDialog(false)}>\n              Cancel\n            </Button>\n            <Button \n              onClick={() => {\n                if (selectedRegistration && otpInput) {\n                  approveMutation.mutate({\n                    id: selectedRegistration.id,\n                    otpCode: otpInput,\n                    roleId: selectedRoleId || undefined,\n                    employeeId: employeeId || undefined,\n                  });\n                }\n              }}\n              disabled={approveMutation.isPending || !otpInput}\n            >\n              {approveMutation.isPending ? (\n                <><Loader2 className=\"h-4 w-4 mr-2 animate-spin\" /> Approving...</>\n              ) : (\n                <><CheckCircle2 className=\"h-4 w-4 mr-2\" /> Approve</>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showRejectDialog} onOpenChange={setShowRejectDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Reject Registration</DialogTitle>\n            <DialogDescription>\n              Reject {selectedRegistration?.firstName} {selectedRegistration?.lastName}'s registration application.\n            </DialogDescription>\n          </DialogHeader>\n          \n          {error && (\n            <Alert variant=\"destructive\">\n              <AlertCircle className=\"h-4 w-4\" />\n              <AlertDescription>{error}</AlertDescription>\n            </Alert>\n          )}\n\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"reason\">Reason for Rejection</Label>\n              <Textarea\n                id=\"reason\"\n                placeholder=\"Provide a reason for rejection (optional)\"\n                value={rejectionReason}\n                onChange={(e) => setRejectionReason(e.target.value)}\n                rows={3}\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowRejectDialog(false)}>\n              Cancel\n            </Button>\n            <Button \n              variant=\"destructive\"\n              onClick={() => {\n                if (selectedRegistration) {\n                  rejectMutation.mutate({\n                    id: selectedRegistration.id,\n                    reason: rejectionReason,\n                  });\n                }\n              }}\n              disabled={rejectMutation.isPending}\n            >\n              {rejectMutation.isPending ? (\n                <><Loader2 className=\"h-4 w-4 mr-2 animate-spin\" /> Rejecting...</>\n              ) : (\n                <><XCircle className=\"h-4 w-4 mr-2\" /> Reject</>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":25882,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n  --opaque-button-border-intensity: -8;\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n  --background: 220 15% 98%;\n  --foreground: 220 15% 12%;\n  --border: 220 15% 92%;\n  --card: 220 15% 97%;\n  --card-foreground: 220 15% 12%;\n  --card-border: 220 15% 94%;\n  --sidebar: 220 15% 95%;\n  --sidebar-foreground: 220 15% 12%;\n  --sidebar-border: 220 15% 91%;\n  --sidebar-primary: 217 91% 45%;\n  --sidebar-primary-foreground: 217 91% 98%;\n  --sidebar-accent: 220 15% 88%;\n  --sidebar-accent-foreground: 220 15% 12%;\n  --sidebar-ring: 217 91% 45%;\n  --popover: 220 15% 94%;\n  --popover-foreground: 220 15% 12%;\n  --popover-border: 220 15% 90%;\n  --primary: 217 91% 45%;\n  --primary-foreground: 217 91% 98%;\n  --secondary: 220 15% 90%;\n  --secondary-foreground: 220 15% 12%;\n  --muted: 220 12% 93%;\n  --muted-foreground: 220 12% 35%;\n  --accent: 220 12% 91%;\n  --accent-foreground: 220 12% 12%;\n  --destructive: 0 84% 42%;\n  --destructive-foreground: 0 84% 98%;\n  --input: 220 15% 75%;\n  --ring: 217 91% 45%;\n  --chart-1: 217 91% 35%;\n  --chart-2: 142 76% 30%;\n  --chart-3: 280 65% 38%;\n  --chart-4: 35 91% 40%;\n  --chart-5: 340 82% 38%;\n  --font-sans: Inter, system-ui, -apple-system, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n  --radius: .5rem;\n  --shadow-2xs: 0px 2px 0px 0px hsl(220 15% 12% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(220 15% 12% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(220 15% 12% / 0.00), 0px 1px 2px -1px hsl(220 15% 12% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(220 15% 12% / 0.00), 0px 1px 2px -1px hsl(220 15% 12% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(220 15% 12% / 0.00), 0px 2px 4px -1px hsl(220 15% 12% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(220 15% 12% / 0.00), 0px 4px 6px -1px hsl(220 15% 12% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(220 15% 12% / 0.00), 0px 8px 10px -1px hsl(220 15% 12% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(220 15% 12% / 0.00);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 220 15% 8%;\n  --foreground: 220 15% 95%;\n  --border: 220 15% 16%;\n  --card: 220 15% 10%;\n  --card-foreground: 220 15% 95%;\n  --card-border: 220 15% 13%;\n  --sidebar: 220 15% 12%;\n  --sidebar-foreground: 220 15% 95%;\n  --sidebar-border: 220 15% 16%;\n  --sidebar-primary: 217 91% 55%;\n  --sidebar-primary-foreground: 217 91% 98%;\n  --sidebar-accent: 220 15% 18%;\n  --sidebar-accent-foreground: 220 15% 95%;\n  --sidebar-ring: 217 91% 55%;\n  --popover: 220 15% 14%;\n  --popover-foreground: 220 15% 95%;\n  --popover-border: 220 15% 18%;\n  --primary: 217 91% 45%;\n  --primary-foreground: 217 91% 98%;\n  --secondary: 220 15% 20%;\n  --secondary-foreground: 220 15% 95%;\n  --muted: 220 12% 18%;\n  --muted-foreground: 220 12% 70%;\n  --accent: 220 12% 16%;\n  --accent-foreground: 220 12% 95%;\n  --destructive: 0 84% 35%;\n  --destructive-foreground: 0 84% 98%;\n  --input: 220 15% 30%;\n  --ring: 217 91% 55%;\n  --chart-1: 217 91% 70%;\n  --chart-2: 142 76% 65%;\n  --chart-3: 280 65% 70%;\n  --chart-4: 35 91% 68%;\n  --chart-5: 340 82% 68%;\n  --shadow-2xs: 0px 2px 0px 0px hsl(220 15% 95% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(220 15% 95% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(220 15% 95% / 0.00), 0px 1px 2px -1px hsl(220 15% 95% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(220 15% 95% / 0.00), 0px 1px 2px -1px hsl(220 15% 95% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(220 15% 95% / 0.00), 0px 2px 4px -1px hsl(220 15% 95% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(220 15% 95% / 0.00), 0px 4px 6px -1px hsl(220 15% 95% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(220 15% 95% / 0.00), 0px 8px 10px -1px hsl(220 15% 95% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(220 15% 95% / 0.00);\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}\n","path":null,"size_bytes":10798,"size_tokens":null},"vps-deploy.sh":{"content":"#!/bin/bash\n\n# AdminHub Automated Deployment Script for VPS\n# This script handles the complete deployment process\n\nset -e\n\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nNC='\\033[0m' # No Color\n\nlog_info() {\n    echo -e \"${BLUE}ℹ️  $1${NC}\"\n}\n\nlog_success() {\n    echo -e \"${GREEN}✅ $1${NC}\"\n}\n\nlog_warn() {\n    echo -e \"${YELLOW}⚠️  $1${NC}\"\n}\n\nlog_error() {\n    echo -e \"${RED}❌ $1${NC}\"\n}\n\n# Header\necho -e \"${BLUE}\"\necho \"================================\"\necho \"AdminHub Docker Deployment\"\necho \"================================\"\necho -e \"${NC}\"\necho \"\"\n\n# Step 1: Check Docker installation\nlog_info \"Step 1: Checking Docker installation...\"\nif ! command -v docker &> /dev/null; then\n    log_warn \"Docker not found. Installing Docker...\"\n    curl -fsSL https://get.docker.com -o get-docker.sh\n    sudo sh get-docker.sh\n    rm get-docker.sh\n    sudo usermod -aG docker $USER\n    log_success \"Docker installed\"\nelse\n    log_success \"Docker is installed: $(docker --version)\"\nfi\n\n# Step 2: Check Docker Compose installation\nlog_info \"Step 2: Checking Docker Compose installation...\"\nif ! command -v docker-compose &> /dev/null; then\n    log_warn \"Docker Compose not found. Installing...\"\n    sudo curl -L \"https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose\n    sudo chmod +x /usr/local/bin/docker-compose\n    log_success \"Docker Compose installed\"\nelse\n    log_success \"Docker Compose is installed: $(docker-compose --version)\"\nfi\n\n# Step 3: Verify configuration files\nlog_info \"Step 3: Verifying configuration files...\"\nif [ ! -f \"docker-compose.yml\" ]; then\n    log_error \"docker-compose.yml not found\"\n    exit 1\nfi\nif [ ! -f \".env.production\" ]; then\n    log_error \".env.production not found\"\n    exit 1\nfi\nlog_success \"All configuration files present\"\n\n# Load env vars from .env.production so docker-compose picks up SESSION_COOKIE_* and CORS settings\nlog_info \"Loading environment variables from .env.production\"\nset -a\n. ./.env.production\nset +a\n\n# Step 4: Create necessary directories\nlog_info \"Step 4: Setting up directories...\"\nmkdir -p logs\nmkdir -p migrations\nlog_success \"Directories ready\"\n\n# Step 5: Stop existing containers (if any)\nlog_info \"Step 5: Cleaning up existing containers...\"\ndocker-compose down 2>/dev/null || true\nlog_success \"Cleanup complete\"\n\n# Step 6: Build Docker images\nlog_info \"Step 6: Building Docker images...\"\ndocker-compose build --no-cache\nlog_success \"Images built successfully\"\n\n# Step 7: Start containers\nlog_info \"Step 7: Starting containers...\"\ndocker-compose up -d\nlog_success \"Containers started\"\n\n# Step 8: Wait for services\nlog_info \"Step 8: Waiting for services to be healthy...\"\nsleep 15\n\n# Step 9: Run migrations\nlog_info \"Step 9: Running database migrations...\"\nif docker exec adminhub-app npx drizzle-kit migrate --config drizzle.config.ts; then\n    log_success \"Migrations completed\"\nelse\n    log_warn \"Migrations step completed (may have been skipped if already applied)\"\nfi\n\n# Step 10: Seed database\nlog_info \"Step 10: Seeding database...\"\nif docker exec adminhub-app npx tsx server/seed.ts; then\n    log_success \"Database seeded\"\nelse\n    log_warn \"Database seeding completed (may have been skipped if already seeded)\"\nfi\n\n# Step 11: Verify deployment\nlog_info \"Step 11: Verifying deployment...\"\necho \"\"\necho -e \"${BLUE}Container Status:${NC}\"\ndocker-compose ps\necho \"\"\n\n# Get exposed port\nEXTERNAL_PORT=$(grep \"EXTERNAL_PORT\" .env.production | cut -d '=' -f2)\nVPS_IP=$(hostname -I | awk '{print $1}')\n\nlog_success \"Deployment completed!\"\necho \"\"\necho -e \"${GREEN}═════════════════════════════════════════${NC}\"\necho -e \"${GREEN}Application is ready!${NC}\"\necho -e \"${GREEN}═════════════════════════════════════════${NC}\"\necho \"\"\necho -e \"Access URL: ${YELLOW}http://${VPS_IP}:${EXTERNAL_PORT}${NC}\"\necho \"\"\necho -e \"Default credentials:\"\necho -e \"  Email:    ${YELLOW}admin@company.com${NC}\"\necho -e \"  Password: ${YELLOW}admin123${NC}\"\necho \"\"\necho -e \"${RED}⚠️  IMPORTANT: Change the admin password immediately after first login!${NC}\"\necho \"\"\necho \"Useful Docker commands:\"\necho \"  View logs:        docker-compose logs -f app\"\necho \"  View DB logs:     docker-compose logs -f postgres\"\necho \"  Stop containers:  docker-compose down\"\necho \"  Restart app:      docker-compose restart app\"\necho \"  Restart DB:       docker-compose restart postgres\"\necho \"\"\n","path":null,"size_bytes":4608,"size_tokens":null},"client/src/pages/dashboard.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useState } from \"react\";\nimport { \n  Users, \n  Activity, \n  CheckCircle2, \n  AlertCircle, \n  RefreshCw, \n  Database, \n  MessageSquare, \n  FormInput, \n  Mail,\n  ClipboardList,\n  Clock,\n  Building2,\n  UserCheck,\n  BarChart3,\n  ArrowRight,\n  ChevronDown\n} from \"lucide-react\";\nimport PlatformBadge from \"@/components/platform-badge\";\nimport type { ServiceConfig, ActivityLog, Task, TeamMember, Department } from \"@shared/schema\";\n\nfunction TechnicianDashboard() {\n  const { teamMember } = useAuth();\n  const [platformsOpen, setPlatformsOpen] = useState(true);\n\n  // Fetch managed user record for the logged-in team member\n  const { data: myManagedUser } = useQuery<any | null>({\n    queryKey: [\"/api/team-members\", teamMember?.id, \"managed-user\"],\n    queryFn: async () => {\n      if (!teamMember) return null;\n      return await fetch(`/api/team-members/${teamMember.id}/managed-user`).then((r) => r.json());\n    },\n    enabled: !!teamMember?.id,\n  });\n\n  const { data: services = [] } = useQuery<any[]>({\n    queryKey: [\"/api/services\"],\n  });\n\n  const platformIcons: any = {\n    metabase: Database,\n    chatwoot: MessageSquare,\n    typebot: FormInput,\n    mailcow: Mail,\n  };\n\n  const { data: myTasks = [], isLoading: tasksLoading } = useQuery<Task[]>({\n    queryKey: [\"/api/tasks\"],\n  });\n\n  const assignedToMe = myTasks.filter(t => t.assignedToId === teamMember?.id);\n  const pendingTasks = assignedToMe.filter(t => t.status === 'pending' || t.status === 'in_progress');\n  const completedTasks = assignedToMe.filter(t => t.status === 'completed');\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold text-foreground\">\n          Welcome, {teamMember?.firstName}\n        </h1>\n        <p className=\"text-muted-foreground mt-1\">\n          {teamMember?.departmentName} Department - Technician Dashboard\n        </p>\n      </div>\n\n      {/* My Platforms - show assigned platforms and quick access links */}\n      <Card>\n        <CardHeader \n          className=\"cursor-pointer flex flex-row items-center justify-between\"\n          onClick={() => setPlatformsOpen(!platformsOpen)}\n        >\n          <div>\n            <CardTitle>My Platforms</CardTitle>\n            <CardDescription>Quick access to the platforms assigned to you</CardDescription>\n          </div>\n          <ChevronDown className={`h-5 w-5 transition-transform ${platformsOpen ? \"rotate-180\" : \"\"}`} />\n        </CardHeader>\n        \n        {platformsOpen && (\n          <CardContent className=\"pt-0\">\n            {myManagedUser && Array.isArray(myManagedUser.platforms) && myManagedUser.platforms.length > 0 ? (\n              <div className=\"space-y-3\">\n                {myManagedUser.platforms.map((p: string) => {\n                  const svc = services.find((s: any) => s.serviceName === p);\n                  const platformUserId = myManagedUser.platformUserIds ? myManagedUser.platformUserIds[p] : undefined;\n                  const accent = p === \"metabase\" ? \"bg-purple-600\" : p === \"chatwoot\" ? \"bg-green-600\" : p === \"typebot\" ? \"bg-indigo-600\" : \"bg-amber-500\";\n                  return (\n                    <div key={p} className=\"flex items-center justify-between p-4 rounded-lg border border-border hover:shadow-md transition-shadow\">\n                      <div className=\"flex items-center gap-4\">\n                        <div className={`${accent} w-1 h-12 rounded`} />\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center gap-2 mb-1\">\n                            <PlatformBadge platform={p} />\n                            {platformUserId && <span className=\"text-xs text-muted-foreground\">ID: {platformUserId}</span>}\n                          </div>\n                          <p className=\"text-xs text-muted-foreground\">{svc ? svc.apiUrl : \"Not configured\"}</p>\n                        </div>\n                      </div>\n                      <div className=\"flex gap-2 ml-4\">\n                        {svc && (\n                          <>\n                            <Button\n                              size=\"sm\"\n                              onClick={() => {\n                                window.location.href = svc.apiUrl;\n                              }}\n                            >\n                              Open\n                            </Button>\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => {\n                                if (!svc) return;\n                                const ssoUrl = platformUserId ? `${svc.apiUrl}?user_id=${encodeURIComponent(platformUserId)}` : svc.apiUrl;\n                                window.location.href = ssoUrl;\n                              }}\n                            >\n                              SSO\n                            </Button>\n                          </>\n                        )}\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <p>You don't have access to any platforms yet.</p>\n              </div>\n            )}\n          </CardContent>\n        )}\n      </Card>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        <div className=\"flex group rounded-md overflow-hidden\">\n          <div className=\"bg-blue-600 w-1\" />\n          <Card className=\"flex-1 transition-shadow group-hover:shadow-lg\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Assigned Tasks</CardTitle>\n            <ClipboardList className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-assigned-tasks\">\n              {assignedToMe.length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Total assigned to you\n            </p>\n          </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"flex group rounded-md overflow-hidden\">\n          <div className=\"bg-amber-500 w-1\" />\n          <Card className=\"flex-1 transition-shadow group-hover:shadow-lg\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">In Progress</CardTitle>\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-pending-tasks\">\n              {pendingTasks.length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Pending completion\n            </p>\n          </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"flex group rounded-md overflow-hidden\">\n          <div className=\"bg-green-600 w-1\" />\n          <Card className=\"flex-1 transition-shadow group-hover:shadow-lg\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Completed</CardTitle>\n            <CheckCircle2 className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-completed-tasks\">\n              {completedTasks.length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Tasks finished\n            </p>\n          </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n          <div>\n            <CardTitle>My Tasks</CardTitle>\n            <CardDescription>Tasks assigned to you</CardDescription>\n          </div>\n          <Link href=\"/tasks\">\n            <Button variant=\"outline\" size=\"sm\">\n              View All <ArrowRight className=\"ml-2 h-4 w-4\" />\n            </Button>\n          </Link>\n        </CardHeader>\n        <CardContent>\n          {tasksLoading ? (\n            <div className=\"space-y-3\">\n              {[1, 2, 3].map((i) => (\n                <Skeleton key={i} className=\"h-16 w-full\" />\n              ))}\n            </div>\n          ) : pendingTasks.length > 0 ? (\n            <div className=\"space-y-3\">\n              {pendingTasks.slice(0, 5).map((task) => (\n                <div\n                  key={task.id}\n                  className=\"flex items-center justify-between p-3 rounded-md border border-border\"\n                  data-testid={`task-${task.id}`}\n                >\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"font-medium truncate\">{task.title}</p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      Priority: {task.priority} | Due: {task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date'}\n                    </p>\n                  </div>\n                  <Badge variant={task.status === 'in_progress' ? 'default' : 'secondary'}>\n                    {task.status.replace('_', ' ')}\n                  </Badge>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <CheckCircle2 className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n              <p>No pending tasks</p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction DepartmentAdminDashboard() {\n  const { teamMember } = useAuth();\n\n  const { data: tasks = [], isLoading: tasksLoading } = useQuery<Task[]>({\n    queryKey: [\"/api/tasks\"],\n  });\n\n  const { data: teamMembers = [] } = useQuery<TeamMember[]>({\n    queryKey: [\"/api/team-members\"],\n  });\n\n  const deptTasks = tasks.filter(t => t.departmentId === teamMember?.departmentId);\n  const deptMembers = teamMembers.filter(m => m.departmentId === teamMember?.departmentId);\n  const activeTechnicians = deptMembers.filter(m => m.role === 'technician' && m.status === 'active');\n  const pendingTasks = deptTasks.filter(t => t.status === 'pending' || t.status === 'in_progress');\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold text-foreground\">\n          {teamMember?.departmentName} Dashboard\n        </h1>\n        <p className=\"text-muted-foreground mt-1\">\n          Department overview and management\n        </p>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Team Members</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-team-members\">\n              {deptMembers.length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              In your department\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Active Technicians</CardTitle>\n            <UserCheck className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-active-technicians\">\n              {activeTechnicians.length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Available for tasks\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Department Tasks</CardTitle>\n            <ClipboardList className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-dept-tasks\">\n              {deptTasks.length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Total tasks\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Pending Tasks</CardTitle>\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-pending-dept-tasks\">\n              {pendingTasks.length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Need attention\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n            <div>\n              <CardTitle>Team Members</CardTitle>\n              <CardDescription>Your department team</CardDescription>\n            </div>\n            <Link href=\"/team\">\n              <Button variant=\"outline\" size=\"sm\">\n                Manage <ArrowRight className=\"ml-2 h-4 w-4\" />\n              </Button>\n            </Link>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              {deptMembers.slice(0, 5).map((member) => (\n                <div\n                  key={member.id}\n                  className=\"flex items-center justify-between p-3 rounded-md border border-border\"\n                  data-testid={`member-${member.id}`}\n                >\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"font-medium\">{member.firstName} {member.lastName}</p>\n                    <p className=\"text-xs text-muted-foreground capitalize\">{member.role}</p>\n                  </div>\n                  <Badge variant={member.status === 'active' ? 'default' : 'secondary'}>\n                    {member.status}\n                  </Badge>\n                </div>\n              ))}\n              {deptMembers.length === 0 && (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Users className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                  <p>No team members</p>\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n            <div>\n              <CardTitle>Recent Tasks</CardTitle>\n              <CardDescription>Department task activity</CardDescription>\n            </div>\n            <Link href=\"/tasks\">\n              <Button variant=\"outline\" size=\"sm\">\n                View All <ArrowRight className=\"ml-2 h-4 w-4\" />\n              </Button>\n            </Link>\n          </CardHeader>\n          <CardContent>\n            {tasksLoading ? (\n              <div className=\"space-y-3\">\n                {[1, 2, 3].map((i) => (\n                  <Skeleton key={i} className=\"h-16 w-full\" />\n                ))}\n              </div>\n            ) : deptTasks.length > 0 ? (\n              <div className=\"space-y-3\">\n                {deptTasks.slice(0, 5).map((task) => (\n                  <div\n                    key={task.id}\n                    className=\"flex items-center justify-between p-3 rounded-md border border-border\"\n                    data-testid={`task-${task.id}`}\n                  >\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"font-medium truncate\">{task.title}</p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        Priority: {task.priority}\n                      </p>\n                    </div>\n                    <Badge variant={task.status === 'completed' ? 'default' : 'secondary'}>\n                      {task.status.replace('_', ' ')}\n                    </Badge>\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <ClipboardList className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                <p>No tasks yet</p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n\nfunction ManagementDashboard() {\n  const { data: services, isLoading: servicesLoading } = useQuery<ServiceConfig[]>({\n    queryKey: [\"/api/services\"],\n  });\n\n  const { data: recentActivity, isLoading: activityLoading } = useQuery<ActivityLog[]>({\n    queryKey: [\"/api/activity/recent\"],\n  });\n\n  const { data: stats } = useQuery<{\n    totalUsers: number;\n    activeUsers: number;\n    totalActivities: number;\n    servicesEnabled: number;\n  }>({\n    queryKey: [\"/api/stats\"],\n  });\n\n  const { data: departments = [] } = useQuery<Department[]>({\n    queryKey: [\"/api/departments\"],\n  });\n\n  const { data: teamMembers = [] } = useQuery<TeamMember[]>({\n    queryKey: [\"/api/team-members\"],\n  });\n\n  const { data: tasks = [] } = useQuery<Task[]>({\n    queryKey: [\"/api/tasks\"],\n  });\n\n  const platformIcons = {\n    metabase: Database,\n    chatwoot: MessageSquare,\n    typebot: FormInput,\n    mailcow: Mail,\n  };\n\n  const activeDepts = departments.filter(d => d.status === 'active');\n  const totalTechnicians = teamMembers.filter(m => m.role === 'technician').length;\n  const pendingTasks = tasks.filter(t => t.status === 'pending' || t.status === 'in_progress');\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold text-foreground\">Global Dashboard</h1>\n        <p className=\"text-muted-foreground mt-1\">\n          Management overview across all departments\n        </p>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Departments</CardTitle>\n            <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-departments\">\n              {activeDepts.length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Active departments\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Team Members</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-team\">\n              {teamMembers.length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              {totalTechnicians} technicians\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Tasks</CardTitle>\n            <ClipboardList className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-tasks\">\n              {tasks.length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              {pendingTasks.length} pending\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Services Online</CardTitle>\n            <RefreshCw className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-services-online\">\n              {stats?.servicesEnabled ?? 0}/4\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Connected platforms\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n            <div>\n              <CardTitle>Departments</CardTitle>\n              <CardDescription>Organization structure</CardDescription>\n            </div>\n            <Link href=\"/departments\">\n              <Button variant=\"outline\" size=\"sm\">\n                Manage <ArrowRight className=\"ml-2 h-4 w-4\" />\n              </Button>\n            </Link>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              {departments.map((dept) => {\n                const deptMembers = teamMembers.filter(m => m.departmentId === dept.id);\n                const deptTasks = tasks.filter(t => t.departmentId === dept.id);\n                return (\n                  <div\n                    key={dept.id}\n                    className=\"p-3 rounded-md border border-border\"\n                    data-testid={`dept-${dept.id}`}\n                  >\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <p className=\"font-medium\">{dept.name}</p>\n                      <Badge variant=\"outline\">{dept.code}</Badge>\n                    </div>\n                    <div className=\"flex gap-4 text-xs text-muted-foreground\">\n                      <span>{deptMembers.length} members</span>\n                      <span>{deptTasks.length} tasks</span>\n                    </div>\n                  </div>\n                );\n              })}\n              {departments.length === 0 && (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Building2 className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                  <p>No departments</p>\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Service Status</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {servicesLoading ? (\n              <div className=\"space-y-3\">\n                {[1, 2, 3, 4].map((i) => (\n                  <Skeleton key={i} className=\"h-16 w-full\" />\n                ))}\n              </div>\n            ) : (\n              <div className=\"space-y-3\">\n                {services?.map((service) => {\n                  const Icon = platformIcons[service.serviceName as keyof typeof platformIcons] || Database;\n                  return (\n                    <div\n                      key={service.id}\n                      className=\"flex items-center justify-between p-3 rounded-md border border-border\"\n                      data-testid={`service-status-${service.serviceName}`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-muted\">\n                          <Icon className=\"h-5 w-5 text-muted-foreground\" />\n                        </div>\n                        <div>\n                          <p className=\"font-medium capitalize\">{service.serviceName}</p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            {service.lastSyncAt\n                              ? `Synced ${new Date(service.lastSyncAt).toLocaleString()}`\n                              : \"Never synced\"}\n                          </p>\n                        </div>\n                      </div>\n                      <Badge variant={service.enabled ? \"default\" : \"secondary\"}>\n                        {service.enabled ? \"Active\" : \"Inactive\"}\n                      </Badge>\n                    </div>\n                  );\n                })}\n                {(!services || services.length === 0) && (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <AlertCircle className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                    <p>No services configured</p>\n                    <Link href=\"/config\">\n                      <Button variant=\"ghost\" className=\"mt-2\">\n                        Configure Services\n                      </Button>\n                    </Link>\n                  </div>\n                )}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n            <div>\n              <CardTitle>Recent Activity</CardTitle>\n              <CardDescription>System-wide activity</CardDescription>\n            </div>\n            <Link href=\"/activity\">\n              <Button variant=\"outline\" size=\"sm\">\n                View All <ArrowRight className=\"ml-2 h-4 w-4\" />\n              </Button>\n            </Link>\n          </CardHeader>\n          <CardContent>\n            {activityLoading ? (\n              <div className=\"space-y-3\">\n                {[1, 2, 3, 4, 5].map((i) => (\n                  <Skeleton key={i} className=\"h-12 w-full\" />\n                ))}\n              </div>\n            ) : (\n              <div className=\"space-y-3\">\n                {recentActivity?.slice(0, 5).map((activity) => (\n                  <div\n                    key={activity.id}\n                    className=\"flex items-start gap-3 p-3 rounded-md border border-border\"\n                    data-testid={`activity-${activity.id}`}\n                  >\n                    <Activity className=\"h-4 w-4 text-muted-foreground mt-0.5\" />\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-sm font-medium truncate\">{activity.action}</p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        {activity.platform && <span className=\"capitalize\">{activity.platform}</span>}\n                        {activity.platform && \" | \"}\n                        {activity.createdAt && new Date(activity.createdAt).toLocaleTimeString()}\n                      </p>\n                    </div>\n                  </div>\n                ))}\n                {(!recentActivity || recentActivity.length === 0) && (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <Activity className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                    <p>No recent activity</p>\n                  </div>\n                )}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n\nexport default function Dashboard() {\n  const { isManagement, isDepartmentAdmin, isTechnician, isLoading, teamMember } = useAuth();\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <Skeleton className=\"h-10 w-64\" />\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          {[1, 2, 3, 4].map((i) => (\n            <Skeleton key={i} className=\"h-32 w-full\" />\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  if (!teamMember) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"text-center\">\n          <AlertCircle className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n          <h2 className=\"text-xl font-semibold\">Access Denied</h2>\n          <p className=\"text-muted-foreground mt-2\">\n            Your account is not linked to a team member profile.\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  if (isManagement) {\n    return <ManagementDashboard />;\n  }\n\n  if (isDepartmentAdmin) {\n    return <DepartmentAdminDashboard />;\n  }\n\n  if (isTechnician) {\n    return <TechnicianDashboard />;\n  }\n\n  return <TechnicianDashboard />;\n}\n","path":null,"size_bytes":28773,"size_tokens":null},"replit.md":{"content":"# Admin Hub\n\n## Overview\nAdmin Hub is a unified platform management application that provides centralized control over Metabase, Chatwoot, Typebot, and Mailcow. It allows managing users, monitoring analytics, and streamlining operations from one powerful dashboard.\n\n## Project Structure\n- `client/` - React frontend built with Vite\n- `server/` - Express.js backend API\n- `shared/` - Shared code and Drizzle ORM schema\n- `migrations/` - Database migration files\n\n## Tech Stack\n- **Frontend**: React 18, Vite, TailwindCSS, Radix UI, React Query\n- **Backend**: Express.js, TypeScript\n- **Database**: PostgreSQL with Drizzle ORM\n- **Build**: Vite for frontend, esbuild for backend\n\n## Development\n- Run `npm run dev` to start the development server\n- Frontend and backend are served together on port 5000\n- Database schema is in `shared/schema.ts`\n\n## Scripts\n- `npm run dev` - Start development server\n- `npm run build` - Build for production\n- `npm run start` - Run production server\n- `npm run db:push` - Push schema to database\n\n## Environment Variables\n- `DATABASE_URL` - PostgreSQL connection string (auto-provided by Replit)\n- `NODE_ENV` - development or production\n","path":null,"size_bytes":1170,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"server/run-migration.ts":{"content":"import pkg from 'pg';\nconst { Client } = pkg;\n\nconst connectionString = process.env.DATABASE_URL || 'postgresql://postgres:0109115188087@Kdn@postgres:5432/postgres';\n\nconst migrations = [\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"address_line_1\" varchar(255)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"address_line_2\" varchar(255)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"city\" varchar(100)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"state\" varchar(100)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"postal_code\" varchar(20)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"country\" varchar(100)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_1_name\" varchar(100)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_1_relationship\" varchar(50)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_1_phone\" varchar(20)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_1_email\" varchar`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_1_address\" text`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_2_name\" varchar(100)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_2_relationship\" varchar(50)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_2_phone\" varchar(20)`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_2_email\" varchar`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"next_of_kin_2_address\" text`,\n  `ALTER TABLE \"team_members\" ADD COLUMN IF NOT EXISTS \"is_verified\" boolean DEFAULT false NOT NULL`,\n];\n\nasync function runMigrations() {\n  const client = new Client({ connectionString });\n  try {\n    await client.connect();\n    console.log('✓ Connected to database');\n    \n    for (const migration of migrations) {\n      console.log(`Running: ${migration.substring(0, 70)}...`);\n      await client.query(migration);\n      console.log(`  ✓ Done`);\n    }\n    console.log('\\n✅ All migrations completed successfully!');\n    process.exit(0);\n  } catch (error) {\n    console.error('❌ Migration failed:', error);\n    process.exit(1);\n  } finally {\n    await client.end();\n  }\n}\n\nrunMigrations();\n","path":null,"size_bytes":2285,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"client/src/hooks/useAuth.ts":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport type { User, RoleType, PermissionType } from \"@shared/schema\";\nimport { PERMISSION_TYPES, ROLE_TYPES } from \"@shared/schema\";\n\nexport interface AuthenticatedTeamMember {\n  id: string;\n  userId: string | null;\n  departmentId: string;\n  roleId: string | null;\n  employeeId: string | null;\n  email: string;\n  firstName: string;\n  lastName: string;\n  role: string;\n  phone: string | null;\n  status: string;\n  lastLoginAt: Date | null;\n  createdAt: Date | null;\n  updatedAt: Date | null;\n  roleName?: string;\n  roleCode?: RoleType;\n  roleLevel?: number;\n  departmentCode?: string;\n  departmentName?: string;\n  permissions?: string[];\n}\n\nexport interface AuthUser extends User {\n  teamMember?: AuthenticatedTeamMember | null;\n}\n\nexport function useAuth() {\n  const { data, isLoading, error } = useQuery<AuthUser>({\n    queryKey: [\"/api/auth/user\"],\n    retry: false,\n  });\n\n  const user = data;\n  const teamMember = data?.teamMember;\n\n  const hasPermission = (permission: PermissionType): boolean => {\n    if (!teamMember?.permissions) return false;\n    return teamMember.permissions.includes(permission);\n  };\n\n  const hasAnyPermission = (permissions: PermissionType[]): boolean => {\n    if (!teamMember?.permissions) return false;\n    return permissions.some(p => teamMember.permissions?.includes(p));\n  };\n\n  const hasAllPermissions = (permissions: PermissionType[]): boolean => {\n    if (!teamMember?.permissions) return false;\n    return permissions.every(p => teamMember.permissions?.includes(p));\n  };\n\n  const isRole = (roleCode: RoleType): boolean => {\n    return teamMember?.roleCode === roleCode;\n  };\n\n  const isRoleOrHigher = (roleCode: RoleType): boolean => {\n    const roleLevels: Record<RoleType, number> = {\n      [ROLE_TYPES.TECHNICIAN]: 1,\n      [ROLE_TYPES.DEPARTMENT_ADMIN]: 2,\n      [ROLE_TYPES.MANAGEMENT]: 3,\n    };\n    \n    const requiredLevel = roleLevels[roleCode];\n    return (teamMember?.roleLevel ?? 0) >= requiredLevel;\n  };\n\n  const isManagement = isRole(ROLE_TYPES.MANAGEMENT);\n  const isDepartmentAdmin = isRole(ROLE_TYPES.DEPARTMENT_ADMIN);\n  const isTechnician = isRole(ROLE_TYPES.TECHNICIAN);\n\n  return {\n    user,\n    teamMember,\n    isLoading,\n    error,\n    isAuthenticated: !!user,\n    isTeamMember: !!teamMember,\n    hasPermission,\n    hasAnyPermission,\n    hasAllPermissions,\n    isRole,\n    isRoleOrHigher,\n    isManagement,\n    isDepartmentAdmin,\n    isTechnician,\n    PERMISSION_TYPES,\n    ROLE_TYPES,\n  };\n}\n","path":null,"size_bytes":2506,"size_tokens":null},"server/routes-teams.ts":{"content":"import { Express } from 'express';\nimport { isTeamMemberAuthenticated } from './auth';\nimport { requireRoleOrHigher } from './rbac';\nimport { ROLE_TYPES, insertTeamSchema } from '@shared/schema';\n\nexport default function registerTeamRoutes(app: Express, storage: any) {\n  \n  app.get('/api/teams', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const teams = await storage.getAllTeams();\n      res.json(teams);\n    } catch (error) {\n      console.error('Error fetching teams:', error);\n      res.status(500).json({ message: 'Failed to fetch teams' });\n    }\n  });\n\n  app.get('/api/teams/:id', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const team = await storage.getTeam(id);\n      if (!team) {\n        return res.status(404).json({ message: 'Team not found' });\n      }\n      res.json(team);\n    } catch (error) {\n      console.error('Error fetching team:', error);\n      res.status(500).json({ message: 'Failed to fetch team' });\n    }\n  });\n\n  app.post('/api/teams', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const validatedData = insertTeamSchema.parse(req.body);\n      const team = await storage.createTeam(validatedData);\n      \n      await storage.createActivityLog(\n        req.teamMember.id,\n        'created_team',\n        'team',\n        team.id,\n        undefined,\n        { teamName: team.name, teamCode: team.code }\n      );\n      \n      res.status(201).json(team);\n    } catch (error) {\n      console.error('Error creating team:', error);\n      res.status(400).json({ message: 'Failed to create team' });\n    }\n  });\n\n  app.patch('/api/teams/:id', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const validatedData = insertTeamSchema.partial().parse(req.body);\n      const team = await storage.updateTeam(id, validatedData);\n      \n      await storage.createActivityLog(\n        req.teamMember.id,\n        'updated_team',\n        'team',\n        id,\n        undefined,\n        { updates: validatedData }\n      );\n      \n      res.json(team);\n    } catch (error) {\n      console.error('Error updating team:', error);\n      res.status(400).json({ message: 'Failed to update team' });\n    }\n  });\n\n  app.delete('/api/teams/:id', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.MANAGEMENT), async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      await storage.deleteTeam(id);\n      \n      await storage.createActivityLog(\n        req.teamMember.id,\n        'deleted_team',\n        'team',\n        id\n      );\n      \n      res.json({ message: 'Team deleted' });\n    } catch (error) {\n      console.error('Error deleting team:', error);\n      res.status(400).json({ message: 'Failed to delete team' });\n    }\n  });\n\n  app.get('/api/teams/:id/members', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const members = await storage.getMembersInTeam(id);\n      const sanitized = members.map((m: any) => ({\n        id: m.id,\n        firstName: m.firstName,\n        lastName: m.lastName,\n        email: m.email,\n        departmentId: m.departmentId,\n        role: m.role,\n        status: m.status,\n      }));\n      res.json(sanitized);\n    } catch (error) {\n      console.error('Error fetching team members:', error);\n      res.status(500).json({ message: 'Failed to fetch team members' });\n    }\n  });\n\n  app.post('/api/teams/:teamId/members/:memberId', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.DEPARTMENT_ADMIN), async (req: any, res) => {\n    try {\n      const { teamId, memberId } = req.params;\n      const membership = await storage.addMemberToTeam(memberId, teamId, req.teamMember.id);\n      \n      await storage.createActivityLog(\n        req.teamMember.id,\n        'added_member_to_team',\n        'team_member_teams',\n        membership.id,\n        undefined,\n        { teamId, memberId }\n      );\n      \n      res.status(201).json(membership);\n    } catch (error) {\n      console.error('Error adding member to team:', error);\n      res.status(400).json({ message: 'Failed to add member to team' });\n    }\n  });\n\n  app.delete('/api/teams/:teamId/members/:memberId', isTeamMemberAuthenticated, requireRoleOrHigher(ROLE_TYPES.DEPARTMENT_ADMIN), async (req: any, res) => {\n    try {\n      const { teamId, memberId } = req.params;\n      await storage.removeMemberFromTeam(memberId, teamId);\n      \n      await storage.createActivityLog(\n        req.teamMember.id,\n        'removed_member_from_team',\n        'team_member_teams',\n        undefined,\n        undefined,\n        { teamId, memberId }\n      );\n      \n      res.json({ message: 'Member removed from team' });\n    } catch (error) {\n      console.error('Error removing member from team:', error);\n      res.status(400).json({ message: 'Failed to remove member from team' });\n    }\n  });\n\n  app.get('/api/my-teams', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const member = req.teamMember;\n      const memberTeams = await storage.getTeamsForMember(member.id);\n      res.json(memberTeams);\n    } catch (error) {\n      console.error('Error fetching user teams:', error);\n      res.status(500).json({ message: 'Failed to fetch your teams' });\n    }\n  });\n\n  app.get('/api/my-team-ids', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const member = req.teamMember;\n      const teamIds = await storage.getTeamIdsForMember(member.id);\n      res.json(teamIds);\n    } catch (error) {\n      console.error('Error fetching user team IDs:', error);\n      res.status(500).json({ message: 'Failed to fetch your team IDs' });\n    }\n  });\n\n  app.get('/api/team-members/:id/teams', isTeamMemberAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const memberTeams = await storage.getTeamsForMember(id);\n      res.json(memberTeams);\n    } catch (error) {\n      console.error('Error fetching member teams:', error);\n      res.status(500).json({ message: 'Failed to fetch member teams' });\n    }\n  });\n}\n","path":null,"size_bytes":6195,"size_tokens":null},"client/src/pages/team.tsx":{"content":"/**\n * @fileoverview Team management page\n * Copyright (c) 2025 DevPulse.Inc\n * Designed for MM ALL ELECTRONICS\n *\n * Description: UI for listing and managing team members.\n */\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Plus, Pencil, Trash2, UserPlus } from \"lucide-react\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport PlatformBadge from \"@/components/platform-badge\";\nimport type { TeamMember, Department, Role } from \"@shared/schema\";\n\nexport default function Team() {\n  const { toast } = useToast();\n  const { teamMember, isManagement, isDepartmentAdmin, hasPermission, PERMISSION_TYPES } = useAuth();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingMember, setEditingMember] = useState<TeamMember | null>(null);\n  const [filterDept, setFilterDept] = useState<string>(\"all\");\n  const [formData, setFormData] = useState({\n    departmentId: \"\",\n    roleId: \"\",\n    employeeId: \"\",\n    email: \"\",\n    firstName: \"\",\n    lastName: \"\",\n    role: \"technician\",\n    phone: \"\",\n    status: \"active\",\n    password: \"\",\n  });\n\n  const { data: departments = [] } = useQuery<Department[]>({\n    queryKey: [\"/api/departments\"],\n  });\n\n  const { data: roles = [] } = useQuery<Role[]>({\n    queryKey: [\"/api/roles\"],\n  });\n\n  const { data: managedUsers = [] } = useQuery<any[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const { data: allMembers = [], isLoading } = useQuery<TeamMember[]>({\n    queryKey: [\"/api/team-members\"],\n  });\n\n  const canManageUsers = hasPermission(PERMISSION_TYPES.MANAGE_GLOBAL_USERS) || hasPermission(PERMISSION_TYPES.MANAGE_DEPARTMENT_USERS);\n  const canManageAllDepts = hasPermission(PERMISSION_TYPES.MANAGE_GLOBAL_USERS);\n\n  const filteredMembers = (() => {\n    let result = allMembers;\n    \n    if (!isManagement && !canManageAllDepts && teamMember?.departmentId) {\n      result = result.filter(m => m.departmentId === teamMember.departmentId);\n    }\n    \n    if (filterDept !== \"all\") {\n      result = result.filter(m => m.departmentId === filterDept);\n    }\n    \n    return result;\n  })();\n\n  const members = filteredMembers;\n\n  const createMutation = useMutation({\n    mutationFn: (data: any) => apiRequest(\"/api/team-members\", \"POST\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/team-members\"] });\n      toast({ title: \"Team member created successfully\" });\n      closeDialog();\n    },\n    onError: (error: any) => {\n      const errorMsg = error?.response?.data?.error || error?.message || \"Failed to create team member\";\n      toast({ title: \"Failed to create team member\", description: errorMsg, variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) =>\n      apiRequest(`/api/team-members/${id}`, \"PATCH\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/team-members\"] });\n      toast({ title: \"Team member updated successfully\" });\n      closeDialog();\n    },\n    onError: () => {\n      toast({ title: \"Failed to update team member\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/team-members/${id}`, \"DELETE\"),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/team-members\"] });\n      toast({ title: \"Team member deleted successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete team member\", variant: \"destructive\" });\n    },\n  });\n\n  // Assign platforms to existing team member\n  const [isAssignOpen, setIsAssignOpen] = useState(false);\n  const [assigningMember, setAssigningMember] = useState<TeamMember | null>(null);\n  const [assignPlatforms, setAssignPlatforms] = useState<string[]>([]);\n  const [assignPlatformUserIds, setAssignPlatformUserIds] = useState<Record<string, string>>({});\n\n  const assignMutation = useMutation({\n    mutationFn: async ({ id, payload }: { id: string; payload: any }) => {\n      return await apiRequest(`/api/team-members/${id}/assign-platforms`, \"POST\", payload);\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/team-members\"] });\n      toast({ title: \"Platforms assigned\", description: \"Platform access updated for the team member.\" });\n      setIsAssignOpen(false);\n      setAssigningMember(null);\n      setAssignPlatforms([]);\n      setAssignPlatformUserIds({});\n    },\n    onError: (err: any) => {\n      const msg = err?.response?.data?.message || err?.message || \"Failed to assign platforms\";\n      toast({ title: \"Error\", description: msg, variant: \"destructive\" });\n    }\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (editingMember) {\n      updateMutation.mutate({ id: editingMember.id, data: formData });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  const openEditDialog = (member: TeamMember) => {\n    setEditingMember(member);\n    setFormData({\n      departmentId: member.departmentId,\n      roleId: member.roleId || \"\",\n      employeeId: member.employeeId || \"\",\n      email: member.email,\n      firstName: member.firstName,\n      lastName: member.lastName,\n      role: member.role,\n      phone: member.phone || \"\",\n      status: member.status,\n      password: \"\",\n    });\n    setIsDialogOpen(true);\n  };\n\n  const closeDialog = () => {\n    setIsDialogOpen(false);\n    setEditingMember(null);\n    setFormData({\n      departmentId: \"\",\n      roleId: \"\",\n      employeeId: \"\",\n      email: \"\",\n      firstName: \"\",\n      lastName: \"\",\n      role: \"technician\",\n      phone: \"\",\n      status: \"active\",\n      password: \"\",\n    });\n  };\n\n  const openAssignDialog = (member: TeamMember) => {\n    setAssigningMember(member);\n    const m = managedUsers?.find((mu: any) => mu.team_member_id === member.id || mu.email === member.email);\n    if (m) {\n      setAssignPlatforms(Array.isArray(m.platforms) ? m.platforms : []);\n      setAssignPlatformUserIds(m.platformUserIds || {});\n    } else {\n      setAssignPlatforms([]);\n      setAssignPlatformUserIds({});\n    }\n    setIsAssignOpen(true);\n  };\n\n  const getDeptName = (deptId: string) => {\n    const dept = departments.find(d => d.id === deptId);\n    return dept ? `${dept.code} - ${dept.name}` : \"Unknown\";\n  };\n\n  if (isLoading) {\n    return <div className=\"p-6\">Loading team members...</div>;\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Team Members</h1>\n          <p className=\"text-muted-foreground\">Manage employees across all departments</p>\n        </div>\n        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-add-member\">\n              <UserPlus className=\"w-4 h-4 mr-2\" />\n              Add Team Member\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\">\n            <form onSubmit={handleSubmit}>\n              <DialogHeader>\n                <DialogTitle>\n                  {editingMember ? \"Edit Team Member\" : \"Add Team Member\"}\n                </DialogTitle>\n                <DialogDescription>\n                  {editingMember ? \"Update team member information\" : \"Add a new team member\"}\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"grid grid-cols-2 gap-4 py-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"firstName\">First Name</Label>\n                  <Input\n                    id=\"firstName\"\n                    value={formData.firstName}\n                    onChange={(e) => setFormData({ ...formData, firstName: e.target.value })}\n                    required\n                    data-testid=\"input-first-name\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"lastName\">Last Name</Label>\n                  <Input\n                    id=\"lastName\"\n                    value={formData.lastName}\n                    onChange={(e) => setFormData({ ...formData, lastName: e.target.value })}\n                    required\n                    data-testid=\"input-last-name\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"email\">Email</Label>\n                  <Input\n                    id=\"email\"\n                    type=\"email\"\n                    value={formData.email}\n                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                    required\n                    data-testid=\"input-email\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"phone\">Phone</Label>\n                  <Input\n                    id=\"phone\"\n                    value={formData.phone}\n                    onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n                    data-testid=\"input-phone\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"department\">Department</Label>\n                  <Select\n                    value={formData.departmentId}\n                    onValueChange={(value) => setFormData({ ...formData, departmentId: value })}\n                    required\n                  >\n                    <SelectTrigger data-testid=\"select-department\">\n                      <SelectValue placeholder=\"Select department\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {departments.map((dept) => (\n                        <SelectItem key={dept.id} value={dept.id}>\n                          {dept.code} - {dept.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"role\">Role</Label>\n                  <Select\n                    value={formData.role}\n                    onValueChange={(value) => setFormData({ ...formData, role: value })}\n                  >\n                    <SelectTrigger data-testid=\"select-role\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"admin\">Admin</SelectItem>\n                      <SelectItem value=\"technician\">Technician</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2 col-span-2\">\n                  <Label htmlFor=\"employeeId\">Employee ID</Label>\n                  <Input\n                    id=\"employeeId\"\n                    value={formData.employeeId}\n                    onChange={(e) => setFormData({ ...formData, employeeId: e.target.value })}\n                    placeholder=\"e.g., HA-ADM-001\"\n                    data-testid=\"input-employee-id\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    Format: DEPT-ROLE-NUMBER (e.g., HA-ADM-001)\n                  </p>\n                </div>\n              </div>\n              <DialogFooter>\n                <Button type=\"button\" variant=\"outline\" onClick={closeDialog}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\" data-testid=\"button-submit-member\">\n                  {editingMember ? \"Update\" : \"Create\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"flex gap-2\">\n        <Select value={filterDept} onValueChange={setFilterDept}>\n          <SelectTrigger className=\"w-64\" data-testid=\"select-filter-dept\">\n            <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Departments</SelectItem>\n            {departments.map((dept) => (\n              <SelectItem key={dept.id} value={dept.id}>\n                {dept.code} - {dept.name}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <Card>\n        <CardContent className=\"p-0\">\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Employee ID</TableHead>\n                <TableHead>Name</TableHead>\n                <TableHead>Email</TableHead>\n                <TableHead>Department</TableHead>\n                <TableHead>Role</TableHead>\n                <TableHead>Phone</TableHead>\n                <TableHead>Status</TableHead>\n                <TableHead className=\"w-20\">Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {members.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={8} className=\"text-center py-12\">\n                    <UserPlus className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                    <h3 className=\"text-lg font-semibold mb-2\">No team members yet</h3>\n                    <p className=\"text-sm text-muted-foreground mb-4\">\n                      Add your first team member to get started\n                    </p>\n                    <Button onClick={() => setIsDialogOpen(true)}>\n                      <Plus className=\"w-4 h-4 mr-2\" />\n                      Add Team Member\n                    </Button>\n                  </TableCell>\n                </TableRow>\n              ) : (\n                members.map((member) => (\n                  <TableRow key={member.id} data-testid={`row-member-${member.employeeId}`}>\n                    <TableCell className=\"font-mono text-sm\">{member.employeeId || \"—\"}</TableCell>\n                    <TableCell className=\"font-medium\">\n                      <div className=\"flex flex-col\">\n                        <div>{member.firstName} {member.lastName}</div>\n                        <div className=\"mt-1 flex gap-2\">\n                          {(() => {\n                            const m = managedUsers?.find((mu: any) => mu.team_member_id === member.id || mu.email === member.email);\n                            if (!m || !Array.isArray(m.platforms) || m.platforms.length === 0) return null;\n                            return m.platforms.map((p: string) => (\n                              <PlatformBadge key={p} platform={p} small />\n                            ));\n                          })()}\n                        </div>\n                      </div>\n                    </TableCell>\n                    <TableCell>{member.email}</TableCell>\n                    <TableCell>{getDeptName(member.departmentId)}</TableCell>\n                    <TableCell>\n                      <Badge variant={member.role === \"admin\" ? \"default\" : \"secondary\"}>\n                        {member.role}\n                      </Badge>\n                    </TableCell>\n                    <TableCell>{member.phone || \"—\"}</TableCell>\n                    <TableCell>\n                      <Badge variant={member.status === \"active\" ? \"default\" : \"outline\"}>\n                        {member.status}\n                      </Badge>\n                    </TableCell>\n                    <TableCell>\n                        <div className=\"flex gap-1\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => openEditDialog(member)}\n                            data-testid={`button-edit-member-${member.employeeId}`}\n                          >\n                            <Pencil className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => openAssignDialog(member)}\n                            data-testid={`button-assign-platforms-${member.employeeId}`}\n                          >\n                            <UserPlus className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => {\n                              if (confirm(`Delete ${member.firstName} ${member.lastName}?`)) {\n                                deleteMutation.mutate(member.id);\n                              }\n                            }}\n                            data-testid={`button-delete-member-${member.employeeId}`}\n                          >\n                            <Trash2 className=\"w-4 h-4\" />\n                          </Button>\n                        </div>\n                    </TableCell>\n                  </TableRow>\n                ))\n              )}\n            </TableBody>\n          </Table>\n        </CardContent>\n      </Card>\n\n      <Dialog open={isAssignOpen} onOpenChange={setIsAssignOpen}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>Assign Platforms</DialogTitle>\n            <DialogDescription>\n              Assign platform access for {assigningMember ? `${assigningMember.firstName} ${assigningMember.lastName}` : \"\"}.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"py-4 space-y-3\">\n            {([\"metabase\", \"chatwoot\", \"typebot\", \"mailcow\"]).map((p) => (\n              <div key={p} className=\"flex items-center gap-3\">\n                <Checkbox\n                  id={`assign-${p}`}\n                  checked={assignPlatforms.includes(p)}\n                  onCheckedChange={(val) => {\n                    if (val) setAssignPlatforms((s) => Array.from(new Set([...s, p])));\n                    else setAssignPlatforms((s) => s.filter((x) => x !== p));\n                  }}\n                />\n                <Label htmlFor={`assign-${p}`} className=\"capitalize\">{p}</Label>\n                <Input\n                  placeholder=\"Platform user id (optional)\"\n                  value={assignPlatformUserIds[p] || \"\"}\n                  onChange={(e) => setAssignPlatformUserIds((s) => ({ ...s, [p]: e.target.value }))}\n                  className=\"ml-auto w-44\"\n                />\n              </div>\n            ))}\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsAssignOpen(false)}>Cancel</Button>\n            <Button\n              onClick={() => {\n                if (!assigningMember) return;\n                assignMutation.mutate({ id: assigningMember.id, payload: { platforms: assignPlatforms, platformUserIds: assignPlatformUserIds } });\n              }}\n            >\n              Save\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":19760,"size_tokens":null},"client/src/components/platform-badge.tsx":{"content":"import React from \"react\";\nimport { Database, MessageCircle, Zap, Mail } from \"lucide-react\";\n\ntype PlatformKey = \"metabase\" | \"chatwoot\" | \"typebot\" | \"mailcow\";\n\nconst platformMap: Record<\n  PlatformKey,\n  { label: string; color: string; Icon: any }\n> = {\n  metabase: { label: \"Metabase\", color: \"bg-purple-600\", Icon: Database },\n  chatwoot: { label: \"Chatwoot\", color: \"bg-green-600\", Icon: MessageCircle },\n  typebot: { label: \"Typebot\", color: \"bg-indigo-600\", Icon: Zap },\n  mailcow: { label: \"Mailcow\", color: \"bg-amber-500\", Icon: Mail },\n};\n\nexport default function PlatformBadge({\n  platform,\n  small,\n}: {\n  platform: PlatformKey | string;\n  small?: boolean;\n}) {\n  const key = (platform || \"\").toLowerCase() as PlatformKey;\n  const info = (platformMap as any)[key] || { label: platform || \"Unknown\", color: \"bg-gray-500\", Icon: Database };\n\n  return (\n    <div className={`inline-flex items-center space-x-2 rounded-full text-xs text-white ${small ? \"px-1 py-0\" : \"px-2 py-0.5\"}`}>\n      <span className={`${info.color} inline-flex items-center justify-center rounded-full w-5 h-5`}> \n        <info.Icon className=\"w-3 h-3\" />\n      </span>\n      {!small && <span className=\"font-medium text-[0.75rem]\">{info.label}</span>}\n    </div>\n  );\n}\n","path":null,"size_bytes":1255,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"test-login.sh":{"content":"#!/bin/bash\ncurl -X POST http://158.220.107.106:9100/api/auth/login \\\n  -H 'Content-Type: application/json' \\\n  -d '{\"email\":\"admin@company.com\",\"password\":\"admin123\"}' \\\n  2>/dev/null\n","path":null,"size_bytes":185,"size_tokens":null}},"version":2}